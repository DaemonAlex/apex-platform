<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APEX - AV Project Management</title>

    <!-- External Libraries from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        /* ==================== VARIABLES ==================== */
        :root {
            --primary-500: #0ea5e9;
            --primary-600: #0284c7;
            --primary-700: #0369a1;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --success-500: #22c55e;
            --success-600: #16a34a;
            --warning-500: #f59e0b;
            --warning-600: #d97706;
            --danger-500: #ef4444;
            --danger-600: #dc2626;
            --nav-height: 70px;
            --sidebar-width: 280px;
        }

        [data-theme="dark"] {
            --gray-50: #000000;
            --gray-100: #111111;
            --gray-200: #1a1a1a;
            --gray-300: #2a2a2a;
            --gray-800: #e0e0e0;
            --gray-900: #e8e8e8;
        }

        /* ==================== BASE STYLES ==================== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            font-size: 14px;
            line-height: 1.5;
            min-height: 100vh;
            padding-top: var(--nav-height);
        }

        /* ==================== STATIC NAVIGATION ==================== */
        .app-navigation {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--nav-height);
            background: var(--gray-900);
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .nav-content {
            max-width: none;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 1.25rem;
        }

        .nav-title {
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .nav-center {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }


        .nav-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 200ms;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .nav-btn.primary {
            background: var(--primary-500);
        }

        .nav-btn.primary:hover {
            background: var(--primary-600);
        }

        .nav-btn.active {
            background: var(--primary-600);
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.3);
        }

        /* Connection Status & User Menu (same as before) */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            font-size: 0.75rem;
            color: white;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-500);
            animation: pulse 2s infinite;
        }

        .user-menu {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary-500);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        /* ==================== MAIN LAYOUT ==================== */
        .app-layout {
            display: flex;
            min-height: calc(100vh - var(--nav-height));
        }

        .sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid var(--gray-200);
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
            overflow-y: auto;
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-x: auto;
        }

        /* ==================== SIDEBAR ==================== */
        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .sidebar-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .sidebar-subtitle {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-section-title {
            padding: 0 1.5rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: var(--gray-700);
            cursor: pointer;
            transition: all 200ms;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .nav-item:hover {
            background: var(--gray-50);
            color: var(--primary-600);
        }

        .nav-item.active {
            background: var(--primary-50);
            color: var(--primary-700);
            border-right: 3px solid var(--primary-500);
        }

        .nav-item-icon {
            margin-right: 0.75rem;
            font-size: 1.125rem;
            width: 20px;
        }

        .nav-item-text {
            flex: 1;
            font-weight: 500;
        }

        .nav-item-badge {
            background: var(--gray-200);
            color: var(--gray-700);
            padding: 0.125rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .nav-item.active .nav-item-badge {
            background: var(--primary-100);
            color: var(--primary-700);
        }

        /* ==================== CONTENT VIEWS ==================== */
        .content-view {
            display: none;
        }

        .content-view.active {
            display: block;
        }

        .content-header {
            margin-bottom: 2rem;
        }

        .content-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .content-subtitle {
            color: var(--gray-600);
            font-size: 1rem;
        }

        .content-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        /* ==================== DASHBOARD METRICS ==================== */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--gray-200);
            transition: transform 200ms;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .metric-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .metric-icon {
            width: 48px;
            height: 48px;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .metric-icon.primary {
            background: var(--primary-100);
            color: var(--primary-700);
        }

        .metric-icon.success {
            background: #dcfce7;
            color: var(--success-600);
        }

        .metric-icon.warning {
            background: #fef3c7;
            color: var(--warning-600);
        }

        .metric-icon.danger {
            background: #fee2e2;
            color: var(--danger-600);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            font-weight: 500;
        }

        .metric-change {
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 0.5rem;
        }

        .metric-change.positive {
            color: var(--success-600);
        }

        .metric-change.negative {
            color: var(--danger-600);
        }

        .metric-change.neutral {
            color: var(--gray-500);
        }

        /* ==================== CHARTS ==================== */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--gray-200);
        }

        .report-navigation {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--gray-200);
            padding-bottom: 1rem;
        }

        .report-view {
            display: none;
        }

        .report-view:first-of-type {
            display: block;
        }

        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .chart-actions {
            display: flex;
            gap: 0.5rem;
        }

        .chart-action {
            background: var(--gray-100);
            border: none;
            border-radius: 0.375rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 200ms;
        }

        .chart-action:hover {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .chart-action.active {
            background: var(--primary-100);
            color: var(--primary-700);
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 1rem;
        }

        .chart-container canvas {
            max-height: 100%;
        }

        .chart-legend {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.875rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 0.125rem;
        }

        /* ==================== TABLES ==================== */
        .data-table {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--gray-200);
            overflow: hidden;
        }

        .table-header {
            background: var(--gray-50);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .table-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .table-actions {
            display: flex;
            gap: 0.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
        }

        th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
        }

        td {
            color: var(--gray-900);
        }

        tr:hover {
            background: var(--gray-50);
        }

        /* ==================== STATUS BADGES ==================== */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-badge.active {
            background: #dcfce7;
            color: var(--success-700);
        }

        .status-badge.completed {
            background: var(--primary-100);
            color: var(--primary-700);
        }

        .status-badge.on-hold {
            background: #fef3c7;
            color: var(--warning-700);
        }

        .status-badge.cancelled {
            background: #fee2e2;
            color: var(--danger-700);
        }

        /* ==================== BUTTONS ==================== */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 200ms;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary-500);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-600);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        /* ==================== ADMINISTRATION STYLES ==================== */
        .admin-tabs {
            display: flex;
            border-bottom: 2px solid var(--gray-200);
            margin-bottom: 1.5rem;
            gap: 0.5rem;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            background: none;
            color: var(--gray-600);
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: var(--primary-600);
            background: var(--gray-50);
        }

        .tab-btn.active {
            color: var(--primary-600);
            border-bottom-color: var(--primary-500);
        }

        .admin-tab-content {
            display: none;
        }

        .admin-tab-content.active {
            display: block;
        }

        .admin-section {
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .section-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .section-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .search-input {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            min-width: 200px;
        }

        .filter-select {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            background: white;
            min-width: 150px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .data-table th {
            background: var(--gray-50);
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-200);
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-100);
        }

        .data-table tr:hover {
            background: var(--gray-50);
        }

        .user-avatar-small {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary-500);
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.75rem;
            margin-right: 0.5rem;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-badge.active {
            background: var(--success-500);
            color: white;
        }

        .status-badge.inactive {
            background: var(--gray-400);
            color: white;
        }

        .status-badge.pending {
            background: var(--warning-500);
            color: white;
        }

        .roles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        .role-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .role-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .role-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .role-users-count {
            background: var(--gray-100);
            color: var(--gray-600);
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
        }

        .permission-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .permission-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0;
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .permission-item.granted {
            color: var(--success-600);
        }

        .settings-form {
            max-width: 600px;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .financial-settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .financial-setting-card {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            padding: 1.5rem;
        }

        .financial-setting-card h4 {
            color: var(--gray-800);
            font-size: 1.125rem;
            font-weight: 600;
            margin: 0 0 1rem 0;
            border-bottom: 2px solid var(--primary-500);
            padding-bottom: 0.5rem;
        }

        .financial-setting-card .form-group {
            margin-bottom: 1rem;
        }

        .financial-setting-card .form-text {
            font-size: 0.75rem;
            color: var(--gray-600);
            margin-top: 0.25rem;
        }

        .settings-description {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--blue-50);
            border: 1px solid var(--blue-200);
            border-radius: 0.375rem;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 400;
            cursor: pointer;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
        }

        .users-table-container,
        .audit-table-container {
            overflow-x: auto;
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
        }

        .action-btn {
            padding: 0.375rem 0.75rem;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            cursor: pointer;
            margin-right: 0.25rem;
        }

        .action-btn.edit {
            background: var(--primary-100);
            color: var(--primary-700);
        }

        .action-btn.delete {
            background: var(--danger-100);
            color: var(--danger-700);
        }

        .action-btn.reset {
            background: var(--warning-100);
            color: var(--warning-700);
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 1024px) {
            .app-layout {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                order: 2;
                max-height: 200px;
                overflow-y: auto;
            }

            .main-content {
                order: 1;
                padding: 1rem;
            }

            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }

            .chart-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .nav-content {
                padding: 0 1rem;
            }

            .nav-title {
                display: none;
            }

            .nav-breadcrumb {
                display: none;
            }

            .main-content {
                padding: 1rem 0.5rem;
            }
        }

        /* ==================== FIELD OPS REPORTING STYLES ==================== */
        .field-ops-insights {
            display: grid;
            gap: 1.5rem;
        }
        
        .field-ops-summary {
            background: var(--white);
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid var(--gray-200);
        }
        
        .field-ops-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
        }
        
        .field-stat {
            text-align: center;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: 6px;
        }
        
        .field-stat .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary-600);
            margin-bottom: 0.25rem;
        }
        
        .field-stat .stat-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            font-weight: 500;
        }
        
        .field-ops-charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        
        .field-ops-chart {
            background: var(--white);
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid var(--gray-200);
        }
        
        .field-ops-chart h4 {
            margin: 0 0 1rem 0;
            color: var(--gray-800);
            font-size: 1rem;
        }
        
        .work-type-breakdown {
            display: grid;
            gap: 1rem;
        }
        
        .work-type-item {
            display: grid;
            gap: 0.5rem;
        }
        
        .work-type-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .work-type-count {
            font-size: 0.875rem;
            color: var(--gray-600);
        }
        
        .work-type-bar {
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .work-type-progress {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .work-type-progress.info {
            background: var(--info-500);
        }
        
        .work-type-progress.success {
            background: var(--success-500);
        }
        
        .work-type-progress.danger {
            background: var(--danger-500);
        }
        
        .work-type-progress.warning {
            background: var(--warning-500);
        }
        
        .resource-breakdown {
            display: grid;
            gap: 0.75rem;
        }
        
        .resource-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .resource-name {
            font-weight: 500;
            color: var(--gray-800);
            flex: 1;
        }
        
        .resource-stats {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
        }
        
        .resource-bar {
            width: 80px;
            height: 4px;
            background: var(--gray-200);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .resource-progress {
            height: 100%;
            background: var(--primary-500);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .resource-more {
            font-size: 0.875rem;
            color: var(--gray-500);
            text-align: center;
            padding-top: 0.5rem;
            border-top: 1px solid var(--gray-200);
        }
        
        .field-ops-integration {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        
        .integration-stat {
            background: var(--white);
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .integration-icon {
            font-size: 2rem;
        }
        
        .integration-details {
            flex: 1;
        }
        
        .integration-title {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-bottom: 0.25rem;
        }
        
        .integration-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-600);
            margin-bottom: 0.25rem;
        }
        
        .integration-subtitle {
            font-size: 0.8rem;
            color: var(--gray-500);
        }
        
        .field-ops-alerts {
            background: var(--white);
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid var(--gray-200);
        }
        
        .field-alert {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 6px;
        }
        
        .field-alert.warning {
            background: var(--warning-50);
            border: 1px solid var(--warning-200);
        }
        
        .alert-icon {
            font-size: 1.5rem;
        }
        
        .alert-content {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .alert-action {
            color: var(--primary-600);
            text-decoration: none;
            font-weight: 500;
        }
        
        .alert-action:hover {
            color: var(--primary-700);
            text-decoration: underline;
        }
        
        /* ==================== RESCHEDULE ANALYTICS STYLES ==================== */
        .field-ops-reschedule-details {
            background: var(--white);
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid var(--gray-200);
            margin-top: 1.5rem;
        }
        
        .field-ops-reschedule-details h4 {
            margin: 0 0 1rem 0;
            color: var(--gray-800);
            font-size: 1rem;
        }
        
        .reschedule-reasons-breakdown {
            display: grid;
            gap: 0.75rem;
        }
        
        .reason-breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        
        .reason-label {
            flex-shrink: 0;
        }
        
        .reason-stats {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .reason-count {
            font-size: 0.875rem;
            color: var(--gray-600);
            min-width: 80px;
            text-align: right;
        }
        
        .reason-bar {
            flex: 1;
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .reason-progress {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .reason-progress.warning {
            background: var(--warning-500);
        }
        
        .reason-progress.danger {
            background: var(--danger-500);
        }
        
        .reason-progress.info {
            background: var(--info-500);
        }
        
        .reason-progress.secondary {
            background: var(--gray-500);
        }
        
        .integration-value.warning {
            color: var(--warning-600);
        }
        
        .integration-value.info {
            color: var(--info-600);
        }
        
        .integration-value.success {
            color: var(--success-600);
        }
        
        /* ==================== RESCHEDULE CARD STYLING ==================== */
        .schedule-card.rescheduled {
            border-left: 4px solid var(--warning-400);
            background: var(--warning-25);
        }
        
        .schedule-card.rescheduled:hover {
            background: var(--warning-50);
        }
        
        @media (max-width: 768px) {
            .field-ops-charts {
                grid-template-columns: 1fr;
            }
            
            .field-ops-integration {
                grid-template-columns: 1fr;
            }
        }

        /* ==================== FIELD OPS STYLES ==================== */
        .fieldops-tab {
            display: none;
            padding: 1.5rem;
        }
        
        .fieldops-tab.active {
            display: block;
        }
        
        .today-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .today-stats {
            display: flex;
            gap: 1rem;
        }
        
        .stat-badge {
            background: var(--white);
            border: 1px solid var(--gray-200);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-600);
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-top: 0.25rem;
        }
        
        .schedule-grid {
            display: grid;
            gap: 1rem;
        }
        
        .schedule-card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 1rem;
            display: grid;
            grid-template-columns: 100px 1fr auto;
            gap: 1rem;
            align-items: center;
            transition: all 0.2s ease;
        }
        
        .schedule-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        
        .schedule-time {
            font-weight: 600;
            color: var(--gray-700);
        }
        
        .schedule-details {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .schedule-title {
            font-weight: 600;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .project-tag {
            background: var(--primary-100);
            color: var(--primary-700);
            padding: 0.125rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .work-type-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .work-type-badge.install {
            background: var(--info-100);
            color: var(--info-700);
            border-left: 3px solid var(--info-500);
        }
        
        .work-type-badge.commission {
            background: var(--success-100);
            color: var(--success-700);
            border-left: 3px solid var(--success-500);
        }
        
        .work-type-badge.breakfix {
            background: var(--danger-100);
            color: var(--danger-700);
            border-left: 3px solid var(--danger-500);
        }
        
        .work-type-badge.maintenance {
            background: var(--warning-100);
            color: var(--warning-700);
            border-left: 3px solid var(--warning-500);
        }
        
        .calendar-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .calendar-filters {
            display: flex;
            gap: 0.5rem;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--gray-200);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .calendar-day {
            background: var(--white);
            min-height: 100px;
            padding: 0.5rem;
            position: relative;
        }
        
        .calendar-day-header {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.25rem;
        }
        
        .calendar-day.other-month {
            background: var(--gray-50);
        }
        
        .calendar-day.today {
            background: var(--primary-50);
        }
        
        .calendar-event {
            font-size: 0.75rem;
            padding: 0.125rem 0.25rem;
            border-radius: 2px;
            margin-bottom: 2px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .pending-list, .history-list {
            display: grid;
            gap: 1rem;
        }
        
        .pending-card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .pending-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .pending-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* ==================== UTILITY CLASSES ==================== */
        .hidden {
            display: none !important;
        }

        .loading {
            opacity: 0.5;
            pointer-events: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        /* ==================== REPORTS STYLING ==================== */
        .reports-container {
            padding: 1.5rem;
        }

        .reports-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .reports-header h3 {
            margin: 0;
            color: var(--gray-900);
            font-size: 1.5rem;
        }

        .report-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .form-select {
            padding: 0.5rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            background: white;
            font-size: 0.875rem;
            min-width: 150px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: white;
            border-radius: 0.75rem;
            border: 1px solid var(--gray-200);
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .chart-header h4 {
            margin: 0;
            color: var(--gray-900);
            font-size: 1.1rem;
        }

        .chart-controls {
            display: flex;
            gap: 0.5rem;
        }

        .chart-toggle {
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            border: 1px solid var(--gray-300);
            background: white;
            color: var(--gray-600);
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chart-toggle:hover {
            background: var(--gray-50);
            color: var(--gray-900);
        }

        .chart-toggle.active {
            background: var(--primary-600);
            color: white;
            border-color: var(--primary-600);
        }

        .report-tables {
            margin-top: 2rem;
        }

        .report-section {
            background: white;
            border-radius: 0.75rem;
            border: 1px solid var(--gray-200);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .report-section h4 {
            margin: 0 0 1rem 0;
            color: var(--gray-900);
            font-size: 1.1rem;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .report-table th {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
        }

        .report-table td {
            border: 1px solid var(--gray-200);
            padding: 0.75rem;
            vertical-align: middle;
        }

        .report-table tr:hover {
            background: var(--gray-50);
        }

        .progress-bar {
            position: relative;
            width: 100px;
            height: 20px;
            background: var(--gray-200);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #16a34a);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        .text-danger { color: #dc2626; }
        .text-warning { color: #d97706; }
        .text-success { color: #16a34a; }
        .text-muted { color: var(--gray-500); }

        .risk-indicator {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .risk-indicator.risk-low {
            background-color: rgba(34, 197, 94, 0.1);
            color: #16a34a;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .risk-indicator.risk-medium {
            background-color: rgba(245, 158, 11, 0.1);
            color: #d97706;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .risk-indicator.risk-high {
            background-color: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Responsive design for reports */
        @media (max-width: 1024px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .reports-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .report-controls {
                flex-direction: column;
                width: 100%;
            }

            .chart-card {
                padding: 1rem;
            }

            .progress-bar {
                width: 80px;
                height: 16px;
            }

            .progress-text {
                font-size: 0.625rem;
            }
        }

        /* ==================== EXPORT MODAL STYLING ==================== */
        .export-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .export-modal {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 450px;
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
        }

        .export-modal-header {
            padding: 1.5rem 1.5rem 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .export-modal-header h3 {
            margin: 0;
            color: var(--gray-900);
            font-size: 1.25rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-400);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        .export-modal-body {
            padding: 1.5rem;
        }

        .export-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }

        .export-option-btn {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 1rem;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .export-option-btn:hover {
            border-color: var(--primary-300);
            background: var(--primary-50);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .export-option-btn small {
            color: var(--gray-500);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        /* ==================== NOTIFICATION STYLING ==================== */
        .notification {
            position: fixed;
            top: 100px;
            right: 1rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-left: 4px solid var(--primary-500);
            padding: 1rem;
            z-index: 9999;
            max-width: 350px;
            animation: slideIn 0.3s ease-out;
        }

        .notification-success {
            border-left-color: #22c55e;
        }

        .notification-error {
            border-left-color: #ef4444;
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--gray-700);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ==================== PROJECT MANAGEMENT STYLING ==================== */
        .projects-container {
            padding: 1.5rem;
        }

        .projects-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .projects-header h3 {
            margin: 0;
            color: var(--gray-900);
            font-size: 1.5rem;
        }

        .projects-controls {
            display: flex;
            gap: 0.75rem;
        }

        .projects-filter {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .filter-tabs {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-separator {
            width: 1px;
            height: 24px;
            background: var(--gray-300);
            margin: 0 0.5rem;
        }

        .filter-tab {
            padding: 0.5rem 1rem;
            border: 1px solid var(--gray-300);
            background: white;
            color: var(--gray-600);
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .filter-tab:hover {
            background: var(--gray-50);
            color: var(--gray-900);
        }

        .filter-tab.active {
            background: var(--primary-600);
            color: white;
            border-color: var(--primary-600);
        }

        .search-box {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-box input {
            padding: 0.5rem 2.5rem 0.5rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            width: 250px;
        }

        .search-icon {
            position: absolute;
            right: 0.75rem;
            color: var(--gray-400);
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .project-card {
            background: white;
            border-radius: 0.75rem;
            border: 1px solid var(--gray-200);
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .project-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-color: var(--primary-300);
        }

        .project-card.overdue {
            border-left: 4px solid #ef4444;
        }

        .project-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .project-title {
            margin: 0;
            color: var(--gray-900);
            font-size: 1.1rem;
            font-weight: 600;
            line-height: 1.2;
            flex: 1;
        }

        .project-menu {
            margin-left: 0.5rem;
        }

        .menu-btn {
            background: none;
            border: none;
            color: var(--gray-400);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: all 0.2s;
        }

        .menu-btn:hover {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        .project-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .project-client {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .project-type {
            background: var(--gray-100);
            color: var(--gray-700);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .project-details {
            margin-bottom: 1rem;
        }

        .project-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
        }

        .detail-label {
            color: var(--gray-500);
            font-weight: 500;
            flex-shrink: 0;
        }

        .detail-value {
            color: var(--gray-800);
            font-weight: 600;
            text-align: right;
            margin-left: 0.5rem;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .project-progress {
            margin-bottom: 1rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .project-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .project-timeline {
            padding-top: 1rem;
            border-top: 1px solid var(--gray-100);
        }

        .timeline-item {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .timeline-item.overdue {
            color: #ef4444;
            font-weight: 600;
        }

        .timeline-item.due-soon {
            color: #f59e0b;
            font-weight: 600;
        }

        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray-500);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .loading-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 3rem;
            color: var(--gray-500);
        }

        /* Project Modal */
        .project-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 1rem;
        }

        .project-modal {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1.5rem 1.5rem 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--gray-900);
            font-size: 1.25rem;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-footer {
            padding: 1rem 1.5rem 1.5rem 1.5rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Project Modal Overlay Styles */
        .project-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Project Menu Dropdown Styles */
        .project-menu-dropdown {
            position: fixed;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            min-width: 160px;
            z-index: 2000;
            padding: 0.5rem 0;
            animation: fadeIn 0.15s ease-out;
        }

        .project-menu-dropdown .menu-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background-color 0.15s;
            font-size: 0.875rem;
            color: var(--gray-700);
        }

        .project-menu-dropdown .menu-item:hover {
            background: var(--gray-50);
        }

        .project-menu-dropdown .menu-item.danger {
            color: var(--red-600);
        }

        .project-menu-dropdown .menu-item.danger:hover {
            background: rgba(239, 68, 68, 0.05);
        }

        .project-menu-dropdown .menu-icon {
            font-size: 1rem;
            width: 1.25rem;
            text-align: center;
        }

        .project-menu-dropdown .menu-separator {
            height: 1px;
            background: var(--gray-200);
            margin: 0.5rem 0;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Project Detail Modal Styles */
        .project-detail-modal {
            width: 90vw;
            max-width: 1200px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .project-detail-body {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .detail-section {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .detail-section:last-child {
            border-bottom: none;
        }

        .detail-section h4 {
            margin: 0 0 1rem 0;
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .detail-item.full-width {
            grid-column: 1 / -1;
        }

        .detail-item label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-600);
        }

        .detail-item span, .detail-item p {
            font-size: 0.875rem;
            color: var(--gray-900);
        }

        .description-text {
            margin: 0;
            line-height: 1.5;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-container .progress-bar {
            flex: 1;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-container .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.75rem;
            font-weight: 500;
            min-width: 35px;
        }

        .priority-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 500;
            text-transform: capitalize;
        }

        .priority-badge.low {
            background: rgba(34, 197, 94, 0.1);
            color: #16a34a;
        }

        .priority-badge.medium {
            background: rgba(59, 130, 246, 0.1);
            color: #2563eb;
        }

        .priority-badge.high {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }

        .priority-badge.critical {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }

        /* Tasks Section Styles */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .tasks-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .no-tasks {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--gray-500);
        }

        .no-tasks-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .no-tasks p {
            margin: 0.5rem 0;
        }

        .text-muted {
            font-size: 0.875rem;
            color: var(--gray-400);
        }

        .task-item {
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            background: white;
            transition: all 0.2s ease;
        }

        .task-item:hover {
            border-color: var(--gray-300);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .task-info {
            flex: 1;
        }

        .task-name {
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
            font-weight: 500;
            color: var(--gray-900);
        }

        .task-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }

        .task-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 500;
            text-transform: capitalize;
        }

        .task-status.not-started {
            background: rgba(107, 114, 128, 0.1);
            color: #6b7280;
        }

        .task-status.in-progress {
            background: rgba(59, 130, 246, 0.1);
            color: #2563eb;
        }

        .task-status.completed {
            background: rgba(34, 197, 94, 0.1);
            color: #16a34a;
        }

        .task-status.on-hold {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }

        .task-priority {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 500;
            text-transform: capitalize;
        }

        .task-assignee {
            font-size: 0.75rem;
            color: var(--gray-600);
        }

        .task-actions {
            display: flex;
            gap: 0.25rem;
        }

        .btn-icon {
            background: none;
            border: none;
            padding: 0.25rem;
            cursor: pointer;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
            font-size: 0.875rem;
        }

        .btn-icon:hover {
            background: var(--gray-100);
        }

        .task-description {
            margin: 0.75rem 0 0.5rem 0;
            font-size: 0.875rem;
            color: var(--gray-600);
            line-height: 1.4;
        }

        .task-details {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .task-detail {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* Task Modal Styles */
        .task-modal {
            width: 600px;
            max-width: 90vw;
        }

        /* Executive Summary Styles */
        .tab-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--gray-300);
            background: white;
            color: var(--gray-600);
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .tab-btn:hover {
            background: var(--gray-50);
            color: var(--gray-900);
        }

        .tab-btn.active {
            background: var(--primary-600);
            color: white;
            border-color: var(--primary-600);
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid var(--gray-200);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-600);
            margin-bottom: 0.5rem;
        }

        .kpi-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            font-weight: 500;
        }

        .executive-section {
            background: white;
            border-radius: 0.75rem;
            border: 1px solid var(--gray-200);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .executive-section h4 {
            margin: 0 0 1rem 0;
            color: var(--gray-900);
            font-size: 1.1rem;
        }

        .insights-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .insight-card {
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid;
        }

        .insight-success {
            background: rgba(34, 197, 94, 0.05);
            border-color: #22c55e;
        }

        .insight-warning {
            background: rgba(245, 158, 11, 0.05);
            border-color: #f59e0b;
        }

        .insight-info {
            background: rgba(59, 130, 246, 0.05);
            border-color: #3b82f6;
        }

        .insight-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .financial-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .financial-metric {
            text-align: center;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: 0.5rem;
        }

        .financial-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .financial-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .critical-project-item {
            padding: 1rem;
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .critical-project-name {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .critical-project-details {
            display: flex;
            gap: 1rem;
            align-items: center;
            font-size: 0.875rem;
        }

        .overdue-badge {
            background: #ef4444;
            color: white;
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .no-critical {
            text-align: center;
            padding: 2rem;
            color: var(--gray-500);
            font-style: italic;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .projects-filter {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-tabs {
                justify-content: center;
            }

            .search-box input {
                width: 100%;
            }

            .projects-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .financial-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ==================== LOGIN SCREEN STYLING ==================== */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .login-container {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            padding: 2rem;
            width: 100%;
            max-width: 450px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header h1 {
            margin: 0 0 0.5rem 0;
            color: var(--gray-900);
            font-size: 1.75rem;
            font-weight: 700;
        }

        .login-header p {
            margin: 0;
            color: var(--gray-600);
            font-size: 0.875rem;
        }

        .login-form {
            margin-bottom: 2rem;
        }

        .login-form .form-group {
            margin-bottom: 1rem;
        }

        .login-form label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--gray-700);
            font-weight: 600;
            font-size: 0.875rem;
        }

        .login-form input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .login-form input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .login-demo {
            border-top: 1px solid var(--gray-200);
            padding-top: 2rem;
        }

        .login-demo h4 {
            margin: 0 0 1rem 0;
            color: var(--gray-700);
            font-size: 0.875rem;
            text-align: center;
        }

        .demo-accounts {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .demo-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--gray-300);
            background: var(--gray-50);
            color: var(--gray-700);
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .demo-btn:hover {
            background: var(--gray-100);
            border-color: var(--primary-300);
            color: var(--primary-700);
        }

        /* Hide main navigation when not logged in */
        body:not(.logged-in) .app-navigation {
            display: none;
        }


        /* When logged in, always hide the login overlay and show the app */
        body.logged-in #loginScreen { display: none !important; }
        body.logged-in #mainApp { display: flex !important; }

        /* Generic modal styles */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.45);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 11000;
        }
        .modal {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
            width: min(600px, 90%);
            max-height: 85vh;
            overflow: auto;
        }
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--gray-200);
        }
        .modal-body {
            padding: 1rem 1.25rem;
        }
        .modal-close {
            border: 0;
            background: transparent;
            font-size: 1.25rem;
            line-height: 1;
            color: var(--gray-500);
            cursor: pointer;
        }


        /* ==================== PROJECT VIEW STYLES ==================== */


        .calendar-view {
            padding: 1rem 0;
        }

        .calendar-month {
            margin-bottom: 2rem;
        }

        .calendar-month-header {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-500);
        }

        .calendar-projects {
            display: grid;
            gap: 0.75rem;
        }

        .calendar-project {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 0.375rem;
            padding: 1rem;
            border-left: 4px solid var(--primary-500);
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-project:hover {
            border-color: var(--primary-300);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .calendar-project h4 {
            margin: 0 0 0.5rem 0;
            color: var(--gray-900);
        }

        .calendar-project-dates {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
        }

        .calendar-project-meta {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .list-view {
            /* Reuse existing grid styles */
        }

        /* ==================== ADVANCED SEARCH STYLES ==================== */
        .advanced-search-container {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .quick-search-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .search-input-container {
            flex: 1;
            position: relative;
        }

        .global-search-input {
            width: 100%;
            padding: 0.75rem 3rem 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .global-search-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px var(--primary-100);
        }

        .search-input-container .search-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
            pointer-events: none;
        }

        .advanced-filters-panel {
            padding: 1.5rem;
            background: var(--gray-50);
            border-top: 1px solid var(--gray-200);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .filter-group {
            background: white;
            padding: 1rem;
            border-radius: 0.375rem;
            border: 1px solid var(--gray-200);
        }

        .filter-label {
            display: block;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
        }

        .filter-checkboxes {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-checkboxes label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }

        .filter-checkboxes label:hover {
            background: var(--gray-100);
        }

        .filter-checkboxes input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }

        .date-filters, .budget-filters {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .date-filters label, .budget-filters label {
            font-size: 0.75rem;
            color: var(--gray-600);
            margin-bottom: 0.25rem;
        }

        .date-filters input, .budget-filters input {
            padding: 0.5rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }

        .progress-filters {
            display: grid;
            grid-template-columns: 1fr auto 1fr auto;
            gap: 0.5rem;
            align-items: center;
        }

        .progress-filters input[type="range"] {
            width: 100%;
        }

        .progress-filters span {
            font-size: 0.75rem;
            color: var(--gray-600);
            text-align: center;
            min-width: 3rem;
        }

        .quick-presets {
            background: white;
            padding: 1rem;
            border-radius: 0.375rem;
            border: 1px solid var(--gray-200);
        }

        .preset-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .search-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--gray-50);
            border-top: 1px solid var(--gray-200);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .results-info {
            font-size: 0.875rem;
            color: var(--gray-700);
        }

        .filter-count {
            background: var(--primary-100);
            color: var(--primary-700);
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-weight: 500;
        }

        .results-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            font-size: 0.875rem;
        }

        .results-controls label {
            color: var(--gray-600);
            font-weight: 500;
        }

        .results-controls select {
            padding: 0.375rem 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.25rem;
            font-size: 0.875rem;
            background: white;
        }

        /* Responsive Design for Advanced Search */
        @media (max-width: 1200px) {
            .filters-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .quick-search-row {
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }

            .search-results-header {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }

            .results-controls {
                justify-content: center;
            }

            .preset-buttons {
                justify-content: center;
            }

            .filters-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        /* ==================== RAG STATUS STYLES ==================== */
        .rag-green {
            color: #22c55e !important;
            background-color: rgba(34, 197, 94, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .rag-yellow {
            color: #f59e0b !important;
            background-color: rgba(245, 158, 11, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .rag-red {
            color: #ef4444 !important;
            background-color: rgba(239, 68, 68, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        /* Phase Indicators */
        .phase-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            margin-right: 0.5rem;
        }

        .phase-1 {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .phase-2 {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }

        .phase-3 {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
        }

        .phase-4 {
            background: linear-gradient(135deg, #43e97b, #38f9d7);
            color: white;
        }

        .phase-section {
            margin: 1.5rem 0;
            padding: 1rem;
            border-left: 4px solid var(--primary-500);
            background: var(--gray-50);
            border-radius: 0.5rem;
        }

        .phase-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .phase-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .phase-progress {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .phase-tasks-count {
            background: var(--primary-100);
            color: var(--primary-700);
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 600;
        }

        /* RAG status in tables */
        table .rag-green,
        table .rag-yellow,
        table .rag-red {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
        }

        /* Progress bar styling for better visibility */
        .progress-bar {
            position: relative;
            width: 100%;
            height: 1.5rem;
            background-color: var(--gray-200);
            border-radius: 0.375rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--success-500);
            transition: width 0.3s ease;
        }

        .progress-fill[style*="width: 0"] {
            background-color: var(--gray-400);
        }

        .progress-fill[style*="width: 1"],
        .progress-fill[style*="width: 2"],
        .progress-fill[style*="width: 3"],
        .progress-fill[style*="width: 4"] {
            background-color: var(--danger-500);
        }

        .progress-fill[style*="width: 5"],
        .progress-fill[style*="width: 6"],
        .progress-fill[style*="width: 7"] {
            background-color: var(--warning-500);
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-800);
            text-shadow: 0 0 3px rgba(255, 255, 255, 0.8);
        }

        /* Financial and Team Report Styles */
        .financial-details,
        .team-details {
            margin-top: 2rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .financial-section,
        .team-section {
            background: var(--surface);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .financial-section h3,
        .team-section h3 {
            margin: 0 0 1rem 0;
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
        }

        .financial-table-container,
        .team-table-container {
            overflow-x: auto;
        }

        .financial-table,
        .team-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .financial-table th,
        .financial-table td,
        .team-table th,
        .team-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .financial-table th,
        .team-table th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .financial-table .positive {
            color: var(--success-color);
        }

        .financial-table .negative {
            color: var(--error-color);
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-badge.over {
            background: var(--error-bg);
            color: var(--error-color);
        }

        .status-badge.under {
            background: var(--success-bg);
            color: var(--success-color);
        }

        .status-badge.on {
            background: var(--warning-bg);
            color: var(--warning-color);
        }

        .performance-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .performance-badge.excellent {
            background: var(--success-bg);
            color: var(--success-color);
        }

        .performance-badge.good {
            background: var(--info-bg);
            color: var(--info-color);
        }

        .performance-badge.average {
            background: var(--warning-bg);
            color: var(--warning-color);
        }

        .performance-badge.needs {
            background: var(--error-bg);
            color: var(--error-color);
        }

        .budget-type-breakdown {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .type-budget-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .type-info {
            display: flex;
            flex-direction: column;
        }

        .type-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .type-count {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .type-budget {
            font-weight: 600;
            color: var(--accent-color);
        }

        .type-percentage {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .status-distribution {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-info {
            min-width: 120px;
            display: flex;
            flex-direction: column;
        }

        .status-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .status-count {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .status-bar {
            flex: 1;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }

        .status-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .status-fill.completed {
            background: var(--success-color);
        }

        .status-fill.in-progress {
            background: var(--info-color);
        }

        .status-fill.not-started {
            background: var(--gray-400);
        }

        .status-fill.blocked {
            background: var(--error-color);
        }

        .status-percentage {
            min-width: 40px;
            text-align: right;
            font-weight: 500;
            color: var(--text-primary);
        }

        /* Breakfix Budget Styles */
        .breakfix-budget-section {
            margin: 2rem 0;
            padding: 2rem;
            background: var(--surface);
            border-radius: 12px;
            border: 2px solid var(--accent-color);
        }

        .breakfix-budget-section h2 {
            margin: 0 0 1.5rem 0;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Refresh Budget Styles */
        .refresh-budget-section {
            margin: 2rem 0;
            padding: 2rem;
            background: var(--surface);
            border-radius: 12px;
            border: 2px solid #4CAF50;
        }

        .refresh-budget-section h2 {
            margin: 0 0 1.5rem 0;
            color: #4CAF50;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .breakfix-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .breakfix-projects h3 {
            margin: 1.5rem 0 1rem 0;
            color: var(--text-primary);
        }

        .no-breakfix {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .executive-card.warning {
            border: 2px solid var(--warning-color);
            background: var(--warning-bg);
        }

        .executive-card.danger {
            border: 2px solid var(--error-color);
            background: var(--error-bg);
        }

        .budget-edit-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .edit-budget-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .edit-budget-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .edit-budget-btn:nth-child(2) {
            background: #4CAF50;
        }

        .edit-budget-btn:nth-child(2):hover {
            background: #45a049;
        }

        .executive-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
        }

        .executive-header > div:first-child {
            flex: 1;
        }

        /* Executive Dashboard Styles */
        .executive-filters {
            display: flex;
            gap: 1.5rem;
            align-items: center;
            flex-wrap: wrap;
            padding: 1rem 0;
            border-top: 1px solid var(--border-color);
            margin-top: 1rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .filter-group select {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--surface);
            color: var(--text-primary);
            font-size: 0.875rem;
            min-width: 120px;
        }

        .filter-group select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px var(--accent-color)20;
        }

        #executiveDashboard {
            margin-top: 2rem;
        }

        .executive-summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .executive-summary-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .executive-summary-card.critical {
            border-left: 4px solid var(--error-color);
        }

        .executive-summary-card.warning {
            border-left: 4px solid var(--warning-color);
        }

        .executive-summary-card.success {
            border-left: 4px solid var(--success-color);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-metric {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-color);
            line-height: 1;
        }

        .card-metric.critical {
            color: var(--error-color);
        }

        .card-metric.warning {
            color: var(--warning-color);
        }

        .card-metric.success {
            color: var(--success-color);
        }

        .card-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .card-trend {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            margin-top: 1rem;
        }

        .trend-up {
            color: var(--success-color);
        }

        .trend-down {
            color: var(--error-color);
        }

        .trend-neutral {
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- Static Navigation Header -->
    <nav class="app-navigation">
        <div class="nav-content">
            <div class="nav-brand">
                <div class="nav-logo">AP</div>
                <div class="nav-title">APEX</div>
            </div>

            <div class="nav-center">
            </div>

            <div class="nav-actions">
                <!-- Connection Status -->
                <div class="connection-status">
                    <div class="status-dot" id="connectionDot"></div>
                    <span id="connectionText">Connected</span>
                </div>

                <!-- Navigation Buttons -->
                <button class="nav-btn" onclick="showView('dashboard')" id="navDashboard">
                    📊 Dashboard
                </button>
                <button class="nav-btn" onclick="showView('projects')" id="navProjects">
                    📁 Projects
                </button>
                <button class="nav-btn" onclick="showView('fieldops')" id="navFieldops">
                    🛠️ Field Ops
                </button>
                <button class="nav-btn" onclick="showView('reports')" id="navReports">
                    📈 Reports
                </button>
                <button class="nav-btn" onclick="showView('insights')" id="navInsights">
                    🧠 Insights
                </button>
                <button class="nav-btn" onclick="showView('admin')" id="navAdmin">
                    ⚙️ Administration
                </button>
                <button class="nav-btn primary" onclick="showCreateProject()">
                    ➕ New Project
                </button>

                <!-- User Menu -->
                <div class="user-menu">
                    <div class="user-avatar" onclick="toggleUserMenu()" id="userAvatar">A</div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <div class="login-header">
                <h1>🎯 APEX</h1>
                <p>AV Project Execution Platform - [Company Name] Unified Communications</p>
            </div>
            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="loginEmail">Email Address</label>
                    <input type="email" id="loginEmail" name="email" required placeholder="Enter your email" autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" name="password" required placeholder="Enter your password" autocomplete="current-password">
                </div>
                <button type="submit" class="btn btn-primary login-btn">Sign In</button>
            </form>
            <div style="margin-top: 0.75rem; color: var(--gray-500); font-size: 0.85rem; text-align:center;">
                Powered by APEX Backend API
                <div id="backendDbInfo" style="margin-top: 0.25rem; color: var(--gray-500); font-size: 0.8rem; text-align:center;">Checking backend...</div>

            </div>

        </div>
    </div>

    <!-- Main Application Layout -->
    <div class="app-layout" id="mainApp" style="display: none;">
        <!-- Dynamic Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2 class="sidebar-title" id="sidebarTitle">Dashboard</h2>
                <p class="sidebar-subtitle" id="sidebarSubtitle">Project overview and metrics</p>
            </div>

            <nav class="sidebar-nav" id="sidebarNav">
                <!-- Dynamic navigation content -->
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Dashboard View -->
            <div id="dashboardView" class="content-view active">
                <div class="content-header">
                    <h1 class="content-title">APEX Dashboard</h1>
                    <p class="content-subtitle">Real-time overview of all AV projects and key performance indicators</p>
                    <div class="content-actions">
                        <button class="btn btn-primary" onclick="refreshDashboard()">
                            🔄 Refresh Data
                        </button>
                        <button class="btn btn-secondary" onclick="exportDashboard()">
                            📊 Export Report
                        </button>
                    </div>
                </div>

                <!-- Key Metrics -->
                <div class="metrics-grid" id="metricsGrid">
                    <!-- Dynamic metrics cards -->
                </div>

                <!-- Charts -->
                <div class="chart-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Project Status Distribution</h3>
                            <div class="chart-actions">
                                <button class="chart-action active" data-period="30">30d</button>
                                <button class="chart-action" data-period="90">90d</button>
                                <button class="chart-action" data-period="365">1y</button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Progress Trends</h3>
                            <div class="chart-actions">
                                <button class="chart-action active" data-metric="progress">Progress</button>
                                <button class="chart-action" data-metric="budget">Budget</button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="progressChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Recent Projects Table -->
                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">Recent Projects</h3>
                        <div class="table-actions">
                            <button class="btn btn-sm btn-secondary" onclick="showAllProjects()">
                                View All
                            </button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Project Name</th>
                                <th>Client</th>
                                <th>Status</th>
                                <th>Progress</th>
                                <th>Due Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentProjectsTable">
                            <!-- Dynamic project rows -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Projects View -->
            <div id="projectsView" class="content-view">
                <div class="content-header">
                    <h1 class="content-title">All Projects</h1>
                    <p class="content-subtitle">Manage and track all your AV projects</p>
                    <div class="content-actions">
                        <button class="btn btn-primary" onclick="showCreateProject()">
                            ➕ New Project
                        </button>
                        <button class="btn btn-secondary" onclick="exportProjects()">
                            📊 Export All
                        </button>
                    </div>
                </div>

                <div id="projectsContent">
                    <!-- Projects content will be loaded here -->
                </div>
            </div>

            <!-- Field Operations View -->
            <div id="fieldopsView" class="content-view">
                <div class="content-header">
                    <h1 class="content-title">Field Operations</h1>
                    <p class="content-subtitle">Schedule and track onsite installations, commissioning, and service work</p>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="showScheduleFieldWork()">
                            ➕ Schedule Field Work
                        </button>
                    </div>
                </div>
                
                <!-- Field Ops Tabs -->
                <div class="tabs-container">
                    <div class="tabs">
                        <button class="tab-btn active" onclick="showFieldOpsTab('today')" id="tabToday">
                            📅 Today's Schedule
                        </button>
                        <button class="tab-btn" onclick="showFieldOpsTab('calendar')" id="tabCalendar">
                            📆 Calendar View
                        </button>
                        <button class="tab-btn" onclick="showFieldOpsTab('pending')" id="tabPending">
                            ⏳ Pending Queue
                        </button>
                        <button class="tab-btn" onclick="showFieldOpsTab('history')" id="tabHistory">
                            📋 History
                        </button>
                    </div>
                </div>
                
                <!-- Today's Schedule Tab -->
                <div id="todayTab" class="fieldops-tab active">
                    <div class="today-header">
                        <h2>Today - <span id="todayDate"></span></h2>
                        <div class="today-stats">
                            <span class="stat-badge">
                                <span class="stat-value" id="todayJobCount">0</span>
                                <span class="stat-label">Jobs</span>
                            </span>
                            <span class="stat-badge">
                                <span class="stat-value" id="todayTechCount">0</span>
                                <span class="stat-label">Techs</span>
                            </span>
                        </div>
                    </div>
                    <div id="todaySchedule" class="schedule-grid">
                        <!-- Today's jobs will be loaded here -->
                    </div>
                </div>
                
                <!-- Calendar View Tab -->
                <div id="calendarTab" class="fieldops-tab" style="display: none;">
                    <div class="calendar-controls">
                        <button class="btn btn-secondary" onclick="changeMonth(-1)">◀ Previous</button>
                        <h2 id="calendarMonth"></h2>
                        <button class="btn btn-secondary" onclick="changeMonth(1)">Next ▶</button>
                        <div class="calendar-filters">
                            <select id="filterWorkType" onchange="filterCalendar()">
                                <option value="">All Work Types</option>
                                <option value="install">Installation</option>
                                <option value="commission">Commissioning</option>
                                <option value="breakfix">Break/Fix</option>
                                <option value="maintenance">Maintenance</option>
                            </select>
                            <select id="filterProject" onchange="filterCalendar()">
                                <option value="">All Projects</option>
                                <!-- Projects will be loaded here -->
                            </select>
                        </div>
                    </div>
                    <div id="calendarGrid" class="calendar-grid">
                        <!-- Calendar will be rendered here -->
                    </div>
                </div>
                
                <!-- Pending Queue Tab -->
                <div id="pendingTab" class="fieldops-tab" style="display: none;">
                    <div class="pending-header">
                        <h2>Pending Field Work</h2>
                        <p>Work requests awaiting scheduling</p>
                    </div>
                    <div id="pendingList" class="pending-list">
                        <!-- Pending jobs will be loaded here -->
                    </div>
                </div>
                
                <!-- History Tab -->
                <div id="historyTab" class="fieldops-tab" style="display: none;">
                    <div class="history-header">
                        <h2>Completed Field Work</h2>
                        <div class="history-filters">
                            <input type="date" id="historyStartDate" onchange="loadFieldHistory()">
                            <span>to</span>
                            <input type="date" id="historyEndDate" onchange="loadFieldHistory()">
                        </div>
                    </div>
                    <div id="historyList" class="history-list">
                        <!-- History will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Executive Dashboard View -->
            <div id="reportsView" class="content-view">
                <div class="content-header">
                    <h1 class="content-title">Insights</h1>
                    <p class="content-subtitle">Strategic insights and portfolio overview with performance analytics</p>
                    
                    <!-- Executive Filters -->
                    <div class="executive-filters">
                        <div class="filter-group">
                            <label>Time Period:</label>
                            <select id="execTimeFilter" onchange="applyExecutiveFilters()">
                                <option value="current">Current Quarter</option>
                                <option value="ytd">Year to Date</option>
                                <option value="last-quarter">Last Quarter</option>
                                <option value="last-year">Last Year</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Business Line:</label>
                            <select id="execBusinessFilter" onchange="applyExecutiveFilters()">
                                <option value="all">All Business Lines</option>
                                <option value="barrington">Barrington Bank & Trust Company, N.A.</option>
                                <option value="beverly">Beverly Bank & Trust Company, N.A.</option>
                                <option value="crystal-lake">Crystal Lake Bank & Trust Company, N.A.</option>
                                <option value="hinsdale">Hinsdale Bank & Trust Company, N.A.</option>
                                <option value="lake-forest">Lake Forest Bank & Trust Company, N.A.</option>
                                <option value="libertyville">Libertyville Bank & Trust Company, N.A.</option>
                                <option value="northbrook">Northbrook Bank & Trust Company, N.A.</option>
                                <option value="old-plank">Old Plank Trail Community Bank, N.A.</option>
                                <option value="st-charles">St. Charles Bank & Trust Company, N.A.</option>
                                <option value="schaumburg">Schaumburg Bank & Trust Company, N.A.</option>
                                <option value="state-lakes">State Bank of the Lakes, N.A.</option>
                                <option value="town-bank">Town Bank, N.A.</option>
                                <option value="village">Village Bank & Trust, N.A.</option>
                                <option value="wheaton">Wheaton Bank & Trust Company, N.A.</option>
                                <option value="company">[Company Name]</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Project Size:</label>
                            <select id="execSizeFilter" onchange="applyExecutiveFilters()">
                                <option value="all">All Sizes</option>
                                <option value="large">Large ($100K+)</option>
                                <option value="medium">Medium ($25K-$100K)</option>
                                <option value="small">Small (<$25K)</option>
                            </select>
                        </div>
                        <button class="btn btn-outline" onclick="resetExecutiveFilters()">
                            🔄 Reset Filters
                        </button>
                    </div>
                </div>


                <!-- Dynamic Report Content -->
                <div id="reportContent">
                    <!-- Report content will be loaded here based on sidebar selection -->
                </div>
            </div>

            <!-- Administration View -->
            <div id="adminView" class="content-view">
                <div class="content-header">
                    <h1 class="content-title">System Administration</h1>
                    <p class="content-subtitle">Manage users, roles, and system settings</p>
                    <div class="content-actions">
                        <button class="btn btn-primary" onclick="showCreateUser()">
                            👤 Add User
                        </button>
                        <button class="btn btn-secondary" onclick="showCreateRole()">
                            🔐 Create Role
                        </button>
                    </div>
                </div>

                <div id="adminContent">
                    <!-- Admin sub-navigation -->
                    <div class="admin-tabs">
                        <button class="tab-btn active" onclick="showAdminTab('users')" id="adminTabUsers">
                            👥 Users
                        </button>
                        <button class="tab-btn" onclick="showAdminTab('roles')" id="adminTabRoles">
                            🔐 Roles & Permissions
                        </button>
                        <button class="tab-btn" onclick="showAdminTab('settings')" id="adminTabSettings">
                            ⚙️ System Settings
                        </button>
                        <button class="tab-btn" onclick="showAdminTab('audit')" id="adminTabAudit">
                            📋 Audit Log
                        </button>
                    </div>

                    <!-- Users Management -->
                    <div id="adminUsersContent" class="admin-tab-content active">
                        <div class="admin-section">
                            <div class="section-header">
                                <h3>User Management</h3>
                                <div class="section-actions">
                                    <input type="text" placeholder="Search users..." class="search-input" id="userSearchInput" name="userSearch" aria-label="Search users" autocomplete="off" oninput="filterUsers()">
                                    <select class="filter-select" id="userRoleFilter" onchange="filterUsers()">
                                        <option value="">All Roles</option>
                                        <option value="admin">Administrator</option>
                                        <option value="manager">Project Manager</option>
                                        <option value="technician">Technician</option>
                                        <option value="viewer">Viewer</option>
                                    </select>
                                </div>
                            </div>

                            <div class="users-table-container">
                                <table class="data-table" id="usersTable">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Email</th>
                                            <th>Role</th>
                                            <th>Status</th>
                                            <th>Last Login</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableBody">
                                        <!-- User rows will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Roles Management -->
                    <div id="adminRolesContent" class="admin-tab-content">
                        <div class="admin-section">
                            <div class="section-header">
                                <h3>Roles & Permissions</h3>
                                <button class="btn btn-primary" onclick="showCreateRole()">
                                    ➕ Create Role
                                </button>
                            </div>

                            <div class="roles-grid" id="rolesGrid">
                                <!-- Role cards will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- System Settings -->
                    <div id="adminSettingsContent" class="admin-tab-content">
                        <div class="admin-section">
                            <div class="section-header">
                                <h3>System Settings</h3>
                                <div id="restartNotice" style="display:none; margin-top:8px; padding:8px; background:#fff3cd; border:1px solid #ffeeba; color:#856404; border-radius:6px; font-size:0.95em;">
                                    Database settings saved. Please restart the backend server to apply.
                                </div>
                            </div>

                            <div class="settings-form">
                                <div class="form-group">
                                    <label for="companyName">Company Name</label>
                                    <input type="text" class="form-control" id="companyName" name="companyName" value="[Company Name] - Unified Communications" autocomplete="organization">
                                </div>

                                <div class="form-group">
                                    <label>Default Project Status</label>
                                    <select class="form-control" id="defaultProjectStatus">
                                        <option value="not-started">Not Started</option>
                                        <option value="planning">Planning</option>
                                        <option value="active" selected>Active</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="sessionTimeout">Session Timeout (minutes)</label>
                                    <input type="number" class="form-control" id="sessionTimeout" name="sessionTimeout" value="60" inputmode="numeric">
                                </div>

                                <div class="form-group">
                                    <label>Email Notifications</label>
                                    <div class="checkbox-group">
                                        <label><input type="checkbox" name="notifProjectStatus" checked> Project status changes</label>
                                        <label><input type="checkbox" name="notifTaskAssignments" checked> Task assignments</label>
                                        <label><input type="checkbox" name="notifDailySummaries"> Daily summaries</label>
                                        <label><input type="checkbox" name="notifWeeklyReports"> Weekly reports</label>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Database Settings</label>
                                    <div class="form-grid">
                                        <div>
                                            <label>Type</label>
                                            <select class="form-control" id="dbDialect">
                                                <option value="mariadb">MariaDB/MySQL</option>
                                                <option value="mssql">SQL Server</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label>Host</label>
                                            <input class="form-control" id="dbHost" placeholder="127.0.0.1">
                                        </div>
                                        <div>
                                            <label>Port</label>
                                            <input class="form-control" id="dbPort" inputmode="numeric" placeholder="3306">
                                        </div>
                                        <div>
                                            <label>Database</label>
                                            <input class="form-control" id="dbName" placeholder="apex">
                                        </div>
                                        <div>
                                            <label>Username</label>
                                            <input class="form-control" id="dbUser" placeholder="apex_app">
                                        </div>
                                        <div>
                                            <label>Password</label>
                                            <input type="password" class="form-control" id="dbPassword" placeholder="••••••••">
                                        </div>
                                    </div>
                                    <div class="form-actions" style="margin-top:8px">
                                        <button class="btn btn-secondary" onclick="testDbConnection()">🔌 Test Connection</button>
                                        <button class="btn btn-primary" onclick="saveDbSettings()">💾 Save DB Config</button>
                                        <small id="dbConfigMessage" style="margin-left:8px;color:var(--muted-600)"></small>
                                    </div>
                                    <div style="font-size:12px;color:var(--muted-600);margin-top:6px">Changes to database settings require restarting the backend to take effect.</div>
                                </div>

                                    <div class="form-group">
                                        <label>Create MariaDB App User (optional)</label>
                                        <div class="form-grid">
                                            <div>
                                                <label>Root User</label>
                                                <input class="form-control" id="rootDbUser" placeholder="root">
                                            </div>
                                            <div>
                                                <label>Root Password</label>
                                                <input type="password" class="form-control" id="rootDbPassword" placeholder="••••••••">
                                            </div>
                                            <div>
                                                <label>New Username</label>
                                                <input class="form-control" id="newDbUser" placeholder="apex_app">
                                            </div>
                                            <div>
                                                <label>New Password</label>
                                                <input type="password" class="form-control" id="newDbPassword" placeholder="auto-generate or enter">
                                            </div>
                                        </div>
                                        <div class="form-actions" style="margin-top:8px">
                                            <button class="btn btn-secondary" onclick="createMariaDbUser()">👤 Create MariaDB User</button>
                                            <small id="dbUserMessage" style="margin-left:8px;color:var(--muted-600)"></small>
                                        </div>
                                        <div style="font-size:12px;color:var(--muted-600);margin-top:6px">Creates a limited user on the MariaDB server with access to the selected database.</div>
                                    </div>

                                <!-- Financial Report Settings -->
                                <div class="form-group" id="financialSettingsGroup" style="display: none;">
                                    <label>Financial Report Settings</label>
                                    <div class="settings-description">
                                        Configure budget categories and thresholds for financial reports. Only Project Managers and above can access these settings.
                                    </div>
                                    
                                    <div class="financial-settings-grid">
                                        <div class="financial-setting-card">
                                            <h4>Breakfix Budget</h4>
                                            <div class="form-group">
                                                <label>Annual Breakfix Budget ($)</label>
                                                <input type="number" class="form-control" id="breakfixBudget" placeholder="1000000" value="1000000" min="0" step="1000">
                                                <small class="form-text">Total annual budget allocated for breakfix projects</small>
                                            </div>
                                            <div class="form-group">
                                                <label>Warning Threshold (%)</label>
                                                <input type="number" class="form-control" id="breakfixWarningThreshold" placeholder="80" value="80" min="0" max="100">
                                                <small class="form-text">Show warning when spending reaches this percentage</small>
                                            </div>
                                        </div>

                                        <div class="financial-setting-card">
                                            <h4>Refresh Budget</h4>
                                            <div class="form-group">
                                                <label>Annual Refresh Budget ($)</label>
                                                <input type="number" class="form-control" id="refreshBudget" placeholder="2000000" value="2000000" min="0" step="1000">
                                                <small class="form-text">Total annual budget allocated for refresh projects</small>
                                            </div>
                                            <div class="form-group">
                                                <label>Warning Threshold (%)</label>
                                                <input type="number" class="form-control" id="refreshWarningThreshold" placeholder="80" value="80" min="0" max="100">
                                                <small class="form-text">Show warning when spending reaches this percentage</small>
                                            </div>
                                        </div>

                                        <div class="financial-setting-card">
                                            <h4>General Settings</h4>
                                            <div class="form-group">
                                                <label>Budget Reporting Period</label>
                                                <select class="form-control" id="budgetReportingPeriod">
                                                    <option value="monthly">Monthly</option>
                                                    <option value="quarterly" selected>Quarterly</option>
                                                    <option value="annual">Annual</option>
                                                </select>
                                                <small class="form-text">How often to reset budget tracking periods</small>
                                            </div>
                                            <div class="form-group">
                                                <label>Currency Display</label>
                                                <select class="form-control" id="currencyFormat">
                                                    <option value="USD" selected>USD ($)</option>
                                                    <option value="EUR">EUR (€)</option>
                                                    <option value="GBP">GBP (£)</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-actions" style="margin-top: 1rem;">
                                        <button class="btn btn-primary" onclick="saveFinancialSettings()">
                                            💰 Save Financial Settings
                                        </button>
                                        <button class="btn btn-secondary" onclick="resetFinancialSettings()">
                                            🔄 Reset to Defaults
                                        </button>
                                    </div>
                                </div>

                                <div class="form-actions">
                                    <button class="btn btn-primary" onclick="saveSystemSettings()">
                                        💾 Save Settings
                                    </button>
                                    <button class="btn btn-secondary" onclick="resetSystemSettings()">
                                        🔄 Reset to Defaults
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Audit Log -->
                    <div id="adminAuditContent" class="admin-tab-content">
                        <div class="admin-section">
                            <div class="section-header">
                                <h3>Audit Log</h3>
                                <div class="section-actions">
                                    <input type="date" class="form-control" id="auditFromDate">
                                    <input type="date" class="form-control" id="auditToDate">
                                    <select class="filter-select" id="auditActionFilter">
                                        <option value="">All Actions</option>
                                        <option value="login">Login/Logout</option>
                                        <option value="project">Project Changes</option>
                                        <option value="task">Task Changes</option>
                                        <option value="user">User Management</option>
                                        <option value="system">System Changes</option>
                                    </select>
                                    <button class="btn btn-secondary" onclick="filterAuditLog()">Filter</button>
                                    <button class="btn btn-secondary" id="auditCompactToggle" onclick="toggleAuditCompact()">Compact View</button>
                                </div>
                            </div>

                            <div class="audit-table-container">
                                <table class="data-table" id="auditTable">
                                    <thead>
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>User</th>
                                            <th>Action</th>
                                            <th>Entity</th>
                                            <th>Details</th>
                                            <th>Changes</th>
                                            <th>Source</th>
                                        </tr>
                                    </thead>
                                    <tbody id="auditTableBody">
                                        <!-- Audit entries will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ==================== APPLICATION STATE ====================
        // Phase Definitions for AV Projects
        const projectPhases = [
            {
                id: 'phase_1',
                name: 'Pre-installation - Logistics',
                order: 1,
                defaultTasks: [
                    'Kick Off Call',
                    'Create project folder in Egnyte',
                    'Project information gathered',
                    'Review Project Requirements and Submit Writeup to Stakeholder/s',
                    'Create Business Case and submit to Stakeholder/s',
                    'Contact AV Vendor for Quote',
                    'Revise/Review Vendor Quote',
                    'Create SNOW ticket request for PO',
                    'Verify PO Receipt',
                    'Verify Hardware Shipment',
                    'Request Hardware Serials and MACs',
                    'Verify Install Dates',
                    'Verify Infrastructure Requirements Prior to Install',
                    'Verify CRE Furniture Customization',
                    'Verify Installations dates with Vendors, Stakeholders and Local On-site Contacts'
                ]
            },
            {
                id: 'phase_2',
                name: 'Pre-Installation - AV Setup',
                order: 2,
                defaultTasks: [
                    'Verify space names with Stakeholder/s',
                    'SNOW Request to Create Room in AD/Entra with Calendar',
                    'Verify Calendar Ownership with Stakeholder/s',
                    'Verify Site has AV VLAN',
                    'Create IP address request in SNOW',
                    'Request to put MAC/s on VLAN',
                    'Create SNOW Request to assign IP/s to Firewall Policy Group (ISE)',
                    'If Teams Room, Create SNOW request to PAM for MTR Account and Correct OU'
                ]
            },
            {
                id: 'phase_3',
                name: 'Post-Installation Commissioning',
                order: 3,
                defaultTasks: [
                    'Vendor Delivery and Install',
                    'Vendor Commissioning',
                    'Testing and Verification',
                    'Verify Vendor Labeling',
                    'Remind Vendor to Leave Documentation',
                    'Install Signoff',
                    'Testing and Verification',
                    'Install Monitoring tools',
                    'Update NOC with New Devices to be Monitored',
                    'AV Dept Sign Off',
                    'Create Room Instructions',
                    'Label Room Systems, Cabling and Furniture',
                    'Schedule Training with Stakeholder/s',
                    'Provide Training',
                    'AV Dept Install Sign off'
                ]
            },
            {
                id: 'phase_4',
                name: 'Post-Installation - Logistics',
                order: 4,
                defaultTasks: [
                    'Review and Approve Invoices for Payment',
                    'Enter Installed Equipment into Inventory',
                    'Ensure all Documentation is saved in the AV Project Folder in Egnyte',
                    'Update Conference Room Info on SharePoint',
                    'Add Space to Health Website'
                ]
            }
        ];

        const AppState = {
            isLoggedIn: false,
            user: null,
            currentView: 'login',
            data: {
                projects: [],
                metrics: {},
                charts: {}
            },
            breakfixBudget: {
                totalBudget: 50000, // Default $50,000 breakfix budget
                spentAmount: 0,
                remainingBudget: 50000,
                lastUpdated: new Date().toISOString()
            },
            refreshBudget: {
                totalBudget: 100000, // Default $100,000 refresh budget
                spentAmount: 0,
                remainingBudget: 100000,
                lastUpdated: new Date().toISOString()
            },
            config: {
                // Set USE_BACKEND to true if you have a backend server running
                USE_BACKEND: true,  // Backend server is now running via nginx proxy
                apiUrl: '/api',  // API URL through nginx reverse proxy
                refreshInterval: 30000, // 30 seconds
                backendEnabled: false,
                masterAccounts: ['admin@apex.local']
            },
            users: [
                { id: 1, name: 'John Smith', email: 'admin@company.com', password: 'admin123', role: 'Admin', avatar: 'JS' },
                { id: 2, name: 'Sarah Johnson', email: 'pm@company.com', password: 'pm123', role: 'Project-Manager', avatar: 'SJ' },
                { id: 3, name: 'Mike Davis', email: 'lead@company.com', password: 'lead123', role: 'Team-Lead', avatar: 'MD' },
                { id: 4, name: 'Lisa Chen', email: 'tech@company.com', password: 'tech123', role: 'Technician', avatar: 'LC' },
                { id: 5, name: 'Tom Wilson', email: 'client@company.com', password: 'client123', role: 'Client', avatar: 'TW' }
            ],
            projects: [
                {
                    id: 'proj_2023_001',
                    name: 'Corporate Headquarters AV Upgrade',
                    requestorInfo: 'David Thompson, CTO, TechCorp Solutions, david.thompson@techcorp.com',
                    siteLocation: '1200 Technology Drive, Austin, TX 78759',
                    businessLine: 'corporate',
                    description: 'Complete audiovisual system upgrade for corporate boardrooms and training facilities. Includes 12 conference rooms, main auditorium (200 seats), and 3 training rooms. Integration of video conferencing, wireless presentation, digital signage, and centralized control systems.',
                    type: 'upgrade',
                    priority: 'high',
                    requestDate: '2023-02-15',
                    startDate: '2023-03-01',
                    dueDate: '2023-05-30',
                    endDate: '2023-05-28',
                    estimatedBudget: 485000,
                    actualBudget: 467500,
                    status: 'completed',
                    progress: 100,
                    createdAt: '2023-02-15T10:30:00.000Z',
                    updatedAt: '2023-05-28T16:45:00.000Z',
                    tasks: [
                        {
                            id: 'task_2023_001_01',
                            name: 'Site Survey and Requirements Analysis',
                            description: 'Conduct comprehensive site survey, document existing infrastructure, and finalize technical requirements with stakeholders.',
                            status: 'completed',
                            ragStatus: 'green',
                            phase: 'phase_1',
                            priority: 'critical',
                            assignee: 'Mike Davis',
                            estimatedHours: 40,
                            startDate: '2023-03-01',
                            endDate: '2023-03-10',
                            notes: 'Site survey completed successfully. All technical requirements documented and approved by client. Ready for next phase.',
                            completedDate: '2023-03-10',
                            createdAt: '2023-02-20T09:00:00.000Z',
                            updatedAt: '2023-03-10T17:30:00.000Z'
                        },
                        {
                            id: 'task_2023_001_02',
                            name: 'Equipment Procurement and Staging',
                            description: 'Order all AV equipment, verify compatibility, and stage equipment for installation. Includes projectors, displays, audio systems, control processors, and cabling.',
                            status: 'completed',
                            priority: 'high',
                            assignee: 'Lisa Chen',
                            estimatedHours: 32,
                            startDate: '2023-03-05',
                            endDate: '2023-03-25',
                            createdAt: '2023-02-20T09:15:00.000Z',
                            updatedAt: '2023-03-25T14:20:00.000Z'
                        },
                        {
                            id: 'task_2023_001_03',
                            name: 'Infrastructure Installation',
                            description: 'Install cable pathways, power distribution, network infrastructure, and mounting systems. Coordinate with building facilities team.',
                            status: 'completed',
                            priority: 'high',
                            assignee: 'Mike Davis',
                            estimatedHours: 120,
                            startDate: '2023-03-15',
                            endDate: '2023-04-20',
                            createdAt: '2023-02-20T09:30:00.000Z',
                            updatedAt: '2023-04-20T18:00:00.000Z'
                        },
                        {
                            id: 'task_2023_001_04',
                            name: 'AV Equipment Installation and Integration',
                            description: 'Install and integrate all audiovisual equipment including displays, projectors, sound systems, control systems, and video conferencing solutions.',
                            status: 'completed',
                            priority: 'critical',
                            assignee: 'Lisa Chen',
                            estimatedHours: 160,
                            startDate: '2023-04-10',
                            endDate: '2023-05-15',
                            createdAt: '2023-02-20T09:45:00.000Z',
                            updatedAt: '2023-05-15T19:30:00.000Z'
                        },
                        {
                            id: 'task_2023_001_05',
                            name: 'System Programming and Configuration',
                            description: 'Program control systems, configure video conferencing, set up wireless presentation systems, and integrate with corporate network.',
                            status: 'completed',
                            priority: 'critical',
                            assignee: 'Mike Davis',
                            estimatedHours: 80,
                            startDate: '2023-05-01',
                            endDate: '2023-05-20',
                            createdAt: '2023-02-20T10:00:00.000Z',
                            updatedAt: '2023-05-20T16:15:00.000Z'
                        },
                        {
                            id: 'task_2023_001_06',
                            name: 'Testing and Commissioning',
                            description: 'Comprehensive system testing, performance verification, integration testing, and final commissioning with client acceptance.',
                            status: 'completed',
                            priority: 'high',
                            assignee: 'Sarah Johnson',
                            estimatedHours: 48,
                            startDate: '2023-05-18',
                            endDate: '2023-05-26',
                            createdAt: '2023-02-20T10:15:00.000Z',
                            updatedAt: '2023-05-26T15:45:00.000Z'
                        },
                        {
                            id: 'task_2023_001_07',
                            name: 'User Training and Documentation',
                            description: 'Conduct user training sessions, create operation manuals, and provide technical documentation for IT staff.',
                            status: 'completed',
                            priority: 'medium',
                            assignee: 'Sarah Johnson',
                            estimatedHours: 24,
                            startDate: '2023-05-22',
                            endDate: '2023-05-28',
                            createdAt: '2023-02-20T10:30:00.000Z',
                            updatedAt: '2023-05-28T16:45:00.000Z'
                        }
                    ]
                },
                {
                    id: 'proj_2023_002',
                    name: 'University Lecture Hall Digital Transformation',
                    requestorInfo: 'Dr. Maria Rodriguez, Director of IT, State University, maria.rodriguez@stateuniv.edu',
                    siteLocation: '3400 University Boulevard, San Diego, CA 92182',
                    businessLine: 'education',
                    description: 'Modernization of 8 large lecture halls (150-300 seats each) with state-of-the-art presentation systems, lecture capture, interactive displays, and accessibility features. Integration with learning management system.',
                    type: 'new-build',
                    priority: 'high',
                    requestDate: '2023-05-10',
                    startDate: '2023-06-15',
                    dueDate: '2023-08-25',
                    endDate: '2023-08-23',
                    estimatedBudget: 320000,
                    actualBudget: 315800,
                    status: 'completed',
                    progress: 100,
                    createdAt: '2023-05-10T14:20:00.000Z',
                    updatedAt: '2023-08-23T17:30:00.000Z',
                    tasks: [
                        {
                            id: 'task_2023_002_01',
                            name: 'Academic Requirements Assessment',
                            description: 'Meet with faculty and IT staff to understand teaching requirements, accessibility needs, and integration with existing systems.',
                            status: 'completed',
                            priority: 'critical',
                            assignee: 'Sarah Johnson',
                            estimatedHours: 32,
                            startDate: '2023-06-15',
                            endDate: '2023-06-25',
                            createdAt: '2023-05-15T11:00:00.000Z',
                            updatedAt: '2023-06-25T16:30:00.000Z'
                        },
                        {
                            id: 'task_2023_002_02',
                            name: 'Lecture Capture System Design',
                            description: 'Design automated lecture capture system with multi-camera setup, audio processing, and integration with university LMS.',
                            status: 'completed',
                            priority: 'high',
                            assignee: 'Mike Davis',
                            estimatedHours: 48,
                            startDate: '2023-06-20',
                            endDate: '2023-07-05',
                            createdAt: '2023-05-15T11:15:00.000Z',
                            updatedAt: '2023-07-05T18:45:00.000Z'
                        },
                        {
                            id: 'task_2023_002_03',
                            name: 'Interactive Display Installation',
                            description: 'Install 86" interactive touchscreen displays in each lecture hall with wall mounting and cable management.',
                            status: 'completed',
                            priority: 'high',
                            assignee: 'Lisa Chen',
                            estimatedHours: 64,
                            startDate: '2023-07-01',
                            endDate: '2023-07-20',
                            createdAt: '2023-05-15T11:30:00.000Z',
                            updatedAt: '2023-07-20T17:15:00.000Z'
                        },
                        {
                            id: 'task_2023_002_04',
                            name: 'Audio System Enhancement',
                            description: 'Upgrade audio systems with wireless microphone systems, hearing loop integration, and acoustic optimization.',
                            status: 'completed',
                            priority: 'medium',
                            assignee: 'Mike Davis',
                            estimatedHours: 56,
                            startDate: '2023-07-10',
                            endDate: '2023-08-02',
                            createdAt: '2023-05-15T11:45:00.000Z',
                            updatedAt: '2023-08-02T16:00:00.000Z'
                        },
                        {
                            id: 'task_2023_002_05',
                            name: 'System Integration and Testing',
                            description: 'Integrate all systems, configure lecture capture workflows, and conduct comprehensive testing with faculty.',
                            status: 'completed',
                            priority: 'critical',
                            assignee: 'Sarah Johnson',
                            estimatedHours: 40,
                            startDate: '2023-08-05',
                            endDate: '2023-08-20',
                            createdAt: '2023-05-15T12:00:00.000Z',
                            updatedAt: '2023-08-20T19:30:00.000Z'
                        },
                        {
                            id: 'task_2023_002_06',
                            name: 'Faculty Training Program',
                            description: 'Develop and deliver comprehensive training program for faculty on new systems and lecture capture workflows.',
                            status: 'completed',
                            priority: 'high',
                            assignee: 'Sarah Johnson',
                            estimatedHours: 32,
                            startDate: '2023-08-15',
                            endDate: '2023-08-23',
                            createdAt: '2023-05-15T12:15:00.000Z',
                            updatedAt: '2023-08-23T17:30:00.000Z'
                        }
                    ]
                },
                {
                    id: 'proj_2024_003',
                    name: 'Hospital Emergency Department Communication System',
                    requestorInfo: 'Dr. James Mitchell, Chief Medical Officer, Regional Medical Center, j.mitchell@regionalmed.org',
                    siteLocation: '2500 Health Sciences Drive, Phoenix, AZ 85006',
                    businessLine: 'healthcare',
                    description: 'Critical communication system for emergency department including nurse call integration, patient monitoring displays, staff communication systems, and emergency broadcast capabilities. HIPAA compliant implementation.',
                    type: 'new-build',
                    priority: 'critical',
                    requestDate: '2023-11-20',
                    startDate: '2024-01-08',
                    dueDate: '2024-03-15',
                    endDate: '2024-03-12',
                    estimatedBudget: 275000,
                    actualBudget: 282400,
                    status: 'completed',
                    progress: 100,
                    createdAt: '2023-11-20T08:15:00.000Z',
                    updatedAt: '2024-03-12T20:45:00.000Z',
                    tasks: [
                        {
                            id: 'task_2024_003_01',
                            name: 'HIPAA Compliance Assessment',
                            description: 'Review HIPAA requirements, security protocols, and compliance standards for healthcare AV installations.',
                            status: 'completed',
                            priority: 'critical',
                            assignee: 'Sarah Johnson',
                            estimatedHours: 24,
                            startDate: '2024-01-08',
                            endDate: '2024-01-15',
                            createdAt: '2023-11-25T10:00:00.000Z',
                            updatedAt: '2024-01-15T17:00:00.000Z'
                        },
                        {
                            id: 'task_2024_003_02',
                            name: 'Nurse Call System Integration',
                            description: 'Design integration between existing nurse call system and new communication displays for patient status updates.',
                            status: 'completed',
                            priority: 'critical',
                            assignee: 'Mike Davis',
                            estimatedHours: 48,
                            startDate: '2024-01-12',
                            endDate: '2024-02-05',
                            createdAt: '2023-11-25T10:15:00.000Z',
                            updatedAt: '2024-02-05T18:30:00.000Z'
                        },
                        {
                            id: 'task_2024_003_03',
                            name: 'Emergency Communication System',
                            description: 'Install emergency broadcast system with zone-based messaging, automated alerts, and backup power systems.',
                            status: 'completed',
                            priority: 'critical',
                            assignee: 'Lisa Chen',
                            estimatedHours: 72,
                            startDate: '2024-01-20',
                            endDate: '2024-02-25',
                            createdAt: '2023-11-25T10:30:00.000Z',
                            updatedAt: '2024-02-25T19:15:00.000Z'
                        },
                        {
                            id: 'task_2024_003_04',
                            name: 'Patient Information Displays',
                            description: 'Install and configure patient information displays with privacy filters and secure content management.',
                            status: 'completed',
                            priority: 'high',
                            assignee: 'Lisa Chen',
                            estimatedHours: 40,
                            startDate: '2024-02-10',
                            endDate: '2024-03-01',
                            createdAt: '2023-11-25T10:45:00.000Z',
                            updatedAt: '2024-03-01T16:45:00.000Z'
                        },
                        {
                            id: 'task_2024_003_05',
                            name: 'System Security and Testing',
                            description: 'Implement security protocols, conduct penetration testing, and verify HIPAA compliance for all systems.',
                            status: 'completed',
                            priority: 'critical',
                            assignee: 'Sarah Johnson',
                            estimatedHours: 56,
                            startDate: '2024-02-20',
                            endDate: '2024-03-10',
                            createdAt: '2023-11-25T11:00:00.000Z',
                            updatedAt: '2024-03-10T20:30:00.000Z'
                        },
                        {
                            id: 'task_2024_003_06',
                            name: 'Staff Training and Go-Live Support',
                            description: 'Train medical and IT staff on new systems, provide 24/7 go-live support, and establish ongoing support procedures.',
                            status: 'completed',
                            priority: 'high',
                            assignee: 'Sarah Johnson',
                            estimatedHours: 32,
                            startDate: '2024-03-05',
                            endDate: '2024-03-12',
                            createdAt: '2023-11-25T11:15:00.000Z',
                            updatedAt: '2024-03-12T20:45:00.000Z'
                        }
                    ]
                },
                {
                    id: 'proj_2024_004',
                    name: 'Luxury Resort Entertainment Complex',
                    requestorInfo: 'Amanda Foster, Operations Director, Oceanview Resort & Spa, a.foster@oceanviewresort.com',
                    siteLocation: '1 Paradise Bay Drive, Key Largo, FL 33037',
                    businessLine: 'hospitality',
                    description: 'Complete entertainment complex featuring main theater (400 seats), poolside projection systems, restaurant audio zones, lobby digital signage network, and outdoor event spaces with weather-resistant AV systems.',
                    type: 'new-build',
                    priority: 'medium',
                    requestDate: '2024-01-15',
                    startDate: '2024-02-20',
                    dueDate: '2024-06-30',
                    endDate: '2024-06-28',
                    estimatedBudget: 650000,
                    actualBudget: 638200,
                    status: 'completed',
                    progress: 100,
                    createdAt: '2024-01-15T13:30:00.000Z',
                    updatedAt: '2024-06-28T22:15:00.000Z',
                    tasks: [
                        {
                            id: 'task_2024_004_01',
                            name: 'Resort Environment Assessment',
                            description: 'Assess challenging installation environment including salt air, humidity, temperature variations, and aesthetic requirements.',
                            status: 'completed',
                            priority: 'high',
                            assignee: 'Mike Davis',
                            estimatedHours: 40,
                            startDate: '2024-02-20',
                            endDate: '2024-03-05',
                            createdAt: '2024-01-20T14:00:00.000Z',
                            updatedAt: '2024-03-05T17:45:00.000Z'
                        },
                        {
                            id: 'task_2024_004_02',
                            name: 'Main Theater Design and Installation',
                            description: 'Design and install complete theater system including projection, surround sound, stage lighting, and control systems.',
                            status: 'completed',
                            priority: 'critical',
                            assignee: 'Lisa Chen',
                            estimatedHours: 120,
                            startDate: '2024-03-01',
                            endDate: '2024-04-30',
                            createdAt: '2024-01-20T14:15:00.000Z',
                            updatedAt: '2024-04-30T19:30:00.000Z'
                        },
                        {
                            id: 'task_2024_004_03',
                            name: 'Outdoor Weather-Resistant Systems',
                            description: 'Install outdoor projection and audio systems with IP65 rated enclosures and environmental protection.',
                            status: 'completed',
                            priority: 'high',
                            assignee: 'Mike Davis',
                            estimatedHours: 88,
                            startDate: '2024-03-15',
                            endDate: '2024-05-15',
                            createdAt: '2024-01-20T14:30:00.000Z',
                            updatedAt: '2024-05-15T18:20:00.000Z'
                        },
                        {
                            id: 'task_2024_004_04',
                            name: 'Restaurant and Bar Audio Zones',
                            description: 'Design and install multi-zone audio system for restaurants, bars, and common areas with individual volume control.',
                            status: 'completed',
                            priority: 'medium',
                            assignee: 'Lisa Chen',
                            estimatedHours: 64,
                            startDate: '2024-04-01',
                            endDate: '2024-05-20',
                            createdAt: '2024-01-20T14:45:00.000Z',
                            updatedAt: '2024-05-20T16:30:00.000Z'
                        },
                        {
                            id: 'task_2024_004_05',
                            name: 'Digital Signage Network',
                            description: 'Install and configure resort-wide digital signage network with content management system for events and promotions.',
                            status: 'completed',
                            priority: 'medium',
                            assignee: 'Sarah Johnson',
                            estimatedHours: 56,
                            startDate: '2024-04-15',
                            endDate: '2024-06-05',
                            createdAt: '2024-01-20T15:00:00.000Z',
                            updatedAt: '2024-06-05T17:45:00.000Z'
                        },
                        {
                            id: 'task_2024_004_06',
                            name: 'System Integration and Programming',
                            description: 'Integrate all systems with central control, program user interfaces, and establish maintenance protocols.',
                            status: 'completed',
                            priority: 'critical',
                            assignee: 'Mike Davis',
                            estimatedHours: 72,
                            startDate: '2024-05-20',
                            endDate: '2024-06-20',
                            createdAt: '2024-01-20T15:15:00.000Z',
                            updatedAt: '2024-06-20T20:15:00.000Z'
                        },
                        {
                            id: 'task_2024_004_07',
                            name: 'Staff Training and Event Testing',
                            description: 'Train resort staff on all systems, conduct live event testing, and provide ongoing support documentation.',
                            status: 'completed',
                            priority: 'high',
                            assignee: 'Sarah Johnson',
                            estimatedHours: 40,
                            startDate: '2024-06-15',
                            endDate: '2024-06-28',
                            createdAt: '2024-01-20T15:30:00.000Z',
                            updatedAt: '2024-06-28T22:15:00.000Z'
                        }
                    ]
                }
            ]
        };

        // ==================== NAVIGATION MANAGEMENT ====================
        function showView(viewName) {
            // Guard admin view
            if (viewName === 'admin' && !isAdmin()) {
                showNotification('Administration is restricted to Administrators', 'error');
                return;
            }

            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const navBtn = document.getElementById(`nav${viewName.charAt(0).toUpperCase() + viewName.slice(1)}`);
            if (navBtn) navBtn.classList.add('active');

            // Update content views
            document.querySelectorAll('.content-view').forEach(view => {
                view.classList.remove('active');
            });
            // Handle insights using reportsView
            const actualViewName = viewName === 'insights' ? 'reports' : viewName;
            const viewEl = document.getElementById(`${actualViewName}View`);
            if (viewEl) viewEl.classList.add('active');

            // Breadcrumb removed - no longer needed

            // Update sidebar
            updateSidebar(viewName);

            // Load view content
            loadViewContent(viewName);

            AppState.currentView = viewName;
        }

        // Breadcrumb function removed - breadcrumbs no longer used

        function updateSidebar(viewName) {
            const sidebarConfigs = {
                dashboard: {
                    title: 'Dashboard',
                    subtitle: 'Project overview and metrics',
                    nav: `
                        <div class="nav-section">
                            <div class="nav-section-title">Overview</div>
                            <button class="nav-item active" onclick="showDashboardTab('overview')">
                                <span class="nav-item-icon">📊</span>
                                <span class="nav-item-text">Key Metrics</span>
                            </button>
                            <button class="nav-item" onclick="showDashboardTab('trends')">
                                <span class="nav-item-icon">📈</span>
                                <span class="nav-item-text">Trends</span>
                            </button>
                            <button class="nav-item" onclick="showDashboardTab('alerts')">
                                <span class="nav-item-icon">🚨</span>
                                <span class="nav-item-text">Alerts</span>
                                <span class="nav-item-badge">3</span>
                            </button>
                        </div>
                        <div class="nav-section">
                            <div class="nav-section-title">Quick Actions</div>
                            <button class="nav-item" onclick="showCreateProject()">
                                <span class="nav-item-icon">➕</span>
                                <span class="nav-item-text">New Project</span>
                            </button>
                            <button class="nav-item" onclick="exportDashboard()">
                                <span class="nav-item-icon">📊</span>
                                <span class="nav-item-text">Export Report</span>
                            </button>
                        </div>
                    `
                },
                projects: {
                    title: 'Projects',
                    subtitle: 'Manage all AV projects',
                    nav: `
                        <div class="nav-section">
                            <div class="nav-section-title">Views</div>
                            <button class="nav-item active" onclick="showProjectsTab('list')">
                                <span class="nav-item-icon">📋</span>
                                <span class="nav-item-text">List View</span>
                            </button>
                            <button class="nav-item" onclick="showProjectsTab('calendar')">
                                <span class="nav-item-icon">📅</span>
                                <span class="nav-item-text">Calendar View</span>
                            </button>
                        </div>
                        <div class="nav-section">
                            <div class="nav-section-title">Filters</div>
                            <button class="nav-item" onclick="filterProjects('active')">
                                <span class="nav-item-icon">🟢</span>
                                <span class="nav-item-text">Active</span>
                                <span class="nav-item-badge" id="activeCount">0</span>
                            </button>
                            <button class="nav-item" onclick="filterProjects('completed')">
                                <span class="nav-item-icon">✅</span>
                                <span class="nav-item-text">Completed</span>
                                <span class="nav-item-badge" id="completedCount">0</span>
                            </button>
                            <button class="nav-item" onclick="filterProjects('overdue')">
                                <span class="nav-item-icon">⚠️</span>
                                <span class="nav-item-text">Overdue</span>
                                <span class="nav-item-badge" id="overdueCount">0</span>
                            </button>
                        </div>
                    `
                },
                reports: {
                    title: 'Reports & Analytics',
                    subtitle: 'Comprehensive insights',
                    nav: `
                        <div class="nav-section">
                            <div class="nav-section-title">Report Types</div>
                            <button class="nav-item active" onclick="showReportTab('executive')">
                                <span class="nav-item-icon">👔</span>
                                <span class="nav-item-text">Executive Summary</span>
                            </button>
                            <button class="nav-item" onclick="showReportTab('detailed')">
                                <span class="nav-item-icon">📋</span>
                                <span class="nav-item-text">Detailed Analytics</span>
                            </button>
                            <button class="nav-item" onclick="showReportTab('financial')">
                                <span class="nav-item-icon">💰</span>
                                <span class="nav-item-text">Financial Report</span>
                            </button>
                            <button class="nav-item" onclick="showReportTab('team')">
                                <span class="nav-item-icon">👥</span>
                                <span class="nav-item-text">Team Performance</span>
                            </button>
                        </div>
                    `
                },
                admin: {
                    title: 'Administration',
                    subtitle: 'System management and configuration',
                    nav: `
                        <div class="nav-section">
                            <div class="nav-section-title">User Management</div>
                            <button class="nav-item active" onclick="showAdminTab('users')">
                                <span class="nav-item-icon">👥</span>
                                <span class="nav-item-text">Users</span>
                            </button>
                            <button class="nav-item" onclick="showAdminTab('roles')">
                                <span class="nav-item-icon">🔐</span>
                                <span class="nav-item-text">Roles & Permissions</span>
                            </button>
                        </div>
                        <div class="nav-section">
                            <div class="nav-section-title">System</div>
                            <button class="nav-item" onclick="showAdminTab('settings')">
                                <span class="nav-item-icon">⚙️</span>
                                <span class="nav-item-text">Settings</span>
                            </button>
                            <button class="nav-item" onclick="showAdminTab('audit')">
                                <span class="nav-item-icon">📋</span>
                                <span class="nav-item-text">Audit Log</span>
                            </button>
                        </div>
                        <div class="nav-section">
                            <div class="nav-section-title">Quick Actions</div>
                            <button class="nav-item" onclick="showCreateUser()">
                                <span class="nav-item-icon">➕</span>
                                <span class="nav-item-text">Add User</span>
                            </button>
                            <button class="nav-item" onclick="exportUserData()">
                                <span class="nav-item-icon">📊</span>
                                <span class="nav-item-text">Export Users</span>
                            </button>
                        </div>
                    `
                },
                insights: {
                    title: 'Personal Insights',
                    subtitle: 'Productivity analytics and recommendations',
                    nav: `
                        <div class="nav-section">
                            <div class="nav-section-title">Analytics</div>
                            <button class="nav-item active" onclick="showInsightsTab('overview')">
                                <span class="nav-item-icon">📊</span>
                                <span class="nav-item-text">Overview</span>
                            </button>
                            <button class="nav-item" onclick="showInsightsTab('weekly')">
                                <span class="nav-item-icon">📅</span>
                                <span class="nav-item-text">Weekly Trends</span>
                            </button>
                            <button class="nav-item" onclick="showInsightsTab('career')">
                                <span class="nav-item-icon">🚀</span>
                                <span class="nav-item-text">Career Progress</span>
                            </button>
                        </div>
                        <div class="nav-section">
                            <div class="nav-section-title">Tools</div>
                            <button class="nav-item" onclick="setProductivityGoals()">
                                <span class="nav-item-icon">🎯</span>
                                <span class="nav-item-text">Set Goals</span>
                            </button>
                            <button class="nav-item" onclick="showActiveTimers()">
                                <span class="nav-item-icon">⏱️</span>
                                <span class="nav-item-text">Active Timers</span>
                            </button>
                        </div>
                    `
                },
                fieldops: {
                    title: 'Field Operations',
                    subtitle: 'Onsite work scheduling',
                    nav: `
                        <div class="nav-section">
                            <div class="nav-section-title">Schedule</div>
                            <button class="nav-item active" onclick="showFieldOpsTab('today')">
                                <span class="nav-item-icon">📅</span>
                                <span class="nav-item-text">Today's Schedule</span>
                            </button>
                            <button class="nav-item" onclick="showFieldOpsTab('calendar')">
                                <span class="nav-item-icon">📆</span>
                                <span class="nav-item-text">Calendar View</span>
                            </button>
                            <button class="nav-item" onclick="showFieldOpsTab('pending')">
                                <span class="nav-item-icon">⏳</span>
                                <span class="nav-item-text">Pending Queue</span>
                                <span class="nav-item-badge" id="pendingCount">0</span>
                            </button>
                        </div>
                        <div class="nav-section">
                            <div class="nav-section-title">Actions</div>
                            <button class="nav-item" onclick="showScheduleFieldWork()">
                                <span class="nav-item-icon">➕</span>
                                <span class="nav-item-text">Schedule Work</span>
                            </button>
                            <button class="nav-item" onclick="showFieldOpsTab('history')">
                                <span class="nav-item-icon">📋</span>
                                <span class="nav-item-text">History</span>
                            </button>
                        </div>
                    `
                }
            };

            const config = sidebarConfigs[viewName];
            document.getElementById('sidebarTitle').textContent = config.title;
            document.getElementById('sidebarSubtitle').textContent = config.subtitle;
            document.getElementById('sidebarNav').innerHTML = config.nav;
        }

        // ==================== CONTENT LOADING ====================
        function loadViewContent(viewName) {
            switch (viewName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'projects':
                    loadProjects();
                    break;
                case 'reports':
                    loadExecutiveDashboard();
                    break;
                case 'insights':
                    loadPersonalInsights();
                    break;
                case 'fieldops':
                    loadFieldOps();
                    break;
                case 'admin':
                    loadAdministration();
                    break;
            }
        }

        async function loadDashboard() {
            try {
                // Load dashboard metrics
                await loadDashboardMetrics();
                await loadDashboardCharts();
                await loadRecentProjects();
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        async function loadDashboardMetrics() {
            // Demo data - replace with API call
            const metrics = [
                {
                    icon: '📁',
                    iconClass: 'primary',
                    value: '24',
                    label: 'Total Projects',
                    change: '+3 this month',
                    changeClass: 'positive'
                },
                {
                    icon: '✅',
                    iconClass: 'success',
                    value: '18',
                    label: 'Completed',
                    change: '+2 this week',
                    changeClass: 'positive'
                },
                {
                    icon: '🚧',
                    iconClass: 'warning',
                    value: '4',
                    label: 'In Progress',
                    change: 'On track',
                    changeClass: 'neutral'
                },
                {
                    icon: '⚠️',
                    iconClass: 'danger',
                    value: '2',
                    label: 'At Risk',
                    change: '-1 resolved',
                    changeClass: 'positive'
                },
                {
                    icon: '💰',
                    iconClass: 'success',
                    value: '$2.4M',
                    label: 'Total Value',
                    change: '+12% vs last month',
                    changeClass: 'positive'
                },
                {
                    icon: '👥',
                    iconClass: 'primary',
                    value: '85%',
                    label: 'Team Utilization',
                    change: 'Optimal range',
                    changeClass: 'neutral'
                }
            ];

            const metricsGrid = document.getElementById('metricsGrid');
            metricsGrid.innerHTML = metrics.map(metric => `
                <div class="metric-card fade-in">
                    <div class="metric-header">
                        <div class="metric-icon ${metric.iconClass}">${metric.icon}</div>
                    </div>
                    <div class="metric-value">${metric.value}</div>
                    <div class="metric-label">${metric.label}</div>
                    <div class="metric-change ${metric.changeClass}">${metric.change}</div>
                </div>
            `).join('');
        }

        async function loadDashboardCharts() {
            // Hold chart instances globally to prevent reuse errors
            window.__charts = window.__charts || {};

            // Load status distribution chart
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            if (window.__charts.status) { try { window.__charts.status.destroy(); } catch(_) {} }
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not loaded - charts will not be displayed');
                return;
            }
            window.__charts.status = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Active', 'Completed', 'On Hold', 'Cancelled'],
                    datasets: [{
                        data: [6, 18, 2, 1],
                        backgroundColor: [
                            '#22c55e',
                            '#0ea5e9',
                            '#f59e0b',
                            '#ef4444'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Load progress trends chart
            const progressCtx = document.getElementById('progressChart').getContext('2d');
            if (window.__charts.progress) { try { window.__charts.progress.destroy(); } catch(_) {} }
            window.__charts.progress = new Chart(progressCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Average Progress',
                        data: [45, 52, 61, 68, 73, 78],
                        borderColor: '#0ea5e9',
                        backgroundColor: 'rgba(14, 165, 233, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        async function loadRecentProjects() {
            // Use actual projects from AppState
            const projects = (AppState.projects || []).slice(0, 10); // Show up to 10 recent projects

            const tableBody = document.getElementById('recentProjectsTable');
            if (projects.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                            No projects available. <a href="#" onclick="showView('projects')" style="color: var(--primary-500);">Create your first project</a>
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = projects.map(project => `
                <tr>
                    <td>${escapeHtml(project.name || 'Unnamed Project')}</td>
                    <td>${escapeHtml(project.requestorInfo ? project.requestorInfo.split(',')[0] : 'N/A')}</td>
                    <td>
                        <span class="status-badge ${project.status || 'draft'}">${formatStatus(project.status || 'draft')}</span>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="flex: 1; height: 6px; background: var(--gray-200); border-radius: 3px; overflow: hidden;">
                                <div style="height: 100%; background: var(--primary-500); width: ${project.progress || 0}%; transition: width 0.3s;"></div>
                            </div>
                            <span style="font-size: 0.75rem; color: var(--gray-600);">${project.progress || 0}%</span>
                        </div>
                    </td>
                    <td>${formatDate(project.endDate || project.dueDate)}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="viewProject('${project.id}')">
                            View
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadProjects() {
            document.getElementById('projectsContent').innerHTML = `
                <div class="projects-container">
                    <div class="projects-header">
                        <h3>Project Management</h3>
                        <div class="projects-controls">
                            <button class="btn btn-primary" onclick="showCreateProject()">
                                ➕ New Project
                            </button>
                            <button class="btn btn-secondary" onclick="refreshProjects()">
                                🔄 Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Advanced Search & Filtering System -->
                    <div class="advanced-search-container">
                        <!-- Quick Search Bar -->
                        <div class="quick-search-row">
                            <div class="search-input-container">
                                <input type="text" id="globalProjectSearch" placeholder="Search by name, client, location, or description..."
                                       oninput="performAdvancedSearch()" class="global-search-input">
                                <span class="search-icon">🔍</span>
                            </div>
                            <button class="btn btn-secondary" onclick="toggleAdvancedFilters()" id="advancedFilterToggle">
                                🔧 Advanced Filters
                            </button>
                            <button class="btn btn-outline" onclick="clearAllFilters()">
                                🗑️ Clear All
                            </button>
                        </div>

                        <!-- Advanced Filters Panel (Initially Hidden) -->
                        <div class="advanced-filters-panel" id="advancedFiltersPanel" style="display: none;">
                            <div class="filters-grid">
                                <!-- Status & Progress Filters -->
                                <div class="filter-group">
                                    <label class="filter-label">Project Status</label>
                                    <div class="filter-checkboxes" id="statusFilters">
                                        <label><input type="checkbox" value="active" onchange="performAdvancedSearch()"> 🟢 Active</label>
                                        <label><input type="checkbox" value="completed" onchange="performAdvancedSearch()"> ✅ Completed</label>
                                        <label><input type="checkbox" value="on-hold" onchange="performAdvancedSearch()"> ⏸️ On Hold</label>
                                        <label><input type="checkbox" value="draft" onchange="performAdvancedSearch()"> 📝 Draft</label>
                                        <label><input type="checkbox" value="cancelled" onchange="performAdvancedSearch()"> ❌ Cancelled</label>
                                    </div>
                                </div>

                                <!-- Business Line Filter -->
                                <div class="filter-group">
                                    <label class="filter-label">Business Line</label>
                                    <div class="filter-checkboxes" id="businessLineFilters">
                                        <label><input type="checkbox" value="barrington" onchange="performAdvancedSearch()"> 🏦 Barrington Bank & Trust</label>
                                        <label><input type="checkbox" value="beverly" onchange="performAdvancedSearch()"> 🏦 Beverly Bank & Trust</label>
                                        <label><input type="checkbox" value="crystal-lake" onchange="performAdvancedSearch()"> 🏦 Crystal Lake Bank & Trust</label>
                                        <label><input type="checkbox" value="hinsdale" onchange="performAdvancedSearch()"> 🏦 Hinsdale Bank & Trust</label>
                                        <label><input type="checkbox" value="lake-forest" onchange="performAdvancedSearch()"> 🏦 Lake Forest Bank & Trust</label>
                                        <label><input type="checkbox" value="libertyville" onchange="performAdvancedSearch()"> 🏦 Libertyville Bank & Trust</label>
                                        <label><input type="checkbox" value="northbrook" onchange="performAdvancedSearch()"> 🏦 Northbrook Bank & Trust</label>
                                        <label><input type="checkbox" value="old-plank" onchange="performAdvancedSearch()"> 🏦 Old Plank Trail Community Bank</label>
                                        <label><input type="checkbox" value="st-charles" onchange="performAdvancedSearch()"> 🏦 St. Charles Bank & Trust</label>
                                        <label><input type="checkbox" value="schaumburg" onchange="performAdvancedSearch()"> 🏦 Schaumburg Bank & Trust</label>
                                        <label><input type="checkbox" value="state-lakes" onchange="performAdvancedSearch()"> 🏦 State Bank of the Lakes</label>
                                        <label><input type="checkbox" value="town-bank" onchange="performAdvancedSearch()"> 🏦 Town Bank</label>
                                        <label><input type="checkbox" value="village" onchange="performAdvancedSearch()"> 🏦 Village Bank & Trust</label>
                                        <label><input type="checkbox" value="wheaton" onchange="performAdvancedSearch()"> 🏦 Wheaton Bank & Trust</label>
                                        <label><input type="checkbox" value="company" onchange="performAdvancedSearch()"> 🏦 [Company Name]</label>
                                    </div>
                                </div>

                                <!-- Project Type Filter -->
                                <div class="filter-group">
                                    <label class="filter-label">Project Type</label>
                                    <div class="filter-checkboxes" id="projectTypeFilters">
                                        <label><input type="checkbox" value="new-build" onchange="performAdvancedSearch()"> 🏗️ New Build</label>
                                        <label><input type="checkbox" value="upgrade" onchange="performAdvancedSearch()"> ⬆️ Upgrade</label>
                                        <label><input type="checkbox" value="breakfix" onchange="performAdvancedSearch()"> 🔧 Break/Fix</label>
                                        <label><input type="checkbox" value="refresh" onchange="performAdvancedSearch()"> 🔄 Refresh</label>
                                        <label><input type="checkbox" value="custom" onchange="performAdvancedSearch()"> ⚙️ Custom</label>
                                    </div>
                                </div>

                                <!-- Priority Filter -->
                                <div class="filter-group">
                                    <label class="filter-label">Priority</label>
                                    <div class="filter-checkboxes" id="priorityFilters">
                                        <label><input type="checkbox" value="critical" onchange="performAdvancedSearch()"> 🔴 Critical</label>
                                        <label><input type="checkbox" value="high" onchange="performAdvancedSearch()"> 🟠 High</label>
                                        <label><input type="checkbox" value="medium" onchange="performAdvancedSearch()"> 🟡 Medium</label>
                                        <label><input type="checkbox" value="low" onchange="performAdvancedSearch()"> 🟢 Low</label>
                                    </div>
                                </div>

                                <!-- Date Range Filters -->
                                <div class="filter-group">
                                    <label class="filter-label">Date Filters</label>
                                    <div class="date-filters">
                                        <label for="startDateFilter">Start Date:</label>
                                        <input type="date" id="startDateFilter" name="startDateFilter" onchange="performAdvancedSearch()">
                                        <label for="endDateFilter">End Date:</label>
                                        <input type="date" id="endDateFilter" name="endDateFilter" onchange="performAdvancedSearch()">
                                    </div>
                                </div>

                                <!-- Budget Range Filter -->
                                <div class="filter-group">
                                    <label class="filter-label">Budget Range</label>
                                    <div class="budget-filters">
                                        <input type="number" id="minBudgetFilter" placeholder="Min Budget" onchange="performAdvancedSearch()">
                                        <input type="number" id="maxBudgetFilter" placeholder="Max Budget" onchange="performAdvancedSearch()">
                                    </div>
                                </div>

                                <!-- Progress Range Filter -->
                                <div class="filter-group">
                                    <label class="filter-label">Progress Range (%)</label>
                                    <div class="progress-filters">
                                        <input type="range" id="minProgressFilter" min="0" max="100" value="0" onchange="performAdvancedSearch()">
                                        <span id="minProgressValue">0%</span>
                                        <input type="range" id="maxProgressFilter" min="0" max="100" value="100" onchange="performAdvancedSearch()">
                                        <span id="maxProgressValue">100%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Filter Presets -->
                            <div class="quick-presets">
                                <label class="filter-label">Quick Filters:</label>
                                <div class="preset-buttons">
                                    <button class="btn btn-sm btn-outline" onclick="applyPreset('overdue')">⚠️ Overdue Projects</button>
                                    <button class="btn btn-sm btn-outline" onclick="applyPreset('active-high')">🔥 Active High Priority</button>
                                    <button class="btn btn-sm btn-outline" onclick="applyPreset('near-completion')">🎯 Near Completion</button>
                                    <button class="btn btn-sm btn-outline" onclick="applyPreset('budget-exceeded')">💸 Budget Issues</button>
                                    <button class="btn btn-sm btn-outline" onclick="applyPreset('this-month')">📅 Due This Month</button>
                                </div>
                            </div>
                        </div>

                        <!-- Results Summary & Controls -->
                        <div class="search-results-header">
                            <div class="results-info">
                                <span id="searchResultsCount">0 projects found</span>
                                <span id="activeFiltersCount" style="display: none;">• <span class="filter-count">0</span> filters active</span>
                            </div>
                            <div class="results-controls">
                                <label>Sort by:</label>
                                <select id="sortByField" onchange="performAdvancedSearch()">
                                    <option value="name">Project Name</option>
                                    <option value="status">Status</option>
                                    <option value="progress">Progress</option>
                                    <option value="dueDate">Due Date</option>
                                    <option value="startDate">Start Date</option>
                                    <option value="estimatedBudget">Budget</option>
                                    <option value="businessLine">Business Line</option>
                                    <option value="priority">Priority</option>
                                </select>
                                <select id="sortDirection" onchange="performAdvancedSearch()">
                                    <option value="asc">↑ Ascending</option>
                                    <option value="desc">↓ Descending</option>
                                </select>
                                <label>Show:</label>
                                <select id="pageSize" onchange="performAdvancedSearch()">
                                    <option value="25">25 per page</option>
                                    <option value="50">50 per page</option>
                                    <option value="100">100 per page</option>
                                    <option value="all">All projects</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="projects-grid" id="projectsGrid">
                        <div class="loading-state">Loading projects...</div>
                    </div>
                </div>
            `;

            // Initialize advanced search system
            setTimeout(() => {
                performAdvancedSearch();
            }, 100);
        }

        async function loadExecutiveDashboard() {
            const projects = getFilteredProjects();
            const executiveMetrics = generateExecutiveMetrics(projects);
            
            document.getElementById('reportContent').innerHTML = `
                <div class="executive-summary-cards">
                    ${executiveMetrics.map(metric => `
                        <div class="executive-summary-card ${metric.status}">
                            <div class="card-header">
                                <div class="card-title">${metric.title}</div>
                                <div class="card-icon">${metric.icon}</div>
                            </div>
                            <div class="card-metric ${metric.status}">${metric.value}</div>
                            <div class="card-subtitle">${metric.subtitle}</div>
                            <div class="card-trend ${metric.trend.direction}">
                                <span>${metric.trend.icon}</span>
                                <span>${metric.trend.text}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="executive-insights">
                    <div class="insight-section">
                        <h3>Strategic Portfolio Overview</h3>
                        <div class="portfolio-grid">
                            ${generatePortfolioInsights(projects)}
                        </div>
                    </div>

                    <div class="insight-section">
                        <h3>Risk & Performance Analysis</h3>
                        <div class="risk-analysis">
                            ${generateRiskAnalysis(projects)}
                        </div>
                    </div>

                    <div class="insight-section">
                        <h3>Field Operations Overview</h3>
                        <div class="field-ops-insights">
                            ${generateFieldOpsInsights()}
                        </div>
                    </div>

                    <div class="insight-section">
                        <h3>Financial Performance</h3>
                        <div class="financial-overview">
                            ${generateFinancialOverview(projects)}
                        </div>
                    </div>
                </div>

                <div class="executive-actions">
                    <div class="action-items">
                        <h3>Executive Action Items</h3>
                        ${generateActionItems(projects)}
                    </div>
            `;
        }

        // Executive Dashboard Helper Functions
        function generateExecutiveMetrics(projects) {
            const totalProjects = projects.length;
            const atRiskProjects = projects.filter(p => p.status === 'at-risk' || p.priority === 'high').length;
            const completedProjects = projects.filter(p => p.status === 'completed').length;
            const avgProgress = projects.reduce((sum, p) => sum + (p.progress || 0), 0) / totalProjects || 0;
            
            const totalBudget = projects.reduce((sum, p) => sum + (p.estimatedBudget || 0), 0);
            const actualSpend = projects.reduce((sum, p) => sum + (p.actualBudget || 0), 0);
            const budgetVariance = ((actualSpend - totalBudget) / totalBudget * 100) || 0;

            return [
                {
                    title: 'Active Projects',
                    value: totalProjects,
                    subtitle: `${completedProjects} completed this period`,
                    icon: '📊',
                    status: totalProjects > 50 ? 'warning' : 'success',
                    trend: { direction: 'trend-up', icon: '↗️', text: '+12% vs last quarter' }
                },
                {
                    title: 'Portfolio Health', 
                    value: `${Math.round(avgProgress)}%`,
                    subtitle: `${atRiskProjects} projects require attention`,
                    icon: '🎯',
                    status: atRiskProjects > 3 ? 'critical' : avgProgress > 75 ? 'success' : 'warning',
                    trend: { direction: avgProgress > 75 ? 'trend-up' : 'trend-down', icon: avgProgress > 75 ? '↗️' : '↘️', text: avgProgress > 75 ? 'On target' : 'Below target' }
                },
                {
                    title: 'Budget Performance',
                    value: budgetVariance >= 0 ? `${budgetVariance.toFixed(1)}%` : `${Math.abs(budgetVariance).toFixed(1)}%`,
                    subtitle: budgetVariance >= 0 ? 'Over budget' : 'Under budget',
                    icon: '💰',
                    status: Math.abs(budgetVariance) > 10 ? 'critical' : Math.abs(budgetVariance) > 5 ? 'warning' : 'success',
                    trend: { direction: budgetVariance >= 0 ? 'trend-down' : 'trend-up', icon: budgetVariance >= 0 ? '↗️' : '↘️', text: `$${Math.abs(actualSpend - totalBudget).toLocaleString()} variance` }
                },
                {
                    title: 'Resource Utilization',
                    value: '87%',
                    subtitle: 'Team capacity utilization',
                    icon: '👥',
                    status: 'success',
                    trend: { direction: 'trend-up', icon: '↗️', text: 'Optimal range' }
                }
            ];
        }

        function generatePortfolioInsights(projects) {
            const businessLines = {};
            projects.forEach(p => {
                const bl = p.businessLine || 'Other';
                if (!businessLines[bl]) businessLines[bl] = { count: 0, budget: 0, completed: 0 };
                businessLines[bl].count++;
                businessLines[bl].budget += p.estimatedBudget || 0;
                if (p.status === 'completed') businessLines[bl].completed++;
            });

            return Object.entries(businessLines).map(([name, data]) => `
                <div class="portfolio-card">
                    <h4>${name}</h4>
                    <div class="portfolio-stats">
                        <div class="stat">
                            <span class="stat-label">Projects</span>
                            <span class="stat-value">${data.count}</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Investment</span>
                            <span class="stat-value">$${data.budget.toLocaleString()}</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Completion</span>
                            <span class="stat-value">${Math.round((data.completed / data.count) * 100)}%</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function generateRiskAnalysis(projects) {
            const highRisk = projects.filter(p => p.priority === 'high' || p.status === 'at-risk').length;
            const overdue = projects.filter(p => p.dueDate && new Date(p.dueDate) < new Date() && p.status !== 'completed').length;
            
            return `
                <div class="risk-cards">
                    <div class="risk-card ${highRisk > 5 ? 'high-risk' : 'medium-risk'}">
                        <h4>High Priority Projects</h4>
                        <div class="risk-metric">${highRisk}</div>
                        <p>Require executive attention</p>
                    </div>
                    <div class="risk-card ${overdue > 3 ? 'high-risk' : 'low-risk'}">
                        <h4>Overdue Projects</h4>
                        <div class="risk-metric">${overdue}</div>
                        <p>Past original deadline</p>
                    </div>
                </div>
            `;
        }

        function generateFinancialOverview(projects) {
            const breakfixData = calculateBreakfixSpending();
            const refreshData = calculateRefreshSpending();
            
            return `
                <div class="financial-cards">
                    <div class="financial-card">
                        <h4>Breakfix Budget</h4>
                        <div class="financial-metric">$${breakfixData.remainingBudget.toLocaleString()}</div>
                        <p>Remaining of $${breakfixData.totalBudget.toLocaleString()}</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${breakfixData.utilizationRate}%"></div>
                        </div>
                    </div>
                    <div class="financial-card">
                        <h4>Refresh Budget</h4>
                        <div class="financial-metric">$${refreshData.remainingBudget.toLocaleString()}</div>
                        <p>Remaining of $${refreshData.totalBudget.toLocaleString()}</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${refreshData.utilizationRate}%"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateActionItems(projects) {
            const actions = [];
            
            // High priority overdue projects
            const overdueHigh = projects.filter(p => 
                p.priority === 'high' && 
                p.dueDate && 
                new Date(p.dueDate) < new Date() && 
                p.status !== 'completed'
            );
            
            if (overdueHigh.length > 0) {
                actions.push(`
                    <div class="action-item critical">
                        <div class="action-icon">🚨</div>
                        <div class="action-content">
                            <h4>Immediate Attention Required</h4>
                            <p>${overdueHigh.length} high-priority projects are overdue and need executive intervention</p>
                        </div>
                    </div>
                `);
            }

            // Budget concerns
            const breakfixData = calculateBreakfixSpending();
            if (breakfixData.utilizationRate > 85) {
                actions.push(`
                    <div class="action-item warning">
                        <div class="action-icon">💰</div>
                        <div class="action-content">
                            <h4>Budget Alert</h4>
                            <p>Breakfix budget is ${breakfixData.utilizationRate}% utilized. Consider budget reallocation.</p>
                        </div>
                    </div>
                `);
            }

            if (actions.length === 0) {
                actions.push(`
                    <div class="action-item success">
                        <div class="action-icon">✅</div>
                        <div class="action-content">
                            <h4>Portfolio in Good Health</h4>
                            <p>No immediate executive actions required. Continue monitoring key metrics.</p>
                        </div>
                    </div>
                `);
            }

            return actions.join('');
        }

        function generateFieldOpsInsights() {
            // Initialize field ops data if not available
            if (!AppState.fieldOps) {
                initializeFieldOpsData();
            }
            
            const scheduled = AppState.fieldOps.scheduled || [];
            const completed = AppState.fieldOps.completed || [];
            const pending = AppState.fieldOps.pending || [];
            
            // Calculate key metrics
            const totalJobs = scheduled.length + completed.length + pending.length;
            const todayJobs = scheduled.filter(job => {
                return new Date(job.date).toDateString() === new Date().toDateString();
            }).length;
            const thisWeekJobs = scheduled.filter(job => {
                const jobDate = new Date(job.date);
                const today = new Date();
                const weekStart = new Date(today.setDate(today.getDate() - today.getDay()));
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                return jobDate >= weekStart && jobDate <= weekEnd;
            }).length;
            
            // Work type distribution
            const workTypes = {};
            [...scheduled, ...completed].forEach(job => {
                workTypes[job.workType] = (workTypes[job.workType] || 0) + 1;
            });
            
            // Resource utilization
            const resources = {};
            [...scheduled, ...completed].forEach(job => {
                const key = job.vendor ? `${job.assignedTo} (Vendor)` : job.assignedTo;
                resources[key] = (resources[key] || 0) + 1;
            });
            
            // Project integration stats
            const projectLinked = [...scheduled, ...completed].filter(job => job.projectId).length;
            const taskLinked = [...scheduled, ...completed].filter(job => job.taskId).length;
            const projectIntegrationRate = totalJobs > 0 ? Math.round((projectLinked / totalJobs) * 100) : 0;
            
            // Reschedule analytics
            const rescheduledJobs = [...scheduled, ...completed].filter(job => job.rescheduleHistory && job.rescheduleHistory.length > 0);
            const totalReschedules = [...scheduled, ...completed].reduce((sum, job) => {
                return sum + (job.rescheduleHistory ? job.rescheduleHistory.length : 0);
            }, 0);
            const rescheduleRate = totalJobs > 0 ? Math.round((rescheduledJobs.length / totalJobs) * 100) : 0;
            
            // Reschedule reasons breakdown
            const rescheduleReasons = {};
            [...scheduled, ...completed].forEach(job => {
                if (job.rescheduleHistory) {
                    job.rescheduleHistory.forEach(r => {
                        const reason = r.otherReason ? `${r.reason} - ${r.otherReason}` : r.reason;
                        rescheduleReasons[reason] = (rescheduleReasons[reason] || 0) + 1;
                    });
                }
            });
            
            return `
                <div class="field-ops-summary">
                    <div class="field-ops-stats">
                        <div class="field-stat">
                            <div class="stat-value">${totalJobs}</div>
                            <div class="stat-label">Total Jobs</div>
                        </div>
                        <div class="field-stat">
                            <div class="stat-value">${todayJobs}</div>
                            <div class="stat-label">Today</div>
                        </div>
                        <div class="field-stat">
                            <div class="stat-value">${thisWeekJobs}</div>
                            <div class="stat-label">This Week</div>
                        </div>
                        <div class="field-stat">
                            <div class="stat-value">${pending.length}</div>
                            <div class="stat-label">Pending</div>
                        </div>
                    </div>
                </div>
                
                <div class="field-ops-charts">
                    <div class="field-ops-chart">
                        <h4>Work Type Distribution</h4>
                        <div class="work-type-breakdown">
                            ${Object.entries(workTypes).map(([type, count]) => {
                                const percentage = totalJobs > 0 ? Math.round((count / totalJobs) * 100) : 0;
                                const colorClass = {
                                    'Installation': 'info',
                                    'Commissioning': 'success', 
                                    'Break/Fix': 'danger',
                                    'Maintenance': 'warning'
                                }[type] || 'secondary';
                                return `
                                    <div class="work-type-item">
                                        <div class="work-type-label">
                                            <span class="work-type-badge ${type.toLowerCase().replace('/', '')}">${type}</span>
                                            <span class="work-type-count">${count} jobs (${percentage}%)</span>
                                        </div>
                                        <div class="work-type-bar">
                                            <div class="work-type-progress ${colorClass}" style="width: ${percentage}%"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <div class="field-ops-chart">
                        <h4>Resource Utilization</h4>
                        <div class="resource-breakdown">
                            ${Object.entries(resources).slice(0, 5).map(([resource, count]) => {
                                const percentage = totalJobs > 0 ? Math.round((count / totalJobs) * 100) : 0;
                                return `
                                    <div class="resource-item">
                                        <div class="resource-name">${resource}</div>
                                        <div class="resource-stats">
                                            <span>${count} jobs</span>
                                            <div class="resource-bar">
                                                <div class="resource-progress" style="width: ${percentage}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                            ${Object.keys(resources).length > 5 ? `<div class="resource-more">+${Object.keys(resources).length - 5} more resources</div>` : ''}
                        </div>
                    </div>
                </div>
                
                <div class="field-ops-integration">
                    <div class="integration-stat">
                        <div class="integration-icon">🔗</div>
                        <div class="integration-details">
                            <div class="integration-title">Project Integration Rate</div>
                            <div class="integration-value">${projectIntegrationRate}%</div>
                            <div class="integration-subtitle">${projectLinked} of ${totalJobs} jobs linked to projects</div>
                        </div>
                    </div>
                    <div class="integration-stat">
                        <div class="integration-icon">📌</div>
                        <div class="integration-details">
                            <div class="integration-title">Task-Level Tracking</div>
                            <div class="integration-value">${taskLinked}</div>
                            <div class="integration-subtitle">Jobs linked to specific tasks</div>
                        </div>
                    </div>
                </div>
                
                ${totalReschedules > 0 ? `
                    <div class="field-ops-integration">
                        <div class="integration-stat">
                            <div class="integration-icon">🔄</div>
                            <div class="integration-details">
                                <div class="integration-title">Reschedule Rate</div>
                                <div class="integration-value ${rescheduleRate > 20 ? 'warning' : rescheduleRate > 10 ? 'info' : 'success'}">${rescheduleRate}%</div>
                                <div class="integration-subtitle">${rescheduledJobs.length} of ${totalJobs} jobs rescheduled</div>
                            </div>
                        </div>
                        <div class="integration-stat">
                            <div class="integration-icon">📊</div>
                            <div class="integration-details">
                                <div class="integration-title">Total Reschedules</div>
                                <div class="integration-value">${totalReschedules}</div>
                                <div class="integration-subtitle">Includes multiple reschedules per job</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="field-ops-reschedule-details">
                        <h4>Top Reschedule Reasons</h4>
                        <div class="reschedule-reasons-breakdown">
                            ${Object.entries(rescheduleReasons).sort((a, b) => b[1] - a[1]).slice(0, 5).map(([reason, count]) => {
                                const percentage = totalReschedules > 0 ? Math.round((count / totalReschedules) * 100) : 0;
                                const colorClass = {
                                    'Parts Delay': 'warning',
                                    'Vendor Delay': 'danger', 
                                    'Vendor No-Show': 'danger',
                                    'Vendor Reschedule': 'info',
                                    'Client Reschedule': 'info'
                                }[reason.split(' - ')[0]] || 'secondary';
                                return `
                                    <div class="reason-breakdown-item">
                                        <div class="reason-label">
                                            <span class="work-type-badge ${colorClass}">${reason}</span>
                                        </div>
                                        <div class="reason-stats">
                                            <span class="reason-count">${count} times (${percentage}%)</span>
                                            <div class="reason-bar">
                                                <div class="reason-progress ${colorClass}" style="width: ${percentage}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${pending.length > 0 ? `
                    <div class="field-ops-alerts">
                        <div class="field-alert warning">
                            <div class="alert-icon">⏳</div>
                            <div class="alert-content">
                                <strong>Pending Assignments:</strong> ${pending.length} work requests need scheduling
                                <a href="#" onclick="showView('fieldops'); showFieldOpsTab('pending');" class="alert-action">Review Pending →</a>
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        function getFilteredProjects() {
            let projects = AppState.projects || [];
            
            // Get filter values
            const timeFilter = document.getElementById('execTimeFilter')?.value || 'current';
            const businessFilter = document.getElementById('execBusinessFilter')?.value || 'all';
            const sizeFilter = document.getElementById('execSizeFilter')?.value || 'all';
            
            // Apply time period filter
            if (timeFilter !== 'current') {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                
                projects = projects.filter(project => {
                    const projectDate = new Date(project.createdAt || project.startDate);
                    
                    switch(timeFilter) {
                        case 'thisMonth':
                            return projectDate.getMonth() === currentMonth && projectDate.getFullYear() === currentYear;
                        case 'lastMonth':
                            const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                            const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
                            return projectDate.getMonth() === lastMonth && projectDate.getFullYear() === lastMonthYear;
                        case 'thisQuarter':
                            const currentQuarter = Math.floor(currentMonth / 3);
                            const projectQuarter = Math.floor(projectDate.getMonth() / 3);
                            return projectQuarter === currentQuarter && projectDate.getFullYear() === currentYear;
                        case 'thisYear':
                            return projectDate.getFullYear() === currentYear;
                        default:
                            return true;
                    }
                });
            }
            
            // Apply business line filter
            if (businessFilter !== 'all') {
                projects = projects.filter(project => {
                    const projectBusiness = project.businessLine || project.client || '';
                    // Handle partial matches for bank names
                    switch(businessFilter) {
                        case 'barrington':
                            return projectBusiness.toLowerCase().includes('barrington');
                        case 'beverly':
                            return projectBusiness.toLowerCase().includes('beverly');
                        case 'crystal-lake':
                            return projectBusiness.toLowerCase().includes('crystal lake');
                        case 'hinsdale':
                            return projectBusiness.toLowerCase().includes('hinsdale');
                        case 'lake-forest':
                            return projectBusiness.toLowerCase().includes('lake forest');
                        case 'libertyville':
                            return projectBusiness.toLowerCase().includes('libertyville');
                        case 'northbrook':
                            return projectBusiness.toLowerCase().includes('northbrook');
                        case 'old-plank':
                            return projectBusiness.toLowerCase().includes('old plank');
                        case 'st-charles':
                            return projectBusiness.toLowerCase().includes('st. charles') || projectBusiness.toLowerCase().includes('st charles');
                        case 'schaumburg':
                            return projectBusiness.toLowerCase().includes('schaumburg');
                        case 'state-lakes':
                            return projectBusiness.toLowerCase().includes('state bank of the lakes');
                        case 'town-bank':
                            return projectBusiness.toLowerCase().includes('town bank');
                        case 'village':
                            return projectBusiness.toLowerCase().includes('village bank');
                        case 'wheaton':
                            return projectBusiness.toLowerCase().includes('wheaton');
                        case 'company':
                            return projectBusiness.toLowerCase().includes('company');
                        default:
                            return projectBusiness.toLowerCase().includes(businessFilter.toLowerCase());
                    }
                });
            }
            
            // Apply project size filter
            if (sizeFilter !== 'all') {
                projects = projects.filter(project => {
                    const budget = project.estimatedBudget || 0;
                    switch(sizeFilter) {
                        case 'small':
                            return budget < 25000;
                        case 'medium':
                            return budget >= 25000 && budget < 100000;
                        case 'large':
                            return budget >= 100000;
                        default:
                            return true;
                    }
                });
            }
            
            return projects;
        }

        function applyExecutiveFilters() {
            loadExecutiveDashboard();
        }

        function resetExecutiveFilters() {
            document.getElementById('execTimeFilter').value = 'current';
            document.getElementById('execBusinessFilter').value = 'all';
            document.getElementById('execSizeFilter').value = 'all';
            loadExecutiveDashboard();
        }

        // ==================== UTILITY FUNCTIONS ====================
        function formatStatus(status) {
            return status.charAt(0).toUpperCase() + status.slice(1).replace('-', ' ');
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }

        function formatProjectType(type) {
            const typeMap = {
                'new-build': 'New Build',
                'upgrade': 'Upgrade',
                'breakfix': 'BreakFix',
                'refresh': 'Refresh',
                'custom': 'Custom Project'
            };
            return typeMap[type] || type;
        }

        // Phase info helper for badges
        function derivePhaseInfo(phaseId) {
            try {
                const phase = (projectPhases || []).find(p => p.id === phaseId);
                const cls = phaseId ? String(phaseId).replace('_', '-') : 'phase-1';
                return { name: phase ? phase.name : 'Pre-installation - Logistics', class: cls };
            } catch (_) {
                return { name: 'Pre-installation - Logistics', class: 'phase-1' };
            }
        }



        // ============== AUDIT LOGGING HELPERS ==============
        function computeDiff(before = {}, after = {}) {
            try {
                const diff = {};
                const keys = new Set([...Object.keys(before || {}), ...Object.keys(after || {})]);
                keys.forEach(k => {
                    const b = before ? before[k] : undefined;
                    const a = after ? after[k] : undefined;
                    if (JSON.stringify(b) !== JSON.stringify(a)) {
                        diff[k] = { before: b, after: a };
                    }
                });
                return diff;
            } catch (_) { return {}; }
        }

        function auditLogEvent({ action, entity, entityId, entityName, before, after, details = '', severity = 'info', meta = {} }) {
            try {
                AppState.auditLog = AppState.auditLog || [];
                const actor = {
                    id: AppState.user?.id || null,
                    name: AppState.user?.name || AppState.user?.email || 'Unknown',
                    email: AppState.user?.email || '',
                    role: AppState.user?.Role?.name || AppState.user?.role || ''
                };
                const entry = {
                    id: 'audit_' + Date.now() + '_' + Math.random().toString(36).slice(2, 8),
                    timestamp: new Date().toISOString(),
                    action, entity, entityId, entityName,
                    actor, user: actor.name, // backward-compat for existing table renderer
                    details,
                    diff: computeDiff(before || {}, after || {}),
                    severity,
                    meta,
                    userAgent: navigator.userAgent,
                    page: (location.pathname || '') + (location.hash || '')
                };
                AppState.auditLog.unshift(entry);
                try {

                } catch (_) {}
                try {
                    if (isBackendMode()) {
                        const token = AppState.backendAuth?.token;
                        fetch(AppState.config.apiUrl + '/audit/log', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', ...(token ? { 'Authorization': 'Bearer ' + token } : {}) },
                            body: JSON.stringify(entry)
                        }).catch(() => {});
                    }
                } catch (_) {}
                try { if (document.getElementById('auditTableBody')) loadAuditLog(); } catch (_) {}
            } catch (e) {
                console.error('Audit log failed:', e);
            }
        }

        function hasPermission(key) {
            try {
                const roleRaw = String(AppState.user?.Role?.name || AppState.user?.role || '');
                const roleName = roleRaw.toLowerCase().replace('-', '_');
                // Admin-style roles are full access
                if (['admin','owner','superadmin','root'].includes(roleName)) return true;
                // Primary source: explicit permissions on role
                const perms = AppState.user?.Role?.permissions;
                if (Array.isArray(perms)) return perms.includes(key);
                // Fallback by role when permissions array is missing (local/demo mode)
                const allowByRole = {
                    'tasks.notes.view': ['admin','project_manager','manager','auditor','owner','superadmin','root'],
                    'tasks.notes.edit': ['admin','project_manager','manager','owner','superadmin','root']
                };
                if (allowByRole[key]) return allowByRole[key].includes(roleName);
                return false;
            } catch (_) { return false; }
        }


        function formatBusinessLine(businessLine) {
            if (!businessLine) return 'N/A';

            const businessLineMap = {
                'barrington': 'Barrington Bank & Trust Company, N.A.',
                'beverly': 'Beverly Bank & Trust Company, N.A.',
                'crystal-lake': 'Crystal Lake Bank & Trust Company, N.A.',
                'hinsdale': 'Hinsdale Bank & Trust Company, N.A.',
                'lake-forest': 'Lake Forest Bank & Trust Company, N.A.',
                'libertyville': 'Libertyville Bank & Trust Company, N.A.',
                'northbrook': 'Northbrook Bank & Trust Company, N.A.',
                'old-plank': 'Old Plank Trail Community Bank, N.A.',
                'st-charles': 'St. Charles Bank & Trust Company, N.A.',
                'schaumburg': 'Schaumburg Bank & Trust Company, N.A.',
                'state-lakes': 'State Bank of the Lakes, N.A.',
                'town-bank': 'Town Bank, N.A.',
                'village': 'Village Bank & Trust, N.A.',
                'wheaton': 'Wheaton Bank & Trust Company, N.A.',
                'company': '[Company Name]'
            };

            return businessLineMap[businessLine] || businessLine.charAt(0).toUpperCase() + businessLine.slice(1);
        }


        // Ensure add-note handler is available early for inline onclick
        window.submitTaskNote = async function submitTaskNote(projectId, taskId) {
            try {
                const input = document.getElementById(`noteInputModal-${projectId}-${taskId}`) || document.getElementById(`noteInput-${projectId}-${taskId}`);
                if (!input) { console.warn('submitTaskNote: note input not found'); return; }
                const content = String(input.value || '').trim();
                if (!content) { showNotification('Enter a note first', 'warning'); return; }

                const projectIndex = (AppState.projects || []).findIndex(p => String(p.id) === String(projectId));
                if (projectIndex === -1) { console.warn('submitTaskNote: project not found', projectId); return; }
                const taskIndex = (AppState.projects[projectIndex].tasks || []).findIndex(t => String(t.id) === String(taskId));
                if (taskIndex === -1) { console.warn('submitTaskNote: task not found', taskId); return; }

                const user = AppState.user || { name: 'Unknown', role: 'viewer' };
                const note = { id: 'note_' + Date.now(), author: user.name || user.email || 'Unknown', role: user.role || '', content, timestamp: new Date().toISOString() };

                const task = AppState.projects[projectIndex].tasks[taskIndex];
                const newThread = Array.isArray(task.notesThread) ? task.notesThread.slice() : [];
                newThread.push(note);

                if (!isBackendMode()) { showNotification('Backend connection required', 'error'); return; }
                try {
                    const data = await apiFetch(`/projects/${projectId}/tasks/${taskId}`, { method: 'PUT', body: JSON.stringify({ notesThread: newThread }) });
                    const savedTask = data.task || {};
                    const taskRef = AppState.projects[projectIndex].tasks[taskIndex];
                    taskRef.notesThread = Array.isArray(savedTask.notesThread) ? savedTask.notesThread : newThread;
                    taskRef.updatedAt = new Date().toISOString();
                } catch (e) {
                    console.error('Failed to save note to backend:', e);
                    showNotification('Failed to save note to backend', 'error');
                    return;
                }


                showNotification('Note added', 'success');
                input.value = '';

                // Update mini list under task card
                const listEl = document.getElementById(`notesList-${projectId}-${taskId}`);
                if (listEl) {
                    const thread = task.notesThread || [];
                    const items = thread.slice(-2).map(n => `
                        <div style="border-left: 3px solid var(--primary-300); padding-left: 0.5rem;">
                            <div style="font-size: 0.75rem; color: var(--gray-600);">${new Date(n.timestamp).toLocaleString()} — <strong>${n.author || 'Someone'}</strong>${n.role ? ` (${n.role})` : ''}</div>
                            <div style="font-size: 0.85rem; color: var(--gray-800); white-space: pre-wrap;">${(n.content || '').replace(/</g,'&lt;')}</div>
                        </div>`).join('');
                    listEl.innerHTML = (items || '') + (thread.length > 2 ? `<a href="#" style="font-size:0.8rem;" onclick="event.preventDefault(); showAllTaskNotes('${projectId}','${taskId}')">View all notes</a>` : '');
                }

                // Update modal list if open
                const listElModal = document.getElementById(`notesListModal-${projectId}-${taskId}`);
                if (listElModal) {
                    const thread = task.notesThread || [];
                    const items = thread.slice(-3).map(n => `
                        <div style="border-left: 3px solid var(--primary-300); padding-left: 0.5rem;">
                            <div style="font-size: 0.8rem; color: var(--gray-600);">${new Date(n.timestamp).toLocaleString()} — <strong>${n.author || 'Someone'}</strong>${n.role ? ` (${n.role})` : ''}</div>
                            <div style="font-size: 0.9rem; color: var(--gray-900); white-space: pre-wrap;">${(n.content || '').replace(/</g,'&lt;')}</div>
                        </div>`).join('');
                    listElModal.innerHTML = items || '<div style=\'color: var(--gray-500); font-size: 0.9rem;\'>No notes yet.</div>';
                }
            } catch (e) {
                console.error('submitTaskNote error:', e);
                showNotification('Failed to add note', 'error');
            }
        };

        async function editTaskNote(projectId, taskId, noteId) {
            try {
                if (!hasPermission('tasks.notes.edit')) { showNotification('Insufficient permissions', 'error'); return; }
                const projectIndex = AppState.projects.findIndex(p => p.id === projectId);
                if (projectIndex === -1) return;
                const taskIndex = AppState.projects[projectIndex].tasks.findIndex(t => t.id === taskId);
                if (taskIndex === -1) return;
                const task = AppState.projects[projectIndex].tasks[taskIndex];
                const note = (task.notesThread || []).find(n => String(n.id) === String(noteId));
                if (!note) return;
                const current = String(note.content || '');
                const updated = prompt('Edit note:', current);
                if (updated === null) return;
                if (!isBackendMode()) { showNotification('Backend connection required', 'error'); return; }
                const before = { ...note };
                note.content = updated;
                note.editedAt = new Date().toISOString();
                note.editor = AppState.user?.name || AppState.user?.email || 'Unknown';
                note.editHistory = Array.isArray(note.editHistory) ? note.editHistory : [];
                note.editHistory.push({ content: current, editedAt: note.editedAt, editor: note.editor });
                task.updatedAt = new Date().toISOString();

                try {
                    await apiFetch(`/projects/${projectId}/tasks/${taskId}`, { method: 'PUT', body: JSON.stringify({ notesThread: task.notesThread }) });
                } catch (e) {
                    console.error('Failed to update note in backend:', e);
                    // revert local changes
                    note.content = before.content;
                    note.editedAt = before.editedAt;
                    note.editor = before.editor;
                    if (Array.isArray(note.editHistory)) note.editHistory.pop();
                    showNotification('Failed to update note in backend', 'error');
                    return;
                }


                showNotification('Note updated', 'success');

                try { auditLogEvent({ action: 'task.note.edit', entity: 'task', entityId: task.id, entityName: task.name, before: { noteId, content: before.content }, after: { noteId, content: note.content }, details: 'Edited a task note', meta: { projectId, noteId } }); } catch(_) {}

                // If modal is open, refresh it
                const overlay = document.querySelector('.task-modal-overlay');
                if (overlay) {
                    overlay.remove();
                    showAllTaskNotes(projectId, taskId);
                }

                // Update mini list under task card
                const listEl = document.getElementById(`notesList-${projectId}-${taskId}`);
                if (listEl) {
                    const thread = task.notesThread || [];
                    const items = thread.slice(-2).map(n => `
                        <div style=\"border-left: 3px solid var(--primary-300); padding-left: 0.5rem;\">
                            <div style=\"font-size: 0.75rem; color: var(--gray-600);\">${new Date(n.timestamp).toLocaleString()} — <strong>${n.author || 'Someone'}</strong>${n.role ? ` (${n.role})` : ''}</div>
                            <div style=\"font-size: 0.85rem; color: var(--gray-800); white-space: pre-wrap;\">${(n.content || '').replace(/</g,'&lt;')}</div>


                        </div>`).join('');
                    listEl.innerHTML = (items || '') + (thread.length > 2 ? `<a href=\"#\" style=\"font-size:0.8rem;\" onclick=\"event.preventDefault(); showAllTaskNotes('${projectId}','${taskId}')\">View all notes</a>` : '');
                }
            } catch (e) {
                console.error('editTaskNote error:', e);
                showNotification('Failed to update note', 'error');
            }
        }


        function refreshDashboard() {
            const button = event.target;
            button.classList.add('loading');
            setTimeout(() => {
                loadDashboard();
                button.classList.remove('loading');
            }, 1000);
        }

        // ==================== PROJECT MANAGEMENT FUNCTIONS ====================
        let currentProjects = [];
        let filteredProjects = [];


        // Safe helpers to normalize possibly non-array API shapes
        function toArrayMaybe(v) {
            if (Array.isArray(v)) return v;
            if (v && typeof v === 'object') return Object.values(v);
            return [];
        }
        function getTasks(project) {
            try { return toArrayMaybe(project?.tasks); } catch (_) { return []; }
        }
        function normalizeProject(p) {
            try { return { ...p, tasks: getTasks(p) }; } catch (_) { return { ...p, tasks: [] }; }
        }

        async function renderProjectsGrid() {
            try {
                // Use AppState projects directly (demo mode)
                currentProjects = AppState.projects || [];

                filteredProjects = [...currentProjects];
                displayProjects(filteredProjects);

            } catch (error) {
                console.error('Error loading projects:', error);
                showNotification('Failed to load projects', 'error');
            }
        }

        function displayProjects(projects) {
            const projectsGrid = document.getElementById('projectsGrid');
            
            if (!projectsGrid) {
                console.error('❌ projectsGrid element not found - DOM may not be ready');
                return;
            }

            if (projects.length === 0) {
                projectsGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📁</div>
                        <h3>No Projects Found</h3>
                        <p>Create your first project to get started</p>
                        <button class="btn btn-primary" onclick="showCreateProject()">
                            ➕ Create Project
                        </button>
                    </div>
                `;
                return;
            }

            projectsGrid.innerHTML = projects.map(project => {
                const progressColor = project.progress > 75 ? '#22c55e' :
                                    project.progress > 50 ? '#0ea5e9' :
                                    project.progress > 25 ? '#f59e0b' : '#ef4444';

                const isOverdue = project.endDate && new Date(project.endDate) < new Date() && project.status !== 'completed';
                const daysRemaining = project.endDate ? Math.ceil((new Date(project.endDate) - new Date()) / (1000 * 60 * 60 * 24)) : null;

                return `
                    <div class="project-card ${isOverdue ? 'overdue' : ''}" onclick="viewProject('${project.id}')">
                        <div class="project-card-header">
                            <h4 class="project-title">${escapeHtml(project.name)}</h4>
                            <div class="project-menu">
                                <button class="menu-btn" onclick="event.stopPropagation(); showProjectMenu('${project.id}')">⋮</button>
                            </div>
                        </div>

                        <div class="project-meta">
                            <span class="status-badge ${project.status}">${formatStatus(project.status)}</span>
                            <span class="project-type">${formatProjectType(project.type)}</span>
                        </div>

                        <div class="project-details">
                            <div class="project-detail-item">
                                <span class="detail-label">👤 Requestor:</span>
                                <span class="detail-value">${project.requestorInfo ? project.requestorInfo.split(',')[0] : 'N/A'}</span>
                            </div>
                            <div class="project-detail-item">
                                <span class="detail-label">📍 Location:</span>
                                <span class="detail-value">${project.siteLocation || 'N/A'}</span>
                            </div>
                            <div class="project-detail-item">
                                <span class="detail-label">🏢 Business:</span>
                                <span class="detail-value">${formatBusinessLine(project.businessLine)}</span>
                            </div>
                        </div>

                        <div class="project-progress">
                            <div class="progress-header">
                                <span>Progress</span>
                                <span>${project.progress}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${project.progress}%; background: ${progressColor};"></div>
                            </div>
                        </div>

                        <div class="project-stats">
                            <div class="stat">
                                <span class="stat-label">Tasks</span>
                                <span class="stat-value">${getTasks(project).filter(t => t.status === 'completed').length}/${getTasks(project).length}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Budget</span>
                                <span class="stat-value">$${(project.estimatedBudget || 0).toLocaleString()}</span>
                            </div>
                        </div>

                        <div class="project-timeline">
                            ${project.endDate ? `
                                <div class="timeline-item ${isOverdue ? 'overdue' : daysRemaining <= 7 ? 'due-soon' : ''}">
                                    📅 ${isOverdue ? `${Math.abs(daysRemaining)} days overdue` :
                                          daysRemaining <= 0 ? 'Due today' :
                                          `${daysRemaining} days left`}
                                </div>
                            ` : '<div class="timeline-item">📅 No deadline set</div>'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderListView(projects) {
            const projectsGrid = document.getElementById('projectsGrid');

            if (projects.length === 0) {
                projectsGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📁</div>
                        <h3>No Projects Found</h3>
                        <p>No projects match the current filter</p>
                        <button class="btn btn-primary" onclick="showCreateProject()">
                            ➕ Create Project
                        </button>
                    </div>
                `;
                return;
            }

            // Use the existing displayProjects function logic but with custom container
            displayProjects(projects);
        }


        function renderCalendarView(projects) {
            const projectsGrid = document.getElementById('projectsGrid');

            // Create a simple calendar view showing projects by month
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();

            // Get projects with dates
            const projectsWithDates = projects.filter(p => p.startDate || p.dueDate || p.endDate);

            // Group projects by month
            const monthlyProjects = {};

            projectsWithDates.forEach(project => {
                const dates = [project.startDate, project.dueDate, project.endDate].filter(Boolean);
                dates.forEach(dateStr => {
                    const date = new Date(dateStr);
                    const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
                    if (!monthlyProjects[monthKey]) {
                        monthlyProjects[monthKey] = [];
                    }
                    if (!monthlyProjects[monthKey].find(p => p.id === project.id)) {
                        monthlyProjects[monthKey].push(project);
                    }
                });
            });

            // Generate calendar for current and next 2 months
            const months = [];
            for (let i = -1; i <= 2; i++) {
                const monthDate = new Date(currentYear, currentMonth + i, 1);
                const monthKey = `${monthDate.getFullYear()}-${monthDate.getMonth()}`;
                const monthName = monthDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

                months.push({
                    key: monthKey,
                    name: monthName,
                    projects: monthlyProjects[monthKey] || []
                });
            }

            projectsGrid.innerHTML = `
                <div class="calendar-view">
                    ${months.map(month => `
                        <div class="calendar-month">
                            <div class="calendar-month-header">
                                <h4>📅 ${month.name}</h4>
                                <span class="project-count">${month.projects.length} projects</span>
                            </div>
                            <div class="calendar-projects">
                                ${month.projects.length > 0 ? month.projects.map(project => `
                                    <div class="calendar-item" onclick="viewProject('${project.id}')">
                                        <div class="calendar-item-header">
                                            <h5>${project.name}</h5>
                                            <span class="status-badge ${project.status}">${formatStatus(project.status)}</span>
                                        </div>
                                        <div class="calendar-item-details">
                                            ${project.startDate ? `<div>📅 Start: ${formatDate(project.startDate)}</div>` : ''}
                                            ${project.dueDate ? `<div>🎯 Due: ${formatDate(project.dueDate)}</div>` : ''}
                                            ${project.endDate ? `<div>✅ End: ${formatDate(project.endDate)}</div>` : ''}
                                        </div>
                                        <div class="progress-bar small">
                                            <div class="progress-fill" style="width: ${project.progress || 0}%"></div>
                                            <span class="progress-text">${project.progress || 0}%</span>
                                        </div>
                                    </div>
                                `).join('') : '<p class="no-projects">No projects scheduled</p>'}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function updateProjectCounts() {
            const projects = AppState.projects || [];
            const activeCount = projects.filter(p => p.status === 'active').length;
            const completedCount = projects.filter(p => p.status === 'completed').length;
            const overdueCount = projects.filter(p => {
                const dueDate = p.dueDate || p.endDate;
                return dueDate && new Date(dueDate) < new Date() && p.status !== 'completed';
            }).length;

            // Update sidebar badges
            const activeCountEl = document.getElementById('activeCount');
            const completedCountEl = document.getElementById('completedCount');
            const overdueCountEl = document.getElementById('overdueCount');

            if (activeCountEl) activeCountEl.textContent = activeCount;
            if (completedCountEl) completedCountEl.textContent = completedCount;
            if (overdueCountEl) overdueCountEl.textContent = overdueCount;
        }

        function filterProjects(filter) {
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            }

            // Update current filter state
            currentProjectFilter = filter;

            // Use the new rendering system
            renderProjectView(currentProjectView, currentProjectFilter);

            // Update counts
            updateProjectCounts();
        }

        // Advanced Search System Variables
        let currentSearchResults = [];
        let currentPage = 1;
        let isAdvancedFiltersVisible = false;

        function performAdvancedSearch() {
            const searchTerm = document.getElementById('globalProjectSearch')?.value.toLowerCase() || '';
            const allProjects = AppState.projects || [];

            // Apply text search first
            let filtered = allProjects.filter(project =>
                project.name?.toLowerCase().includes(searchTerm) ||
                project.requestorInfo?.toLowerCase().includes(searchTerm) ||
                project.siteLocation?.toLowerCase().includes(searchTerm) ||
                project.businessLine?.toLowerCase().includes(searchTerm) ||
                project.description?.toLowerCase().includes(searchTerm) ||
                project.type?.toLowerCase().includes(searchTerm) ||
                project.priority?.toLowerCase().includes(searchTerm) ||
                // Enhanced: Search within project tasks
                project.tasks?.some(task =>
                    task.name?.toLowerCase().includes(searchTerm) ||
                    task.description?.toLowerCase().includes(searchTerm)
                )
            );

            // Apply status filters
            const statusFilters = Array.from(document.querySelectorAll('#statusFilters input:checked')).map(cb => cb.value);
            if (statusFilters.length > 0) {
                filtered = filtered.filter(project => statusFilters.includes(project.status));
            }

            // Apply business line filters
            const businessLineFilters = Array.from(document.querySelectorAll('#businessLineFilters input:checked')).map(cb => cb.value);
            if (businessLineFilters.length > 0) {
                filtered = filtered.filter(project => businessLineFilters.includes(project.businessLine));
            }

            // Apply project type filters
            const typeFilters = Array.from(document.querySelectorAll('#projectTypeFilters input:checked')).map(cb => cb.value);
            if (typeFilters.length > 0) {
                filtered = filtered.filter(project => typeFilters.includes(project.type));
            }

            // Apply priority filters
            const priorityFilters = Array.from(document.querySelectorAll('#priorityFilters input:checked')).map(cb => cb.value);
            if (priorityFilters.length > 0) {
                filtered = filtered.filter(project => priorityFilters.includes(project.priority));
            }

            // Apply date filters
            const startDateFilter = document.getElementById('startDateFilter')?.value;
            const endDateFilter = document.getElementById('endDateFilter')?.value;
            if (startDateFilter) {
                filtered = filtered.filter(project => {
                    const projectStartDate = project.startDate || project.createdAt;
                    return projectStartDate && new Date(projectStartDate) >= new Date(startDateFilter);
                });
            }
            if (endDateFilter) {
                filtered = filtered.filter(project => {
                    const projectEndDate = project.endDate || project.dueDate;
                    return projectEndDate && new Date(projectEndDate) <= new Date(endDateFilter);
                });
            }

            // Apply budget filters
            const minBudget = parseFloat(document.getElementById('minBudgetFilter')?.value) || 0;
            const maxBudget = parseFloat(document.getElementById('maxBudgetFilter')?.value) || Infinity;
            filtered = filtered.filter(project => {
                const budget = project.estimatedBudget || 0;
                return budget >= minBudget && budget <= maxBudget;
            });

            // Apply progress filters
            const minProgress = parseInt(document.getElementById('minProgressFilter')?.value) || 0;
            const maxProgress = parseInt(document.getElementById('maxProgressFilter')?.value) || 100;
            filtered = filtered.filter(project => {
                const progress = project.progress || 0;
                return progress >= minProgress && progress <= maxProgress;
            });

            // Update progress slider displays
            const minProgressValue = document.getElementById('minProgressValue');
            const maxProgressValue = document.getElementById('maxProgressValue');
            if (minProgressValue) minProgressValue.textContent = minProgress + '%';
            if (maxProgressValue) maxProgressValue.textContent = maxProgress + '%';

            // Apply sorting
            const sortField = document.getElementById('sortByField')?.value || 'name';
            const sortDirection = document.getElementById('sortDirection')?.value || 'asc';
            filtered.sort((a, b) => {
                let aVal = a[sortField] || '';
                let bVal = b[sortField] || '';

                // Handle different data types
                if (sortField === 'progress' || sortField === 'estimatedBudget') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                } else if (sortField.includes('Date')) {
                    aVal = new Date(aVal || '1900-01-01');
                    bVal = new Date(bVal || '1900-01-01');
                } else {
                    aVal = String(aVal).toLowerCase();
                    bVal = String(bVal).toLowerCase();
                }

                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            // Store results and update UI
            currentSearchResults = filtered;
            updateSearchResultsDisplay();
            displaySearchResults();
        }

        function updateSearchResultsDisplay() {
            const resultsCount = document.getElementById('searchResultsCount');
            const activeFiltersCount = document.getElementById('activeFiltersCount');

            if (resultsCount) {
                const totalResults = currentSearchResults.length;
                resultsCount.textContent = `${totalResults} project${totalResults === 1 ? '' : 's'} found`;
            }

            // Count active filters
            const activeFilters = countActiveFilters();
            if (activeFiltersCount) {
                if (activeFilters > 0) {
                    activeFiltersCount.style.display = 'inline';
                    activeFiltersCount.querySelector('.filter-count').textContent = activeFilters;
                } else {
                    activeFiltersCount.style.display = 'none';
                }
            }
        }

        function countActiveFilters() {
            let count = 0;

            // Text search
            if (document.getElementById('globalProjectSearch')?.value.trim()) count++;

            // Checkbox filters
            count += document.querySelectorAll('#statusFilters input:checked').length;
            count += document.querySelectorAll('#businessLineFilters input:checked').length;
            count += document.querySelectorAll('#projectTypeFilters input:checked').length;
            count += document.querySelectorAll('#priorityFilters input:checked').length;

            // Date filters
            if (document.getElementById('startDateFilter')?.value) count++;
            if (document.getElementById('endDateFilter')?.value) count++;

            // Budget filters
            if (document.getElementById('minBudgetFilter')?.value) count++;
            if (document.getElementById('maxBudgetFilter')?.value) count++;

            // Progress filters (only count if not at default 0-100)
            const minProgress = parseInt(document.getElementById('minProgressFilter')?.value) || 0;
            const maxProgress = parseInt(document.getElementById('maxProgressFilter')?.value) || 100;
            if (minProgress > 0 || maxProgress < 100) count++;

            return count;
        }

        function displaySearchResults() {
            const pageSize = document.getElementById('pageSize')?.value || '25';
            let resultsToShow = currentSearchResults;

            // Apply pagination
            if (pageSize !== 'all') {
                const size = parseInt(pageSize);
                const startIndex = (currentPage - 1) * size;
                resultsToShow = currentSearchResults.slice(startIndex, startIndex + size);
            }

            // Update the view based on current project view mode
            const currentView = currentProjectView || 'list';
            switch(currentView) {
                case 'calendar':
                    renderCalendarView(resultsToShow);
                    break;
                default:
                    displayProjects(resultsToShow);
            }
        }

        function toggleAdvancedFilters() {
            const panel = document.getElementById('advancedFiltersPanel');
            const button = document.getElementById('advancedFilterToggle');

            isAdvancedFiltersVisible = !isAdvancedFiltersVisible;

            if (panel) {
                panel.style.display = isAdvancedFiltersVisible ? 'block' : 'none';
            }

            if (button) {
                button.textContent = isAdvancedFiltersVisible ? '🔧 Hide Filters' : '🔧 Advanced Filters';
            }
        }

        function clearAllFilters() {
            // Clear text search
            const searchInput = document.getElementById('globalProjectSearch');
            if (searchInput) searchInput.value = '';

            // Clear all checkboxes
            document.querySelectorAll('.advanced-filters-panel input[type="checkbox"]').forEach(cb => cb.checked = false);

            // Clear date filters
            const startDateFilter = document.getElementById('startDateFilter');
            const endDateFilter = document.getElementById('endDateFilter');
            if (startDateFilter) startDateFilter.value = '';
            if (endDateFilter) endDateFilter.value = '';

            // Clear budget filters
            const minBudgetFilter = document.getElementById('minBudgetFilter');
            const maxBudgetFilter = document.getElementById('maxBudgetFilter');
            if (minBudgetFilter) minBudgetFilter.value = '';
            if (maxBudgetFilter) maxBudgetFilter.value = '';

            // Reset progress sliders
            const minProgressFilter = document.getElementById('minProgressFilter');
            const maxProgressFilter = document.getElementById('maxProgressFilter');
            if (minProgressFilter) minProgressFilter.value = 0;
            if (maxProgressFilter) maxProgressFilter.value = 100;

            // Reset sort controls
            const sortByField = document.getElementById('sortByField');
            const sortDirection = document.getElementById('sortDirection');
            if (sortByField) sortByField.value = 'name';
            if (sortDirection) sortDirection.value = 'asc';

            // Perform fresh search
            performAdvancedSearch();
        }

        function applyPreset(presetName) {
            // Clear existing filters first
            clearAllFilters();

            const currentDate = new Date();
            const nextMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, currentDate.getDate());

            switch(presetName) {
                case 'overdue':
                    // Show overdue projects
                    document.querySelector('#statusFilters input[value="active"]').checked = true;
                    document.getElementById('endDateFilter').value = currentDate.toISOString().split('T')[0];
                    document.getElementById('sortByField').value = 'dueDate';
                    break;

                case 'active-high':
                    // Show active high priority projects
                    document.querySelector('#statusFilters input[value="active"]').checked = true;
                    document.querySelector('#priorityFilters input[value="high"]').checked = true;
                    document.querySelector('#priorityFilters input[value="critical"]').checked = true;
                    document.getElementById('sortByField').value = 'priority';
                    break;

                case 'near-completion':
                    // Show projects 80%+ complete
                    document.querySelector('#statusFilters input[value="active"]').checked = true;
                    document.getElementById('minProgressFilter').value = 80;
                    document.getElementById('sortByField').value = 'progress';
                    document.getElementById('sortDirection').value = 'desc';
                    break;

                case 'budget-exceeded':
                    // This would need custom logic to compare actual vs estimated budget
                    document.querySelector('#statusFilters input[value="active"]').checked = true;
                    document.getElementById('sortByField').value = 'estimatedBudget';
                    document.getElementById('sortDirection').value = 'desc';
                    break;

                case 'this-month':
                    // Show projects due this month
                    const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                    const endOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
                    document.getElementById('startDateFilter').value = startOfMonth.toISOString().split('T')[0];
                    document.getElementById('endDateFilter').value = endOfMonth.toISOString().split('T')[0];
                    document.getElementById('sortByField').value = 'dueDate';
                    break;
            }

            // Apply the preset
            performAdvancedSearch();

            // Show advanced filters panel if preset was applied
            if (!isAdvancedFiltersVisible) {
                toggleAdvancedFilters();
            }
        }

        function searchProjects() {
            // Legacy function - redirect to new advanced search
            performAdvancedSearch();
        }

        async function refreshProjects() {
            const refreshBtn = event.target;
            refreshBtn.innerHTML = '🔄 Refreshing...';
            refreshBtn.disabled = true;

            try {
                // Load fresh data from backend if in backend mode
                if (isBackendMode()) {
                    await loadProjectsFromBackend();
                }
                
                // Re-render the project grid with fresh data
                await renderProjectsGrid();
                
                refreshBtn.innerHTML = '🔄 Refresh';
                refreshBtn.disabled = false;
                showNotification('Projects refreshed successfully!', 'success');
            } catch (error) {
                console.error('Error refreshing projects:', error);
                refreshBtn.innerHTML = '🔄 Refresh';
                refreshBtn.disabled = false;
                showNotification('Failed to refresh projects', 'error');
            }
        }

        function showCreateProject() {
            const modal = document.createElement('div');
            modal.className = 'project-modal-overlay';
            modal.innerHTML = `
                <div class="project-modal">
                    <div class="modal-header">
                        <h3>Create New Project</h3>
                        <button class="close-btn" onclick="this.closest('.project-modal-overlay').remove()">×</button>
                    </div>
                    <form class="modal-body" onsubmit="createProject(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="projectName">Project Name *</label>
                                <input type="text" id="projectName" name="name" required>
                            </div>
                            <div class="form-group">
                                <label for="requestorInfo">Requestor Information *</label>
                                <input type="text" id="requestorInfo" name="requestorInfo" placeholder="Name, Company, Contact" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="siteLocation">Site/Location *</label>
                                <input type="text" id="siteLocation" name="siteLocation" placeholder="Address or Site Name" required>
                            </div>
                            <div class="form-group">
                                <label for="businessLine">Business Line *</label>
                                <select id="businessLine" name="businessLine" required>
                                    <option value="">Select Bank/Business Line</option>
                                    <option value="barrington">Barrington Bank & Trust Company, N.A.</option>
                                    <option value="beverly">Beverly Bank & Trust Company, N.A.</option>
                                    <option value="crystal-lake">Crystal Lake Bank & Trust Company, N.A.</option>
                                    <option value="hinsdale">Hinsdale Bank & Trust Company, N.A.</option>
                                    <option value="lake-forest">Lake Forest Bank & Trust Company, N.A.</option>
                                    <option value="libertyville">Libertyville Bank & Trust Company, N.A.</option>
                                    <option value="northbrook">Northbrook Bank & Trust Company, N.A.</option>
                                    <option value="old-plank">Old Plank Trail Community Bank, N.A.</option>
                                    <option value="st-charles">St. Charles Bank & Trust Company, N.A.</option>
                                    <option value="schaumburg">Schaumburg Bank & Trust Company, N.A.</option>
                                    <option value="state-lakes">State Bank of the Lakes, N.A.</option>
                                    <option value="town-bank">Town Bank, N.A.</option>
                                    <option value="village">Village Bank & Trust, N.A.</option>
                                    <option value="wheaton">Wheaton Bank & Trust Company, N.A.</option>
                                    <option value="company">[Company Name]</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="projectDescription">Project Description</label>
                            <textarea id="projectDescription" name="description" rows="3" placeholder="Detailed project requirements and scope"></textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="projectType">Project Type *</label>
                                <select id="projectType" name="type" required>
                                    <option value="">Select Project Type</option>
                                    <option value="new-build">New Build</option>
                                    <option value="upgrade">Upgrade</option>
                                    <option value="breakfix">BreakFix</option>
                                    <option value="refresh">Refresh</option>
                                    <option value="custom">Custom Project</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="projectStatusA">Initial Status</label>
                                <select id="projectStatusA" name="status">
                                    <option value="draft" selected>📝 Draft</option>
                                    <option value="active">🟢 Active</option>
                                    <option value="on-hold">⏸️ On Hold</option>
                                </select>
                                <small class="form-help">Default is Draft - will auto-update based on tasks</small>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="projectPriority">Priority</label>
                                <select id="projectPriority" name="priority">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="critical">Critical</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="requestDate">Request Date *</label>
                                <input type="date" id="requestDate" name="requestDate" value="${new Date().toISOString().split('T')[0]}" required>
                            </div>
                            <div class="form-group">
                                <label for="projectStartDate">Start Date</label>
                                <input type="date" id="projectStartDate" name="startDate">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="dueDate">Due Date *</label>
                                <input type="date" id="dueDate" name="dueDate" required>
                            </div>
                            <div class="form-group">
                                <label for="estimatedBudget">Estimated Budget *</label>
                                <input type="number" id="estimatedBudget" name="estimatedBudget" min="0" step="100" placeholder="0" required>
                            </div>
                        </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="actualBudget">Initial Actual Budget</label>
                                    <input type="number" id="actualBudget" name="actualBudget" min="0" step="100" placeholder="0">
                                </div>
                                <div class="form-group"><!-- spacer --></div>
                            </div>


                        <div class="form-row">
                            <div class="form-group">
                                <label for="projectStatusB">Initial Status</label>
                                <select id="projectStatusB" name="status">
                                    <option value="draft">Draft</option>
                                    <option value="active" selected>Active</option>
                                    <option value="on-hold">On Hold</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="includeDefaultTasks">
                                    <input type="checkbox" id="includeDefaultTasks" name="includeDefaultTasks" checked>
                                    Include default phase tasks (44 standard AV installation tasks)
                                </label>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.project-modal-overlay').remove()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Create Project</button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function generateDefaultTasks() {
            const phases = [
                {
                    name: "1. Design Phase",
                    tasks: [
                        { name: "Site survey and requirements gathering", duration: 2 },
                        { name: "System design and architecture", duration: 3 },
                        { name: "Equipment specification and selection", duration: 2 },
                        { name: "Detailed drawings and schematics", duration: 3 },
                        { name: "Design review and approval", duration: 1 }
                    ]
                },
                {
                    name: "2. Pre-Installation Phase",
                    tasks: [
                        { name: "Equipment procurement", duration: 5 },
                        { name: "Rack and infrastructure preparation", duration: 2 },
                        { name: "Cable pathway planning", duration: 1 },
                        { name: "Power requirements verification", duration: 1 },
                        { name: "Network infrastructure setup", duration: 2 }
                    ]
                },
                {
                    name: "3. Installation Phase - Infrastructure",
                    tasks: [
                        { name: "Equipment rack installation", duration: 1 },
                        { name: "Power distribution setup", duration: 1 },
                        { name: "Cable management system installation", duration: 1 },
                        { name: "HVAC and cooling verification", duration: 1 },
                        { name: "Grounding and bonding", duration: 1 }
                    ]
                },
                {
                    name: "4. Installation Phase - Core Equipment",
                    tasks: [
                        { name: "Core switching equipment installation", duration: 2 },
                        { name: "Video processing equipment mounting", duration: 2 },
                        { name: "Audio DSP installation", duration: 1 },
                        { name: "Control system processor setup", duration: 1 },
                        { name: "Storage and recording systems", duration: 1 }
                    ]
                },
                {
                    name: "5. Installation Phase - Endpoints",
                    tasks: [
                        { name: "Display mounting and alignment", duration: 2 },
                        { name: "Camera installation and positioning", duration: 2 },
                        { name: "Speaker placement and mounting", duration: 2 },
                        { name: "Microphone installation", duration: 1 },
                        { name: "User interface panels installation", duration: 1 }
                    ]
                },
                {
                    name: "6. Cabling and Termination",
                    tasks: [
                        { name: "Structured cabling installation", duration: 3 },
                        { name: "Video cable runs and termination", duration: 2 },
                        { name: "Audio cable runs and termination", duration: 2 },
                        { name: "Control wiring and termination", duration: 1 },
                        { name: "Cable testing and certification", duration: 1 }
                    ]
                },
                {
                    name: "7. Configuration and Programming",
                    tasks: [
                        { name: "Network configuration", duration: 1 },
                        { name: "Video system configuration", duration: 2 },
                        { name: "Audio DSP programming", duration: 2 },
                        { name: "Control system programming", duration: 3 },
                        { name: "User interface customization", duration: 2 }
                    ]
                },
                {
                    name: "8. Testing and Commissioning",
                    tasks: [
                        { name: "Individual system testing", duration: 2 },
                        { name: "Integrated system testing", duration: 2 },
                        { name: "Performance optimization", duration: 1 },
                        { name: "User acceptance testing", duration: 1 },
                        { name: "Punch list completion", duration: 2 }
                    ]
                },
                {
                    name: "9. Training and Handover",
                    tasks: [
                        { name: "End-user training", duration: 1 },
                        { name: "Administrator training", duration: 1 },
                        { name: "Documentation delivery", duration: 1 },
                        { name: "As-built drawings", duration: 1 },
                        { name: "Project handover and sign-off", duration: 1 }
                    ]
                }
            ];

            const allTasks = [];
            let taskId = 1;
            
            phases.forEach((phase, phaseIndex) => {
                // Add phase as a parent task
                const phaseTask = {
                    id: `task-${Date.now()}-${taskId++}`,
                    name: phase.name,
                    description: `Phase ${phaseIndex + 1} of the AV installation project`,
                    status: 'pending',
                    ragStatus: 'green',
                    priority: 'medium',
                    progress: 0,
                    subtasks: []
                };
                
                // Add individual tasks as subtasks
                phase.tasks.forEach(task => {
                    const subtask = {
                        id: `task-${Date.now()}-${taskId++}`,
                        name: task.name,
                        description: '',
                        status: 'pending',
                        ragStatus: 'green',
                        priority: 'medium',
                        estimatedHours: task.duration * 8, // Convert days to hours
                        progress: 0
                    };
                    phaseTask.subtasks.push(subtask);
                });
                
                allTasks.push(phaseTask);
            });
            
            return allTasks;
        }

        async function createProject(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            // Generate default phase tasks if checkbox is checked
            const generateDefaultTasks = () => {
                const tasks = [];
                let taskId = 1;

                projectPhases.forEach(phase => {
                    phase.defaultTasks.forEach(taskName => {
                        tasks.push({
                            id: `task_${Date.now()}_${taskId++}`,
                            name: taskName,
                            description: '',
                            status: 'not-started',
                            ragStatus: 'green',  // Changed to green by default
                            phase: phase.id,
                            priority: 'medium',
                            assignee: '',
                            estimatedHours: null,
                            startDate: null,
                            endDate: null,
                            notes: '',
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        });
                    });
                });

                return tasks;
            };

            const includeDefaultTasks = formData.get('includeDefaultTasks') === 'on';

            const projectData = {
                id: `proj-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                name: formData.get('name'),
                requestorInfo: formData.get('requestorInfo'),
                siteLocation: formData.get('siteLocation'),
                businessLine: formData.get('businessLine'),
                description: formData.get('description'),
                type: formData.get('type'),
                priority: formData.get('priority'),
                requestDate: formData.get('requestDate'),
                startDate: formData.get('startDate'),
                dueDate: formData.get('dueDate'),
                endDate: formData.get('dueDate'), // Using dueDate as endDate for compatibility
                estimatedBudget: parseFloat(formData.get('estimatedBudget')) || 0,
                actualBudget: parseFloat(formData.get('actualBudget')) || 0,
                status: formData.get('status'),
                progress: 0,
                tasks: includeDefaultTasks ? generateDefaultTasks() : []
            };

            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.innerHTML = 'Creating...';
            submitBtn.disabled = true;

            try {
                if (isBackendMode()) {
                    const payload = toBackendProjectPayload(projectData);
                    const data = await apiFetch('/projects', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    let newProject = data.project || data;

                    // Update UI immediately
                    AppState.projects.unshift(newProject);
                    try { auditLogEvent({ action: 'project.create', entity: 'project', entityId: newProject.id, entityName: newProject.name, after: newProject, details: 'Created via backend' }); } catch(_) {}
                    showNotification('Project created successfully (backend)!', 'success');

                    // If default tasks requested and backend did not return them, create in background
                    if (includeDefaultTasks) {
                        const tasksReturned = getTasks(newProject);
                        const defaultTasks = projectData.tasks || [];
                        if (tasksReturned.length === 0 && defaultTasks.length > 0) {
                            (async () => {
                                try {
                                    const createOne = async (t) => {
                                        const attempts = [
                                            { name: t.name, status: t.status || 'not-started' },
                                            { name: t.name }
                                        ];
                                        for (const payload of attempts) {
                                            try {
                                                await apiFetch(`/projects/${newProject.id}/tasks`, { method: 'POST', body: JSON.stringify(payload) });
                                                return true;
                                            } catch (e) {
                                                // try next payload shape
                                            }
                                        }
                                        console.error('Default task create failed for:', t.name);
                                        return false;
                                    };

                                    const results = await Promise.allSettled(defaultTasks.map(t => createOne(t)));
                                    const anySuccess = results.some(r => r.status === 'fulfilled' && r.value === true);
                                    if (anySuccess) {
                                        // Reload projects from backend to get the updated project with tasks
                                        await loadProjectsFromBackend();
                                        // Re-render the grid to show the updated projects
                                        await renderProjectsGrid();
                                        showNotification('Default tasks added to project', 'success');
                                    } else {
                                        showNotification('Failed to add default tasks (see console)', 'error');
                                    }
                                } catch (bgErr) {
                                    console.error('Background default task creation encountered errors:', bgErr);
                                }
                            })();
                        }
                    } else {
                        // No default tasks, but still reload to ensure consistency
                        setTimeout(async () => {
                            await loadProjectsFromBackend();
                            await renderProjectsGrid();
                        }, 100);
                    }
                } else {
                    // Offline (no backend): create project locally with default tasks
                    const id = 'p_' + Date.now();
                    const newProject = { id, ...projectData, tasks: getTasks({ tasks: projectData.tasks }) };
                    AppState.projects = [newProject, ...(AppState.projects || [])];
                    showNotification('Project created (offline mode)', 'success');
                }
            } catch (error) {
                console.error('Error creating project:', error);
                showNotification('Failed to create project. Please try again.', 'error');
                submitBtn.innerHTML = 'Create Project';
                submitBtn.disabled = false;
                return;
            }

            // Close modal and refresh projects from backend
            form.closest('.project-modal-overlay').remove();
            
            // Always reload from backend to ensure we have the complete project with all data
            if (isBackendMode()) {
                await loadProjectsFromBackend();
            }
            await renderProjectsGrid();
        }

        function viewProject(projectId) {


            const project = AppState.projects.find(p => p.id === projectId);

            if (!project) {
                showNotification('Project not found: ' + projectId, 'error');
                return;
            }

            // Create modal overlay
            const modal = document.createElement('div');
            modal.className = 'project-modal-overlay';

            modal.innerHTML = `
                <div class="project-modal">
                    <div class="modal-header">
                        <h3>📋 ${project.name}</h3>
                        <button class="close-btn" onclick="this.closest('.project-modal-overlay').remove()">×</button>
                    </div>

                    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                        <div class="project-info">
                            <div class="info-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                                <div><strong>Status:</strong> <span class="status-badge ${project.status}">${formatStatus(project.status)}</span></div>
                                <div><strong>Progress:</strong> ${project.progress || 0}%</div>
                                <div><strong>Requestor:</strong> ${project.requestorInfo || 'N/A'}</div>
                                <div><strong>Business Line:</strong> ${formatBusinessLine(project.businessLine)}</div>
                                <div><strong>Location:</strong> ${project.siteLocation || 'N/A'}</div>
                                <div><strong>Type:</strong> ${formatProjectType(project.type)}</div>
                                <div><strong>Est Budget:</strong> $${(project.estimatedBudget || 0).toLocaleString()}</div>
                                <div><strong>Actual Budget:</strong> $${(project.actualBudget || 0).toLocaleString()}</div>
                                <div><strong>Variance:</strong> ${project.estimatedBudget && project.actualBudget ? Math.round(((project.actualBudget - project.estimatedBudget) / project.estimatedBudget) * 100) + '%' : 'N/A'}</div>
                                <div><strong>Start Date:</strong> ${project.startDate ? formatDate(project.startDate) : 'N/A'}</div>
                            </div>

                            ${project.description ? `<div><strong>Description:</strong> ${project.description}</div>` : ''}
                        </div>

                        <div class="project-tasks">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin: 1.5rem 0 1rem 0;">
                                <h4>📋 Tasks (${getTasks(project).length})</h4>
                                <button class="btn btn-primary" onclick="addNewTask('${projectId}')">+ Add Task</button>
                            </div>

                            <div id="projectTasks-${projectId}">
                                ${getTasks(project).length > 0 ?
                                    getTasks(project).map(task => {
                                        const ragInfo = {
                                            'green': { icon: '🟢', label: 'Green', class: 'rag-green' },
                                            'yellow': { icon: '🟡', label: 'Yellow', class: 'rag-yellow' },
                                            'red': { icon: '🔴', label: 'Red', class: 'rag-red' }
                                        };
                                        const rag = ragInfo[task.ragStatus] || ragInfo.yellow;
                                        const phaseInfo = derivePhaseInfo(task.phase);

                                        return `
                                        <div class=\"task-item\" onclick=\"viewTask('${projectId}', '${task.id}')\" style=\"cursor: pointer; border: 1px solid var(--gray-200); padding: 1rem; margin: 0.5rem 0; border-radius: 0.5rem; background: var(--gray-50);\">
                                            <div style=\"display: flex; justify-content: space-between; align-items: flex-start;\">
                                                <div style=\"flex: 1;\">
                                                    <div style=\"display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;\">
                                                        <h5 style=\"margin: 0;\">${task.name}</h5>
                                                        <span class=\"${rag.class}\" style=\"font-size: 0.8rem;\">${rag.icon} ${rag.label}</span>
                                                        ${task.status === 'completed' ? '<span style=\"color: var(--success-500); font-size: 0.8rem;\">✅ Completed</span>' : ''}
                                                    </div>
                                                    <p style=\"color: var(--gray-600); font-size: 0.875rem; margin: 0 0 0.5rem 0;\">${task.description || 'No description'}</p>
                                                    <div style=\"display: flex; gap: 1rem; font-size: 0.8rem; color: var(--gray-500); margin-bottom: 0.5rem;\">
                                                        <span class=\"phase-badge ${phaseInfo.class}\">${phaseInfo.name}</span>
                                                        <span><strong>Status:</strong> <span class=\"status-badge ${task.status}\">${formatStatus(task.status)}</span></span>
                                                        ${task.assignee ? `<span><strong>Assigned:</strong> ${task.assignee}</span>` : ''}
                                                        ${task.priority ? `<span><strong>Priority:</strong> ${task.priority}</span>` : ''}
                                                        ${task.estimatedHours ? `<span><strong>Est Hours:</strong> ${task.estimatedHours}h</span>` : ''}
                                                    </div>
                                                    ${(() => {
                                                        const timeData = task.timeTracking || {};
                                                        const totalHours = timeData.totalTime ? (timeData.totalTime / (1000 * 60 * 60)).toFixed(1) : '0.0';
                                                        const sessionCount = (timeData.sessions || []).length;
                                                        const avgSession = timeData.averageSessionLength ? (timeData.averageSessionLength / (1000 * 60)).toFixed(0) : '0';
                                                        const productivity = timeData.productivityRating || 0;
                                                        const isActive = productivityMonitor?.metrics?.activeTaskId === task.id;
                                                        
                                                        if (timeData.totalTime > 0 || sessionCount > 0 || isActive) {
                                                            return `
                                                                <div style="background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%); border: 1px solid #d1e7ff; border-radius: 6px; padding: 0.75rem; margin-bottom: 0.5rem;">
                                                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                                                        <span style="color: #1e40af; font-weight: 600; font-size: 0.85rem;">⏱️ Time Tracking</span>
                                                                        ${isActive ? '<span style="background: #10b981; color: white; padding: 0.15rem 0.4rem; border-radius: 12px; font-size: 0.7rem; font-weight: 500;">🟢 ACTIVE</span>' : ''}
                                                                    </div>
                                                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem; font-size: 0.75rem;">
                                                                        <div style="background: white; padding: 0.4rem; border-radius: 4px; border-left: 3px solid #3b82f6;">
                                                                            <div style="color: #6b7280; font-weight: 500;">Total Time</div>
                                                                            <div style="color: #1f2937; font-weight: 600;">${totalHours}h</div>
                                                                        </div>
                                                                        <div style="background: white; padding: 0.4rem; border-radius: 4px; border-left: 3px solid #8b5cf6;">
                                                                            <div style="color: #6b7280; font-weight: 500;">Sessions</div>
                                                                            <div style="color: #1f2937; font-weight: 600;">${sessionCount}</div>
                                                                        </div>
                                                                        <div style="background: white; padding: 0.4rem; border-radius: 4px; border-left: 3px solid #06b6d4;">
                                                                            <div style="color: #6b7280; font-weight: 500;">Avg Session</div>
                                                                            <div style="color: #1f2937; font-weight: 600;">${avgSession}m</div>
                                                                        </div>
                                                                        <div style="background: white; padding: 0.4rem; border-radius: 4px; border-left: 3px solid ${productivity >= 7 ? '#10b981' : productivity >= 4 ? '#f59e0b' : '#ef4444'};">
                                                                            <div style="color: #6b7280; font-weight: 500;">Productivity</div>
                                                                            <div style="color: #1f2937; font-weight: 600;">${productivity}/10</div>
                                                                        </div>
                                                                    </div>
                                                                    ${timeData.lastWorked ? `
                                                                        <div style="margin-top: 0.5rem; font-size: 0.7rem; color: #6b7280;">
                                                                            Last worked: ${new Date(timeData.lastWorked).toLocaleDateString()} ${new Date(timeData.lastWorked).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                                                        </div>
                                                                    ` : ''}
                                                                    ${task.estimatedHours && timeData.totalTime ? `
                                                                        <div style="margin-top: 0.5rem;">
                                                                            <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: #6b7280; margin-bottom: 0.2rem;">
                                                                                <span>Progress vs Estimate</span>
                                                                                <span>${((parseFloat(totalHours) / task.estimatedHours) * 100).toFixed(0)}%</span>
                                                                            </div>
                                                                            <div style="background: #e5e7eb; height: 4px; border-radius: 2px; overflow: hidden;">
                                                                                <div style="background: ${parseFloat(totalHours) <= task.estimatedHours ? '#10b981' : '#ef4444'}; height: 100%; width: ${Math.min(100, (parseFloat(totalHours) / task.estimatedHours) * 100)}%; transition: width 0.3s ease;"></div>
                                                                            </div>
                                                                        </div>
                                                                    ` : ''}
                                                                </div>
                                                            `;
                                                        }
                                                        return '';
                                                    })()}
                                                    ${task.notes ? `
                                                        <div style=\"background: #f8f9fa; padding: 0.5rem; border-radius: 0.25rem; margin-top: 0.5rem;\">
                                                            <strong style=\"font-size: 0.8rem; color: var(--gray-700);\">PM Notes:</strong>
                                                            <p style=\"font-size: 0.8rem; color: var(--gray-600); margin: 0.25rem 0 0 0;\">${task.notes}</p>
                                                        </div>
                                                    ` : ''}
                                                    ${task.completedDate ? `
                                                        <div style=\"font-size: 0.75rem; color: var(--success-600); margin-top: 0.5rem;\">
                                                            ✅ Completed: ${formatDate(task.completedDate)}
                                                        </div>
                                                    ` : ''}

                                                    <div class=\"task-notes\" style=\"margin-top: 0.5rem; background: #fff; border: 1px solid var(--gray-200); border-radius: 6px; padding: 0.5rem; ${hasPermission('tasks.notes.view') ? '' : 'display:none;'}\" onclick=\"event.stopPropagation();\">
                                                        <div style=\"display:flex; justify-content: space-between; align-items:center; margin-bottom: 0.25rem;\">
                                                            <strong style=\"font-size: 0.8rem; color: var(--gray-800);\">📝 Notes</strong>
                                                            <small style=\"color: var(--gray-500);\">${(task.notesThread || []).length} entries</small>
                                                        </div>
                                                        <div id=\"notesList-${projectId}-${task.id}\" style=\"display:flex; flex-direction:column; gap:6px;\">
                                                            ${(() => {
                                                                const thread = Array.isArray(task.notesThread) ? task.notesThread : [];
                                                                const items = thread.slice(-2);
                                                                if (items.length === 0) return '<div style=\'color: var(--gray-500); font-size: 0.8rem;\'>No notes yet.</div>';
                                                                return items.map(n => `
                                                                    <div style=\"border-left: 3px solid var(--primary-300); padding-left: 0.5rem;\">
                                                                        <div style=\"font-size: 0.75rem; color: var(--gray-600);\">${new Date(n.timestamp).toLocaleString()} — <strong>${(n.author || 'Someone')}</strong>${n.role ? ` (${n.role})` : ''}</div>
                                                                        <div style=\"font-size: 0.85rem; color: var(--gray-800); white-space: pre-wrap;\">${(n.content || '').replace(/</g,'&lt;')}</div>
                                                                    </div>
                                                                `).join('');
                                                            })()}
                                                            ${(Array.isArray(task.notesThread) && task.notesThread.length > 2) ? `<a href=\"#\" style=\"font-size:0.8rem;\" onclick=\"event.preventDefault(); showAllTaskNotes('${projectId}','${task.id}')\">View all notes</a>` : ''}
                                                        </div>
                                                        ${hasPermission('tasks.notes.edit') ? `
                                                            <div style=\"margin-top: 0.5rem; display:flex; gap:0.5rem;\">
                                                                <input id=\"noteInput-${projectId}-${task.id}\" class=\"form-control\" placeholder=\"Add a note...\" style=\"flex:1;\">
                                                                <button class=\"btn btn-secondary btn-sm\" onclick=\"window.submitTaskNote('${projectId}','${task.id}')\">Add</button>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                                <div style=\"display: flex; flex-direction: column; gap: 0.5rem;\">
                                                    ${task.status !== 'completed' ?
                                                        `<button class=\"btn btn-success btn-sm\" onclick=\"event.stopPropagation(); completeTask('${projectId}', '${task.id}')\" title=\"Mark Complete\">✅ Complete</button>` :
                                                        `<button class=\"btn btn-warning btn-sm\" onclick=\"event.stopPropagation(); reopenTask('${projectId}', '${task.id}')\" title=\"Reopen Task\">🔄 Reopen</button>`
                                                    }
                                                    ${task.status !== 'completed' ? 
                                                        `<button class=\"btn btn-primary btn-sm\" onclick=\"event.stopPropagation(); startWorkSession('${task.id}', '${projectId}')\" title=\"Start Work Session\">🎯 Start Work</button>` : ''
                                                    }
                                                    ${task.status !== 'completed' ? 
                                                        `<button class="btn btn-info btn-sm" onclick="event.stopPropagation(); scheduleFieldWorkFromTask('${projectId}', '${task.id}')" title="Schedule Field Work">🛠️ Schedule Field</button>` : ''
                                                    }
                                                    <button class=\"btn btn-secondary btn-sm\" onclick=\"event.stopPropagation(); editTask('${projectId}', '${task.id}')\" title=\"Edit Task\">✏️ Edit</button>
                                                    <button class=\"btn btn-danger btn-sm\" onclick=\"event.stopPropagation(); deleteTask('${projectId}', '${task.id}')\" title=\"Delete Task\">🗑️ Delete</button>
                                                </div>
                                            </div>
                                        </div>
                                        `;
                                    }).join('')
                                    : '<div style="text-align: center; padding: 2rem; color: var(--gray-500);"><p>No tasks yet. Click "Add Task" to get started.</p></div>'
                                }
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        ${AppState.user && ['admin','owner','project_manager'].includes(((AppState.user.Role?.name || AppState.user.role || '') + '').toLowerCase().replace('-', '_')) ?
                            `<button class="btn btn-secondary" onclick="editProject('${projectId}')">Edit Project</button>` : ''
                        }
                        <button class="btn btn-secondary" onclick="this.closest('.project-modal-overlay').remove()">Close</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

        }

        function renderProjectTasks(tasks, projectId) {
            if (!tasks || tasks.length === 0) {
                return `
                    <div class="no-tasks">
                        <div class="no-tasks-icon">📋</div>
                        <p>No tasks created yet.</p>
                        <p class="text-muted">Click "Add Task" to get started.</p>
                    </div>
                `;
            }

            // Helper function to get phase name and badge class
            const getPhaseInfo = (phaseId) => {
                const phase = projectPhases.find(p => p.id === phaseId);
                const phaseClass = phaseId ? phaseId.replace('_', '-') : 'phase-1';
                return {
                    name: phase ? phase.name : 'Pre-installation - Logistics',
                    class: phaseClass
                };
            };

            return tasks.map(task => {
                const phaseInfo = getPhaseInfo(task.phase);
                return `
                    <div class="task-item" data-task-id="${task.id}">
                        <div class="task-header">
                            <div class="task-info">
                                <h5 class="task-name">${task.name}</h5>
                                <div class="task-meta">
                                    <span class="phase-badge ${phaseInfo.class}">${phaseInfo.name}</span>
                                    <span class="task-status ${task.status}">${formatStatus(task.status)}</span>
                                    ${task.priority ? `<span class="task-priority ${task.priority}">${formatStatus(task.priority)}</span>` : ''}
                                    ${task.assignee ? `<span class="task-assignee">👤 ${task.assignee}</span>` : ''}
                                </div>
                            </div>
                            <div class="task-actions">
                                <button class="btn-icon" onclick="editTask('${projectId}', '${task.id}')" title="Edit Task">✏️</button>
                                <button class="btn-icon" onclick="deleteTask('${projectId}', '${task.id}')" title="Delete Task">🗑️</button>
                            </div>
                        </div>
                        ${task.description ? `<p class="task-description">${task.description}</p>` : ''}
                        <div class="task-details">
                            ${task.startDate ? `<span class="task-detail">📅 ${formatDate(task.startDate)}</span>` : ''}
                            ${task.endDate ? `<span class="task-detail">⏰ ${formatDate(task.endDate)}</span>` : ''}
                            ${task.estimatedHours ? `<span class="task-detail">⏱️ ${task.estimatedHours}h</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addNewTask(projectId) {
            const modal = document.createElement('div');
            modal.className = 'project-modal-overlay task-modal-overlay';
            modal.innerHTML = `
                <div class="project-modal task-modal">
                    <div class="modal-header">
                        <h3>Add New Task</h3>
                        <button class="close-btn" onclick="this.closest('.task-modal-overlay').remove()">×</button>
                    </div>
                    <form class="modal-body" onsubmit="createTask(event, '${projectId}')">
                        <div class="form-group">
                            <label for="taskName">Task Name *</label>
                            <input type="text" id="taskName" name="name" required>
                        </div>

                        <div class="form-group">
                            <label for="taskDescription">Description</label>
                            <textarea id="taskDescription" name="description" rows="3"></textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="taskStatus">Status</label>
                                <select id="taskStatus" name="status">
                                    <option value="not-started">Not Started</option>
                                    <option value="in-progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                    <option value="on-hold">On Hold</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="taskRAGStatus">RAG Status</label>
                                <select id="taskRAGStatus" name="ragStatus">
                                    <option value="green" selected>🟢 Green - On Track</option>
                                    <option value="yellow">🟡 Yellow - At Risk</option>
                                    <option value="red">🔴 Red - Critical Issues</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="taskPhase">Phase</label>
                                <select id="taskPhase" name="phase">
                                    <option value="phase_1">Pre-installation - Logistics</option>
                                    <option value="phase_2">Pre-Installation - AV Setup</option>
                                    <option value="phase_3">Post-Installation Commissioning</option>
                                    <option value="phase_4">Post-Installation - Logistics</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="taskPriority">Priority</label>
                                <select id="taskPriority" name="priority">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="critical">Critical</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="taskAssignee">Assignee</label>
                                <input type="text" id="taskAssignee" name="assignee" placeholder="Assigned to">
                            </div>
                            <div class="form-group">
                                <!-- Empty for layout -->
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="taskEstimatedHours">Estimated Hours</label>
                                <input type="number" id="taskEstimatedHours" name="estimatedHours" min="0" step="0.5">
                            </div>
                            <div class="form-group">
                                <!-- Empty for layout -->
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="taskStartDate">Start Date</label>
                                <input type="date" id="taskStartDate" name="startDate">
                            </div>
                            <div class="form-group">
                                <label for="taskEndDate">End Date</label>
                                <input type="date" id="taskEndDate" name="endDate">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="taskNotes">PM Notes</label>
                            <textarea id="taskNotes" name="notes" rows="4" placeholder="Project manager notes and updates..."></textarea>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.task-modal-overlay').remove()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Add Task</button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);
        }

        async function createTask(event, projectId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            const taskData = {
                id: 'task_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                name: formData.get('name'),
                description: formData.get('description'),
                status: formData.get('status'),
                ragStatus: formData.get('ragStatus') || 'green',  // Changed default to green
                phase: formData.get('phase') || 'phase_1',
                priority: formData.get('priority'),
                assignee: formData.get('assignee'),
                estimatedHours: parseFloat(formData.get('estimatedHours')) || null,
                startDate: formData.get('startDate'),
                endDate: formData.get('endDate'),
                notes: formData.get('notes') || '',
                notesThread: [],
                completedDate: formData.get('status') === 'completed' ? new Date().toISOString() : null,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.innerHTML = 'Adding...';
            submitBtn.disabled = true;

            try {
                // Find the project and add the task
                const projectIndex = AppState.projects.findIndex(p => p.id === projectId);
                if (projectIndex !== -1) {
                    if (!AppState.projects[projectIndex].tasks) {
                        AppState.projects[projectIndex].tasks = [];
                    }

                    if (!isBackendMode()) { showNotification('Backend connection required', 'error'); submitBtn.innerHTML = 'Add Task'; submitBtn.disabled = false; return; }
                    try {
                        const data = await apiFetch(`/projects/${projectId}/tasks`, {
                            method: 'POST',
                            body: JSON.stringify(taskData)
                        });
                        const newTask = data.task || taskData;
                        AppState.projects[projectIndex].tasks.push(newTask);
                        try { auditLogEvent({ action: 'task.create', entity: 'task', entityId: newTask.id, entityName: newTask.name, after: newTask, details: 'Task created via backend', meta: { projectId } }); } catch(_) {}
                    } catch (e) {
                        console.error('Failed to add task to backend:', e);
                        showNotification('Failed to add task to backend', 'error');
                        submitBtn.innerHTML = 'Add Task';
                        submitBtn.disabled = false;
                        return;
                    }

                    // Recalculate project progress and status
                    const project = AppState.projects[projectIndex];
                    project.progress = calculateProjectProgress(project);
                    project.status = calculateProjectStatus(project);
                    project.updatedAt = new Date().toISOString();



                    showNotification('Task added successfully!', 'success');
                    form.closest('.task-modal-overlay').remove();

                    // Refresh the task list in the project detail view
                    const tasksContainer = document.getElementById(`projectTasks-${projectId}`);
                    if (tasksContainer) {
                        tasksContainer.innerHTML = renderProjectTasks(AppState.projects[projectIndex].tasks, projectId);
                    }

                    // Refresh other views if visible
                    if (AppState.currentView === 'projects') {
                        renderProjectsGrid();
                    } else if (AppState.currentView === 'dashboard') {
                        loadDashboard();
                    }

                    } else {
                        throw new Error('Project not found');
                    }
                } catch (error) {
                    console.error('Error adding task:', error);
                    showNotification('Failed to add task. Please try again.', 'error');
                    submitBtn.innerHTML = 'Add Task';
                    submitBtn.disabled = false;
                }
            }


        // View-only task details modal with phase and RAG
        window.viewTask = function viewTask(projectId, taskId) {
            const project = (AppState.projects || []).find(p => String(p.id) === String(projectId));
            const task = project?.tasks?.find(t => String(t.id) === String(taskId));
            if (!task) { showNotification('Task not found', 'error'); return; }

            const ragInfo = {
                'green': { icon: '🟢', label: 'Green', class: 'rag-green' },
                'yellow': { icon: '🟡', label: 'Yellow', class: 'rag-yellow' },
                'red': { icon: '🔴', label: 'Red', class: 'rag-red' }
            };
            const rag = ragInfo[task.ragStatus] || ragInfo.yellow;
            const phaseInfo = derivePhaseInfo(task.phase);

            const modal = document.createElement('div');
            modal.className = 'project-modal-overlay task-modal-overlay';
            modal.innerHTML = `
                <div class="project-modal task-modal">
                    <div class="modal-header">
                        <h3>Task Details</h3>
                        <button class="close-btn" onclick="this.closest('.task-modal-overlay').remove()">×</button>
                    </div>
                    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                        <h4 style="margin-top: 0;">${task.name}</h4>
                        <div style="display: flex; gap: 0.5rem; align-items: center; margin: 0.5rem 0 1rem 0;">
                            <span class="phase-badge ${phaseInfo.class}">${phaseInfo.name}</span>
                            <span class="${rag.class}">${rag.icon} ${rag.label}</span>
                            <span class="status-badge ${task.status}">${formatStatus(task.status)}</span>
                        </div>
                        ${task.description ? `<p style="color: var(--gray-700);">${task.description}</p>` : ''}
                        <div class="info-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                            ${task.assignee ? `<div><strong>Assigned:</strong> ${task.assignee}</div>` : ''}
                            ${task.priority ? `<div><strong>Priority:</strong> ${formatStatus(task.priority)}</div>` : ''}
                            ${task.estimatedHours ? `<div><strong>Est. Hours:</strong> ${task.estimatedHours}h</div>` : ''}
                            ${task.startDate ? `<div><strong>Start:</strong> ${formatDate(task.startDate)}</div>` : ''}
                            ${task.endDate ? `<div><strong>End:</strong> ${formatDate(task.endDate)}</div>` : ''}
                        </div>
                        ${task.notes ? `
                            <div style="background: #f8f9fa; padding: 0.5rem; border-radius: 0.25rem; margin-top: 1rem;">
                                <strong style="font-size: 0.85rem; color: var(--gray-700);">PM Notes</strong>
                                <p style="font-size: 0.9rem; color: var(--gray-700); margin: 0.25rem 0 0 0;">${task.notes}</p>
                            </div>
                        ` : ''}

                        <div class="task-notes" style="margin-top: 0.75rem; background: #fff; border: 1px solid var(--gray-200); border-radius: 6px; padding: 0.5rem; ${hasPermission('tasks.notes.view') ? '' : 'display:none;'}">
                            <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 0.25rem;">
                                <strong style="font-size: 0.85rem; color: var(--gray-800);">📝 Notes</strong>
                                <small style="color: var(--gray-500);">${(task.notesThread || []).length} entries</small>
                            </div>
                            <div id="notesListModal-${projectId}-${taskId}" style="display:flex; flex-direction:column; gap:6px;">
                                ${(() => {
                                    const thread = Array.isArray(task.notesThread) ? task.notesThread : [];
                                    const items = thread.slice(-3);
                                    if (items.length === 0) return '<div style=\'color: var(--gray-500); font-size: 0.9rem;\'>No notes yet.</div>';
                                    return items.map(n => `
                                        <div style=\"border-left: 3px solid var(--primary-300); padding-left: 0.5rem;\">
                                            <div style=\"font-size: 0.8rem; color: var(--gray-600);\">${new Date(n.timestamp).toLocaleString()} — <strong>${(n.author || 'Someone')}</strong>${n.role ? ` (${n.role})` : ''}</div>
                                            <div style=\"font-size: 0.9rem; color: var(--gray-900); white-space: pre-wrap;\">${(n.content || '').replace(/</g,'&lt;')}</div>
                                        </div>
                                    `).join('');
                                })()}
                                ${(Array.isArray(task.notesThread) && task.notesThread.length > 3) ? `<a href=\"#\" style=\"font-size:0.85rem;\" onclick=\"event.preventDefault(); showAllTaskNotes('${projectId}','${taskId}')\">View all notes</a>` : ''}
                            </div>
                            ${hasPermission('tasks.notes.edit') ? `
                                <div style=\"margin-top: 0.5rem; display:flex; gap:0.5rem;\">
                                    <input id=\"noteInputModal-${projectId}-${taskId}\" class=\"form-control\" placeholder=\"Add a note...\" style=\"flex:1;\">
                                    <button class=\"btn btn-secondary btn-sm\" onclick=\"window.submitTaskNote('${projectId}','${taskId}')\">Add</button>
                                </div>
                            ` : ''}
                        </div>

                        ${task.completedDate ? `
                            <div style="font-size: 0.85rem; color: var(--success-700); margin-top: 0.75rem;">
                                ✅ Completed: ${formatDate(task.completedDate)}
                            </div>
                        ` : ''}
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.task-modal-overlay').remove()">Close</button>
                        <button class="btn btn-primary" onclick="this.closest('.task-modal-overlay').remove(); editTask('${projectId}', '${taskId}')">Edit Task</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }



        function editTask(projectId, taskId) {
            const project = AppState.projects.find(p => p.id === projectId);
            const task = project?.tasks?.find(t => t.id === taskId);

            if (!task) {
                showNotification('Task not found', 'error');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'project-modal-overlay task-modal-overlay';
            modal.innerHTML = `
                <div class="project-modal task-modal">
                    <div class="modal-header">
                        <h3>Edit Task</h3>
                        <button class="close-btn" onclick="this.closest('.task-modal-overlay').remove()">×</button>
                    </div>
                    <form class="modal-body" onsubmit="updateTask(event, '${projectId}', '${taskId}')">
                        <div class="form-group">
                            <label for="editTaskName">Task Name *</label>
                            <input type="text" id="editTaskName" name="name" value="${task.name}" required>
                        </div>

                        <div class="form-group">
                            <label for="editTaskDescription">Description</label>
                            <textarea id="editTaskDescription" name="description" rows="3">${task.description || ''}</textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editTaskStatus">Status</label>
                                <select id="editTaskStatus" name="status">
                                    <option value="not-started" ${task.status === 'not-started' ? 'selected' : ''}>Not Started</option>
                                    <option value="in-progress" ${task.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                    <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>Completed</option>
                                    <option value="on-hold" ${task.status === 'on-hold' ? 'selected' : ''}>On Hold</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editTaskRAGStatus">RAG Status</label>
                                <select id="editTaskRAGStatus" name="ragStatus">
                                    <option value="green" ${(task.ragStatus || 'yellow') === 'green' ? 'selected' : ''}>🟢 Green - On Track</option>
                                    <option value="yellow" ${(task.ragStatus || 'yellow') === 'yellow' ? 'selected' : ''}>🟡 Yellow - At Risk</option>
                                    <option value="red" ${(task.ragStatus || 'yellow') === 'red' ? 'selected' : ''}>🔴 Red - Critical Issues</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editTaskPhase">Phase</label>
                                <select id="editTaskPhase" name="phase">
                                    <option value="phase_1" ${(task.phase || 'phase_1') === 'phase_1' ? 'selected' : ''}>Pre-installation - Logistics</option>
                                    <option value="phase_2" ${task.phase === 'phase_2' ? 'selected' : ''}>Pre-Installation - AV Setup</option>
                                    <option value="phase_3" ${task.phase === 'phase_3' ? 'selected' : ''}>Post-Installation Commissioning</option>
                                    <option value="phase_4" ${task.phase === 'phase_4' ? 'selected' : ''}>Post-Installation - Logistics</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editTaskPriority">Priority</label>
                                <select id="editTaskPriority" name="priority">
                                    <option value="low" ${task.priority === 'low' ? 'selected' : ''}>Low</option>
                                    <option value="medium" ${task.priority === 'medium' ? 'selected' : ''}>Medium</option>
                                    <option value="high" ${task.priority === 'high' ? 'selected' : ''}>High</option>
                                    <option value="critical" ${task.priority === 'critical' ? 'selected' : ''}>Critical</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editTaskAssignee">Assignee</label>
                                <input type="text" id="editTaskAssignee" name="assignee" value="${task.assignee || ''}" placeholder="Assigned to">
                            </div>
                            <div class="form-group">
                                <!-- Empty for layout -->
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editTaskEstimatedHours">Estimated Hours</label>
                                <input type="number" id="editTaskEstimatedHours" name="estimatedHours" value="${task.estimatedHours || ''}" min="0" step="0.5">
                            </div>
                            <div class="form-group">
                                <!-- Empty for layout -->
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editTaskStartDate">Start Date</label>
                                <input type="date" id="editTaskStartDate" name="startDate" value="${task.startDate || ''}">
                            </div>
                            <div class="form-group">
                                <label for="editTaskEndDate">End Date</label>
                                <input type="date" id="editTaskEndDate" name="endDate" value="${task.endDate || ''}">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="editTaskNotes">PM Notes</label>
                            <textarea id="editTaskNotes" name="notes" rows="4" placeholder="Project manager notes and updates...">${task.notes || ''}</textarea>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.task-modal-overlay').remove()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Update Task</button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);
        }

        async function updateTask(event, projectId, taskId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            const updatedTaskData = {
                name: formData.get('name'),
                description: formData.get('description'),
                status: formData.get('status'),
                ragStatus: formData.get('ragStatus') || 'green',  // Changed default to green
                phase: formData.get('phase') || 'phase_1',
                priority: formData.get('priority'),
                assignee: formData.get('assignee'),
                estimatedHours: parseFloat(formData.get('estimatedHours')) || null,
                startDate: formData.get('startDate'),
                endDate: formData.get('endDate'),
                notes: formData.get('notes') || '',
                updatedAt: new Date().toISOString()
            };

            // Handle completion date
            const currentTask = AppState.projects.find(p => p.id === projectId)?.tasks?.find(t => t.id === taskId);
            if (formData.get('status') === 'completed' && currentTask?.status !== 'completed') {
                updatedTaskData.completedDate = new Date().toISOString();
            } else if (formData.get('status') !== 'completed' && currentTask?.status === 'completed') {
                updatedTaskData.completedDate = null;
            }

            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.innerHTML = 'Updating...';
            submitBtn.disabled = true;

            try {
                // Find the project and task
                const projectIndex = AppState.projects.findIndex(p => p.id === projectId);
                const taskIndex = AppState.projects[projectIndex]?.tasks?.findIndex(t => t.id === taskId);

                if (projectIndex !== -1 && taskIndex !== -1) {
                    const beforeTask = JSON.parse(JSON.stringify(AppState.projects[projectIndex].tasks[taskIndex]));
                    if (!isBackendMode()) { showNotification('Backend connection required', 'error'); submitBtn.innerHTML = 'Update Task'; submitBtn.disabled = false; return; }
                    try {
                        await apiFetch(`/projects/${projectId}/tasks/${taskId}`, {
                            method: 'PUT',
                            body: JSON.stringify(updatedTaskData)
                        });
                        // Update local state with server-accepted values
                        AppState.projects[projectIndex].tasks[taskIndex] = {
                            ...AppState.projects[projectIndex].tasks[taskIndex],
                            ...updatedTaskData
                        };
                    } catch (e) {
                        console.error('Failed to update task in backend:', e);
                        showNotification('Failed to update task in backend', 'error');
                        submitBtn.innerHTML = 'Update Task';
                        submitBtn.disabled = false;
                        return;
                    }

                    // Recalculate project progress and status
                    const project = AppState.projects[projectIndex];
                    project.progress = calculateProjectProgress(project);
                    project.status = calculateProjectStatus(project);
                    project.updatedAt = new Date().toISOString();

                    // Audit log (task update)
                    try { const afterTask = AppState.projects[projectIndex].tasks[taskIndex]; auditLogEvent({ action: 'task.update', entity: 'task', entityId: afterTask.id, entityName: afterTask.name, before: beforeTask, after: afterTask, details: 'Task updated', meta: { projectId } }); } catch(_) {}



                    showNotification('Task updated successfully!', 'success');
                    form.closest('.task-modal-overlay').remove();

                    // Refresh the task list in the project detail view
                    const tasksContainer = document.getElementById(`projectTasks-${projectId}`);
                    if (tasksContainer) {
                        tasksContainer.innerHTML = renderProjectTasks(AppState.projects[projectIndex].tasks, projectId);
                    }

                    // Refresh other views if visible
                    if (AppState.currentView === 'projects') {
                        renderProjectsGrid();
                    } else if (AppState.currentView === 'dashboard') {
                        loadDashboard();
                    }
                } else {
                    throw new Error('Project or task not found');
                }

            } catch (error) {
                console.error('Error updating task:', error);
                showNotification('Failed to update task. Please try again.', 'error');
                submitBtn.innerHTML = 'Update Task';
                submitBtn.disabled = false;
            }
        }

        async function deleteTask(projectId, taskId) {
            const project = AppState.projects.find(p => p.id === projectId);
            const task = project?.tasks?.find(t => t.id === taskId);

            if (!task) {
                showNotification('Task not found', 'error');
                return;
            }

            // Show confirmation dialog
            const confirmDelete = confirm(`Are you sure you want to delete "${task.name}"? This action cannot be undone.`);

            if (confirmDelete) {
                // Remove task from project (backend first if enabled)
                const projectIndex = AppState.projects.findIndex(p => p.id === projectId);
                if (projectIndex !== -1) {
                    if (!isBackendMode()) { showNotification('Backend connection required', 'error'); return; }
                    try {
                        await apiFetch(`/projects/${projectId}/tasks/${taskId}`, { method: 'DELETE' });
                    } catch (e) {
                        console.error('Failed to delete task in backend:', e);
                        showNotification('Failed to delete task in backend', 'error');
                        return;
                    }

                    try { auditLogEvent({ action: 'task.delete', entity: 'task', entityId: task.id, entityName: task.name, before: task, details: 'Task deleted', meta: { projectId } }); } catch(_) {}
                    AppState.projects[projectIndex].tasks = AppState.projects[projectIndex].tasks.filter(t => t.id !== taskId);

                    // Recalculate project progress and status
                    const project = AppState.projects[projectIndex];
                    project.progress = calculateProjectProgress(project);
                    project.status = calculateProjectStatus(project);
                    project.updatedAt = new Date().toISOString();



                    showNotification('Task deleted successfully!', 'success');

                    // Refresh the task list in the project detail view
                    const tasksContainer = document.getElementById(`projectTasks-${projectId}`);
                    if (tasksContainer) {
                        tasksContainer.innerHTML = renderProjectTasks(AppState.projects[projectIndex].tasks, projectId);
                    }

                    // Refresh other views if visible
                    if (AppState.currentView === 'projects') {
                        renderProjectsGrid();
                    } else if (AppState.currentView === 'dashboard') {
                        loadDashboard();
                    }
                }
            }
        }

        function calculateProjectProgress(project) {
            const tasks = getTasks(project);
            if (tasks.length === 0) return 0;

            const completedTasks = tasks.filter(task => task.status === 'completed').length;
            const inProgressTasks = tasks.filter(task => task.status === 'in-progress').length;

            // Give partial credit for in-progress tasks
            const totalProgress = completedTasks + (inProgressTasks * 0.5);
            return Math.round((totalProgress / tasks.length) * 100);
        }

        function calculateProjectStatus(project) {
            const tasks = getTasks(project);
            if (tasks.length === 0) {
                // No tasks - keep current status or default to draft
                return project.status || 'draft';
            }

            const completedTasks = tasks.filter(task => task.status === 'completed').length;
            const inProgressTasks = tasks.filter(task => task.status === 'in-progress').length;
            const onHoldTasks = tasks.filter(task => task.status === 'on-hold').length;
            const notStartedTasks = tasks.filter(task => task.status === 'not-started').length;

            // Business logic for automatic status updates:
            if (completedTasks === tasks.length) {
                // All tasks completed = project completed
                return 'completed';
            } else if (inProgressTasks > 0) {
                // Any task in progress = project is active
                return 'active';
            } else if (onHoldTasks === tasks.length) {
                // All tasks on hold = project on hold
                return 'on-hold';
            } else if (notStartedTasks === tasks.length) {
                // All tasks not started = keep current status (could be draft or active)
                return project.status === 'completed' ? 'active' : project.status || 'draft';
            } else {
                // Mixed states but no in-progress = active (project has been worked on)
                return 'active';
            }
        }

        function getProgressColor(progress) {
            if (progress >= 75) return '#10b981';
            if (progress >= 50) return '#3b82f6';
            if (progress >= 25) return '#f59e0b';
            return '#ef4444';
        }

        function showProjectMenu(projectId) {
            // Remove any existing menu
            const existingMenu = document.querySelector('.project-menu-dropdown');
            if (existingMenu) {
                existingMenu.remove();
            }

            const menu = document.createElement('div');
            menu.className = 'project-menu-dropdown';
            menu.innerHTML = `
                <div class="menu-item" onclick="editProject('${projectId}')">
                    <span class="menu-icon">✏️</span>
                    <span>Edit Project</span>
                </div>
                <div class="menu-item" onclick="viewProject('${projectId}')">
                    <span class="menu-icon">👁️</span>
                    <span>View Details</span>
                </div>
                <div class="menu-item" onclick="duplicateProject('${projectId}')">
                    <span class="menu-icon">📋</span>
                    <span>Duplicate</span>
                </div>
                <div class="menu-separator"></div>
                <div class="menu-item danger" onclick="deleteProject('${projectId}')">
                    <span class="menu-icon">🗑️</span>
                    <span>Delete Project</span>
                </div>
            `;

            // Position the menu relative to the clicked button
            const button = event.target.closest('.menu-btn');
            const rect = button.getBoundingClientRect();
            menu.style.position = 'fixed';
            menu.style.top = (rect.bottom + 5) + 'px';
            menu.style.left = (rect.left - 120) + 'px';
            menu.style.zIndex = '2000';

            document.body.appendChild(menu);

            // Close menu when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 0);
        }

        function editProject(projectId) {
            const project = AppState.projects.find(p => p.id === projectId);
            if (!project) {
                showNotification('Project not found', 'error');
                return;
            }

            // Close any existing menu
            const existingMenu = document.querySelector('.project-menu-dropdown');
            if (existingMenu) {
                existingMenu.remove();
            }

            const modal = document.createElement('div');
            modal.className = 'project-modal-overlay';
            modal.innerHTML = `
                <div class="project-modal">
                    <div class="modal-header">
                        <h3>Edit Project</h3>
                        <button class="close-btn" onclick="this.closest('.project-modal-overlay').remove()">×</button>
                    </div>
                    <form class="modal-body" onsubmit="updateProject(event, '${projectId}')">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editProjectName">Project Name *</label>
                                <input type="text" id="editProjectName" name="name" value="${project.name}" required>
                            </div>
                            <div class="form-group">
                                <label for="editRequestorInfo">Requestor Information *</label>
                                <input type="text" id="editRequestorInfo" name="requestorInfo" value="${project.requestorInfo || ''}" placeholder="Name, Company, Contact" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editSiteLocation">Site/Location *</label>
                                <input type="text" id="editSiteLocation" name="siteLocation" value="${project.siteLocation || ''}" placeholder="Address or Site Name" required>
                            </div>
                            <div class="form-group">
                                <label for="editBusinessLine">Business Line *</label>
                                <select id="editBusinessLine" name="businessLine" required>
                                    <option value="">Select Bank/Business Line</option>
                                    <option value="barrington" ${project.businessLine === 'barrington' ? 'selected' : ''}>Barrington Bank & Trust Company, N.A.</option>
                                    <option value="beverly" ${project.businessLine === 'beverly' ? 'selected' : ''}>Beverly Bank & Trust Company, N.A.</option>
                                    <option value="crystal-lake" ${project.businessLine === 'crystal-lake' ? 'selected' : ''}>Crystal Lake Bank & Trust Company, N.A.</option>
                                    <option value="hinsdale" ${project.businessLine === 'hinsdale' ? 'selected' : ''}>Hinsdale Bank & Trust Company, N.A.</option>
                                    <option value="lake-forest" ${project.businessLine === 'lake-forest' ? 'selected' : ''}>Lake Forest Bank & Trust Company, N.A.</option>
                                    <option value="libertyville" ${project.businessLine === 'libertyville' ? 'selected' : ''}>Libertyville Bank & Trust Company, N.A.</option>
                                    <option value="northbrook" ${project.businessLine === 'northbrook' ? 'selected' : ''}>Northbrook Bank & Trust Company, N.A.</option>
                                    <option value="old-plank" ${project.businessLine === 'old-plank' ? 'selected' : ''}>Old Plank Trail Community Bank, N.A.</option>
                                    <option value="st-charles" ${project.businessLine === 'st-charles' ? 'selected' : ''}>St. Charles Bank & Trust Company, N.A.</option>
                                    <option value="schaumburg" ${project.businessLine === 'schaumburg' ? 'selected' : ''}>Schaumburg Bank & Trust Company, N.A.</option>
                                    <option value="state-lakes" ${project.businessLine === 'state-lakes' ? 'selected' : ''}>State Bank of the Lakes, N.A.</option>
                                    <option value="town-bank" ${project.businessLine === 'town-bank' ? 'selected' : ''}>Town Bank, N.A.</option>
                                    <option value="village" ${project.businessLine === 'village' ? 'selected' : ''}>Village Bank & Trust, N.A.</option>
                                    <option value="wheaton" ${project.businessLine === 'wheaton' ? 'selected' : ''}>Wheaton Bank & Trust Company, N.A.</option>
                                    <option value="company" ${project.businessLine === 'company' ? 'selected' : ''}>[Company Name]</option>
                                </select>
                            </div>
                        </div>


                        <div class="form-group">
                            <label for="editProjectDescription">Project Description</label>
                            <textarea id="editProjectDescription" name="description" rows="3" placeholder="Detailed project requirements and scope">${project.description || ''}</textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editProjectType">Project Type *</label>
                                <select id="editProjectType" name="type" required>
                                    <option value="">Select Project Type</option>
                                    <option value="new-build" ${project.type === 'new-build' ? 'selected' : ''}>New Build</option>
                                    <option value="upgrade" ${project.type === 'upgrade' ? 'selected' : ''}>Upgrade</option>
                                    <option value="breakfix" ${project.type === 'breakfix' ? 'selected' : ''}>BreakFix</option>
                                    <option value="refresh" ${project.type === 'refresh' ? 'selected' : ''}>Refresh</option>
                                    <option value="custom" ${project.type === 'custom' ? 'selected' : ''}>Custom Project</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editProjectStatus">Project Status</label>
                                <select id="editProjectStatus" name="status">
                                    <option value="draft" ${project.status === 'draft' ? 'selected' : ''}>📝 Draft</option>
                                    <option value="active" ${project.status === 'active' ? 'selected' : ''}>🟢 Active</option>
                                    <option value="on-hold" ${project.status === 'on-hold' ? 'selected' : ''}>⏸️ On Hold</option>
                                    <option value="completed" ${project.status === 'completed' ? 'selected' : ''}>✅ Completed</option>
                                    <option value="cancelled" ${project.status === 'cancelled' ? 'selected' : ''}>❌ Cancelled</option>
                                </select>
                                <small class="form-help">Manual override - automatically updates based on task status</small>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editProjectPriority">Priority</label>
                                <select id="editProjectPriority" name="priority">
                                    <option value="low" ${project.priority === 'low' ? 'selected' : ''}>Low</option>
                                    <option value="medium" ${project.priority === 'medium' ? 'selected' : ''}>Medium</option>
                                    <option value="high" ${project.priority === 'high' ? 'selected' : ''}>High</option>
                                    <option value="critical" ${project.priority === 'critical' ? 'selected' : ''}>Critical</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <!-- Empty for layout balance -->
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editRequestDate">Request Date *</label>
                                <input type="date" id="editRequestDate" name="requestDate" value="${project.requestDate || ''}" required>
                            </div>
                            <div class="form-group">
                                <label for="editProjectStartDate">Start Date</label>
                                <input type="date" id="editProjectStartDate" name="startDate" value="${project.startDate || ''}">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editDueDate">Due Date *</label>
                                <input type="date" id="editDueDate" name="dueDate" value="${project.endDate || project.dueDate || ''}" required>
                            </div>
                            <div class="form-group">
                                <label for="editEstimatedBudget">Estimated Budget *</label>
                                <input type="number" id="editEstimatedBudget" name="estimatedBudget" min="0" step="100" value="${project.estimatedBudget || 0}" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editProjectStatus">Status</label>
                                <select id="editProjectStatus2" name="status">
                                    <option value="draft" ${project.status === 'draft' ? 'selected' : ''}>Draft</option>
                                    <option value="active" ${project.status === 'active' ? 'selected' : ''}>Active</option>
                                    <option value="on-hold" ${project.status === 'on-hold' ? 'selected' : ''}>On Hold</option>
                                    <option value="completed" ${project.status === 'completed' ? 'selected' : ''}>Completed</option>
                                    <option value="cancelled" ${project.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editActualBudget">Actual Budget</label>
                                <input type="number" id="editActualBudget" name="actualBudget" min="0" step="100" value="${project.actualBudget || 0}">
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.project-modal-overlay').remove()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Update Project</button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);
        }

        async function updateProject(event, projectId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            const updatedData = {
                name: formData.get('name'),
                requestorInfo: formData.get('requestorInfo'),
                siteLocation: formData.get('siteLocation'),
                businessLine: formData.get('businessLine'),
                description: formData.get('description'),
                type: formData.get('type'),
                priority: formData.get('priority'),
                requestDate: formData.get('requestDate'),
                startDate: formData.get('startDate'),
                dueDate: formData.get('dueDate'),
                endDate: formData.get('dueDate'), // Using dueDate as endDate for compatibility
                estimatedBudget: parseFloat(formData.get('estimatedBudget')) || 0,
                actualBudget: parseFloat(formData.get('actualBudget')) || 0,
                status: formData.get('status')
            };

            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.innerHTML = 'Updating...';
            submitBtn.disabled = true;

            try {
                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Find and update the project in AppState
                const projectIndex = AppState.projects.findIndex(p => p.id === projectId);
                if (projectIndex !== -1) {
                    const project = AppState.projects[projectIndex];
                    const beforeProject = JSON.parse(JSON.stringify(project));

                    // Validate status change - warn if setting to completed with incomplete tasks
                    if (updatedData.status === 'completed' && getTasks(project).length > 0) {
                        const incompleteTasks = getTasks(project).filter(t => t.status !== 'completed');
                        if (incompleteTasks.length > 0) {
                            if (!confirm(`Warning: This project has ${incompleteTasks.length} incomplete task(s). Setting the project status to "Completed" while tasks remain incomplete may affect reporting accuracy.\n\nDo you want to proceed?`)) {
                                submitBtn.innerHTML = 'Update Project';
                                submitBtn.disabled = false;
                                return;
                            }
                        }
                    }

                        if (!isBackendMode()) { showNotification('Backend connection required', 'error'); submitBtn.innerHTML = 'Update Project'; submitBtn.disabled = false; return; }
                        try {
                            const payload = toBackendProjectPayload({
                                ...AppState.projects[projectIndex],
                                ...updatedData
                            });
                            const data = await apiFetch(`/projects/${AppState.projects[projectIndex].id}`, {
                                method: 'PUT',
                                body: JSON.stringify(payload)
                            });
                            const updatedProject = data.project || data;
                            AppState.projects[projectIndex] = updatedProject;
                            // Recalculate budget spending for breakfix and refresh projects
                            calculateBudgetSpending();
                        } catch (e) {
                            console.error('Failed to update project in backend:', e);
                            showNotification('Failed to update project in backend', 'error');
                            submitBtn.innerHTML = 'Update Project';
                            submitBtn.disabled = false;
                            return;
                        }

                        // Audit log (project update)
                        try { auditLogEvent({ action: 'project.update', entity: 'project', entityId: AppState.projects[projectIndex].id, entityName: AppState.projects[projectIndex].name, before: beforeProject, after: AppState.projects[projectIndex], details: 'Updated project details' }); } catch(_) {}

                        showNotification('Project updated successfully!', 'success');
                        form.closest('.project-modal-overlay').remove();

                    // Refresh the current view
                    if (AppState.currentView === 'projects') {
                        renderProjectsGrid();
                    } else if (AppState.currentView === 'dashboard') {
                        loadDashboard();
                    }
                } else {
                    throw new Error('Project not found');
                }

            } catch (error) {
                console.error('Error updating project:', error);
                showNotification('Failed to update project. Please try again.', 'error');
                submitBtn.innerHTML = 'Update Project';
                submitBtn.disabled = false;
            }
        }

        async function duplicateProject(projectId) {
            const project = AppState.projects.find(p => p.id === projectId);
            if (!project) { showNotification('Project not found', 'error'); return; }
            const existingMenu = document.querySelector('.project-menu-dropdown');
            if (existingMenu) existingMenu.remove();
            if (!isBackendMode()) { showNotification('Backend connection required', 'error'); return; }
            try {
                const payload = toBackendProjectPayload({
                    ...project,
                    name: project.name + ' (Copy)',
                    status: 'draft',
                    tasks: (project.tasks || []).map(t => ({ name: t.name, status: 'not-started' }))
                });
                const data = await apiFetch('/projects', { method: 'POST', body: JSON.stringify(payload) });
                const newProject = data.project || data;
                AppState.projects.unshift(newProject);
                showNotification('Project duplicated successfully!', 'success');
                if (AppState.currentView === 'projects') { renderProjectsGrid(); }
                else if (AppState.currentView === 'dashboard') { loadDashboard(); }
            } catch (e) {
                console.warn('Duplicate with embedded tasks failed, retrying:', e);
                try {
                    const base = toBackendProjectPayload({ ...project, name: project.name + ' (Copy)', status: 'draft', tasks: [] });
                    const created = await apiFetch('/projects', { method: 'POST', body: JSON.stringify(base) });
                    const newProject = created.project || created;
                    const newId = newProject.id;
                    for (const t of (project.tasks || [])) {
                        try { await apiFetch(`/projects/${newId}/tasks`, { method: 'POST', body: JSON.stringify({ name: t.name, status: 'not-started' }) }); } catch (_) {}
                    }
                    // Reload from backend to reflect latest state
                    await loadProjectsFromBackend();
                    showNotification('Project duplicated successfully!', 'success');
                } catch (e2) {
                    console.error('Failed to duplicate project in backend:', e2);
                    showNotification('Failed to duplicate project', 'error');
                }
            }
        }

        async function completeTask(projectId, taskId) {
            const projectIndex = AppState.projects.findIndex(p => p.id === projectId);
            if (projectIndex === -1) return;
            const taskIndex = AppState.projects[projectIndex].tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            const beforeTask = JSON.parse(JSON.stringify(AppState.projects[projectIndex].tasks[taskIndex]));
            if (!isBackendMode()) { showNotification('Backend connection required', 'error'); return; }
            try {
                const payload = { status: 'completed', completedDate: new Date().toISOString(), updatedAt: new Date().toISOString() };
                await apiFetch(`/projects/${projectId}/tasks/${taskId}`, { method: 'PUT', body: JSON.stringify(payload) });
                Object.assign(AppState.projects[projectIndex].tasks[taskIndex], payload);
                const project = AppState.projects[projectIndex];
                project.progress = calculateProjectProgress(project);
                project.status = calculateProjectStatus(project);
                project.updatedAt = new Date().toISOString();
                try { const afterTask = AppState.projects[projectIndex].tasks[taskIndex]; auditLogEvent({ action: 'task.complete', entity: 'task', entityId: afterTask.id, entityName: afterTask.name, before: beforeTask, after: afterTask, details: 'Task marked complete', meta: { projectId } }); } catch(_) {}
                showNotification('Task marked as complete!', 'success');
                refreshTaskList(projectId);
                if (AppState.currentView === 'projects') renderProjectsGrid(); else if (AppState.currentView === 'dashboard') loadDashboard();
            } catch (e) {
                console.error('Failed to complete task in backend:', e);
                showNotification('Failed to complete task', 'error');
            }
        }

        async function reopenTask(projectId, taskId) {
            const projectIndex = AppState.projects.findIndex(p => p.id === projectId);
            if (projectIndex === -1) return;
            const taskIndex = AppState.projects[projectIndex].tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            const beforeTask = JSON.parse(JSON.stringify(AppState.projects[projectIndex].tasks[taskIndex]));
            if (!isBackendMode()) { showNotification('Backend connection required', 'error'); return; }
            try {
                const payload = { status: 'in-progress', completedDate: null, updatedAt: new Date().toISOString() };
                await apiFetch(`/projects/${projectId}/tasks/${taskId}`, { method: 'PUT', body: JSON.stringify(payload) });
                Object.assign(AppState.projects[projectIndex].tasks[taskIndex], payload);
                const project = AppState.projects[projectIndex];
                project.progress = calculateProjectProgress(project);
                project.status = calculateProjectStatus(project);
                project.updatedAt = new Date().toISOString();
                try { const afterTask = AppState.projects[projectIndex].tasks[taskIndex]; auditLogEvent({ action: 'task.reopen', entity: 'task', entityId: afterTask.id, entityName: afterTask.name, before: beforeTask, after: afterTask, details: 'Task reopened (in-progress)', meta: { projectId } }); } catch(_) {}
                showNotification('Task reopened and set to in-progress!', 'success');
                refreshTaskList(projectId);
                if (AppState.currentView === 'projects') renderProjectsGrid(); else if (AppState.currentView === 'dashboard') loadDashboard();
            } catch (e) {
                console.error('Failed to reopen task in backend:', e);
                showNotification('Failed to reopen task', 'error');
            }
        }

        function showAllTaskNotes(projectId, taskId) {
            const project = AppState.projects.find(p => p.id === projectId);
            const task = project?.tasks?.find(t => t.id === taskId);
            const thread = Array.isArray(task?.notesThread) ? task.notesThread : [];
            const modal = document.createElement('div');
            modal.className = 'project-modal-overlay task-modal-overlay';
            modal.innerHTML = `
                <div class="project-modal task-modal">
                    <div class="modal-header">
                        <h3>Task Notes</h3>
                        <button class="close-btn" onclick="this.closest('.task-modal-overlay').remove()">×</button>
                    </div>
                    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                        ${thread.length === 0 ? '<div style="color: var(--gray-500);">No notes yet.</div>' : ''}
                        ${thread.map(n => `
                            <div style=\"border-left: 3px solid var(--primary-300); padding-left: 0.5rem; margin-bottom: 0.5rem;\">
                                <div style=\"font-size: 0.8rem; color: var(--gray-600);\">${new Date(n.timestamp).toLocaleString()} — <strong>${n.author || 'Someone'}</strong>${n.role ? ` (${n.role})` : ''}</div>
                                <div style=\"white-space: pre-wrap; color: var(--gray-900);\">${(n.content || '').replace(/</g,'&lt;')}</div>
                                <div style=\"text-align:right; margin-top:4px;\">${hasPermission('tasks.notes.edit') ? `<a href=\"#\" onclick=\"event.preventDefault(); editTaskNote('${projectId}','${taskId}','${n.id}')\">Edit</a>` : ''}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.task-modal-overlay').remove()">Close</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);
        }

        window.submitTaskNote = async function submitTaskNote(projectId, taskId) {
            try {
                const input = document.getElementById(`noteInputModal-${projectId}-${taskId}`) || document.getElementById(`noteInput-${projectId}-${taskId}`);
                if (!input) { console.warn('submitTaskNote: note input not found'); return; }
                const content = String(input.value || '').trim();
                if (!content) { showNotification('Enter a note first', 'warning'); return; }
                const projectIndex = (AppState.projects || []).findIndex(p => String(p.id) === String(projectId));
                if (projectIndex === -1) { console.warn('submitTaskNote: project not found', projectId); return; }
                const taskIndex = (AppState.projects[projectIndex].tasks || []).findIndex(t => String(t.id) === String(taskId));
                if (taskIndex === -1) { console.warn('submitTaskNote: task not found', taskId); return; }
                const user = AppState.user || { name: 'Unknown', role: 'viewer' };



                const note = { id: 'note_' + Date.now(), author: user.name || user.email || 'Unknown', role: user.role || '', content, timestamp: new Date().toISOString() };
                const task = AppState.projects[projectIndex].tasks[taskIndex];
                const newThread = Array.isArray(task.notesThread) ? task.notesThread.slice() : [];
                newThread.push(note);

                if (!isBackendMode()) { showNotification('Backend connection required', 'error'); return; }
                try {
                    const data = await apiFetch(`/projects/${projectId}/tasks/${taskId}`, { method: 'PUT', body: JSON.stringify({ notesThread: newThread }) });
                    const savedTask = data.task || {};
                    const taskRef = AppState.projects[projectIndex].tasks[taskIndex];
                    taskRef.notesThread = Array.isArray(savedTask.notesThread) ? savedTask.notesThread : newThread;
                    taskRef.updatedAt = new Date().toISOString();
                } catch (e) {
                    console.error('Failed to save note to backend:', e);
                    showNotification('Failed to save note to backend', 'error');
                    return;
                }


                showNotification('Note added', 'success');
                input.value = '';

                // Update notes list in place
                const listEl = document.getElementById(`notesList-${projectId}-${taskId}`);
                if (listEl) {
                    const thread = task.notesThread;
                    const items = thread.slice(-2).map(n => `
                        <div style=\"border-left: 3px solid var(--primary-300); padding-left: 0.5rem;\">
                            <div style=\"font-size: 0.75rem; color: var(--gray-600);\">${new Date(n.timestamp).toLocaleString()} — <strong>${n.author || 'Someone'}</strong>${n.role ? ` (${n.role})` : ''}</div>
                            <div style=\"font-size: 0.85rem; color: var(--gray-800); white-space: pre-wrap;\">${(n.content || '').replace(/</g,'&lt;')}</div>
                        </div>`).join('');
                    listEl.innerHTML = (items || '') + (thread.length > 2 ? `<a href=\"#\" style=\"font-size:0.8rem;\" onclick=\"event.preventDefault(); showAllTaskNotes('${projectId}','${taskId}')\">View all notes</a>` : '');
                }

                // Update modal list if open
                const listElModal = document.getElementById(`notesListModal-${projectId}-${taskId}`);
                if (listElModal) {
                    const thread = task.notesThread || [];
                    const items = thread.slice(-3).map(n => `
                        <div style="border-left: 3px solid var(--primary-300); padding-left: 0.5rem;">
                            <div style="font-size: 0.8rem; color: var(--gray-600);">${new Date(n.timestamp).toLocaleString()} — <strong>${n.author || 'Someone'}</strong>${n.role ? ` (${n.role})` : ''}</div>
                            <div style="font-size: 0.9rem; color: var(--gray-900); white-space: pre-wrap;">${(n.content || '').replace(/</g,'&lt;')}</div>
                        </div>`).join('');
                    listElModal.innerHTML = items || '<div style=\'color: var(--gray-500); font-size: 0.9rem;\'>No notes yet.</div>';
                }

            } catch (e) {
                console.error('submitTaskNote error:', e);
                showNotification('Failed to add note', 'error');
            }
        }

        // Expose for inline handlers
        try { window.submitTaskNote = submitTaskNote; } catch(_) {}




        function refreshTaskList(projectId) {
            const project = AppState.projects.find(p => p.id === projectId);
            if (!project) return;

            const tasksContainer = document.getElementById(`projectTasks-${projectId}`);
            if (tasksContainer) {
                const taskHtml = project.tasks.map(task => {
                    const ragInfo = {
                        'green': { icon: '🟢', label: 'Green', class: 'rag-green' },
                        'yellow': { icon: '🟡', label: 'Yellow', class: 'rag-yellow' },
                        'red': { icon: '🔴', label: 'Red', class: 'rag-red' }
                    };
                    const rag = ragInfo[task.ragStatus] || ragInfo.yellow;
                    const phaseInfo = derivePhaseInfo(task.phase);

                    return `
                    <div class=\"task-item\" onclick=\"viewTask('${projectId}', '${task.id}')\" style=\"cursor: pointer; border: 1px solid var(--gray-200); padding: 1rem; margin: 0.5rem 0; border-radius: 0.5rem; background: var(--gray-50);\">
                        <div style=\"display: flex; justify-content: space-between; align-items: flex-start;\">
                            <div style=\"flex: 1;\">
                                <div style=\"display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;\">
                                    <h5 style=\"margin: 0;\">${task.name}</h5>
                                    <span class=\"${rag.class}\" style=\"font-size: 0.8rem;\">${rag.icon} ${rag.label}</span>
                                    ${task.status === 'completed' ? '<span style=\"color: var(--success-500); font-size: 0.8rem;\">✅ Completed</span>' : ''}
                                </div>
                                <p style=\"color: var(--gray-600); font-size: 0.875rem; margin: 0 0 0.5rem 0;\">${task.description || 'No description'}</p>
                                <div style=\"display: flex; gap: 1rem; font-size: 0.8rem; color: var(--gray-500); margin-bottom: 0.5rem;\">
                                    <span class=\"phase-badge ${phaseInfo.class}\">${phaseInfo.name}</span>
                                    <span><strong>Status:</strong> <span class=\"status-badge ${task.status}\">${formatStatus(task.status)}</span></span>
                                    ${task.assignee ? `<span><strong>Assigned:</strong> ${task.assignee}</span>` : ''}
                                    ${task.priority ? `<span><strong>Priority:</strong> ${task.priority}</span>` : ''}
                                    ${task.estimatedHours ? `<span><strong>Est Hours:</strong> ${task.estimatedHours}h</span>` : ''}
                                </div>
                                ${task.notes ? `

                                    <div style=\"background: #f8f9fa; padding: 0.5rem; border-radius: 0.25rem; margin-top: 0.5rem;\">
                                        <strong style=\"font-size: 0.8rem; color: var(--gray-700);\">PM Notes:</strong>
                                        <p style=\"font-size: 0.8rem; color: var(--gray-600); margin: 0.25rem 0 0 0;\">${task.notes}</p>
                                    </div>
                                ` : ''}
                                ${task.completedDate ? `
                                    <div style=\"font-size: 0.75rem; color: var(--success-600); margin-top: 0.5rem;\">
                                        ✅ Completed: ${formatDate(task.completedDate)}
                                    </div>
                                ` : ''}
                            </div>
                            <div style=\"display: flex; flex-direction: column; gap: 0.5rem;\">
                                ${task.status !== 'completed' ?
                                    `<button class=\"btn btn-success btn-sm\" onclick=\"event.stopPropagation(); completeTask('${projectId}', '${task.id}')\" title=\"Mark Complete\">✅ Complete</button>` :
                                    `<button class=\"btn btn-warning btn-sm\" onclick=\"event.stopPropagation(); reopenTask('${projectId}', '${task.id}')\" title=\"Reopen Task\">🔄 Reopen</button>`
                                }
                                <button class=\"btn btn-secondary btn-sm\" onclick=\"event.stopPropagation(); editTask('${projectId}', '${task.id}')\" title=\"Edit Task\">✏️ Edit</button>
                                <button class=\"btn btn-danger btn-sm\" onclick=\"event.stopPropagation(); deleteTask('${projectId}', '${task.id}')\" title=\"Delete Task\">🗑️ Delete</button>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');

                tasksContainer.innerHTML = taskHtml || '<div style=\"text-align: center; padding: 2rem; color: var(--gray-500);\"><p>No tasks yet. Click \"Add Task\" to get started.</p></div>';
            }
        }

        async function deleteProject(projectId) {
            const project = AppState.projects.find(p => p.id === projectId);
            if (!project) {
                showNotification('Project not found', 'error');
                return;
            }

            // Close any existing menu
            const existingMenu = document.querySelector('.project-menu-dropdown');
            if (existingMenu) {
                existingMenu.remove();
            }

            // Show confirmation dialog
            const confirmDelete = confirm(`Are you sure you want to delete "${project.name}"? This action cannot be undone.`);

            if (confirmDelete) {
                if (!isBackendMode()) { showNotification('Backend connection required', 'error'); return; }
                try {
                    await apiFetch(`/projects/${projectId}`, { method: 'DELETE' });
                } catch (e) {
                    console.error('Failed to delete project in backend:', e);
                    showNotification('Failed to delete project in backend', 'error');
                    return;
                }

                // Remove project from AppState
                try { auditLogEvent({ action: 'project.delete', entity: 'project', entityId: project.id, entityName: project.name, before: project, details: 'Project deleted' }); } catch(_) {}
                AppState.projects = AppState.projects.filter(p => p.id !== projectId);


                showNotification('Project deleted successfully!', 'success');

                // Refresh the current view
                if (AppState.currentView === 'projects') {
                    renderProjectsGrid();
                } else if (AppState.currentView === 'dashboard') {
                    loadDashboard();
                }
            }
        }

        function exportDashboard() {
            exportReport();
        }

        async function exportProjects(format = 'json') {
            const btn = typeof event !== 'undefined' ? event.target : null;
            const original = btn ? btn.innerHTML : null;
            if (btn) { btn.innerHTML = '📄 Exporting...'; btn.disabled = true; }
            try {
                const projects = Array.isArray(AppState.projects) ? AppState.projects : [];
                const data = { projects };
                if (format === 'csv') {
                    const csv = generateCSVData(data);
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `projects_${new Date().toISOString().slice(0,10)}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    await exportToJSON(data);
                }
                showNotification('Export generated', 'success');
            } catch (e) {
                console.error('Export projects failed:', e);
                showNotification('Failed to export projects', 'error');
            } finally {
                if (btn && original != null) { btn.innerHTML = original; btn.disabled = false; }
            }
        }


        function toggleUserMenu() {
            const userMenu = document.getElementById('userMenu');
            if (userMenu) {
                userMenu.style.display = userMenu.style.display === 'none' ? 'block' : 'none';
            }
        }

        function showDashboardTab(tab) {
            // Show dashboard tab: tab

            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.nav-item').classList.add('active');

            // Show different content based on tab
            switch(tab) {
                case 'overview':
                    showKeyMetricsView();
                    break;
                case 'trends':
                    showTrendsView();
                    break;
                case 'alerts':
                    showAlertsView();
                    break;
            }
        }

        function showKeyMetricsView() {
            const projects = AppState.projects || [];

            // Calculate key metrics from actual project data
            const totalProjects = projects.length;
            const activeProjects = projects.filter(p => p.status === 'active').length;
            const completedProjects = projects.filter(p => p.status === 'completed').length;
            const overdueProjects = projects.filter(p => {
                const dueDate = p.endDate || p.dueDate;
                return dueDate && new Date(dueDate) < new Date() && p.status !== 'completed';
            }).length;

            const avgProgress = projects.length > 0
                ? Math.round(projects.reduce((sum, p) => sum + (p.progress || 0), 0) / projects.length)
                : 0;

            const totalBudget = projects.reduce((sum, p) => sum + (p.estimatedBudget || 0), 0);
            const spentBudget = projects.reduce((sum, p) => sum + (p.actualBudget || 0), 0);
            const budgetUtilization = totalBudget > 0 ? Math.round((spentBudget / totalBudget) * 100) : 0;

            const onTimeProjects = projects.filter(p => {
                if (p.status !== 'completed') return false;
                const dueDate = p.endDate || p.dueDate;
                const completedDate = p.completedDate;
                return dueDate && completedDate && new Date(completedDate) <= new Date(dueDate);
            }).length;

            const onTimeRate = completedProjects > 0 ? Math.round((onTimeProjects / completedProjects) * 100) : 0;

            const metrics = [
                {
                    icon: '📁',
                    iconClass: 'primary',
                    value: totalProjects.toString(),
                    label: 'Total Projects',
                    change: `${activeProjects} active`,
                    changeClass: activeProjects > 0 ? 'positive' : 'neutral'
                },
                {
                    icon: '🎯',
                    iconClass: avgProgress > 75 ? 'success' : avgProgress > 50 ? 'warning' : 'danger',
                    value: `${avgProgress}%`,
                    label: 'Average Progress',
                    change: avgProgress > 75 ? 'On track' : avgProgress > 50 ? 'Moderate pace' : 'Needs attention',
                    changeClass: avgProgress > 75 ? 'positive' : avgProgress > 50 ? 'neutral' : 'negative'
                },
                {
                    icon: '⚠️',
                    iconClass: overdueProjects === 0 ? 'success' : overdueProjects <= 2 ? 'warning' : 'danger',
                    value: overdueProjects.toString(),
                    label: 'Overdue Projects',
                    change: overdueProjects === 0 ? 'All on schedule' : `${Math.round((overdueProjects/totalProjects)*100)}% of total`,
                    changeClass: overdueProjects === 0 ? 'positive' : 'negative'
                },
                {
                    icon: '💰',
                    iconClass: budgetUtilization <= 90 ? 'success' : budgetUtilization <= 100 ? 'warning' : 'danger',
                    value: `${budgetUtilization}%`,
                    label: 'Budget Utilization',
                    change: `$${spentBudget.toLocaleString()} of $${totalBudget.toLocaleString()}`,
                    changeClass: budgetUtilization <= 90 ? 'positive' : budgetUtilization <= 100 ? 'neutral' : 'negative'
                },
                {
                    icon: '✅',
                    iconClass: onTimeRate >= 80 ? 'success' : onTimeRate >= 60 ? 'warning' : 'danger',
                    value: `${onTimeRate}%`,
                    label: 'On-Time Delivery',
                    change: `${onTimeProjects} of ${completedProjects} completed`,
                    changeClass: onTimeRate >= 80 ? 'positive' : onTimeRate >= 60 ? 'neutral' : 'negative'
                },
                {
                    icon: '👥',
                    iconClass: 'primary',
                    value: `${Math.min(100, Math.round((activeProjects / Math.max(1, totalProjects)) * 100))}%`,
                    label: 'Team Utilization',
                    change: activeProjects > 0 ? 'Active workload' : 'Available capacity',
                    changeClass: activeProjects > 0 ? 'positive' : 'neutral'
                }
            ];

            const metricsGrid = document.getElementById('metricsGrid');
            metricsGrid.innerHTML = metrics.map(metric => `
                <div class="metric-card fade-in">
                    <div class="metric-header">
                        <div class="metric-icon ${metric.iconClass}">${metric.icon}</div>
                    </div>
                    <div class="metric-value">${metric.value}</div>
                    <div class="metric-label">${metric.label}</div>
                    <div class="metric-change ${metric.changeClass}">${metric.change}</div>
                </div>
            `).join('');

            // Show the charts grid
            const chartGrid = document.querySelector('.chart-grid');
            if (chartGrid) chartGrid.style.display = 'grid';
        }

        function showTrendsView() {
            const projects = AppState.projects || [];

            // Hide charts grid and show trends-specific content
            const chartGrid = document.querySelector('.chart-grid');
            if (chartGrid) chartGrid.style.display = 'none';

            // Calculate trend metrics
            const currentDate = new Date();
            const thirtyDaysAgo = new Date(currentDate.getTime() - (30 * 24 * 60 * 60 * 1000));
            const ninetyDaysAgo = new Date(currentDate.getTime() - (90 * 24 * 60 * 60 * 1000));

            // Recent project activity
            const recentProjects = projects.filter(p => {
                const created = new Date(p.createdAt || p.requestDate);
                return created >= thirtyDaysAgo;
            }).length;

            const recentCompletions = projects.filter(p => {
                const completed = new Date(p.completedDate || '1900-01-01');
                return completed >= thirtyDaysAgo && p.status === 'completed';
            }).length;

            // Budget trends
            const recentBudgetCommitments = projects.filter(p => {
                const created = new Date(p.createdAt || p.requestDate);
                return created >= thirtyDaysAgo;
            }).reduce((sum, p) => sum + (p.estimatedBudget || 0), 0);

            // Performance trends - calculate average project duration
            const completedProjectsWithDates = projects.filter(p => {
                // Only include completed projects with valid start and end dates
                return p.status === 'completed' &&
                       (p.startDate || p.createdAt) &&
                       p.completedDate &&
                       !isNaN(new Date(p.startDate || p.createdAt)) &&
                       !isNaN(new Date(p.completedDate));
            });

            const avgProjectDuration = completedProjectsWithDates.map(p => {
                const start = new Date(p.startDate || p.createdAt);
                const end = new Date(p.completedDate);
                const durationInDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24));

                // Return valid duration or 0 if calculation results in invalid number
                return isNaN(durationInDays) || durationInDays < 0 ? 0 : durationInDays;
            }).filter(duration => duration > 0); // Remove zero durations

            const avgDuration = avgProjectDuration.length > 0
                ? Math.round(avgProjectDuration.reduce((a, b) => a + b, 0) / avgProjectDuration.length)
                : 0;

            const trends = [
                {
                    icon: '📈',
                    iconClass: recentProjects > 0 ? 'success' : 'neutral',
                    value: recentProjects.toString(),
                    label: 'New Projects (30d)',
                    change: recentProjects > 0 ? 'Growing pipeline' : 'Stable pipeline',
                    changeClass: recentProjects > 0 ? 'positive' : 'neutral'
                },
                {
                    icon: '🏁',
                    iconClass: recentCompletions > 0 ? 'success' : 'warning',
                    value: recentCompletions.toString(),
                    label: 'Completed (30d)',
                    change: recentCompletions > 0 ? 'Strong delivery' : 'Focus needed',
                    changeClass: recentCompletions > 0 ? 'positive' : 'negative'
                },
                {
                    icon: '💸',
                    iconClass: recentBudgetCommitments > 0 ? 'primary' : 'neutral',
                    value: `$${(recentBudgetCommitments / 1000).toFixed(0)}K`,
                    label: 'Budget Committed (30d)',
                    change: `${recentProjects} new commitments`,
                    changeClass: 'neutral'
                },
                {
                    icon: '⏱️',
                    iconClass: avgDuration <= 60 ? 'success' : avgDuration <= 120 ? 'warning' : 'danger',
                    value: `${avgDuration}d`,
                    label: 'Avg Project Duration',
                    change: avgDuration <= 60 ? 'Efficient delivery' : avgDuration <= 120 ? 'Moderate pace' : 'Long cycles',
                    changeClass: avgDuration <= 60 ? 'positive' : avgDuration <= 120 ? 'neutral' : 'negative'
                },
                {
                    icon: '🎯',
                    iconClass: 'primary',
                    value: `${Math.round((recentCompletions / Math.max(1, recentProjects)) * 100)}%`,
                    label: 'Completion Rate',
                    change: 'Recent performance',
                    changeClass: 'neutral'
                },
                {
                    icon: '🔮',
                    iconClass: 'warning',
                    value: projects.filter(p => p.status === 'active').length.toString(),
                    label: 'Projected Completions',
                    change: 'Next 30 days',
                    changeClass: 'neutral'
                }
            ];

            const metricsGrid = document.getElementById('metricsGrid');
            metricsGrid.innerHTML = `
                <div class="trends-header" style="grid-column: 1 / -1; margin-bottom: 1rem;">
                    <h2 style="color: var(--gray-800); margin: 0;">📈 Trends Analysis</h2>
                    <p style="color: var(--gray-600); margin: 0.5rem 0 0 0;">Key performance indicators and project momentum over time</p>
                </div>
                ${trends.map(metric => `
                    <div class="metric-card fade-in">
                        <div class="metric-header">
                            <div class="metric-icon ${metric.iconClass}">${metric.icon}</div>
                        </div>
                        <div class="metric-value">${metric.value}</div>
                        <div class="metric-label">${metric.label}</div>
                        <div class="metric-change ${metric.changeClass}">${metric.change}</div>
                    </div>
                `).join('')}
            `;
        }

        function showAlertsView() {
            const projects = AppState.projects || [];
            const alerts = [];
            const currentDate = new Date();

            // Hide charts grid
            const chartGrid = document.querySelector('.chart-grid');
            if (chartGrid) chartGrid.style.display = 'none';

            // Generate alerts based on project conditions
            projects.forEach(project => {
                const dueDate = project.endDate || project.dueDate;
                const dueDateObj = dueDate ? new Date(dueDate) : null;
                const daysUntilDue = dueDateObj ? Math.ceil((dueDateObj - currentDate) / (1000 * 60 * 60 * 24)) : null;

                // CRITICAL ALERTS
                if (project.status !== 'completed' && dueDateObj && currentDate > dueDateObj) {
                    alerts.push({
                        level: 'critical',
                        icon: '🚨',
                        title: 'Project Overdue',
                        message: `${project.name} is ${Math.abs(daysUntilDue)} days overdue`,
                        action: `View Project`,
                        projectId: project.id,
                        priority: 1
                    });
                }

                if (project.actualBudget && project.estimatedBudget &&
                    (project.actualBudget / project.estimatedBudget) > 1.1) {
                    const overage = Math.round(((project.actualBudget / project.estimatedBudget) - 1) * 100);
                    alerts.push({
                        level: 'critical',
                        icon: '💸',
                        title: 'Budget Overrun',
                        message: `${project.name} is ${overage}% over budget`,
                        action: 'Review Budget',
                        projectId: project.id,
                        priority: 1
                    });
                }

                // WARNING ALERTS
                if (project.status === 'active' && dueDateObj && daysUntilDue <= 7 && daysUntilDue > 0) {
                    alerts.push({
                        level: 'warning',
                        icon: '⚠️',
                        title: 'Due Soon',
                        message: `${project.name} due in ${daysUntilDue} day${daysUntilDue === 1 ? '' : 's'}`,
                        action: 'Check Progress',
                        projectId: project.id,
                        priority: 2
                    });
                }

                if (project.status === 'active' && (project.progress || 0) < 25 &&
                    dueDateObj && daysUntilDue <= 30) {
                    alerts.push({
                        level: 'warning',
                        icon: '🐌',
                        title: 'Slow Progress',
                        message: `${project.name} only ${project.progress || 0}% complete with ${daysUntilDue} days left`,
                        action: 'Review Tasks',
                        projectId: project.id,
                        priority: 2
                    });
                }

                const incompleteTasks = getTasks(project).filter(t => t.status !== 'completed').length;
                if (project.status === 'completed' && incompleteTasks > 0) {
                    alerts.push({
                        level: 'warning',
                        icon: '❗',
                        title: 'Inconsistent Status',
                        message: `${project.name} marked complete but has ${incompleteTasks} open task${incompleteTasks === 1 ? '' : 's'}`,
                        action: 'Review Tasks',
                        projectId: project.id,
                        priority: 2
                    });
                }

                // INFO ALERTS
                if (project.status === 'on-hold') {
                    const onHoldDays = project.updatedAt ?
                        Math.ceil((currentDate - new Date(project.updatedAt)) / (1000 * 60 * 60 * 24)) : 0;
                    if (onHoldDays >= 14) {
                        alerts.push({
                            level: 'info',
                            icon: '⏸️',
                            title: 'Long-term Hold',
                            message: `${project.name} on hold for ${onHoldDays} days`,
                            action: 'Review Status',
                            projectId: project.id,
                            priority: 3
                        });
                    }
                }

                if (project.status === 'active' && (!project.tasks || project.tasks.length === 0)) {
                    alerts.push({
                        level: 'info',
                        icon: '📝',
                        title: 'No Tasks Defined',
                        message: `${project.name} has no tasks - consider breaking down work`,
                        action: 'Add Tasks',
                        projectId: project.id,
                        priority: 3
                    });
                }
            });

            // Sort alerts by priority and limit
            alerts.sort((a, b) => a.priority - b.priority);
            const topAlerts = alerts.slice(0, 12);

            // Update badge count
            const alertBadge = document.querySelector('.nav-item[onclick*="alerts"] .nav-item-badge');
            if (alertBadge) {
                const criticalCount = alerts.filter(a => a.level === 'critical').length;
                alertBadge.textContent = criticalCount || alerts.length;
                alertBadge.style.display = alerts.length > 0 ? 'inline' : 'none';
            }

            const metricsGrid = document.getElementById('metricsGrid');
            if (topAlerts.length === 0) {
                metricsGrid.innerHTML = `
                    <div class="alert-empty" style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">✅</div>
                        <h2 style="color: var(--success-600); margin: 0 0 0.5rem 0;">All Clear!</h2>
                        <p style="color: var(--gray-600); margin: 0;">No critical issues or warnings detected across your projects.</p>
                    </div>
                `;
            } else {
                metricsGrid.innerHTML = `
                    <div class="alerts-header" style="grid-column: 1 / -1; margin-bottom: 1rem;">
                        <h2 style="color: var(--gray-800); margin: 0;">🚨 Project Alerts</h2>
                        <p style="color: var(--gray-600); margin: 0.5rem 0 0 0;">Issues requiring immediate attention (${topAlerts.length} alert${topAlerts.length === 1 ? '' : 's'})</p>
                    </div>
                    ${topAlerts.map(alert => `
                        <div class="alert-card metric-card fade-in ${alert.level}" onclick="viewProject('${alert.projectId}')" style="cursor: pointer;">
                            <div class="metric-header">
                                <div class="metric-icon ${alert.level === 'critical' ? 'danger' : alert.level === 'warning' ? 'warning' : 'info'}">${alert.icon}</div>
                            </div>
                            <div class="alert-title" style="font-weight: 600; color: var(--gray-900); margin-bottom: 0.25rem;">${alert.title}</div>
                            <div class="alert-message" style="font-size: 0.875rem; color: var(--gray-700); margin-bottom: 0.5rem;">${alert.message}</div>
                            <div class="alert-action" style="font-size: 0.75rem; color: var(--primary-600); font-weight: 500;">${alert.action} →</div>
                        </div>
                    `).join('')}
                `;
            }
        }

        let currentProjectView = 'list';
        let currentProjectFilter = 'all';

        function showProjectsTab(tab) {
            // Show projects tab: tab
            currentProjectView = tab;

            // Update active state in sidebar
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.textContent.includes('List View') ||
                    item.textContent.includes('Kanban Board') ||
                    item.textContent.includes('Calendar View')) {
                    item.classList.remove('active');
                }
            });

            // Find and activate the clicked tab
            const tabs = document.querySelectorAll('.nav-item');
            tabs.forEach(tabElement => {
                const text = tabElement.textContent.toLowerCase();
                if ((tab === 'list' && text.includes('list view')) ||
                    (tab === 'kanban' && text.includes('kanban board')) ||
                    (tab === 'calendar' && text.includes('calendar view'))) {
                    tabElement.classList.add('active');
                }
            });

            // Render the appropriate view
            renderProjectView(tab, currentProjectFilter);
        }

        function renderProjectView(view, filter = 'all') {
            let projects = [...(AppState.projects || [])];

            // Apply filter first
            switch(filter) {
                case 'active':
                    projects = projects.filter(p => p.status === 'active');
                    break;
                case 'completed':
                    projects = projects.filter(p => p.status === 'completed');
                    break;
                case 'overdue':
                    projects = projects.filter(p => {
                        const dueDate = p.dueDate || p.endDate;
                        return dueDate && new Date(dueDate) < new Date() && p.status !== 'completed';
                    });
                    break;
            }

            // Render based on view type
            switch(view) {
                case 'list':
                    renderListView(projects);
                    break;
                case 'calendar':
                    renderCalendarView(projects);
                    break;
                default:
                    renderListView(projects);
            }

            // Update counts in sidebar
            updateProjectCounts();
        }

        // Current report state
        let currentReportTab = 'executive';


        function showReportTab(tab) {
            // Show report tab: tab
            currentReportTab = tab;

            // Update active state in sidebar
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Find and activate the clicked tab
            const tabs = document.querySelectorAll('.nav-item');
            tabs.forEach(tabElement => {
                if (tabElement.textContent.toLowerCase().includes(tab.toLowerCase())) {
                    tabElement.classList.add('active');
                }
            });

            // Load content based on tab
            const reportContent = document.getElementById('reportContent');
            if (!reportContent) return;

            switch(tab) {
                case 'executive':
                    loadExecutiveReport();
                    break;
                case 'detailed':
                    loadDetailedAnalyticsReport();
                    break;
                case 'financial':
                    loadFinancialReport();
                    break;
                case 'team':
                    loadTeamPerformanceReport();
                    break;
                default:
                    loadDetailedAnalyticsReport();
            }
        }

        async function loadExecutiveReport() {
            const reportContent = document.getElementById('reportContent');
            if (!reportContent) return;
            
            // Load the executive dashboard content
            await loadExecutiveDashboard();
        }

        async function loadDetailedAnalyticsReport() {
            const reportContent = document.getElementById('reportContent');
            if (!reportContent) return;
            
            // Ensure we have fresh data from backend if in backend mode
            if (isBackendMode() && (!AppState.projects || AppState.projects.length === 0)) {
                try {
                    await loadProjectsFromBackend();
                } catch (error) {
                    console.warn('Could not load fresh data from backend:', error);
                }
            }
            
            reportContent.innerHTML = `
                <div class="report-charts">
                    <!-- Project Performance Trends -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h4>Project Performance Trends</h4>
                            <div class="chart-controls">
                                <button class="chart-toggle active" onclick="switchPerformanceChart('progress')">Progress</button>
                                <button class="chart-toggle" onclick="switchPerformanceChart('budget')">Budget</button>
                                <button class="chart-toggle" onclick="switchPerformanceChart('timeline')">Timeline</button>
                            </div>
                        </div>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>

                    <!-- RAG Status Distribution -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h4>Project Health Status (RAG)</h4>
                            <p class="chart-subtitle">Red = Critical Issues (≥10% tasks red) | Yellow = At Risk (≥20% tasks yellow) | Green = On Track</p>
                        </div>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="statusDistributionChart"></canvas>
                        </div>
                    </div>

                    <!-- Task RAG Status -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h4>Task Health Status (RAG)</h4>
                            <p class="chart-subtitle">Individual task status across all projects</p>
                        </div>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="taskRAGChart"></canvas>
                        </div>
                    </div>

                    <!-- Budget Variance Analysis -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h4>Budget Variance Analysis</h4>
                            <p class="chart-subtitle">Estimated vs Actual Budget by Project</p>
                        </div>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="budgetAnalysisChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Detailed Tables -->
                <div class="report-tables">
                    <div class="report-section">
                        <h4>Project Performance Summary</h4>
                        <div class="table-container">
                            <table class="report-table" id="projectSummaryTable">
                                <thead>
                                    <tr>
                                        <th>Project</th>
                                        <th>RAG Status</th>
                                        <th>Progress</th>
                                        <th>Budget Variance</th>
                                        <th>Timeline Status</th>
                                        <th>Deliverables</th>
                                    </tr>
                                </thead>
                                <tbody id="projectSummaryBody">
                                    <tr><td colspan="6" style="text-align: center;">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            // Load the analytics content
            setTimeout(() => {
                renderReportCharts();
                loadProjectSummaryTable();
            }, 100);
        }

        async function loadExecutiveSummary() {
            try {
                // Loading executive summary...
                const projects = AppState.projects || [];

                // Calculate metrics from actual project data
                const totalProjects = projects.length;
                const completedProjects = projects.filter(p => p.status === 'completed').length;
                const completionRate = totalProjects > 0 ? Math.round((completedProjects / totalProjects) * 100) : 0;

                // Calculate projects on budget (within 10% variance)
                const projectsWithBudgets = projects.filter(p => p.estimatedBudget && p.actualBudget);
                const projectsOnBudget = projectsWithBudgets.filter(p => {
                    const variance = Math.abs((p.actualBudget - p.estimatedBudget) / p.estimatedBudget) * 100;
                    return variance <= 10;
                }).length;

                const totalBudget = projects.reduce((sum, p) => sum + (p.estimatedBudget || 0), 0);
                const spentBudget = projects.reduce((sum, p) => sum + (p.actualBudget || 0), 0);
                const remainingBudget = totalBudget - spentBudget;

                const atRiskProjects = projects.filter(p => {
                    if (p.status === 'completed') return false;
                    if (p.endDate && new Date(p.endDate) < new Date()) return true;
                    if (p.progress < 50 && p.status === 'active') return true;
                    return false;
                }).length;

                // Update KPIs
                document.getElementById('kpi-projects').textContent = totalProjects;
                document.getElementById('kpi-completion').textContent = completionRate + '%';
                document.getElementById('kpi-budget').textContent = projectsOnBudget + '/' + projectsWithBudgets.length;
                document.getElementById('kpi-risk').textContent = atRiskProjects + ' at risk';

                // Update financial overview
                document.getElementById('exec-total-budget').textContent = '$' + totalBudget.toLocaleString();
                document.getElementById('exec-spent-budget').textContent = '$' + spentBudget.toLocaleString();
                document.getElementById('exec-remaining-budget').textContent = '$' + remainingBudget.toLocaleString();
                const budgetVariance = totalBudget > 0 ? Math.round(((spentBudget - totalBudget) / totalBudget) * 100) : 0;
                document.getElementById('exec-budget-util').textContent = (budgetVariance > 0 ? '+' : '') + budgetVariance + '%';

                // Generate strategic insights based on project data
                const insights = [];

                if (completionRate >= 80) {
                    insights.push({
                        type: 'success',
                        title: 'Excellent Completion Rate',
                        message: `${completionRate}% project completion rate is well above industry average.`
                    });
                } else if (completionRate < 60) {
                    insights.push({
                        type: 'warning',
                        title: 'Low Completion Rate',
                        message: `${completionRate}% completion rate needs attention. Consider reviewing project management processes.`
                    });
                }

                if (projectsWithBudgets.length > 0) {
                    const budgetPerformanceRate = Math.round((projectsOnBudget / projectsWithBudgets.length) * 100);
                    if (budgetPerformanceRate >= 80) {
                        insights.push({
                            type: 'success',
                            title: 'Excellent Budget Performance',
                            message: `${budgetPerformanceRate}% of projects are within budget variance (±10%).`
                        });
                    } else if (budgetPerformanceRate < 60) {
                        insights.push({
                            type: 'warning',
                            title: 'Budget Variance Concerns',
                            message: `Only ${budgetPerformanceRate}% of projects are within budget. Review cost controls.`
                        });
                    }
                }

                if (atRiskProjects > 0) {
                    insights.push({
                        type: 'warning',
                        title: 'Projects at Risk',
                        message: `${atRiskProjects} project(s) require immediate attention to prevent delays.`
                    });
                } else {
                    insights.push({
                        type: 'success',
                        title: 'All Projects on Track',
                        message: 'No projects are currently at risk of delays or budget overruns.'
                    });
                }

                // Update strategic insights
                const insightsContainer = document.getElementById('strategicInsights');
                if (insightsContainer) {
                    insightsContainer.innerHTML = insights.map(insight => `
                        <div class="insight-card insight-${insight.type}">
                            <div class="insight-header">
                                <span class="insight-icon">${insight.type === 'success' ? '✅' : insight.type === 'warning' ? '⚠️' : 'ℹ️'}</span>
                                <strong>${insight.title}</strong>
                            </div>
                            <p>${insight.message}</p>
                        </div>
                    `).join('');
                }

                // Update critical projects with actual at-risk projects
                const criticalProjects = projects.filter(p => {
                    if (p.status === 'completed') return false;
                    if (p.endDate && new Date(p.endDate) < new Date()) return true;
                    if (p.progress < 50 && p.status === 'active') return true;
                    return false;
                }).slice(0, 5); // Top 5 critical projects

                const criticalContainer = document.getElementById('criticalProjects');
                if (criticalContainer) {
                    if (criticalProjects.length > 0) {
                        criticalContainer.innerHTML = criticalProjects.map(project => {
                            const isOverdue = project.endDate && new Date(project.endDate) < new Date();
                            return `
                                <div class="critical-project-item">
                                    <div class="critical-project-name">${project.name}</div>
                                    <div class="critical-project-details">
                                        <span class="status-badge ${project.status}">${formatStatus(project.status)}</span>
                                        <span class="progress">${project.progress || 0}% complete</span>
                                        ${isOverdue ? '<span class="overdue-badge">OVERDUE</span>' : ''}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        criticalContainer.innerHTML = '<div class="no-critical">No critical projects at this time ✅</div>';
                    }
                }

            } catch (error) {
                console.error('Error loading executive summary:', error);
                showNotification('Failed to load executive summary', 'error');
            }
        }

        // ==================== CHART FUNCTIONS ====================
        let reportCharts = {};

        async function renderReportCharts() {
            try {
                const period = document.getElementById('reportPeriod')?.value || '30';
                const userRole = ((AppState.user?.Role?.name || AppState.user?.role || '') + '').toLowerCase().replace('-', '_') || 'auditor';

                // Role-based chart visibility
                const chartPermissions = {
                    'auditor': ['performance', 'status'],
                    'manager': ['performance', 'status', 'taskrag'],
                    'project_manager': ['performance', 'status', 'taskrag', 'budget'],
                    'admin': ['performance', 'status', 'taskrag', 'budget']
                };
                chartPermissions['owner'] = chartPermissions['admin'];
                chartPermissions['superadmin'] = chartPermissions['admin'];
                chartPermissions['root'] = chartPermissions['admin'];


                const allowedCharts = chartPermissions[userRole] || ['performance', 'status'];

                // Hide charts not allowed for this role
                const chartContainers = {
                    'performance': 'performanceChart',
                    'status': 'statusDistributionChart',
                    'taskrag': 'taskRAGChart',
                    'budget': 'budgetAnalysisChart'
                };

                Object.entries(chartContainers).forEach(([chartType, containerId]) => {
                    const container = document.getElementById(containerId)?.parentElement?.parentElement;
                    if (container) {
                        container.style.display = allowedCharts.includes(chartType) ? 'block' : 'none';
                    }
                });

                // Render allowed charts
                const renderPromises = [];
                if (allowedCharts.includes('performance')) {
                    renderPromises.push(renderPerformanceChart('progress', period));
                }
                if (allowedCharts.includes('status')) {
                    renderPromises.push(renderStatusDistributionChart(period));
                }
                if (allowedCharts.includes('taskrag')) {
                    renderPromises.push(renderTaskRAGChart(period));
                }
                if (allowedCharts.includes('budget')) {
                    renderPromises.push(renderBudgetAnalysisChart(period));
                }

                await Promise.all(renderPromises);

            } catch (error) {
                console.error('Error rendering report charts:', error);
            }
        }


        async function renderPerformanceChart(type = 'progress', period = '30') {
            try {
                const projects = AppState.projects || [];
                const ctx = document.getElementById('performanceChart');
                if (!ctx) return;

                // Destroy existing chart
                if (reportCharts.performance) {
                    reportCharts.performance.destroy();
                }

                // Generate chart data from actual projects
                const chartData = generatePerformanceChartData(projects, type);
                if (!chartData) return;

                const config = {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: { usePointStyle: true }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(0, 0, 0, 0.1)' },
                                ticks: {
                                    callback: function(value) {
                                        return type === 'budget' ? '$' + value.toLocaleString() : value + '%';
                                    }
                                }
                            },
                            x: { grid: { display: false } }
                        },
                        elements: {
                            point: { radius: 4, hoverRadius: 6 },
                            line: { tension: 0.4 }
                        }
                    }
                };

                reportCharts.performance = new Chart(ctx, config);
            } catch (error) {
                console.error('Error rendering performance chart:', error);
            }
        }

        function generatePerformanceChartData(projects, type) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
            const data = [];

            // Sample data generation - in real app this would use actual historical data
            for (let i = 0; i < months.length; i++) {
                if (type === 'progress') {
                    data.push(Math.round(60 + (i * 8) + (Math.random() * 10)));
                } else if (type === 'budget') {
                    data.push(Math.round(75 + (i * 5) + (Math.random() * 8)));
                } else {
                    data.push(Math.round(80 + (i * 3) + (Math.random() * 5)));
                }
            }

            return {
                labels: months,
                datasets: [{
                    label: type === 'progress' ? 'Progress %' : type === 'budget' ? 'Budget Utilization %' : 'Timeline Accuracy %',
                    data: data,
                    borderColor: 'rgb(14, 165, 233)',
                    backgroundColor: 'rgba(14, 165, 233, 0.1)',
                    fill: true
                }]
            };
        }

        function generateStatusChartData(projects) {
            // Red/Yellow/Green status based on project health
            const ragStatus = {
                green: 0,
                yellow: 0,
                red: 0
            };

            projects.forEach(project => {
                const health = calculateProjectHealth(project);
                if (health === 'green') ragStatus.green++;
                else if (health === 'yellow') ragStatus.yellow++;
                else ragStatus.red++;
            });

            return {
                labels: ['On Track (Green)', 'At Risk (Yellow)', 'Critical (Red)'],
                datasets: [{
                    data: [ragStatus.green, ragStatus.yellow, ragStatus.red],
                    backgroundColor: [
                        'rgba(34, 197, 94, 0.8)',   // Green
                        'rgba(245, 158, 11, 0.8)',   // Yellow
                        'rgba(239, 68, 68, 0.8)'     // Red
                    ],
                    borderColor: [
                        'rgb(34, 197, 94)',   // Green
                        'rgb(245, 158, 11)',   // Yellow
                        'rgb(239, 68, 68)'     // Red
                    ],
                    borderWidth: 1
                }]
            };
        }

        function calculateProjectHealth(project) {
            // Green: On track, no issues
            // Yellow: At risk if Yellow tasks exceed threshold
            // Red: Critical if Red tasks exceed threshold

            // Aggregate task-level RAG to influence project health using thresholds
            const tasks = Array.isArray(project.tasks) ? project.tasks : [];
            const openTasks = tasks.filter(t => (t?.status || '').toLowerCase() !== 'completed');
            const consider = openTasks.length ? openTasks : tasks;

            let green = 0, yellow = 0, red = 0;
            for (const t of consider) {
                const rag = (t?.ragStatus || '').toLowerCase();
                if (rag === 'red') red++;
                else if (rag === 'yellow') yellow++;
                else if (rag === 'green') green++;
            }
            const total = consider.length || 0;
            const percRed = total ? (red / total) * 100 : 0;
            const percYellow = total ? (yellow / total) * 100 : 0;
            const small = total > 0 && total <= 5; // small project override

            // Project-level status overrides
            if (project.status === 'cancelled') return 'red';
            if (project.status === 'on-hold') return 'yellow';
            if (project.status === 'completed') {
                // Check if completed on time and on budget
                const onTime = !project.endDate || !project.dueDate || new Date(project.endDate) <= new Date(project.dueDate);
                const budgetVariance = project.actualBudget && project.estimatedBudget ?
                    ((project.actualBudget - project.estimatedBudget) / project.estimatedBudget) * 100 : 0;

                if (onTime && budgetVariance <= 10) return 'green';
                else if (onTime && budgetVariance <= 25) return 'yellow';
                else return 'red';
            }

            // Thresholds for visibility of risk
            // Red if ≥10% tasks are red, or any red on very small projects
            if (percRed >= 10 || (small && red >= 1)) return 'red';
            // Yellow if ≥20% tasks are yellow, or any yellow on very small projects
            if (percYellow >= 20 || (small && yellow >= 1)) return 'yellow';

            // For active projects, also consider schedule/progress
            const now = new Date();
            const isOverdue = project.dueDate && new Date(project.dueDate) < now;
            const progress = project.progress || 0;

            // Calculate expected progress based on timeline
            let expectedProgress = 0;
            if (project.startDate && project.dueDate) {
                const totalMs = new Date(project.dueDate) - new Date(project.startDate);
                const elapsedMs = now - new Date(project.startDate);
                expectedProgress = totalMs > 0 ? Math.min(100, Math.max(0, (elapsedMs / totalMs) * 100)) : 0;
            }

            const progressGap = expectedProgress - progress;

            if (isOverdue) return 'red';
            if (progressGap > 20) return 'red';    // More than 20% behind schedule
            if (progressGap > 10) return 'yellow'; // 10-20% behind schedule
            if (progress >= 90) return 'green';    // Nearly complete
            if (progressGap > 0) return 'yellow';  // Slightly behind

            return 'green';                        // On track or ahead
        }

        function calculateBreakfixSpending() {
            const breakfixProjects = (AppState.projects || []).filter(p => 
                p.type && p.type.toLowerCase().includes('breakfix')
            );
            const totalSpent = breakfixProjects.reduce((sum, p) => sum + (p.actualBudget || 0), 0);
            
            AppState.breakfixBudget.spentAmount = totalSpent;
            AppState.breakfixBudget.remainingBudget = AppState.breakfixBudget.totalBudget - totalSpent;
            
            return {
                totalBudget: AppState.breakfixBudget.totalBudget,
                spentAmount: totalSpent,
                remainingBudget: AppState.breakfixBudget.remainingBudget,
                utilizationRate: AppState.breakfixBudget.totalBudget > 0 ? 
                    Math.round((totalSpent / AppState.breakfixBudget.totalBudget) * 100) : 0,
                projectCount: breakfixProjects.length,
                projects: breakfixProjects
            };
        }

        function calculateRefreshSpending() {
            const refreshProjects = (AppState.projects || []).filter(p => 
                p.type && p.type.toLowerCase().includes('refresh')
            );
            const totalSpent = refreshProjects.reduce((sum, p) => sum + (p.actualBudget || 0), 0);
            
            AppState.refreshBudget.spentAmount = totalSpent;
            AppState.refreshBudget.remainingBudget = AppState.refreshBudget.totalBudget - totalSpent;
            
            return {
                totalBudget: AppState.refreshBudget.totalBudget,
                spentAmount: totalSpent,
                remainingBudget: AppState.refreshBudget.remainingBudget,
                utilizationRate: AppState.refreshBudget.totalBudget > 0 ? 
                    Math.round((totalSpent / AppState.refreshBudget.totalBudget) * 100) : 0,
                projectCount: refreshProjects.length,
                projects: refreshProjects
            };
        }

        function calculateBudgetSpending() {
            calculateBreakfixSpending();
            calculateRefreshSpending();
        }

        async function updateBreakfixBudget(newBudget) {
            AppState.breakfixBudget.totalBudget = newBudget;
            AppState.breakfixBudget.lastUpdated = new Date().toISOString();
            calculateBreakfixSpending(); // Recalculate remaining budget
            
            // Save to database
            if (isBackendMode()) {
                try {
                    await apiFetch('/settings', {
                        method: 'POST',
                        body: JSON.stringify({
                            key: 'breakfixBudget',
                            value: AppState.breakfixBudget,
                            type: 'json',
                            category: 'financial',
                            description: 'Breakfix budget configuration'
                        })
                    });
                } catch (error) {
                    console.error('Error saving breakfix budget:', error);
                }
            }
            
            showNotification(`Breakfix budget updated to $${newBudget.toLocaleString()}`, 'success');
        }

        async function updateRefreshBudget(newBudget) {
            AppState.refreshBudget.totalBudget = newBudget;
            AppState.refreshBudget.lastUpdated = new Date().toISOString();
            calculateRefreshSpending(); // Recalculate remaining budget
            
            // Save to database
            if (isBackendMode()) {
                try {
                    await apiFetch('/settings', {
                        method: 'POST',
                        body: JSON.stringify({
                            key: 'refreshBudget',
                            value: AppState.refreshBudget,
                            type: 'json',
                            category: 'financial',
                            description: 'Refresh budget configuration'
                        })
                    });
                } catch (error) {
                    console.error('Error saving refresh budget:', error);
                }
            }
            
            showNotification(`Refresh budget updated to $${newBudget.toLocaleString()}`, 'success');
        }

        function showBreakfixBudgetEditor() {
            const currentBudget = AppState.breakfixBudget.totalBudget;
            const newBudget = prompt(
                `Enter the annual breakfix budget:\n\nCurrent budget: $${currentBudget.toLocaleString()}`,
                currentBudget
            );
            
            if (newBudget === null) return; // User cancelled
            
            const budgetValue = parseFloat(newBudget);
            if (isNaN(budgetValue) || budgetValue < 0) {
                showNotification('Please enter a valid positive number', 'error');
                return;
            }
            
            updateBreakfixBudget(budgetValue);
        }

        function showRefreshBudgetEditor() {
            const currentBudget = AppState.refreshBudget.totalBudget;
            const newBudget = prompt(
                `Enter the annual refresh budget:\n\nCurrent budget: $${currentBudget.toLocaleString()}`,
                currentBudget
            );
            
            if (newBudget === null) return; // User cancelled
            
            const budgetValue = parseFloat(newBudget);
            if (isNaN(budgetValue) || budgetValue < 0) {
                showNotification('Please enter a valid positive number', 'error');
                return;
            }
            
            updateRefreshBudget(budgetValue);
        }

        function generateFinancialData(projects) {
            const totalBudget = projects.reduce((sum, p) => sum + (p.estimatedBudget || 0), 0);
            const actualSpend = projects.reduce((sum, p) => sum + (p.actualBudget || 0), 0);
            const spendVariance = actualSpend - totalBudget;
            const utilizationRate = totalBudget > 0 ? Math.round((actualSpend / totalBudget) * 100) : 0;
            const overBudgetProjects = projects.filter(p => 
                (p.actualBudget || 0) > (p.estimatedBudget || 0)
            ).length;

            const projectBreakdown = projects.map(project => {
                const estimated = project.estimatedBudget || 0;
                const actual = project.actualBudget || 0;
                const variance = actual - estimated;
                let budgetStatus = 'on';
                if (variance > 0) budgetStatus = 'over';
                else if (variance < -100) budgetStatus = 'under';

                return {
                    name: project.name,
                    estimated,
                    actual,
                    variance,
                    budgetStatus
                };
            });

            const typeGroups = {};
            projects.forEach(project => {
                const type = project.type || 'Other';
                if (!typeGroups[type]) typeGroups[type] = { budget: 0, count: 0 };
                typeGroups[type].budget += project.estimatedBudget || 0;
                typeGroups[type].count += 1;
            });

            const typeBreakdown = Object.entries(typeGroups).map(([type, data]) => ({
                type,
                budget: data.budget,
                count: data.count,
                percentage: totalBudget > 0 ? Math.round((data.budget / totalBudget) * 100) : 0
            }));

            return {
                totalBudget,
                actualSpend,
                spendVariance,
                utilizationRate,
                overBudgetProjects,
                projectBreakdown,
                typeBreakdown
            };
        }

        function generateTeamPerformanceData(projects) {
            const allTasks = projects.flatMap(p => p.tasks || []);
            const activeMembers = new Set(allTasks.map(t => t.assignee).filter(a => a && a.trim())).size;
            const completedTasks = allTasks.filter(t => t.status === 'completed').length;
            const completionRate = allTasks.length > 0 ? Math.round((completedTasks / allTasks.length) * 100) : 0;
            
            const tasksWithHours = allTasks.filter(t => t.actualHours && t.actualHours > 0);
            const avgHoursPerTask = tasksWithHours.length > 0 ? 
                Math.round(tasksWithHours.reduce((sum, t) => sum + t.actualHours, 0) / tasksWithHours.length) : 0;

            const onTimeTasks = allTasks.filter(t => {
                if (!t.dueDate || !t.completedDate) return false;
                const dueDate = new Date(t.dueDate);
                const completedDate = new Date(t.completedDate);
                return completedDate <= dueDate;
            });
            const onTimeRate = completedTasks > 0 ? Math.round((onTimeTasks.length / completedTasks) * 100) : 0;

            const memberStats = {};
            allTasks.forEach(task => {
                const assignee = task.assignee || 'Unassigned';
                if (!memberStats[assignee]) {
                    memberStats[assignee] = {
                        name: assignee,
                        assignedTasks: 0,
                        completedTasks: 0,
                        totalHours: 0,
                        taskCount: 0
                    };
                }
                
                memberStats[assignee].assignedTasks++;
                if (task.status === 'completed') {
                    memberStats[assignee].completedTasks++;
                }
                if (task.actualHours) {
                    memberStats[assignee].totalHours += task.actualHours;
                    memberStats[assignee].taskCount++;
                }
            });

            const memberBreakdown = Object.values(memberStats).map(member => {
                const completionRate = member.assignedTasks > 0 ? 
                    Math.round((member.completedTasks / member.assignedTasks) * 100) : 0;
                const avgHours = member.taskCount > 0 ? 
                    Math.round(member.totalHours / member.taskCount) : 0;
                
                let performance = 'Average';
                if (completionRate >= 90) performance = 'Excellent';
                else if (completionRate >= 75) performance = 'Good';
                else if (completionRate < 50) performance = 'Needs Improvement';

                return {
                    ...member,
                    completionRate,
                    avgHours,
                    performance
                };
            });

            const statusCounts = {};
            allTasks.forEach(task => {
                const status = task.status || 'Not Started';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            const statusBreakdown = Object.entries(statusCounts).map(([status, count]) => ({
                status,
                count,
                percentage: allTasks.length > 0 ? Math.round((count / allTasks.length) * 100) : 0
            }));

            return {
                activeMembers,
                completedTasks,
                completionRate,
                avgHoursPerTask,
                onTimeRate,
                memberBreakdown,
                statusBreakdown
            };
        }

        async function loadFinancialReport() {
            const reportContent = document.getElementById('reportContent');
            if (!reportContent) return;
            
            // Ensure we have fresh data from backend if in backend mode
            if (isBackendMode() && (!AppState.projects || AppState.projects.length === 0)) {
                try {
                    await loadProjectsFromBackend();
                } catch (error) {
                    console.warn('Could not load fresh data from backend:', error);
                }
            }
            
            const projects = AppState.projects || [];
            const financialData = generateFinancialData(projects);
            const breakfixData = calculateBreakfixSpending();
            const refreshData = calculateRefreshSpending();
            
            console.log('Financial Report Data:', { breakfixData, refreshData }); // Debug log
            
            reportContent.innerHTML = `
                <div class="executive-header">
                    <h2>Financial Report</h2>
                    <p class="report-subtitle">Project budget analysis and cost tracking</p>
                    <div class="budget-edit-buttons">
                        <button class="edit-budget-btn" onclick="showBreakfixBudgetEditor()">
                            🔧 Edit Breakfix Budget
                        </button>
                        <button class="edit-budget-btn" onclick="showRefreshBudgetEditor()">
                            🔄 Edit Refresh Budget
                        </button>
                    </div>
                </div>
                
                <div class="executive-cards">
                    <div class="executive-card">
                        <div class="card-icon">💰</div>
                        <div class="card-content">
                            <div class="card-title">Total Budget</div>
                            <div class="card-value">$${financialData.totalBudget.toLocaleString()}</div>
                            <div class="card-change">Allocated across ${projects.length} projects</div>
                        </div>
                    </div>
                    <div class="executive-card">
                        <div class="card-icon">💸</div>
                        <div class="card-content">
                            <div class="card-title">Actual Spend</div>
                            <div class="card-value">$${financialData.actualSpend.toLocaleString()}</div>
                            <div class="card-change ${financialData.spendVariance >= 0 ? 'positive' : 'negative'}">
                                ${financialData.spendVariance >= 0 ? '+' : ''}$${financialData.spendVariance.toLocaleString()} vs budget
                            </div>
                        </div>
                    </div>
                    <div class="executive-card">
                        <div class="card-icon">📊</div>
                        <div class="card-content">
                            <div class="card-title">Budget Utilization</div>
                            <div class="card-value">${financialData.utilizationRate}%</div>
                            <div class="card-change">Of allocated budget</div>
                        </div>
                    </div>
                    <div class="executive-card">
                        <div class="card-icon">⚠️</div>
                        <div class="card-content">
                            <div class="card-title">Over Budget</div>
                            <div class="card-value">${financialData.overBudgetProjects}</div>
                            <div class="card-change">Projects exceeding budget</div>
                        </div>
                    </div>
                </div>

                <div class="breakfix-budget-section">
                    <h2>Breakfix Budget Status</h2>
                    <div class="breakfix-cards">
                        <div class="executive-card ${breakfixData.utilizationRate > 90 ? 'warning' : ''}">
                            <div class="card-icon">🔧</div>
                            <div class="card-content">
                                <div class="card-title">Breakfix Budget</div>
                                <div class="card-value">$${breakfixData.totalBudget.toLocaleString()}</div>
                                <div class="card-change">Annual allocation</div>
                            </div>
                        </div>
                        <div class="executive-card">
                            <div class="card-icon">💸</div>
                            <div class="card-content">
                                <div class="card-title">Spent to Date</div>
                                <div class="card-value">$${breakfixData.spentAmount.toLocaleString()}</div>
                                <div class="card-change">${breakfixData.utilizationRate}% utilized</div>
                            </div>
                        </div>
                        <div class="executive-card ${breakfixData.remainingBudget < 0 ? 'danger' : ''}">
                            <div class="card-icon">💰</div>
                            <div class="card-content">
                                <div class="card-title">Remaining Budget</div>
                                <div class="card-value">$${breakfixData.remainingBudget.toLocaleString()}</div>
                                <div class="card-change">${breakfixData.projectCount} breakfix projects</div>
                            </div>
                        </div>
                        <div class="executive-card">
                            <div class="card-icon">📊</div>
                            <div class="card-content">
                                <div class="card-title">Budget Health</div>
                                <div class="card-value">
                                    ${breakfixData.utilizationRate > 100 ? 'OVER BUDGET' :
                                      breakfixData.utilizationRate > 90 ? 'CRITICAL' :
                                      breakfixData.utilizationRate > 75 ? 'WARNING' : 'HEALTHY'}
                                </div>
                                <div class="card-change">Current status</div>
                            </div>
                        </div>
                    </div>
                    
                    ${breakfixData.projects.length > 0 ? `
                        <div class="breakfix-projects">
                            <h3>Breakfix Projects</h3>
                            <div class="financial-table-container">
                                <table class="financial-table">
                                    <thead>
                                        <tr>
                                            <th>Project</th>
                                            <th>Status</th>
                                            <th>Budget Used</th>
                                            <th>Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${breakfixData.projects.map(project => `
                                            <tr>
                                                <td>${project.name}</td>
                                                <td>
                                                    <span class="status-badge ${project.status}">${project.status}</span>
                                                </td>
                                                <td>$${(project.actualBudget || 0).toLocaleString()}</td>
                                                <td>${project.requestDate || 'N/A'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    ` : '<div class="no-breakfix">No breakfix projects found</div>'}
                </div>

                <div class="refresh-budget-section">
                    <h2>Refresh Budget Status</h2>
                    <div class="breakfix-cards">
                        <div class="executive-card ${refreshData.utilizationRate > 90 ? 'warning' : ''}">
                            <div class="card-icon">🔄</div>
                            <div class="card-content">
                                <div class="card-title">Refresh Budget</div>
                                <div class="card-value">$${refreshData.totalBudget.toLocaleString()}</div>
                                <div class="card-change">Annual allocation</div>
                            </div>
                        </div>
                        <div class="executive-card">
                            <div class="card-icon">💸</div>
                            <div class="card-content">
                                <div class="card-title">Spent to Date</div>
                                <div class="card-value">$${refreshData.spentAmount.toLocaleString()}</div>
                                <div class="card-change">${refreshData.utilizationRate}% utilized</div>
                            </div>
                        </div>
                        <div class="executive-card ${refreshData.remainingBudget < 0 ? 'danger' : ''}">
                            <div class="card-icon">💰</div>
                            <div class="card-content">
                                <div class="card-title">Remaining Budget</div>
                                <div class="card-value">$${refreshData.remainingBudget.toLocaleString()}</div>
                                <div class="card-change">${refreshData.projectCount} refresh projects</div>
                            </div>
                        </div>
                        <div class="executive-card">
                            <div class="card-icon">📊</div>
                            <div class="card-content">
                                <div class="card-title">Budget Health</div>
                                <div class="card-value">
                                    ${refreshData.utilizationRate > 100 ? 'OVER BUDGET' :
                                      refreshData.utilizationRate > 90 ? 'CRITICAL' :
                                      refreshData.utilizationRate > 75 ? 'WARNING' : 'HEALTHY'}
                                </div>
                                <div class="card-change">Current status</div>
                            </div>
                        </div>
                    </div>
                    
                    ${refreshData.projects.length > 0 ? `
                        <div class="refresh-projects">
                            <h3>Refresh Projects</h3>
                            <div class="financial-table-container">
                                <table class="financial-table">
                                    <thead>
                                        <tr>
                                            <th>Project</th>
                                            <th>Status</th>
                                            <th>Budget Used</th>
                                            <th>Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${refreshData.projects.map(project => `
                                            <tr>
                                                <td>${project.name}</td>
                                                <td>
                                                    <span class="status-badge ${project.status}">${project.status}</span>
                                                </td>
                                                <td>$${(project.actualBudget || 0).toLocaleString()}</td>
                                                <td>${project.requestDate || 'N/A'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    ` : '<div class="no-breakfix">No refresh projects found</div>'}
                </div>

                <div class="financial-details">
                    <div class="financial-section">
                        <h3>Project Budget Breakdown</h3>
                        <div class="financial-table-container">
                            <table class="financial-table">
                                <thead>
                                    <tr>
                                        <th>Project</th>
                                        <th>Estimated Budget</th>
                                        <th>Actual Budget</th>
                                        <th>Variance</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${financialData.projectBreakdown.map(project => `
                                        <tr>
                                            <td>${project.name}</td>
                                            <td>$${project.estimated.toLocaleString()}</td>
                                            <td>$${project.actual.toLocaleString()}</td>
                                            <td class="${project.variance >= 0 ? 'positive' : 'negative'}">
                                                ${project.variance >= 0 ? '+' : ''}$${project.variance.toLocaleString()}
                                            </td>
                                            <td>
                                                <span class="status-badge ${project.budgetStatus}">
                                                    ${project.budgetStatus === 'over' ? 'Over Budget' : 
                                                      project.budgetStatus === 'under' ? 'Under Budget' : 'On Budget'}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="financial-section">
                        <h3>Budget by Project Type</h3>
                        <div class="budget-type-breakdown">
                            ${financialData.typeBreakdown.map(type => `
                                <div class="type-budget-item">
                                    <div class="type-info">
                                        <span class="type-name">${type.type}</span>
                                        <span class="type-count">${type.count} projects</span>
                                    </div>
                                    <div class="type-budget">$${type.budget.toLocaleString()}</div>
                                    <div class="type-percentage">${type.percentage}%</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            showNotification('Financial report loaded', 'success');
        }

        async function loadTeamPerformanceReport() {
            const reportContent = document.getElementById('reportContent');
            if (!reportContent) return;
            
            // Ensure we have fresh data from backend if in backend mode
            if (isBackendMode() && (!AppState.projects || AppState.projects.length === 0)) {
                try {
                    await loadProjectsFromBackend();
                } catch (error) {
                    console.warn('Could not load fresh data from backend:', error);
                }
            }
            
            const projects = AppState.projects || [];
            const teamData = generateTeamPerformanceData(projects);
            
            reportContent.innerHTML = `
                <div class="executive-header">
                    <h2>Team Performance Report</h2>
                    <p class="report-subtitle">Team productivity and task completion analysis</p>
                </div>
                
                <div class="executive-cards">
                    <div class="executive-card">
                        <div class="card-icon">👥</div>
                        <div class="card-content">
                            <div class="card-title">Active Team Members</div>
                            <div class="card-value">${teamData.activeMembers}</div>
                            <div class="card-change">Across all projects</div>
                        </div>
                    </div>
                    <div class="executive-card">
                        <div class="card-icon">✅</div>
                        <div class="card-content">
                            <div class="card-title">Tasks Completed</div>
                            <div class="card-value">${teamData.completedTasks}</div>
                            <div class="card-change">${teamData.completionRate}% completion rate</div>
                        </div>
                    </div>
                    <div class="executive-card">
                        <div class="card-icon">⏱️</div>
                        <div class="card-content">
                            <div class="card-title">Avg Hours/Task</div>
                            <div class="card-value">${teamData.avgHoursPerTask}h</div>
                            <div class="card-change">Team efficiency metric</div>
                        </div>
                    </div>
                    <div class="executive-card">
                        <div class="card-icon">🎯</div>
                        <div class="card-content">
                            <div class="card-title">On-Time Delivery</div>
                            <div class="card-value">${teamData.onTimeRate}%</div>
                            <div class="card-change">Tasks delivered on schedule</div>
                        </div>
                    </div>
                </div>

                <div class="team-details">
                    <div class="team-section">
                        <h3>Team Member Performance</h3>
                        <div class="team-table-container">
                            <table class="team-table">
                                <thead>
                                    <tr>
                                        <th>Team Member</th>
                                        <th>Assigned Tasks</th>
                                        <th>Completed</th>
                                        <th>Completion Rate</th>
                                        <th>Avg Hours/Task</th>
                                        <th>Performance</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${teamData.memberBreakdown.map(member => `
                                        <tr>
                                            <td>${member.name || 'Unassigned'}</td>
                                            <td>${member.assignedTasks}</td>
                                            <td>${member.completedTasks}</td>
                                            <td>${member.completionRate}%</td>
                                            <td>${member.avgHours}h</td>
                                            <td>
                                                <span class="performance-badge ${member.performance.toLowerCase()}">
                                                    ${member.performance}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="team-section">
                        <h3>Task Status Distribution</h3>
                        <div class="status-distribution">
                            ${teamData.statusBreakdown.map(status => `
                                <div class="status-item">
                                    <div class="status-info">
                                        <span class="status-name">${status.status}</span>
                                        <span class="status-count">${status.count} tasks</span>
                                    </div>
                                    <div class="status-bar">
                                        <div class="status-fill ${status.status.toLowerCase()}" 
                                             style="width: ${status.percentage}%"></div>
                                    </div>
                                    <div class="status-percentage">${status.percentage}%</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            showNotification('Team performance report loaded', 'success');
        }

        async function renderTaskRAGChart(period = '30') {
            try {
                const projects = AppState.projects || [];
                const chartData = generateTaskRAGChartData(projects);
                const ctx = document.getElementById('taskRAGChart');
                if (!ctx) return;

                if (reportCharts.taskRAG) {
                    reportCharts.taskRAG.destroy();
                }

                reportCharts.taskRAG = new Chart(ctx, {
                    type: 'doughnut',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: { usePointStyle: true }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? Math.round((context.parsed / total) * 100) : 0;
                                        return `${context.label}: ${context.parsed} tasks (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error rendering task RAG chart:', error);
            }
        }

        function generateTaskRAGChartData(projects) {
            let greenTasks = 0, yellowTasks = 0, redTasks = 0;

            projects.forEach(project => {
                if (project.tasks) {
                    getTasks(project).forEach(task => {
                        const ragStatus = task.ragStatus || 'yellow';
                        if (ragStatus === 'green') greenTasks++;
                        else if (ragStatus === 'yellow') yellowTasks++;
                        else redTasks++;
                    });
                }
            });

            return {
                labels: ['Green - On Track', 'Yellow - At Risk', 'Red - Critical'],
                datasets: [{
                    data: [greenTasks, yellowTasks, redTasks],
                    backgroundColor: [
                        'rgba(34, 197, 94, 0.8)',   // Green
                        'rgba(245, 158, 11, 0.8)',   // Yellow
                        'rgba(239, 68, 68, 0.8)'     // Red
                    ],
                    borderColor: [
                        'rgb(34, 197, 94)',   // Green
                        'rgb(245, 158, 11)',   // Yellow
                        'rgb(239, 68, 68)'     // Red
                    ],
                    borderWidth: 1
                }]
            };
        }

        function generateBudgetVarianceChartData(projects) {
            // Filter projects that have both estimated and actual budgets
            const projectsWithBudgets = projects.filter(p => p.estimatedBudget && p.actualBudget);

            const labels = projectsWithBudgets.map(p => p.name.length > 20 ? p.name.substring(0, 17) + '...' : p.name);
            const estimatedBudgets = projectsWithBudgets.map(p => p.estimatedBudget);
            const actualBudgets = projectsWithBudgets.map(p => p.actualBudget);

            return {
                labels: labels,
                datasets: [{
                    label: 'Estimated Budget',
                    data: estimatedBudgets,
                    backgroundColor: 'rgba(14, 165, 233, 0.6)',
                    borderColor: 'rgb(14, 165, 233)',
                    borderWidth: 1
                }, {
                    label: 'Actual Budget',
                    data: actualBudgets,
                    backgroundColor: 'rgba(239, 68, 68, 0.6)',
                    borderColor: 'rgb(239, 68, 68)',
                    borderWidth: 1
                }]
            };
        }

        async function renderStatusDistributionChart(period = '30') {
            try {
                const projects = AppState.projects || [];
                const chartData = generateStatusChartData(projects);
                const ctx = document.getElementById('statusDistributionChart');
                if (!ctx) return;

                if (reportCharts.statusDistribution) {
                    reportCharts.statusDistribution.destroy();
                }

                const colors = {
                    'Active': '#22c55e',
                    'Completed': '#0ea5e9',
                    'On-hold': '#f59e0b',
                    'Cancelled': '#ef4444',
                    'Draft': '#6b7280'
                };

                reportCharts.statusDistribution = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            data: chartData.datasets[0].data,
                            backgroundColor: chartData.datasets[0].backgroundColor,
                            borderColor: chartData.datasets[0].borderColor,
                            borderWidth: 1,
                            cutout: '60%'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    usePointStyle: true,
                                    padding: 20
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        return `${context.label}: ${context.parsed} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error rendering status distribution chart:', error);
            }
        }

        async function renderTeamUtilizationChart(period = '30') {
            try {
                // Mock team utilization data - in real app, this would come from API
                const teamData = {
                    labels: ['John Smith', 'Sarah Davis', 'Mike Johnson', 'Emily Brown', 'David Wilson'],
                    datasets: [{
                        label: 'Current Workload',
                        data: [85, 92, 67, 78, 88],
                        backgroundColor: 'rgba(34, 197, 94, 0.6)',
                        borderColor: 'rgb(34, 197, 94)',
                        borderWidth: 2
                    }, {
                        label: 'Capacity',
                        data: [100, 100, 100, 100, 100],
                        backgroundColor: 'rgba(156, 163, 175, 0.3)',
                        borderColor: 'rgb(156, 163, 175)',
                        borderWidth: 1
                    }]
                };

                const ctx = document.getElementById('teamUtilizationChart');
                if (!ctx) return;

                if (reportCharts.teamUtilization) {
                    reportCharts.teamUtilization.destroy();
                }

                reportCharts.teamUtilization = new Chart(ctx, {
                    type: 'bar',
                    data: teamData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) { return value + '%'; }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error rendering team utilization chart:', error);
            }
        }

        async function renderBudgetAnalysisChart(period = '30') {
            try {
                const projects = AppState.projects || [];
                const chartData = generateBudgetVarianceChartData(projects);
                const ctx = document.getElementById('budgetAnalysisChart');
                if (!ctx) return;

                if (reportCharts.budgetAnalysis) {
                    reportCharts.budgetAnalysis.destroy();
                }

                reportCharts.budgetAnalysis = new Chart(ctx, {
                    type: 'bar',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: $${context.parsed.y.toLocaleString()}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error rendering budget analysis chart:', error);
            }
        }

        function switchPerformanceChart(type) {
            // Update button states
            document.querySelectorAll('.chart-toggle').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Re-render chart with new type
            const period = document.getElementById('reportPeriod')?.value || '30';
            renderPerformanceChart(type, period);
        }

        async function loadProjectSummaryTable() {
            try {
                const projects = AppState.projects || [];
                const tbody = document.getElementById('projectSummaryBody');
                const userRole = ((AppState.user?.Role?.name || AppState.user?.role || '') + '').toLowerCase().replace('-', '_') || 'auditor';

                // Role-based column filtering
                const columnPermissions = {
                    'auditor': ['name', 'status', 'progress', 'timeline'],
                    'manager': ['name', 'status', 'progress', 'timeline'],
                    'project_manager': ['name', 'status', 'progress', 'budget', 'timeline', 'risk'],
                    'admin': ['name', 'status', 'progress', 'budget', 'timeline', 'risk']
                };
                columnPermissions['owner'] = columnPermissions['admin'];
                columnPermissions['superadmin'] = columnPermissions['admin'];
                columnPermissions['root'] = columnPermissions['admin'];


                const allowedColumns = columnPermissions[userRole] || ['name', 'status', 'progress', 'timeline'];

                // Update table headers based on role
                const tableHeaders = document.querySelector('#projectSummaryTable thead tr');
                if (tableHeaders) {
                    const headerMap = ['name', 'status', 'progress', 'budget', 'timeline', 'risk'];
                    const headers = tableHeaders.querySelectorAll('th');
                    headers.forEach((header, index) => {
                        const columnType = headerMap[index];
                        header.style.display = allowedColumns.includes(columnType) ? '' : 'none';
                    });
                }

                tbody.innerHTML = projects.map(project => {
                    // Calculate budget variance
                    const budgetVariance = project.estimatedBudget && project.actualBudget
                        ? Math.round(((project.actualBudget - project.estimatedBudget) / project.estimatedBudget) * 100)
                        : null;

                    // Get RAG status
                    const ragStatus = calculateProjectHealth(project);
                    const ragInfo = {
                        'green': { label: 'Green', class: 'rag-green', icon: '🟢' },
                        'yellow': { label: 'Yellow', class: 'rag-yellow', icon: '🟡' },
                        'red': { label: 'Red', class: 'rag-red', icon: '🔴' }
                    };

                    // Calculate deliverables status
                    const totalTasks = getTasks(project).length;
                    const completedTasks = getTasks(project).filter(t => t.status === 'completed').length;

                    // Build row with role-based column visibility
                    const cells = [
                        `<td><strong>${project.name}</strong></td>`, // name
                        `<td><span class="${ragInfo[ragStatus].class}">${ragInfo[ragStatus].icon} ${ragInfo[ragStatus].label}</span></td>`, // RAG status
                        `<td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${project.progress || 0}%"></div>
                                <span class="progress-text">${project.progress || 0}%</span>
                            </div>
                        </td>`, // progress
                        `<td>
                            ${budgetVariance !== null ?
                                `<span class="${budgetVariance > 10 ? 'text-danger' : budgetVariance > -10 ? 'text-warning' : 'text-success'}">
                                    ${budgetVariance > 0 ? '+' : ''}${budgetVariance}%
                                </span>` :
                                '<span class="text-muted">No data</span>'
                            }
                        </td>`, // budget variance
                        `<td>
                            ${project.dueDate ?
                                new Date(project.dueDate) < new Date() && project.status !== 'completed' ?
                                    `<span class="text-danger">⚠️ Overdue</span>` :
                                    `<span class="text-success">📅 ${formatDate(project.dueDate)}</span>`
                                : '<span class="text-muted">No deadline</span>'
                            }
                        </td>`, // timeline status
                        `<td>
                            <span>${completedTasks}/${totalTasks} tasks</span>
                            ${totalTasks > 0 ? `<div class="progress-bar small"><div class="progress-fill" style="width: ${(completedTasks/totalTasks)*100}%"></div></div>` : ''}
                        </td>` // deliverables
                    ];

                    const headerMap = ['name', 'status', 'progress', 'budget', 'timeline', 'risk'];
                    const visibleCells = cells.filter((cell, index) => allowedColumns.includes(headerMap[index]));

                    return `<tr>${visibleCells.join('')}</tr>`;
                }).join('');

            } catch (error) {
                console.error('Error loading project summary:', error);
                document.getElementById('projectSummaryBody').innerHTML = `
                    <tr><td colspan="6" style="text-align: center; color: var(--gray-500);">
                        Failed to load project data
                    </td></tr>
                `;
            }
        }

        async function exportReport() {
            const exportButton = event.target;
            const originalText = exportButton.innerHTML;
            exportButton.innerHTML = '📄 Exporting...';
            exportButton.disabled = true;

            try {
                // Show export options modal
                const exportType = await showExportModal();
                if (!exportType) {
                    exportButton.innerHTML = originalText;
                    exportButton.disabled = false;
                    return;
                }

                const reportData = await generateReportData();

                if (exportType === 'pdf') {
                    await exportToPDF(reportData);
                } else if (exportType === 'excel') {
                    await exportToExcel(reportData);
                } else if (exportType === 'json') {
                    await exportToJSON(reportData);
                }

                showNotification('Report exported successfully!', 'success');
            } catch (error) {
                console.error('Export failed:', error);
                showNotification('Export failed. Please try again.', 'error');
            } finally {
                exportButton.innerHTML = originalText;
                exportButton.disabled = false;
            }
        }

        function showExportModal() {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'export-modal-overlay';
                modal.innerHTML = `
                    <div class="export-modal">
                        <div class="export-modal-header">
                            <h3>Export Report</h3>
                            <button class="close-btn" onclick="this.closest('.export-modal-overlay').remove(); resolve(null);">×</button>
                        </div>
                        <div class="export-modal-body">
                            <p>Choose your export format:</p>
                            <div class="export-options">
                                <button class="export-option-btn" onclick="selectExport('pdf')">
                                    📄 PDF Report
                                    <small>Professional formatted document</small>
                                </button>
                                <button class="export-option-btn" onclick="selectExport('excel')">
                                    📊 Excel Spreadsheet
                                    <small>Data tables with formulas</small>
                                </button>
                                <button class="export-option-btn" onclick="selectExport('json')">
                                    💾 JSON Data
                                    <small>Raw data for external systems</small>
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                window.selectExport = (type) => {
                    modal.remove();
                    delete window.selectExport;
                    resolve(type);
                };

                // Close on backdrop click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve(null);
                    }
                });
            });
        }

        async function generateReportData() {
            const period = document.getElementById('reportPeriod')?.value || '30';
            const userRole = ((AppState.user?.Role?.name || AppState.user?.role || '') + '').toLowerCase().replace('-', '_') || 'auditor';

            // Gather all report data
            const [metricsData, chartData, projectsData] = await Promise.all([
                DashboardAPI.getMetrics(),
                DashboardAPI.getChartData('status', period),
                DashboardAPI.getRecentProjects(50)
            ]);

            return {
                reportInfo: {
                    title: 'Project Analytics Report',
                    generated: new Date().toISOString(),
                    period: period + ' days',
                    userRole: userRole,
                    user: AppState.user
                },
                metrics: metricsData.metrics,
                charts: chartData,
                projects: projectsData.projects,
                summary: {
                    totalProjects: projectsData.projects.length,
                    activeProjects: projectsData.projects.filter(p => p.status === 'active').length,
                    completedProjects: projectsData.projects.filter(p => p.status === 'completed').length,
                    averageProgress: Math.round(
                        projectsData.projects.reduce((sum, p) => sum + p.progress, 0) /
                        projectsData.projects.length
                    ),
                    overdueProjects: projectsData.projects.filter(p => p.isOverdue).length
                }
            };
        }

        async function exportToPDF(reportData) {
            // Use jsPDF library for PDF generation (would need to be included)
            // For now, create a printable HTML version
            const printWindow = window.open('', '_blank');
            const printHTML = generatePrintHTML(reportData);

            printWindow.document.write(printHTML);
            printWindow.document.close();
            printWindow.print();
        }

        async function exportToExcel(reportData) {
            // Create Excel-compatible CSV data
            const csvData = generateCSVData(reportData);
            const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', `project-report-${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function exportToJSON(reportData) {
            const jsonString = JSON.stringify(reportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', `project-data-${new Date().getTime()}.json`);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function generatePrintHTML(reportData) {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${reportData.reportInfo.title}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 2rem; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 1rem; margin-bottom: 2rem; }
                        .section { margin-bottom: 2rem; }
                        .metrics-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin: 1rem 0; }
                        .metric-card { border: 1px solid #ccc; padding: 1rem; text-align: center; }
                        .table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
                        .table th, .table td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
                        .table th { background: #f5f5f5; }
                        @media print { body { margin: 1rem; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>${reportData.reportInfo.title}</h1>
                        <p>Generated: ${new Date(reportData.reportInfo.generated).toLocaleString()}</p>
                        <p>Period: Last ${reportData.reportInfo.period}</p>
                    </div>

                    <div class="section">
                        <h2>Executive Summary</h2>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <h3>${reportData.summary.totalProjects}</h3>
                                <p>Total Projects</p>
                            </div>
                            <div class="metric-card">
                                <h3>${reportData.summary.activeProjects}</h3>
                                <p>Active Projects</p>
                            </div>
                            <div class="metric-card">
                                <h3>${reportData.summary.averageProgress}%</h3>
                                <p>Average Progress</p>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <h2>Project Details</h2>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Project Name</th>
                                    <th>Status</th>
                                    <th>Progress</th>
                                    <th>Client</th>
                                    <th>End Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reportData.projects.map(project => `
                                    <tr>
                                        <td>${project.name}</td>
                                        <td>${formatStatus(project.status)}</td>
                                        <td>${project.progress}%</td>
                                        <td>${project.client}</td>
                                        <td>${project.endDate ? formatDate(project.endDate) : 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </body>
                </html>
            `;
        }

        function generateCSVData(reportData) {
            const headers = [
                'Project Name',
                'Requestor Information',
                'Site/Location',
                'Business Line',
                'Project Type',
                'Priority',
                'Status',
                'Progress %',
                'Request Date',
                'Start Date',
                'Due Date',
                'Estimated Budget',
                'Actual Budget',
                'Budget Utilization %',
                'Days Remaining',
                'Is Overdue',
                'Tasks Total',
                'Tasks Completed'
            ];

            const rows = reportData.projects.map(project => {
                const budgetUtilization = project.estimatedBudget > 0
                    ? Math.round((project.actualBudget / project.estimatedBudget) * 100)
                    : 0;

                const daysRemaining = project.dueDate || project.endDate ?
                    Math.ceil((new Date(project.dueDate || project.endDate) - new Date()) / (1000 * 60 * 60 * 24)) :
                    '';

                return [
                    project.name,
                    project.requestorInfo || '',
                    project.siteLocation || '',
                    formatBusinessLine(project.businessLine),
                    formatProjectType(project.type),
                    formatStatus(project.priority),
                    formatStatus(project.status),
                    project.progress,
                    project.requestDate || '',
                    project.startDate || '',
                    project.dueDate || project.endDate || '',
                    project.estimatedBudget || 0,
                    project.actualBudget || 0,
                    budgetUtilization,
                    daysRemaining,
                    (project.isOverdue || daysRemaining < 0) ? 'Yes' : 'No',
                    getTasks(project).length,
                    getTasks(project).filter(t => t.status === 'completed').length
                ];
            });

            const csvContent = [headers, ...rows]
                .map(row => row.map(field => `"${field}"`).join(','))
                .join('\n');

            return csvContent;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    ${type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️'} ${message}
                </div>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ==================== ADMINISTRATION ====================

        // Enhanced AppState to include roles and audit data
        // Initialize administration data only after AppState is defined
        function initializeAdminData() {
            if (!AppState.roles) {

            AppState.roles = [
                {
                    id: 'owner',
                    name: 'Owner',
                    displayName: 'Owner (Master)',
                    description: 'Full platform ownership access',
                    permissions: [
                        'view_all_projects',
                        'create_projects',
                        'edit_projects',
                        'delete_projects',
                        'manage_users',
                        'manage_roles',
                        'system_settings',
                        'view_audit_log'
                    ],
                    userCount: 1,
                    isSystem: true
                },
                {
                    id: 'admin',
                    name: 'Administrator',
                    description: 'Full system access with all permissions',
                    permissions: [
                        'view_all_projects',
                        'create_projects',
                        'edit_projects',
                        'delete_projects',
                        'manage_users',
                        'manage_roles',
                        'system_settings',
                        'view_audit_log'
                    ],
                    userCount: 1
                },
                {
                    id: 'manager',
                    name: 'Project Manager',
                    description: 'Manage projects and assigned team members',
                    permissions: [
                        'view_all_projects',
                        'create_projects',
                        'edit_projects',
                        'assign_tasks',
                        'view_reports'
                    ],
                    userCount: 1
                },
                {
                    id: 'technician',
                    name: 'Technician',
                    description: 'View and update assigned tasks',
                    permissions: [
                        'view_assigned_projects',
                        'update_task_status',
                        'view_project_details'
                    ],
                    userCount: 2
                },
                {
                    id: 'viewer',
                    name: 'Viewer',
                    description: 'Read-only access to assigned projects',
                    permissions: [
                        'view_assigned_projects',
                        'view_project_details'
                    ],
                    userCount: 1
                }
            ];
            }

            if (!AppState.auditLog) {
            AppState.auditLog = [
                {
                    id: 1,
                    timestamp: new Date().toISOString(),
                    user: 'John Smith',
                    action: 'login',
                    resource: 'System',
                    details: 'User logged in successfully',
                    ipAddress: '192.168.1.100'
                },
                {
                    id: 2,
                    timestamp: new Date(Date.now() - 3600000).toISOString(),
                    user: 'Sarah Johnson',
                    action: 'project',
                    resource: 'proj_2023_001',
                    details: 'Updated project status to completed',
                    ipAddress: '192.168.1.101'
                }
            ];
            }
        }

        function loadPersonalInsights() {
            console.log('📊 Loading Personal Insights view');
            
            // Ensure systems are initialized
            if (!window.personalInsights) {
                console.log('Initializing productivity systems...');
                initProductivitySystems();
                // Retry after initialization
                setTimeout(() => {
                    loadPersonalInsights();
                }, 500);
                return;
            }
            
            const content = renderPersonalInsightsView();
            document.getElementById('reportContent').innerHTML = content;
        }

        function loadAdministration() {
            // Load users by default
            showAdminTab('users');
            loadUsers();
        }

        function showAdminTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`adminTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.admin-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`admin${tab.charAt(0).toUpperCase() + tab.slice(1)}Content`).classList.add('active');

            // Update sidebar navigation
            updateAdminSidebarNav(tab);

            // Load tab-specific content
            switch (tab) {
                case 'users':
                    loadUsers();
                    break;
                case 'roles':
                    loadRoles();
                    break;
                case 'settings':
                    loadSettings();
                    break;
                case 'audit':
                    loadAuditLog();
                    break;
            }
        }

        function showInsightsTab(tab) {
            console.log('Switching to insights tab:', tab);
            
            // Update sidebar navigation
            document.querySelectorAll('#sidebarNav .nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and activate the clicked tab
            const clickedTab = event?.target?.closest('.nav-item');
            if (clickedTab) clickedTab.classList.add('active');
            
            // Generate content based on tab
            let content = '';
            
            switch(tab) {
                case 'overview':
                    content = renderPersonalInsightsView();
                    break;
                case 'weekly':
                    content = renderWeeklyTrends();
                    break;
                case 'career':
                    content = renderCareerProgress();
                    break;
                default:
                    content = renderPersonalInsightsView();
            }
            
            // Update the main content area
            document.getElementById('reportContent').innerHTML = content;
        }
        
        function renderWeeklyTrends() {
            return `
                <div class="weekly-trends-container" style="padding: 2rem; max-width: 1200px; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="color: var(--gray-900); margin: 0;">📅 Weekly Productivity Trends</h2>
                        <button class="btn-secondary" onclick="showInsightsTab('overview')" style="padding: 0.5rem 1rem;">
                            ← Back to Overview
                        </button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 1rem 0; color: var(--gray-800);">📈 This Week vs Last Week</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div style="text-align: center; padding: 1rem; background: var(--gray-50); border-radius: 6px;">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-500);">24h</div>
                                    <div style="font-size: 0.8rem; color: var(--gray-600);">This Week</div>
                                </div>
                                <div style="text-align: center; padding: 1rem; background: var(--gray-50); border-radius: 6px;">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--gray-500);">21h</div>
                                    <div style="font-size: 0.8rem; color: var(--gray-600);">Last Week</div>
                                </div>
                            </div>
                            <div style="margin-top: 1rem; padding: 0.5rem; background: var(--success-50); border-left: 3px solid var(--success-500); border-radius: 4px;">
                                <div style="font-size: 0.9rem; color: var(--success-700);">+3 hours improvement (+14%)</div>
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 1rem 0; color: var(--gray-800);">🎯 Focus Quality</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div style="text-align: center; padding: 1rem; background: var(--gray-50); border-radius: 6px;">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--success-500);">78%</div>
                                    <div style="font-size: 0.8rem; color: var(--gray-600);">This Week</div>
                                </div>
                                <div style="text-align: center; padding: 1rem; background: var(--gray-50); border-radius: 6px;">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--gray-500);">72%</div>
                                    <div style="font-size: 0.8rem; color: var(--gray-600);">Last Week</div>
                                </div>
                            </div>
                            <div style="margin-top: 1rem; padding: 0.5rem; background: var(--success-50); border-left: 3px solid var(--success-500); border-radius: 4px;">
                                <div style="font-size: 0.9rem; color: var(--success-700);">+6% focus improvement</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 1rem 0; color: var(--gray-800);">📊 Daily Breakdown</h3>
                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; margin-top: 1rem;">
                            ${['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map((day, i) => {
                                const hours = [4.5, 5.2, 3.8, 6.1, 4.9, 2.1, 1.4][i];
                                const maxHeight = Math.max(...[4.5, 5.2, 3.8, 6.1, 4.9, 2.1, 1.4]);
                                const heightPercent = (hours / maxHeight) * 100;
                                return `
                                    <div style="text-align: center;">
                                        <div style="height: 60px; display: flex; align-items: end; justify-content: center; margin-bottom: 0.5rem;">
                                            <div style="width: 20px; background: var(--primary-500); border-radius: 2px; height: ${heightPercent}%;"></div>
                                        </div>
                                        <div style="font-size: 0.7rem; color: var(--gray-600);">${day}</div>
                                        <div style="font-size: 0.8rem; font-weight: 500;">${hours}h</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div style="margin-top: 1rem; text-align: center; color: var(--gray-600); font-size: 0.9rem;">
                            Best day: Thursday (6.1 hours) | Lowest: Sunday (1.4 hours)
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderCareerProgress() {
            return `
                <div class="career-progress-container" style="padding: 2rem; max-width: 1200px; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="color: var(--gray-900); margin: 0;">🚀 Career Development Progress</h2>
                        <button class="btn-secondary" onclick="showInsightsTab('overview')" style="padding: 0.5rem 1rem;">
                            ← Back to Overview
                        </button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 1rem 0; color: var(--gray-800);">🎯 Skill Development</h3>
                            ${[
                                {name: 'Project Management', level: 75, change: '+5', trend: 'up'},
                                {name: 'Technical Leadership', level: 60, change: '+8', trend: 'up'},
                                {name: 'Team Collaboration', level: 80, change: '+2', trend: 'up'},
                                {name: 'Strategic Planning', level: 55, change: '+12', trend: 'up'},
                                {name: 'Data Analysis', level: 45, change: '+15', trend: 'up'}
                            ].map(skill => `
                                <div style="margin-bottom: 1.5rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; align-items: center;">
                                        <span style="font-weight: 500;">${skill.name}</span>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <span style="color: var(--gray-600);">${skill.level}%</span>
                                            <span style="color: var(--success-600); font-size: 0.8rem; font-weight: 500;">${skill.change}</span>
                                        </div>
                                    </div>
                                    <div style="width: 100%; height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden;">
                                        <div style="height: 100%; background: linear-gradient(90deg, var(--primary-500), var(--primary-600)); width: ${skill.level}%; transition: width 0.3s;"></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 1rem 0; color: var(--gray-800);">🏆 Recent Achievements</h3>
                            ${[
                                {icon: '🎯', title: 'Project Completion', desc: 'Successfully delivered 3 major projects this quarter', date: '2 days ago'},
                                {icon: '👥', title: 'Team Leadership', desc: 'Led cross-functional team of 8 members', date: '1 week ago'},
                                {icon: '📊', title: 'Process Improvement', desc: 'Implemented new workflow reducing delivery time by 25%', date: '2 weeks ago'},
                                {icon: '🎓', title: 'Skill Certification', desc: 'Completed Advanced Project Management course', date: '3 weeks ago'}
                            ].map(achievement => `
                                <div style="margin-bottom: 1rem; padding: 1rem; background: var(--gray-50); border-radius: 6px; border-left: 3px solid var(--primary-500);">
                                    <div style="display: flex; align-items: start; gap: 0.75rem;">
                                        <div style="font-size: 1.2rem;">${achievement.icon}</div>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 500; margin-bottom: 0.25rem; color: var(--gray-800);">${achievement.title}</div>
                                            <div style="font-size: 0.8rem; color: var(--gray-600); margin-bottom: 0.25rem;">${achievement.desc}</div>
                                            <div style="font-size: 0.7rem; color: var(--gray-500);">${achievement.date}</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 1rem 0; color: var(--gray-800);">🎯 Growth Recommendations</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div style="padding: 1rem; background: var(--blue-50); border-radius: 6px; border-left: 3px solid var(--primary-500);">
                                <div style="font-weight: 500; margin-bottom: 0.5rem; color: var(--primary-700);">📚 Learning Path</div>
                                <div style="font-size: 0.9rem; color: var(--gray-700); margin-bottom: 0.5rem;">Focus on Strategic Planning to reach next career level</div>
                                <div style="font-size: 0.8rem; color: var(--primary-600);">Target: 70% by end of quarter</div>
                            </div>
                            <div style="padding: 1rem; background: var(--green-50); border-radius: 6px; border-left: 3px solid var(--success-500);">
                                <div style="font-weight: 500; margin-bottom: 0.5rem; color: var(--success-700);">💡 Opportunity</div>
                                <div style="font-size: 0.9rem; color: var(--gray-700); margin-bottom: 0.5rem;">Consider mentoring junior team members</div>
                                <div style="font-size: 0.8rem; color: var(--success-600);">Builds leadership experience</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== FIELD OPERATIONS FUNCTIONS ====================
        
        // Initialize Field Ops data structure
        function initializeFieldOpsData() {
            // Try to load from localStorage
            const savedData = localStorage.getItem('fieldOpsData');
            if (savedData) {
                try {
                    AppState.fieldOps = JSON.parse(savedData);
                } catch (e) {
                    console.error('Error loading Field Ops data:', e);
                    AppState.fieldOps = {
                        scheduled: [],
                        pending: [],
                        completed: []
                    };
                }
            } else {
                AppState.fieldOps = {
                    scheduled: [],
                    pending: [],
                    completed: []
                };
            }
        }
        
        // Initialize on load
        if (!AppState.fieldOps) {
            initializeFieldOpsData();
        }
        
        function loadFieldOps() {
            // Audit log field ops section access
            try { 
                auditLogEvent({ 
                    action: 'fieldops.access', 
                    entity: 'fieldops', 
                    entityId: 'main', 
                    entityName: 'Field Operations', 
                    details: `Accessed Field Operations section`,
                    meta: { 
                        section: 'fieldops',
                        view: 'main'
                    }
                }); 
            } catch(_) {}
            
            // Set today's date
            const today = new Date();
            document.getElementById('todayDate').textContent = today.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Load project dropdown for filters
            loadProjectDropdown();
            
            // Load today's schedule
            loadTodaySchedule();
            
            // Load pending count
            updatePendingCount();
            
            // Initialize calendar
            initializeCalendar();
        }
        
        function showFieldOpsTab(tabName) {
            // Audit log field ops tab navigation
            try { 
                auditLogEvent({ 
                    action: 'fieldops.tab.navigate', 
                    entity: 'fieldops', 
                    entityId: tabName, 
                    entityName: `${tabName.charAt(0).toUpperCase() + tabName.slice(1)} Tab`, 
                    details: `Navigated to Field Operations ${tabName} tab`,
                    meta: { 
                        tab: tabName,
                        section: 'fieldops'
                    }
                }); 
            } catch(_) {}
            
            // Hide all tabs
            document.querySelectorAll('.fieldops-tab').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Show selected tab
            document.getElementById(`${tabName}Tab`).style.display = 'block';
            
            // Update tab buttons
            document.querySelectorAll('#fieldopsView .tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');
            
            // Update sidebar nav
            document.querySelectorAll('.sidebar .nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Load tab-specific content
            switch(tabName) {
                case 'today':
                    loadTodaySchedule();
                    break;
                case 'calendar':
                    renderCalendar();
                    break;
                case 'pending':
                    loadPendingQueue();
                    break;
                case 'history':
                    loadFieldHistory();
                    break;
            }
        }
        
        function loadTodaySchedule() {
            const today = new Date().toDateString();
            const todayJobs = AppState.fieldOps.scheduled.filter(job => {
                return new Date(job.date).toDateString() === today;
            });
            
            const scheduleDiv = document.getElementById('todaySchedule');
            
            if (todayJobs.length === 0) {
                scheduleDiv.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--gray-500);">
                        <p style="font-size: 1.1rem;">No field work scheduled for today</p>
                        <button class="btn btn-primary" onclick="showScheduleFieldWork()" style="margin-top: 1rem;">
                            Schedule Field Work
                        </button>
                    </div>
                `;
            } else {
                scheduleDiv.innerHTML = todayJobs.map(job => renderScheduleCard(job)).join('');
            }
            
            // Update stats
            document.getElementById('todayJobCount').textContent = todayJobs.length;
            const techs = [...new Set(todayJobs.map(job => job.assignedTo))];
            document.getElementById('todayTechCount').textContent = techs.length;
        }
        
        function renderScheduleCard(job) {
            const workTypeBadgeClass = job.workType.toLowerCase().replace('/', '');
            const projectTag = job.projectId ? 
                `<span class="project-tag">[${job.projectCode || job.projectId}]</span>` : '';
            const taskIndicator = job.taskId ? 
                `<span style="color: var(--primary-600); font-size: 0.75rem; margin-left: 0.5rem;">📌 Task-linked</span>` : '';
            const rescheduleIndicator = job.rescheduleHistory && job.rescheduleHistory.length > 0 ? 
                `<span style="color: var(--warning-600); font-size: 0.75rem; margin-left: 0.5rem;" title="Rescheduled ${job.rescheduleHistory.length} time(s)">🔄 Rescheduled (${job.rescheduleHistory.length})</span>` : '';
            
            return `
                <div class="schedule-card ${job.rescheduleHistory && job.rescheduleHistory.length > 0 ? 'rescheduled' : ''}">
                    <div class="schedule-time">
                        ${job.startTime || '9:00 AM'}
                    </div>
                    <div class="schedule-details">
                        <div class="schedule-title">
                            ${projectTag}
                            ${job.title || job.workType}
                            ${taskIndicator}
                            ${rescheduleIndicator}
                        </div>
                        <div style="color: var(--gray-600); font-size: 0.875rem;">
                            ${job.client} - ${job.location}
                        </div>
                        <div style="color: var(--gray-500); font-size: 0.875rem;">
                            Assigned to: ${job.assignedTo} ${job.vendor ? '(Vendor)' : ''}
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;">
                        <span class="work-type-badge ${workTypeBadgeClass}">
                            ${job.workType}
                        </span>
                        <button class="btn btn-sm btn-secondary" onclick="viewFieldJob('${job.id}')">
                            View Details
                        </button>
                    </div>
                </div>
            `;
        }
        
        function loadPendingQueue() {
            const pendingList = document.getElementById('pendingList');
            const pendingJobs = AppState.fieldOps.pending || [];
            
            if (pendingJobs.length === 0) {
                pendingList.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--gray-500);">
                        <p style="font-size: 1.1rem;">No pending field work requests</p>
                        <p style="margin-top: 0.5rem;">All work has been scheduled</p>
                    </div>
                `;
            } else {
                pendingList.innerHTML = pendingJobs.map(job => `
                    <div class="pending-card">
                        <div class="pending-info">
                            <div style="font-weight: 600; color: var(--gray-900);">
                                ${job.projectId ? `[${job.projectCode}] ` : ''}${job.title}
                            </div>
                            <div style="color: var(--gray-600); font-size: 0.875rem;">
                                ${job.client} - ${job.workType}
                            </div>
                            <div style="color: var(--gray-500); font-size: 0.875rem;">
                                Requested: ${new Date(job.requestedDate).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="pending-actions">
                            <button class="btn btn-sm btn-primary" onclick="schedulePendingJob('${job.id}')">
                                Schedule
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        function updatePendingCount() {
            const pendingCount = AppState.fieldOps.pending?.length || 0;
            const badge = document.getElementById('pendingCount');
            if (badge) {
                badge.textContent = pendingCount;
                badge.style.display = pendingCount > 0 ? 'inline-block' : 'none';
            }
        }
        
        function initializeCalendar() {
            const now = new Date();
            AppState.currentMonth = now.getMonth();
            AppState.currentYear = now.getFullYear();
        }
        
        function renderCalendar() {
            const month = AppState.currentMonth;
            const year = AppState.currentYear;
            
            // Update month display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendarMonth').textContent = `${monthNames[month]} ${year}`;
            
            // Generate calendar grid
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const calendarGrid = document.getElementById('calendarGrid');
            
            let html = '';
            
            // Day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                html += `<div style="background: var(--gray-100); padding: 0.5rem; font-weight: 600; text-align: center;">${day}</div>`;
            });
            
            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-day other-month"></div>';
            }
            
            // Days of month
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toDateString();
                const isToday = dateStr === today.toDateString();
                
                // Get jobs for this day
                const dayJobs = AppState.fieldOps.scheduled.filter(job => {
                    return new Date(job.date).toDateString() === dateStr;
                });
                
                html += `
                    <div class="calendar-day ${isToday ? 'today' : ''}" onclick="showDaySchedule('${dateStr}')">
                        <div class="calendar-day-header">${day}</div>
                        ${dayJobs.slice(0, 3).map(job => {
                            const workTypeClass = job.workType.toLowerCase().replace('/', '');
                            return `
                                <div class="calendar-event work-type-badge ${workTypeClass}" 
                                     onclick="event.stopPropagation(); viewFieldJob('${job.id}')">
                                    ${job.projectCode ? `[${job.projectCode}] ` : ''}${job.workType}
                                </div>
                            `;
                        }).join('')}
                        ${dayJobs.length > 3 ? `<div style="font-size: 0.7rem; color: var(--gray-500);">+${dayJobs.length - 3} more</div>` : ''}
                    </div>
                `;
            }
            
            calendarGrid.innerHTML = html;
        }
        
        function changeMonth(direction) {
            AppState.currentMonth += direction;
            if (AppState.currentMonth < 0) {
                AppState.currentMonth = 11;
                AppState.currentYear--;
            } else if (AppState.currentMonth > 11) {
                AppState.currentMonth = 0;
                AppState.currentYear++;
            }
            renderCalendar();
        }
        
        function scheduleFieldWorkFromTask(projectId, taskId) {
            // Get project and task details
            const project = AppState.projects.find(p => p.id === projectId);
            const task = project?.tasks?.find(t => t.id === taskId);
            
            if (!project || !task) {
                showNotification('Project or task not found', 'error');
                return;
            }
            
            // Audit log the initiation of field work scheduling from task
            try { 
                auditLogEvent({ 
                    action: 'fieldops.schedule.initiate', 
                    entity: 'fieldwork', 
                    entityId: `${projectId}-${taskId}`, 
                    entityName: `${task.name}`, 
                    details: `Initiated field work scheduling from task in project: ${project.name}`,
                    meta: { projectId, taskId, projectName: project.name, taskName: task.name }
                }); 
            } catch(_) {}
            
            // Open scheduling modal with pre-filled data
            showScheduleFieldWork(projectId, taskId);
            
            // Pre-fill additional task data
            setTimeout(() => {
                const form = document.querySelector('.modal-overlay form');
                if (form) {
                    // Set title based on task
                    form.querySelector('[name="title"]').value = task.name || '';
                    
                    // Auto-detect work type based on task name/description
                    if (task.name?.toLowerCase().includes('install') || task.description?.toLowerCase().includes('install')) {
                        form.querySelector('[name="workType"]').value = 'Installation';
                    } else if (task.name?.toLowerCase().includes('commission')) {
                        form.querySelector('[name="workType"]').value = 'Commissioning';
                    } else if (task.name?.toLowerCase().includes('maintenance')) {
                        form.querySelector('[name="workType"]').value = 'Maintenance';
                    } else if (task.name?.toLowerCase().includes('repair') || task.name?.toLowerCase().includes('fix')) {
                        form.querySelector('[name="workType"]').value = 'Break/Fix';
                    }
                    
                    // Set assignee if available
                    if (task.assignee) {
                        form.querySelector('[name="assignedTo"]').value = task.assignee;
                    }
                    
                    // Set duration based on estimated hours
                    if (task.estimatedHours) {
                        const hours = task.estimatedHours;
                        if (hours <= 2) {
                            form.querySelector('[name="duration"]').value = '2';
                        } else if (hours <= 4) {
                            form.querySelector('[name="duration"]').value = '4';
                        } else if (hours <= 8) {
                            form.querySelector('[name="duration"]').value = '8';
                        } else if (hours <= 16) {
                            form.querySelector('[name="duration"]').value = '16';
                        } else if (hours <= 24) {
                            form.querySelector('[name="duration"]').value = '24';
                        } else {
                            form.querySelector('[name="duration"]').value = '40';
                        }
                    }
                    
                    // Add notes about the task
                    const notesField = form.querySelector('[name="notes"]');
                    notesField.value = `Task: ${task.name}\n${task.notes ? `PM Notes: ${task.notes}` : ''}`;
                }
            }, 100);
        }
        
        function showScheduleFieldWork(projectId = null, taskId = null) {
            // Create scheduling modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <h2>Schedule Field Work</h2>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
                    </div>
                    <form onsubmit="saveFieldWork(event)" class="modal-body" data-task-id="${taskId || ''}" data-project-id="${projectId || ''}">
                        <div class="form-group">
                            <label>Work Type <span style="color: red;">*</span></label>
                            <select name="workType" required>
                                <option value="">Select Type</option>
                                <option value="Installation">Installation</option>
                                <option value="Commissioning">Commissioning</option>
                                <option value="Break/Fix">Break/Fix</option>
                                <option value="Maintenance">Preventive Maintenance</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Date <span style="color: red;">*</span></label>
                                <input type="date" name="date" required>
                            </div>
                            <div class="form-group">
                                <label>Start Time</label>
                                <input type="time" name="startTime" value="09:00">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Project (Optional)</label>
                            <select name="projectId" onchange="updateClientLocation(this)">
                                <option value="">No Project Association</option>
                                ${AppState.projects.map(p => `
                                    <option value="${p.id}" ${projectId === p.id ? 'selected' : ''}>
                                        ${p.name}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Client Name <span style="color: red;">*</span></label>
                                <input type="text" name="client" required>
                            </div>
                            <div class="form-group">
                                <label>Location <span style="color: red;">*</span></label>
                                <input type="text" name="location" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Title/Description <span style="color: red;">*</span></label>
                            <input type="text" name="title" placeholder="e.g., Install conference room AV system" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Assigned To <span style="color: red;">*</span></label>
                                <input type="text" name="assignedTo" placeholder="Tech/Vendor name" required>
                            </div>
                            <div class="form-group">
                                <label>Is Vendor?</label>
                                <select name="isVendor">
                                    <option value="false">Internal Tech</option>
                                    <option value="true">External Vendor</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Duration Estimate</label>
                            <select name="duration">
                                <option value="2">2 hours</option>
                                <option value="4" selected>4 hours</option>
                                <option value="8">Full day (8 hours)</option>
                                <option value="16">2 days</option>
                                <option value="24">3 days</option>
                                <option value="40">1 week</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Notes</label>
                            <textarea name="notes" rows="3" placeholder="Special instructions, equipment needed, etc."></textarea>
                        </div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Schedule Work
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Auto-fill if from project
            if (projectId) {
                const project = AppState.projects.find(p => p.id === projectId);
                if (project) {
                    modal.querySelector('[name="client"]').value = project.client || '';
                    modal.querySelector('[name="location"]').value = project.location || '';
                }
            }
        }
        
        function updateClientLocation(select) {
            const projectId = select.value;
            if (projectId) {
                const project = AppState.projects.find(p => p.id === projectId);
                if (project) {
                    const form = select.closest('form');
                    form.querySelector('[name="client"]').value = project.client || '';
                    form.querySelector('[name="location"]').value = project.location || '';
                }
            }
        }
        
        function saveFieldWork(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            // Get task association if scheduled from a task
            const taskId = form.dataset.taskId;
            const linkedProjectId = form.dataset.projectId;
            
            const job = {
                id: 'field_' + Date.now(),
                workType: formData.get('workType'),
                date: formData.get('date'),
                startTime: formData.get('startTime'),
                projectId: formData.get('projectId') || linkedProjectId || null,
                taskId: taskId || null,
                projectCode: null,
                client: formData.get('client'),
                location: formData.get('location'),
                title: formData.get('title'),
                assignedTo: formData.get('assignedTo'),
                vendor: formData.get('isVendor') === 'true',
                duration: parseInt(formData.get('duration')),
                notes: formData.get('notes'),
                status: 'scheduled',
                createdAt: new Date().toISOString()
            };
            
            // Get project code if associated
            if (job.projectId) {
                const project = AppState.projects.find(p => p.id === job.projectId);
                if (project) {
                    job.projectCode = project.projectNumber || project.name.substring(0, 8);
                }
            }
            
            // Add to scheduled jobs
            AppState.fieldOps.scheduled.push(job);
            
            // Audit log the field work scheduling
            try { 
                auditLogEvent({ 
                    action: 'fieldops.schedule.create', 
                    entity: 'fieldwork', 
                    entityId: job.id, 
                    entityName: job.title, 
                    after: job,
                    details: `Scheduled ${job.workType} field work: ${job.title} for ${job.client} on ${new Date(job.date).toLocaleDateString()}`,
                    meta: { 
                        workType: job.workType,
                        assignedTo: job.assignedTo,
                        client: job.client,
                        location: job.location,
                        projectId: job.projectId,
                        taskId: job.taskId,
                        projectCode: job.projectCode,
                        vendor: job.vendor,
                        duration: job.duration
                    }
                }); 
            } catch(_) {}
            
            // Save to localStorage
            localStorage.setItem('fieldOpsData', JSON.stringify(AppState.fieldOps));
            
            // Close modal
            form.closest('.modal-overlay').remove();
            
            // Refresh view
            if (AppState.currentView === 'fieldops') {
                const activeTab = document.querySelector('#fieldopsView .tab-btn.active').id.replace('tab', '').toLowerCase();
                showFieldOpsTab(activeTab);
            }
            
            showNotification('Field work scheduled successfully', 'success');
        }
        
        function loadProjectDropdown() {
            const select = document.getElementById('filterProject');
            if (select) {
                select.innerHTML = '<option value="">All Projects</option>' +
                    AppState.projects.map(p => `
                        <option value="${p.id}">${p.name}</option>
                    `).join('');
            }
        }
        
        function filterCalendar() {
            // Filter implementation
            renderCalendar();
        }
        
        function loadFieldHistory() {
            const historyList = document.getElementById('historyList');
            const completedJobs = AppState.fieldOps.completed || [];
            
            if (completedJobs.length === 0) {
                historyList.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--gray-500);">
                        <p style="font-size: 1.1rem;">No completed field work yet</p>
                    </div>
                `;
            } else {
                historyList.innerHTML = completedJobs.map(job => `
                    <div class="schedule-card">
                        <div style="color: var(--gray-600);">
                            ${new Date(job.date).toLocaleDateString()}
                        </div>
                        <div class="schedule-details">
                            <div class="schedule-title">
                                ${job.projectCode ? `[${job.projectCode}] ` : ''}${job.title}
                            </div>
                            <div style="color: var(--gray-600); font-size: 0.875rem;">
                                ${job.client} - Completed by ${job.assignedTo}
                            </div>
                        </div>
                        <span class="work-type-badge ${job.workType.toLowerCase().replace('/', '')}">
                            ${job.workType}
                        </span>
                    </div>
                `).join('');
            }
        }
        
        function viewFieldJob(jobId) {
            const job = AppState.fieldOps.scheduled.find(j => j.id === jobId) ||
                       AppState.fieldOps.pending.find(j => j.id === jobId) ||
                       AppState.fieldOps.completed.find(j => j.id === jobId);
            
            if (!job) {
                showNotification('Job not found', 'error');
                return;
            }
            
            // Audit log the field work details view
            try { 
                auditLogEvent({ 
                    action: 'fieldops.view', 
                    entity: 'fieldwork', 
                    entityId: job.id, 
                    entityName: job.title, 
                    details: `Viewed details for ${job.workType} field work: ${job.title}`,
                    meta: { 
                        workType: job.workType,
                        status: job.status,
                        client: job.client,
                        assignedTo: job.assignedTo,
                        projectId: job.projectId
                    }
                }); 
            } catch(_) {}
            
            // Show job details modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <h2>Field Work Details</h2>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <strong>Work Type:</strong> ${job.workType}
                            </div>
                            <div>
                                <strong>Date:</strong> ${new Date(job.date).toLocaleDateString()}
                                ${job.startTime ? ` at ${job.startTime}` : ''}
                            </div>
                            <div>
                                <strong>Client:</strong> ${job.client}
                            </div>
                            <div>
                                <strong>Location:</strong> ${job.location}
                            </div>
                            <div>
                                <strong>Description:</strong> ${job.title}
                            </div>
                            <div>
                                <strong>Assigned To:</strong> ${job.assignedTo} ${job.vendor ? '(Vendor)' : '(Internal)'}
                            </div>
                            ${job.projectId ? `
                                <div>
                                    <strong>Related Project:</strong> 
                                    <a href="#" onclick="showProjectView('${job.projectId}'); this.closest('.modal-overlay').remove();">
                                        ${job.projectCode}
                                    </a>
                                </div>
                            ` : ''}
                            ${job.notes ? `
                                <div>
                                    <strong>Notes:</strong><br>
                                    ${job.notes}
                                </div>
                            ` : ''}
                            ${job.rescheduleHistory && job.rescheduleHistory.length > 0 ? `
                                <div>
                                    <strong>Reschedule History (${job.rescheduleHistory.length}):</strong>
                                    <div style="background: var(--warning-50); padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem; border-left: 4px solid var(--warning-400);">
                                        ${job.rescheduleHistory.map((r, index) => `
                                            <div style="margin-bottom: ${index < job.rescheduleHistory.length - 1 ? '0.75rem' : '0'}; padding-bottom: ${index < job.rescheduleHistory.length - 1 ? '0.75rem' : '0'}; border-bottom: ${index < job.rescheduleHistory.length - 1 ? '1px solid var(--warning-200)' : 'none'};">
                                                <div style="font-weight: 600; color: var(--warning-800);">Reschedule ${index + 1}:</div>
                                                <div><strong>Date Change:</strong> ${new Date(r.originalDate).toLocaleDateString()} → ${new Date(r.newDate).toLocaleDateString()}</div>
                                                <div><strong>Reason:</strong> ${r.reason}${r.otherReason ? ' - ' + r.otherReason : ''}</div>
                                                <div><strong>Rescheduled:</strong> ${new Date(r.rescheduledAt).toLocaleDateString()} by ${r.rescheduledBy}</div>
                                                ${r.notes ? `<div><strong>Notes:</strong> ${r.notes}</div>` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                            Close
                        </button>
                        ${job.status === 'scheduled' ? `
                            <button class="btn btn-warning" onclick="rescheduleFieldJob('${job.id}')">
                                🔄 Reschedule
                            </button>
                            <button class="btn btn-success" onclick="completeFieldJob('${job.id}')">
                                Mark Complete
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function completeFieldJob(jobId) {
            const jobIndex = AppState.fieldOps.scheduled.findIndex(j => j.id === jobId);
            if (jobIndex !== -1) {
                const job = AppState.fieldOps.scheduled[jobIndex];
                const beforeState = { ...job };
                
                job.status = 'completed';
                job.completedAt = new Date().toISOString();
                
                // Audit log the field work completion
                try { 
                    auditLogEvent({ 
                        action: 'fieldops.complete', 
                        entity: 'fieldwork', 
                        entityId: job.id, 
                        entityName: job.title, 
                        before: beforeState,
                        after: job,
                        details: `Completed ${job.workType} field work: ${job.title} for ${job.client} by ${job.assignedTo}`,
                        meta: { 
                            workType: job.workType,
                            assignedTo: job.assignedTo,
                            client: job.client,
                            location: job.location,
                            projectId: job.projectId,
                            taskId: job.taskId,
                            projectCode: job.projectCode,
                            vendor: job.vendor,
                            completedAt: job.completedAt,
                            duration: job.duration
                        }
                    }); 
                } catch(_) {}
                
                // Move to completed
                AppState.fieldOps.completed.push(job);
                AppState.fieldOps.scheduled.splice(jobIndex, 1);
                
                // Save
                localStorage.setItem('fieldOpsData', JSON.stringify(AppState.fieldOps));
                
                // Close modal and refresh
                document.querySelector('.modal-overlay').remove();
                showFieldOpsTab('today');
                
                showNotification('Field work marked as complete', 'success');
            }
        }
        
        function rescheduleFieldJob(jobId) {
            const job = AppState.fieldOps.scheduled.find(j => j.id === jobId);
            if (!job) {
                showNotification('Job not found', 'error');
                return;
            }
            
            // Close the job details modal first
            document.querySelector('.modal-overlay').remove();
            
            // Create reschedule modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <h2>Reschedule Field Work</h2>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
                    </div>
                    <form onsubmit="saveReschedule(event)" class="modal-body" data-job-id="${job.id}">
                        <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h4 style="margin: 0 0 0.5rem 0;">Current Schedule</h4>
                            <div><strong>${job.workType}:</strong> ${job.title}</div>
                            <div><strong>Client:</strong> ${job.client}</div>
                            <div><strong>Current Date:</strong> ${new Date(job.date).toLocaleDateString()} ${job.startTime ? `at ${job.startTime}` : ''}</div>
                            <div><strong>Assigned To:</strong> ${job.assignedTo}</div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>New Date <span style="color: red;">*</span></label>
                                <input type="date" name="newDate" required min="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div class="form-group">
                                <label>New Start Time</label>
                                <input type="time" name="newStartTime" value="${job.startTime || '09:00'}">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Reschedule Reason <span style="color: red;">*</span></label>
                            <select name="rescheduleReason" required onchange="toggleOtherReason(this)">
                                <option value="">Select Reason</option>
                                <option value="Parts Delay">Parts Delay</option>
                                <option value="Vendor Delay">Vendor Delay</option>
                                <option value="Vendor No-Show">Vendor No-Show</option>
                                <option value="Vendor Reschedule">Vendor Reschedule</option>
                                <option value="Client Reschedule">Client Reschedule</option>
                                <option value="Other">Other (Specify)</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="otherReasonGroup" style="display: none;">
                            <label>Please specify reason <span style="color: red;">*</span></label>
                            <textarea name="otherReason" rows="3" placeholder="Detailed explanation for reschedule..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Additional Notes</label>
                            <textarea name="rescheduleNotes" rows="2" placeholder="Any additional information about the reschedule..."></textarea>
                        </div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-warning">
                                🔄 Reschedule Work
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function toggleOtherReason(select) {
            const otherGroup = document.getElementById('otherReasonGroup');
            const otherTextarea = document.querySelector('[name="otherReason"]');
            
            if (select.value === 'Other') {
                otherGroup.style.display = 'block';
                otherTextarea.required = true;
            } else {
                otherGroup.style.display = 'none';
                otherTextarea.required = false;
                otherTextarea.value = '';
            }
        }
        
        function saveReschedule(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const jobId = form.dataset.jobId;
            
            // Validate other reason if selected
            const rescheduleReason = formData.get('rescheduleReason');
            const otherReason = formData.get('otherReason');
            
            if (rescheduleReason === 'Other' && !otherReason.trim()) {
                showNotification('Please specify the reason for "Other"', 'error');
                return;
            }
            
            // Find the job
            const jobIndex = AppState.fieldOps.scheduled.findIndex(j => j.id === jobId);
            if (jobIndex === -1) {
                showNotification('Job not found', 'error');
                return;
            }
            
            const job = AppState.fieldOps.scheduled[jobIndex];
            const beforeState = { ...job };
            
            // Create reschedule record
            const rescheduleRecord = {
                originalDate: job.date,
                originalStartTime: job.startTime,
                newDate: formData.get('newDate'),
                newStartTime: formData.get('newStartTime'),
                reason: rescheduleReason,
                otherReason: rescheduleReason === 'Other' ? otherReason : null,
                notes: formData.get('rescheduleNotes'),
                rescheduledAt: new Date().toISOString(),
                rescheduledBy: AppState.user?.name || AppState.user?.email || 'Unknown'
            };
            
            // Add reschedule history to job
            if (!job.rescheduleHistory) {
                job.rescheduleHistory = [];
            }
            job.rescheduleHistory.push(rescheduleRecord);
            
            // Update job with new date/time
            job.date = formData.get('newDate');
            job.startTime = formData.get('newStartTime');
            job.lastRescheduled = new Date().toISOString();
            job.rescheduleCount = (job.rescheduleCount || 0) + 1;
            
            // Audit log the reschedule
            try { 
                auditLogEvent({ 
                    action: 'fieldops.reschedule', 
                    entity: 'fieldwork', 
                    entityId: job.id, 
                    entityName: job.title, 
                    before: beforeState,
                    after: job,
                    details: `Rescheduled ${job.workType} field work from ${new Date(rescheduleRecord.originalDate).toLocaleDateString()} to ${new Date(rescheduleRecord.newDate).toLocaleDateString()}. Reason: ${rescheduleRecord.reason}${rescheduleRecord.otherReason ? ' - ' + rescheduleRecord.otherReason : ''}`,
                    meta: { 
                        workType: job.workType,
                        client: job.client,
                        assignedTo: job.assignedTo,
                        projectId: job.projectId,
                        rescheduleReason: rescheduleRecord.reason,
                        otherReason: rescheduleRecord.otherReason,
                        originalDate: rescheduleRecord.originalDate,
                        newDate: rescheduleRecord.newDate,
                        rescheduleCount: job.rescheduleCount
                    }
                }); 
            } catch(_) {}
            
            // Save to localStorage
            localStorage.setItem('fieldOpsData', JSON.stringify(AppState.fieldOps));
            
            // Close modal
            form.closest('.modal-overlay').remove();
            
            // Refresh current view
            if (AppState.currentView === 'fieldops') {
                const activeTab = document.querySelector('#fieldopsView .tab-btn.active').id.replace('tab', '').toLowerCase();
                showFieldOpsTab(activeTab);
            }
            
            showNotification(`Field work rescheduled to ${new Date(formData.get('newDate')).toLocaleDateString()}`, 'success');
        }
        
        function schedulePendingJob(jobId) {
            const job = AppState.fieldOps.pending.find(j => j.id === jobId);
            if (job) {
                // Audit log the pending job scheduling initiation
                try { 
                    auditLogEvent({ 
                        action: 'fieldops.pending.schedule', 
                        entity: 'fieldwork', 
                        entityId: job.id, 
                        entityName: job.title, 
                        details: `Initiated scheduling for pending ${job.workType} field work: ${job.title}`,
                        meta: { 
                            workType: job.workType,
                            client: job.client,
                            location: job.location,
                            projectId: job.projectId
                        }
                    }); 
                } catch(_) {}
                
                showScheduleFieldWork(job.projectId);
                // Pre-fill the form with job data
                setTimeout(() => {
                    const form = document.querySelector('.modal-overlay form');
                    if (form) {
                        form.querySelector('[name="workType"]').value = job.workType;
                        form.querySelector('[name="title"]').value = job.title;
                        form.querySelector('[name="client"]').value = job.client;
                        form.querySelector('[name="location"]').value = job.location || '';
                    }
                }, 100);
            }
        }
        
        function showDaySchedule(dateStr) {
            const dayJobs = AppState.fieldOps.scheduled.filter(job => {
                return new Date(job.date).toDateString() === dateStr;
            });
            
            if (dayJobs.length === 0) {
                showNotification('No field work scheduled for this day', 'info');
                return;
            }
            
            // Show day's schedule in modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal" style="max-width: 700px;">
                    <div class="modal-header">
                        <h2>Schedule for ${new Date(dateStr).toLocaleDateString('en-US', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        })}</h2>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="schedule-grid">
                            ${dayJobs.map(job => renderScheduleCard(job)).join('')}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                            Close
                        </button>
                        <button class="btn btn-primary" onclick="showScheduleFieldWork(); this.closest('.modal-overlay').remove()">
                            Add Field Work
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function updateAdminSidebarNav(activeTab) {
            const navItems = document.querySelectorAll('.sidebar .nav-item');
            navItems.forEach(item => item.classList.remove('active'));

            const tabMap = {
                'users': 0,
                'roles': 1,
                'settings': 2,
                'audit': 3
            };

            if (navItems[tabMap[activeTab]]) {
                navItems[tabMap[activeTab]].classList.add('active');
            }
        }

        async function loadUsers() {
            const usersTableBody = document.getElementById('usersTableBody');

            try {
                if (isBackendMode()) {
                    const data = await apiFetch('/users');
                    AppState.users = (data.users || []).map(u => ({
                        id: u.id,
                        name: u.name,
                        email: u.email,
                        avatar: (u.name || '?').split(' ').map(n => n[0]).join('').slice(0,2).toUpperCase(),
                        Role: u.Role
                    }));
                }
            } catch (e) {
                console.error('Failed to load users from backend, using local:', e);
            }

            usersTableBody.innerHTML = (AppState.users || []).map(user => `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center;">
                            <div class="user-avatar-small">${user.avatar || ''}</div>
                            <div>
                                <div style="font-weight: 500;">${user.name}</div>
                            </div>
                        </div>
                    </td>
                    <td>${user.email}</td>
                    <td>
                        <span class="status-badge ${(user.Role?.name || user.role || '').toLowerCase()}">${user.Role?.displayName || (user.role || '').replace('-', ' ')}</span>
                    </td>
                    <td>
                        <span class="status-badge active">Active</span>
                    </td>
                    <td>Just now</td>
                    <td>
                        <button class="action-btn edit" onclick="editUser('${user.id}')">✏️ Edit</button>
                        <button class="action-btn reset" onclick="resetUserPassword('${user.id}')">🔑 Reset Password</button>
                        <button class="action-btn delete" onclick="deleteUser('${user.id}')">🗑️ Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadRoles() {
            const rolesGrid = document.getElementById('rolesGrid');
            try {
                if (isBackendMode()) {
                    const data = await apiFetch('/roles');
                    AppState.roles = (data || []).map(r => ({
                        ...r,
                        permissions: Array.isArray(r.permissions) ? r.permissions
                          : (r && r.permissions && typeof r.permissions === 'object' ? Object.values(r.permissions)
                          : (typeof r.permissions === 'string' ? r.permissions.split(',').map(s=>s.trim()).filter(Boolean) : []))
                    }));
                }
            } catch (e) {
                console.error('Failed to load roles from backend, using local:', e);
            }

            rolesGrid.innerHTML = (AppState.roles || []).map(role => `
                <div class="role-card">
                    <div class="role-card-header">
                        <div class="role-name">${role.displayName || role.name}</div>
                        <span class="role-users-count">${(role.userCount ?? 0)} users</span>
                    </div>
                    <p style="margin-bottom: 1rem; color: var(--gray-600); font-size: 0.875rem;">${role.description || ''}</p>
                    <ul class="permission-list">
                        ${(role.permissions || []).slice(0, 4).map(perm => `
                            <li class="permission-item granted">
                                ✅ ${perm.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                            </li>
                        `).join('')}
                        ${(role.permissions || []).length > 4 ? `<li class="permission-item">...and ${(role.permissions || []).length - 4} more</li>` : ''}
                    </ul>
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <button class="action-btn edit" onclick="editRole('${role.id}')">✏️ Edit</button>
                        <button class="action-btn delete" onclick="deleteRole('${role.id}')" ${role.isSystem ? 'disabled' : ''}>🗑️ Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function loadSettings() {
            document.getElementById('companyName').focus();
            
            // Show financial settings for Project Manager and above
            const userRole = (AppState.user?.Role?.name || AppState.user?.role || '').toLowerCase();
            const hasFinancialAccess = ['project_manager', 'admin', 'owner', 'superadmin', 'root'].includes(userRole.replace('-', '_'));
            
            const financialSettingsGroup = document.getElementById('financialSettingsGroup');
            if (financialSettingsGroup) {
                financialSettingsGroup.style.display = hasFinancialAccess ? 'block' : 'none';
            }
            
            // Load financial settings from localStorage
            if (hasFinancialAccess) {
                loadFinancialSettings();
            }
            
            if (isBackendMode()) {
                loadDbSettings().catch(() => {});
            }
        }

        async function loadDbSettings() {
            try {
                const cfg = await apiFetch('/admin/db/config');
                const prof = cfg?.profiles?.[cfg.activeProfile] || {};
                document.getElementById('dbDialect').value = (prof.dialect || 'mariadb').toLowerCase();
                document.getElementById('dbHost').value = prof.host || '127.0.0.1';
                document.getElementById('dbPort').value = prof.port || (prof.dialect === 'mssql' ? 1433 : 3306);
                document.getElementById('dbName').value = prof.database || 'apex';
                document.getElementById('dbUser').value = prof.user || '';
                document.getElementById('dbPassword').value = prof.password || '';
                const m = document.getElementById('dbConfigMessage');
                if (m) m.textContent = 'Loaded current DB config';
            } catch (e) {
                const m = document.getElementById('dbConfigMessage');
                if (m) m.textContent = 'Could not load DB config';
            }
        }

        async function testDbConnection() {
            if (!isBackendMode()) { return alert('Backend not connected'); }
            const payload = {
                dialect: document.getElementById('dbDialect').value,
                host: document.getElementById('dbHost').value,
                port: parseInt(document.getElementById('dbPort').value || '0', 10),
                database: document.getElementById('dbName').value,
                user: document.getElementById('dbUser').value,
                password: document.getElementById('dbPassword').value
            };
            const m = document.getElementById('dbConfigMessage');
            try {
                const r = await apiFetch('/admin/db/test', { method: 'POST', body: JSON.stringify(payload) });
                if (r.ok) { m.textContent = 'Connection OK'; m.style.color = 'var(--success-600)'; }
                else { m.textContent = 'Connection failed'; m.style.color = 'var(--danger-600)'; }
            } catch (e) {
                m.textContent = 'Connection failed: ' + (e.message || e);
                m.style.color = 'var(--danger-600)';
            }
        }

        async function createMariaDbUser() {
            const m = document.getElementById('dbUserMessage');
            try {
                const dialect = (document.getElementById('dbDialect').value || '').toLowerCase();
                if (!['mariadb','mysql'].includes(dialect)) {
                    m.textContent = 'User creation is only supported for MariaDB/MySQL';
                    m.style.color = 'var(--danger-600)';
                    return;
                }
                const payload = {
                    rootUser: document.getElementById('rootDbUser').value || 'root',
                    rootPassword: document.getElementById('rootDbPassword').value || '',
                    host: document.getElementById('dbHost').value || '127.0.0.1',
                    port: parseInt(document.getElementById('dbPort').value || '3306', 10),
                    database: document.getElementById('dbName').value || 'apex',
                    newUser: document.getElementById('newDbUser').value || 'apex_app',
                    newPassword: document.getElementById('newDbPassword').value || ''
                };
                if (!payload.rootPassword) { m.textContent = 'Enter root password'; m.style.color = 'var(--danger-600)'; return; }
                if (!payload.newPassword) { m.textContent = 'Enter a password for the new user'; m.style.color = 'var(--danger-600)'; return; }
                m.textContent = 'Creating user...'; m.style.color = 'var(--muted-600)';
                const r = await apiFetch('/admin/db/create-mariadb-user', { method: 'POST', body: JSON.stringify(payload) });
                m.textContent = r?.message || 'User created'; m.style.color = 'var(--success-600)';
                // If created successfully, reflect in the main DB fields
                document.getElementById('dbUser').value = payload.newUser;
                document.getElementById('dbPassword').value = payload.newPassword;
            } catch (e) {
                m.textContent = 'Failed: ' + (e.message || e);
                m.style.color = 'var(--danger-600)';
            }
        }

        async function saveDbSettings() {
            if (!isBackendMode()) { return alert('Backend not connected'); }
            const prof = {
                dialect: document.getElementById('dbDialect').value,
                host: document.getElementById('dbHost').value,
                port: parseInt(document.getElementById('dbPort').value || '0', 10),
                database: document.getElementById('dbName').value,
                user: document.getElementById('dbUser').value,
                password: document.getElementById('dbPassword').value
            };
            const payload = { activeProfile: 'default', profiles: { default: prof } };
            const m = document.getElementById('dbConfigMessage');
            try {
                const r = await apiFetch('/admin/db/config', { method: 'PUT', body: JSON.stringify(payload) });
                m.textContent = (r.message || 'Saved') + ' (restart required)';
                m.style.color = 'var(--muted-600)';
            } catch (e) {
                m.textContent = 'Save failed: ' + (e.message || e);
                m.style.color = 'var(--danger-600)';
            }
        }


        function loadAuditLog() {
            const auditTableBody = document.getElementById('auditTableBody');
            const escapeHtml = (s) => String(s ?? '').replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
            const fmt = (v) => escapeHtml(typeof v === 'object' ? JSON.stringify(v) : v);
            const rows = (AppState.auditLog || []).map(entry => {
                const userName = entry.user || entry.actor?.name || 'Unknown';
                const action = entry.action || '';
                const entityLabel = entry.entityName || entry.resource || entry.entity || '-';
                const details = entry.details || '';
                const source = entry.ipAddress || entry.page || '';
                const diff = entry.diff || {};
                const diffKeys = Object.keys(diff);
                const hasBA = !!entry.before || !!entry.after;
                let changesCell = '-';
                if (diffKeys.length || hasBA) {
                    const diffList = diffKeys.map(k => `<div><strong>${escapeHtml(k)}</strong>: <span style="color:#6b7280;">${fmt(diff[k]?.before)}</span> → <span style="color:#111827;">${fmt(diff[k]?.after)}</span></div>`).join('');
                    const beforeBlock = entry.before ? `<div><strong>Before:</strong><pre style="white-space:pre-wrap;margin:0.5rem 0;">${escapeHtml(JSON.stringify(entry.before, null, 2))}</pre></div>` : '';
                    const afterBlock = entry.after ? `<div><strong>After:</strong><pre style="white-space:pre-wrap;margin:0.5rem 0;">${escapeHtml(JSON.stringify(entry.after, null, 2))}</pre></div>` : '';
                    const inner = diffKeys.length ? diffList : (beforeBlock + afterBlock);
                    changesCell = `<details><summary>View</summary><div class="audit-diff" style="padding:0.5rem 0;">${inner}</div></details>`;
                }
                const actionBadgeClass = (action.startsWith('project') || action.startsWith('task') || action === 'login') ? 'active' : 'pending';
                const severity = entry.severity || 'info';
                const sevIcon = ({ info: 'ℹ️', warning: '⚠️', error: '❗', success: '✅' })[severity] || 'ℹ️';
                return `
                <tr>
                    <td>${new Date(entry.timestamp).toLocaleString()}</td>
                    <td>
                        <div style="display: flex; align-items: center;">
                            <div class="user-avatar-small">${escapeHtml(userName.charAt(0))}</div>
                            ${escapeHtml(userName)}
                        </div>
                    </td>
                    <td><span class="status-badge ${actionBadgeClass}">${sevIcon} ${escapeHtml(action)}</span></td>
                    <td>${escapeHtml(entityLabel)}</td>
                    <td>${escapeHtml(details)}</td>
                    <td>${changesCell}</td>
                    <td>${escapeHtml(source || '-')}</td>
                </tr>`;


            }).join('');
            auditTableBody.innerHTML = rows;
            try { applyAuditCompact(); } catch(_) {}
        }

        function filterUsers() {
            const searchTerm = document.getElementById('userSearchInput').value.toLowerCase();
            const roleFilter = document.getElementById('userRoleFilter').value.toLowerCase();

            let filteredUsers = AppState.users;

            if (searchTerm) {
                filteredUsers = filteredUsers.filter(user =>
                    user.name.toLowerCase().includes(searchTerm) ||
                    user.email.toLowerCase().includes(searchTerm)
                );
            }

            if (roleFilter) {
                filteredUsers = filteredUsers.filter(user => {
                    const rName = (user.Role?.name || user.role || '').toLowerCase();
                    return rName.includes(roleFilter);
                });
            }

            const usersTableBody = document.getElementById('usersTableBody');
            usersTableBody.innerHTML = filteredUsers.map(user => `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center;">
                            <div class="user-avatar-small">${user.avatar}</div>


                            <div>
                                <div style="font-weight: 500;">${user.name}</div>
                            </div>
                        </div>
                    </td>
                    <td>${user.email}</td>
                    <td>
                        <span class="status-badge ${(user.Role?.name || user.role || '').toLowerCase()}">${user.Role?.displayName || (user.role || '').replace('-', ' ')}</span>
                    </td>
                    <td>
                        <span class="status-badge active">Active</span>
                    </td>
                    <td>Just now</td>
                    <td>
                        <button class="action-btn edit" onclick="editUser('${user.id}')">✏️ Edit</button>
                        <button class="action-btn reset" onclick="resetUserPassword('${user.id}')">🔑 Reset Password</button>
                        <button class="action-btn delete" onclick="deleteUser('${user.id}')">🗑️ Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function showCreateUser() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h2>Add New User</h2>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
                    </div>
                    <div class="modal-body">
                        <form onsubmit="createUser(event)">
                            <div class="form-group">
                                <label>Full Name</label>
                                <input type="text" name="name" class="form-control" required autocomplete="name">
                            </div>

                            <div class="form-group">
                                <label>Email Address</label>
                                <input type="email" name="email" class="form-control" required autocomplete="email">
                            </div>

                            <div class="form-group">
                                <label>Role</label>
                                <select name="role" class="form-control" required>
                                    <option value="">Select a role</option>
                                    ${AppState.roles.map(role =>
                                        `<option value="${role.id}">${role.name}</option>`
                                    ).join('')}
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Temporary Password</label>
                                <input type="password" name="password" class="form-control" required autocomplete="new-password">
                            </div>

                            <div class="checkbox-group">
                                <label>
                                    <input type="checkbox" name="forcePasswordChange" checked>
                                    Require password change on first login
                                </label>
                            </div>

                            <div class="form-actions" style="margin-top: 1.5rem;">
                                <button type="submit" class="btn btn-primary">Create User</button>
                                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        async function createUser(event) {
            event.preventDefault();
            const formData = new FormData(event.target);

            if (isBackendMode()) {
                try {
                    const roleIdRaw = formData.get('role');
                    const roleId = typeof roleIdRaw === 'string' && /^\d+$/.test(roleIdRaw) ? parseInt(roleIdRaw, 10) : roleIdRaw;
                    await apiFetch('/users', {
                        method: 'POST',
                        body: JSON.stringify({
                            name: formData.get('name'),
                            email: formData.get('email'),
                            password: formData.get('password'),
                            roleId: roleId,
                            department: 'AV Team',
                            forcePasswordChange: formData.get('forcePasswordChange') === 'on'
                        })
                    });
                    showNotification('User created successfully', 'success');
                    event.target.closest('.modal-overlay').remove();
                    loadUsers();
                    return;
                } catch (e) {
                    console.error('Backend user create failed:', e);
                    showNotification('Failed to create user via backend', 'error');
                    return;
                }
            }

            // Local fallback (demo data)
            const newUser = {
                id: AppState.users && AppState.users.length > 0 ? Math.max(...AppState.users.map(u => u.id)) + 1 : 1,
                name: formData.get('name'),
                email: formData.get('email'),
                password: formData.get('password'),
                role: (AppState.roles.find(r => String(r.id) === String(formData.get('role'))) || { name: 'Viewer' }).name,
                avatar: formData.get('name').split(' ').map(n => n[0]).join('')
            };

            AppState.users.push(newUser);

            // Update role user count
            const role = AppState.roles.find(r => String(r.id) === String(formData.get('role')));
            if (role && typeof role.userCount === 'number') role.userCount++;

            // Add audit entry (local)
            AppState.auditLog.unshift({
                id: AppState.auditLog.length + 1,
                timestamp: new Date().toISOString(),
                user: AppState.user.name,
                action: 'user',
                resource: newUser.email,
                details: `Created new user account`,
                ipAddress: '127.0.0.1'
            });

            showNotification(`User "${newUser.name}" created successfully`, 'success');
            event.target.closest('.modal-overlay').remove();
            loadUsers();
        }

        function editUser(userId) {
            const user = (AppState.users || []).find(u => String(u.id) === String(userId));
            if (!user) return;

            const currentRoleId = user.Role?.id ?? (AppState.roles.find(r => r.name.toLowerCase() === (user.role || '').toLowerCase())?.id);
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                  <div class="modal-header">
                    <h2>Edit User</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
                  </div>
                  <div class="modal-body">
                    <form onsubmit="submitEditUser(event, '${user.id}')">
                      <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" name="name" class="form-control" value="${user.name}" required autocomplete="name">
                      </div>
                      <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="email" class="form-control" value="${user.email}" required autocomplete="email">
                      </div>
                      <div class="form-group">
                        <label>Role</label>
                        <select name="roleId" class="form-control" required>
                          ${(AppState.roles || []).map(r => `<option value="${r.id}" ${String(r.id)===String(currentRoleId)?'selected':''}>${r.displayName || r.name}</option>`).join('')}
                        </select>
                      </div>
                      <div class="checkbox-group">
                        <label>
                          <input type="checkbox" name="isActive" ${user.isActive===false?'':'checked'}>
                          Active
                        </label>
                      </div>
                      <div class="form-actions" style="margin-top: 1.5rem;">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                      </div>
                    </form>
                  </div>
                </div>`;
            document.body.appendChild(modal);
        }

        async function submitEditUser(event, userId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            const payload = {
                name: formData.get('name'),
                email: formData.get('email'),
                roleId: formData.get('roleId'),
                isActive: formData.get('isActive') === 'on'
            };

            if (!isBackendMode()) { showNotification('Backend connection required', 'error'); return; }


            if (isBackendMode()) {
                try {
                    await apiFetch(`/users/${userId}`, { method: 'PUT', body: JSON.stringify(payload) });
                    showNotification('User updated successfully', 'success');
                    form.closest('.modal-overlay').remove();
                    await loadUsers();
                    return;
                } catch (e) {
                    console.error('Backend user update failed:', e);
                    showNotification('Failed to update user via backend', 'error');
                    return;
                }
            }


        }

        async function resetUserPassword(userId) {
            const user = (AppState.users || []).find(u => String(u.id) === String(userId));
            if (!user) return;

            if (!confirm(`Reset password for ${user.name}?`)) return;

            if (isBackendMode()) {
                try {
                    const data = await apiFetch(`/users/${userId}/reset-password`, { method: 'POST', body: JSON.stringify({}) });
                    const temp = data.tempPassword;
                    const modal = document.createElement('div');
                    modal.className = 'modal-overlay';
                    modal.innerHTML = `
                      <div class="modal">
                        <div class="modal-header">
                          <h2>Temporary Password</h2>
                          <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">\u00d7</button>
                        </div>
                        <div class="modal-body">
                          <p>Provide this temporary password to <strong>${user.name}</strong> and require them to change it on next login:</p>
                          <div class="form-group">
                            <input type="text" class="form-control" value="${temp}" readonly>
                          </div>
                          <div class="form-actions" style="margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">Done</button>
                          </div>
                        </div>
                      </div>`;
                    document.body.appendChild(modal);
                    return;
                } catch (e) {
                    console.error('Backend password reset failed:', e);
                    showNotification('Failed to reset password via backend', 'error');
                    return;
                }
            }

            // Local fallback
            showNotification(`Password reset (local only) for ${user.email}`, 'success');
            AppState.auditLog.unshift({
                id: AppState.auditLog.length + 1,
                timestamp: new Date().toISOString(),
                user: AppState.user.name,
                action: 'user',
                resource: user.email,
                details: 'Password reset initiated (local)',
                ipAddress: '127.0.0.1'
            });
        }

        async function deleteUser(userId) {
            const user = (AppState.users || []).find(u => String(u.id) === String(userId));
            if (!user) return;

            if (!confirm(`Delete user ${user.name}? This action cannot be undone.`)) return;

            if (isBackendMode()) {
                try {
                    await apiFetch(`/users/${userId}`, { method: 'DELETE' });
                    showNotification(`User "${user.name}" deleted`, 'success');
                    loadUsers();
                    return;
                } catch (e) {
                    console.error('Backend user delete failed:', e);
                    showNotification('Failed to delete user via backend', 'error');
                    return;
                }
            }

            // Local fallback
            const roleName = (user.role || '').toLowerCase().replace(' ', '');
            const role = AppState.roles.find(r => String(r.id) === roleName);
            if (role && typeof role.userCount === 'number') role.userCount--;

            AppState.users = AppState.users.filter(u => String(u.id) !== String(userId));

            AppState.auditLog.unshift({
                id: AppState.auditLog.length + 1,
                timestamp: new Date().toISOString(),
                user: AppState.user.name,
                action: 'user',
                resource: user.email,
                details: 'User account deleted',
                ipAddress: '127.0.0.1'
            });

            showNotification(`User "${user.name}" deleted successfully`, 'success');
            loadUsers();
        }


        async function getPermissionCatalog() {
            if (AppState.permissionCatalog) return AppState.permissionCatalog;
            const fallback = [
                { category: 'Users', items: [
                    { key: 'users.create', label: 'Create users' },
                    { key: 'users.read', label: 'View users' },
                    { key: 'users.update', label: 'Edit users' },
                    { key: 'users.delete', label: 'Delete users' }
                ]},
                { category: 'Projects', items: [
                    { key: 'projects.create', label: 'Create projects' },
                    { key: 'projects.read', label: 'View all projects' },
                    { key: 'projects.read.own', label: 'View own projects' },
                    { key: 'projects.update', label: 'Edit projects' },
                    { key: 'projects.update.tasks', label: 'Edit project tasks' },
                    { key: 'tasks.notes.view', label: 'View task notes' },
                    { key: 'tasks.notes.edit', label: 'Edit task notes' },
                    { key: 'projects.delete', label: 'Delete projects' }
                ]},
                { category: 'Reports', items: [
                    { key: 'reports.executive', label: 'Executive reports' },
                    { key: 'reports.portfolio', label: 'Portfolio reports' },
                    { key: 'reports.resource', label: 'Resource reports' },
                    { key: 'reports.risk', label: 'Risk reports' },
                    { key: 'reports.project', label: 'Project reports' },
                    { key: 'reports.project.own', label: 'Own project reports' }
                ]},
                { category: 'Administration', items: [
                    { key: 'settings.manage', label: 'Manage system settings' },
                    { key: 'roles.manage', label: 'Manage roles & permissions' },
                    { key: 'audit.view', label: 'View audit log' }
                ]}
            ];
            try {
                if (isBackendMode()) {
                    const data = await apiFetch('/roles/permissions');
                    AppState.permissionCatalog = data.categories || fallback;
                } else {
                    AppState.permissionCatalog = fallback;
                }
            } catch (_) {
                AppState.permissionCatalog = fallback;
            }
            return AppState.permissionCatalog;
        }

        function renderPermissionGrid(container, categories, selected=new Set()) {
            container.innerHTML = categories.map(cat => `
                <div style="margin:10px 0;">
                    <div style="font-weight:600; margin-bottom:6px;">${cat.category}</div>
                    <div class="checkbox-group" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:6px;">
                        ${cat.items.map(it => {
                            const checked = selected.has(it.key) ? 'checked' : '';
                            return `<label><input type="checkbox" name="perm" value="${it.key}" ${checked}> ${it.label}</label>`;
                        }).join('')}
                    </div>
                </div>
            `).join('');
        }

        async function showCreateRole() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                  <div class="modal-header">
                    <h2>Create Role</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">\u00d7</button>
                  </div>
                  <div class="modal-body">
                    <form onsubmit="submitCreateRole(event)">
                      <div class="form-group">
                        <label>Role Key (lowercase, underscores)</label>
                        <input type="text" name="name" class="form-control" pattern="^[a-z_]+$" placeholder="e.g. project_manager" required>
                      </div>
                      <div class="form-group">
                        <label>Display Name</label>
                        <input type="text" name="displayName" class="form-control" required>
                      </div>
                      <div class="form-group">
                        <label>Description</label>
                        <textarea name="description" class="form-control" rows="3"></textarea>
                      </div>
                      <div class="form-group">
                        <label>Priority</label>
                        <input type="number" name="priority" class="form-control" value="10" min="0" step="1">
                      </div>
                      <div class="form-group">
                        <label>Permissions</label>
                        <div id="permGrid-create"></div>
                      </div>
                      <div class="form-actions" style="margin-top: 1.5rem;">
                        <button type="submit" class="btn btn-primary">Create</button>
                        <button type="button" class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                      </div>
                    </form>
                  </div>
                </div>`;
            document.body.appendChild(modal);
            // Populate permissions grid
            try { const cats = await getPermissionCatalog(); renderPermissionGrid(modal.querySelector('#permGrid-create'), cats, new Set()); } catch(_) {}

        }

        async function submitCreateRole(event) {
            event.preventDefault();
            const form = event.target;
            const fd = new FormData(form);
            const permissions = Array.from(form.querySelectorAll('input[name="perm"]:checked')).map(el => el.value);
            const payload = {
              name: fd.get('name'),
              displayName: fd.get('displayName'),
              description: fd.get('description') || '',
              permissions,
              priority: parseInt(fd.get('priority') || '10', 10)
            };

            if (isBackendMode()) {
              try {
                await apiFetch('/roles', { method: 'POST', body: JSON.stringify(payload) });
                showNotification('Role created successfully', 'success');
                form.closest('.modal-overlay').remove();
                await loadRoles();
                return;
              } catch (e) {
                console.error('Create role failed:', e);
                showNotification(e.message || 'Failed to create role', 'error');
                return;
              }
            }

            // Local fallback
            AppState.roles = AppState.roles || [];
            AppState.roles.push({ ...payload, id: payload.name, isSystem: false, userCount: 0 });
            showNotification('Role created (local)', 'success');
            form.closest('.modal-overlay').remove();
            loadRoles();
        }

        async function editRole(roleId) {
            const role = (AppState.roles || []).find(r => String(r.id) === String(roleId));
            if (!role) return;

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const perms = (role.permissions || []).join(', ');
            modal.innerHTML = `
                <div class="modal">
                  <div class="modal-header">
                    <h2>Edit Role</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">\u00d7</button>
                  </div>
                  <div class="modal-body">
                    <form onsubmit="submitEditRole(event, '${roleId}')">
                      <div class="form-group">
                        <label>Display Name</label>
                        <input type="text" name="displayName" class="form-control" value="${role.displayName || role.name}" required>
                      </div>
                      <div class="form-group">
                        <label>Description</label>
                        <textarea name="description" class="form-control" rows="3">${role.description || ''}</textarea>
                      </div>
                      <div class="form-group">
                        <label>Priority</label>
                        <input type="number" name="priority" class="form-control" value="${role.priority ?? 10}" min="0" step="1">
                      </div>
                      <div class="form-group">
                        <label>Permissions</label>
                        <div id="permGrid-edit"></div>
                      </div>
                      <div class="form-actions" style="margin-top: 1.5rem;">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                      </div>
                    </form>
                  </div>
                </div>`;
            document.body.appendChild(modal);
            // Populate permissions grid with current selections
            try { const cats = await getPermissionCatalog(); const sel = new Set(role.permissions || []); renderPermissionGrid(modal.querySelector('#permGrid-edit'), cats, sel); } catch(_) {}

        }

        async function submitEditRole(event, roleId) {
            event.preventDefault();
            const form = event.target;
            const fd = new FormData(form);
            const permissions = Array.from(form.querySelectorAll('input[name="perm"]:checked')).map(el => el.value);
            const payload = {
              displayName: fd.get('displayName'),
              description: fd.get('description') || '',
              permissions,
              priority: parseInt(fd.get('priority') || '10', 10)
            };

            if (isBackendMode()) {
              try {
                await apiFetch(`/roles/${roleId}`, { method: 'PUT', body: JSON.stringify(payload) });
                showNotification('Role updated successfully', 'success');
                form.closest('.modal-overlay').remove();
                await loadRoles();
                return;
              } catch (e) {
                console.error('Update role failed:', e);
                showNotification(e.message || 'Failed to update role', 'error');
                return;
              }
            }

            // Local fallback
            const idx = (AppState.roles || []).findIndex(r => String(r.id) === String(roleId));
            if (idx !== -1) {
              AppState.roles[idx] = { ...AppState.roles[idx], ...payload };
              showNotification('Role updated (local)', 'success');
              form.closest('.modal-overlay').remove();
              loadRoles();
            }
        }

        async function deleteRole(roleId) {
            const role = (AppState.roles || []).find(r => String(r.id) === String(roleId));
            if (!role) return;
            if (role.isSystem || ['admin','owner'].includes(String(role.name).toLowerCase()) || ['admin','owner'].includes(String(role.id).toLowerCase())) {
              showNotification('Cannot delete a system role', 'error');
              return;
            }
            if (!confirm(`Delete role "${role.displayName || role.name}"?`)) return;

            if (isBackendMode()) {
              try {
                await apiFetch(`/roles/${roleId}`, { method: 'DELETE' });
                showNotification('Role deleted', 'success');
                await loadRoles();
                return;
              } catch (e) {
                console.error('Delete role failed:', e);
                showNotification(e.message || 'Failed to delete role', 'error');
                return;
              }
            }

            // Local fallback (respect userCount)
            if ((role.userCount || 0) > 0) {
              showNotification(`Cannot delete role with ${role.userCount} assigned users`, 'error');
              return;
            }
            AppState.roles = (AppState.roles || []).filter(r => String(r.id) !== String(roleId));
            showNotification('Role deleted (local)', 'success');
            loadRoles();
        }

        function saveSystemSettings() {
            const companyName = document.getElementById('companyName').value;
            const defaultStatus = document.getElementById('defaultProjectStatus').value;
            const sessionTimeout = document.getElementById('sessionTimeout').value;

            showNotification('System settings saved successfully', 'success');

            // Add audit entry
            AppState.auditLog.unshift({
                id: AppState.auditLog.length + 1,
                timestamp: new Date().toISOString(),
                user: AppState.user.name,
                action: 'system',
                resource: 'Settings',
                details: 'System settings updated',
                ipAddress: '192.168.1.100'
            });
        }

        function resetSystemSettings() {
            if (confirm('Reset all settings to default values?')) {
                document.getElementById('companyName').value = '[Company Name] - Unified Communications';
                document.getElementById('defaultProjectStatus').value = 'active';
                document.getElementById('sessionTimeout').value = '60';

                showNotification('Settings reset to defaults', 'info');
            }
        }

        // Financial Settings Functions
        async function loadFinancialSettings() {
            let settings = {};
            
            if (isBackendMode()) {
                try {
                    const response = await apiFetch('/settings');
                    settings = response;
                } catch (error) {
                    console.error('Error loading financial settings:', error);
                }
            }
            
            // Load values with defaults
            document.getElementById('breakfixBudget').value = settings.breakfixBudget || 1000000;
            document.getElementById('breakfixWarningThreshold').value = settings.breakfixWarningThreshold || 80;
            document.getElementById('refreshBudget').value = settings.refreshBudget || 2000000;
            document.getElementById('refreshWarningThreshold').value = settings.refreshWarningThreshold || 80;
            document.getElementById('budgetReportingPeriod').value = settings.budgetReportingPeriod || 'quarterly';
            document.getElementById('currencyFormat').value = settings.currencyFormat || 'USD';
        }

        async function saveFinancialSettings() {
            const settings = {
                breakfixBudget: parseInt(document.getElementById('breakfixBudget').value) || 1000000,
                breakfixWarningThreshold: parseInt(document.getElementById('breakfixWarningThreshold').value) || 80,
                refreshBudget: parseInt(document.getElementById('refreshBudget').value) || 2000000,
                refreshWarningThreshold: parseInt(document.getElementById('refreshWarningThreshold').value) || 80,
                budgetReportingPeriod: document.getElementById('budgetReportingPeriod').value || 'quarterly',
                currencyFormat: document.getElementById('currencyFormat').value || 'USD',
                lastUpdated: new Date().toISOString(),
                updatedBy: AppState.user?.email || 'Unknown'
            };

            // Save each setting to database
            if (isBackendMode()) {
                try {
                    const settingsToSave = [
                        { key: 'breakfixBudget', value: settings.breakfixBudget, type: 'number' },
                        { key: 'breakfixWarningThreshold', value: settings.breakfixWarningThreshold, type: 'number' },
                        { key: 'refreshBudget', value: settings.refreshBudget, type: 'number' },
                        { key: 'refreshWarningThreshold', value: settings.refreshWarningThreshold, type: 'number' },
                        { key: 'budgetReportingPeriod', value: settings.budgetReportingPeriod, type: 'string' },
                        { key: 'currencyFormat', value: settings.currencyFormat, type: 'string' }
                    ];
                    
                    for (const setting of settingsToSave) {
                        await apiFetch('/settings', {
                            method: 'POST',
                            body: JSON.stringify({
                                ...setting,
                                category: 'financial',
                                description: `Financial setting: ${setting.key}`
                            })
                        });
                    }
                } catch (error) {
                    console.error('Error saving financial settings:', error);
                    showNotification('Error saving settings', 'error');
                    return;
                }
            }
            
            // Audit log the change
            auditLogEvent({
                action: 'update',
                entity: 'financial_settings',
                entityId: 'financial_config',
                entityName: 'Financial Report Settings',
                after: settings,
                details: 'Updated financial report budget settings'
            });

            showNotification('Financial settings saved successfully', 'success');
        }

        async function resetFinancialSettings() {
            if (confirm('Reset financial settings to default values?')) {
                document.getElementById('breakfixBudget').value = 1000000;
                document.getElementById('breakfixWarningThreshold').value = 80;
                document.getElementById('refreshBudget').value = 2000000;
                document.getElementById('refreshWarningThreshold').value = 80;
                document.getElementById('budgetReportingPeriod').value = 'quarterly';
                document.getElementById('currencyFormat').value = 'USD';

                // Remove from database
                if (isBackendMode()) {
                    try {
                        const settingsToDelete = [
                            'breakfixBudget', 'breakfixWarningThreshold', 'refreshBudget',
                            'refreshWarningThreshold', 'budgetReportingPeriod', 'currencyFormat'
                        ];
                        for (const key of settingsToDelete) {
                            await apiFetch(`/settings/${key}`, { method: 'DELETE' });
                        }
                    } catch (error) {
                        console.error('Error deleting financial settings:', error);
                    }
                }
                
                showNotification('Financial settings reset to defaults', 'info');
            }
        }

        // Helper function to get financial settings for use in reports
        async function getFinancialSettings() {
            let settings = {};
            
            if (isBackendMode()) {
                try {
                    const response = await apiFetch('/settings');
                    settings = response;
                } catch (error) {
                    console.error('Error loading financial settings:', error);
                }
            }
            
            // Return settings with defaults for any missing values
            return {
                breakfixBudget: settings.breakfixBudget || 1000000,
                breakfixWarningThreshold: settings.breakfixWarningThreshold || 80,
                refreshBudget: settings.refreshBudget || 2000000,
                refreshWarningThreshold: settings.refreshWarningThreshold || 80,
                budgetReportingPeriod: settings.budgetReportingPeriod || 'quarterly',
                currencyFormat: settings.currencyFormat || 'USD'
            };
        }

        function filterAuditLog() {
            const fromDate = document.getElementById('auditFromDate').value;
            const toDate = document.getElementById('auditToDate').value;
            const actionFilter = document.getElementById('auditActionFilter').value;

            let filteredLog = [...(AppState.auditLog || [])];

            if (fromDate) {
                filteredLog = filteredLog.filter(entry => new Date(entry.timestamp) >= new Date(fromDate));
            }
            if (toDate) {
                filteredLog = filteredLog.filter(entry => new Date(entry.timestamp) <= new Date(toDate));
            }
            if (actionFilter) {
                const af = actionFilter.toLowerCase();
                filteredLog = filteredLog.filter(entry => {
                    const a = String(entry.action || '').toLowerCase();
                    const e = String(entry.entity || '').toLowerCase();
                    if (af === 'login') return a === 'login' || a === 'logout';
                    if (af === 'project') return e === 'project' || a.startsWith('project');
                    if (af === 'task') return e === 'task' || a.startsWith('task');
                    if (af === 'user') return e === 'user' || a.startsWith('user');
                    if (af === 'system') return e === 'system' || a.startsWith('system');
                    return a === af;
                });
            }

            const escapeHtml = (s) => String(s ?? '').replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
            const fmt = (v) => escapeHtml(typeof v === 'object' ? JSON.stringify(v) : v);

            const rows = filteredLog.map(entry => {
                const userName = entry.user || entry.actor?.name || 'Unknown';
                const action = entry.action || '';
                const entityLabel = entry.entityName || entry.resource || entry.entity || '-';
                const details = entry.details || '';
                const source = entry.ipAddress || entry.page || '';
                const diff = entry.diff || {};
                const diffKeys = Object.keys(diff);
                const hasBA = !!entry.before || !!entry.after;
                let changesCell = '-';
                if (diffKeys.length || hasBA) {
                    const diffList = diffKeys.map(k => `<div><strong>${escapeHtml(k)}</strong>: <span style=\"color:#6b7280;\">${fmt(diff[k]?.before)}</span> → <span style=\"color:#111827;\">${fmt(diff[k]?.after)}</span></div>`).join('');
                    const beforeBlock = entry.before ? `<div><strong>Before:</strong><pre style=\"white-space:pre-wrap;margin:0.5rem 0;\">${escapeHtml(JSON.stringify(entry.before, null, 2))}</pre></div>` : '';
                    const afterBlock = entry.after ? `<div><strong>After:</strong><pre style=\"white-space:pre-wrap;margin:0.5rem 0;\">${escapeHtml(JSON.stringify(entry.after, null, 2))}</pre></div>` : '';
                    const inner = diffKeys.length ? diffList : (beforeBlock + afterBlock);
                    changesCell = `<details><summary>View</summary><div class=\"audit-diff\" style=\"padding:0.5rem 0;\">${inner}</div></details>`;
                }
                const actionBadgeClass = (action.startsWith('project') || action.startsWith('task') || action === 'login') ? 'active' : 'pending';
                return `
                <tr>
                    <td>${new Date(entry.timestamp).toLocaleString()}</td>
                    <td>
                        <div style="display: flex; align-items: center;">
                            <div class="user-avatar-small">${escapeHtml(userName.charAt(0))}</div>
                            ${escapeHtml(userName)}
                        </div>
                    </td>
                    <td><span class="status-badge ${actionBadgeClass}">${({ info: 'ℹ️', warning: '⚠️', error: '❗', success: '✅' })[entry.severity || 'info'] || 'ℹ️'} ${escapeHtml(action)}</span></td>
                    <td>${escapeHtml(entityLabel)}</td>
                    <td>${escapeHtml(details)}</td>
                    <td>${changesCell}</td>
                    <td>${escapeHtml(source || '-')}</td>
                </tr>`;
            }).join('');

            const auditTableBody = document.getElementById('auditTableBody');
            auditTableBody.innerHTML = rows;
            try { applyAuditCompact(); } catch(_) {}

            showNotification(`Filtered audit log: ${filteredLog.length} entries found`, 'info');
        }

        function applyAuditCompact() {
            try {
                const table = document.getElementById('auditTable');
                if (!table) return;
                const hide = !!AppState.auditCompact;
                const colIdx = 4; // zero-based index for 'Details' column
                const headRow = table.tHead && table.tHead.rows && table.tHead.rows[0];
                if (headRow && headRow.cells[colIdx]) {
                    headRow.cells[colIdx].style.display = hide ? 'none' : '';
                }
                const bodies = table.tBodies || [];
                for (let b = 0; b < bodies.length; b++) {
                    const rows = bodies[b].rows || [];
                    for (let r = 0; r < rows.length; r++) {
                        const cell = rows[r].cells && rows[r].cells[colIdx];
                        if (cell) cell.style.display = hide ? 'none' : '';
                    }
                }
                const btn = document.getElementById('auditCompactToggle');
                if (btn) btn.innerText = hide ? 'Full View' : 'Compact View';
            } catch (_) {}
        }

        function toggleAuditCompact() {
            AppState.auditCompact = !AppState.auditCompact;
            try { applyAuditCompact(); } catch(_) {}
        }


        function exportUserData() {
            const userData = AppState.users.map(user => ({
                name: user.name,
                email: user.email,
                role: user.role
            }));

            const dataStr = JSON.stringify(userData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = 'users-export.json';
            link.click();

            URL.revokeObjectURL(url);
            showNotification('User data exported successfully', 'success');
        }


        // ==================== AUTHENTICATION ====================
        async function handleLogin(event) {
            try {
                event.preventDefault();
                const formData = new FormData(event.target);
                const submitBtn = event.target.querySelector('.login-btn');
                if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Signing in...'; }
                const email = formData.get('email');
                const password = formData.get('password');

                // If backend is disabled, skip backend auth and use local login
                if (!AppState.config.USE_BACKEND) {
                    const user = AppState.users.find(u => u.email === email && u.password === password);
                    if (user) {
                        showNotification('Signed in (offline mode)', 'success');
                        loginUser(user);
                        return;
                    } else {
                        throw new Error('Invalid credentials');
                    }
                }

                const res = await fetchWithTimeout(AppState.config.apiUrl + '/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                }, 15000);
                const data = await res.json().catch(() => ({}));
                
                // Enhanced error logging for debugging
                console.log('🔍 Login API Response:', {
                    status: res.status,
                    statusText: res.statusText,
                    ok: res.ok,
                    data: data,
                    requestData: { email, password: password ? '***' : 'empty' }
                });
                
                if (!res.ok || !data.token) {
                    // Fallback: allow local Owner login for master account while backend denies
                    const fallbackUser = await tryLocalMasterLogin(email, password);
                    if (fallbackUser) {
                        showNotification('Signed in (offline mode)', 'success');
                        loginUser(fallbackUser);
                        return;
                    }
                    showNotification(data.error || 'Invalid email or password', 'error');
                    if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Sign In'; }
                    return;
                }

                // Store tokens and enable backend mode globally
                AppState.backendAuth = { token: data.token, refreshToken: data.refreshToken, email };
                AppState.config.backendEnabled = true;

                // Normalize user shape for UI compatibility
                const user = data.user || {};
                if (user.Role?.name && !user.role) user.role = user.Role.name;
                // Master account override (treat as Owner)
                try {
                    const masterList = (AppState.config.masterAccounts || []).map(e => String(e).toLowerCase());
                    if (masterList.includes(String(email).toLowerCase())) {
                        user.role = 'Owner';
                        user.Role = user.Role || {};
                        user.Role.name = 'Owner';
                        user.Role.displayName = user.Role.displayName || 'Owner';
                        user.Role.id = user.Role.id || 'owner';
                    }
                } catch (_) {}
                AppState.user = user;

                // If backend mandates a password change, force it now
                if (data.mustChangePassword || user.mustChangePassword) {
                    await showBackendForceChangeModal();
                } else {
                    showNotification('Login successful', 'success');
                }

        // Local master account fallback when backend returns 401
        async function tryLocalMasterLogin(email, password) {
            try {
                const masters = (AppState.config.masterAccounts || []).map(e => String(e).toLowerCase());
                const pass = String(password || '');
                if (masters.includes(String(email || '').toLowerCase()) && pass === 'TempAdmin!2345') {
                    // Construct a minimal Owner user locally
                    const name = 'Platform Owner';
                    const avatar = (name.split(' ').map(n => n[0]).join('').slice(0,2) || 'PO').toUpperCase();
                    return {
                        id: 'owner_local',
                        name,
                        email,
                        role: 'Owner',
                        Role: { id: 'owner', name: 'Owner', displayName: 'Owner (Master)' },
                        avatar
                    };
                }

                // Also allow demo users as fallback
                const demo = (AppState.users || []).find(u => u.email?.toLowerCase() === String(email).toLowerCase() && u.password === password);
                if (demo) {
                    return { ...demo, Role: { id: (demo.role||'').toLowerCase(), name: demo.role, displayName: demo.role } };
                }
            } catch (_) {}
            return null;
        }


                loginUser(AppState.user);
            } catch (error) {
                console.error('🚨 Error in handleLogin:', error);
                try {
                    const email = (document.getElementById('loginEmail') || {}).value || '';
                    const password = (document.getElementById('loginPassword') || {}).value || '';
                    const fallbackUser = await tryLocalMasterLogin(email, password);
                    if (fallbackUser) {
                        showNotification('Signed in (offline mode)', 'success');
                        loginUser(fallbackUser);
                        return;
                    }
                } catch (_) {}
                const msg = (error && (error.name === 'AbortError')) ? 'Login request timed out. Please check backend connectivity.' : 'Login error. Please try again.';
                showNotification(msg, 'error');
                const submitBtn = (event && event.target) ? event.target.querySelector('.login-btn') : null;
                if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Sign In'; }
            }
        }



        function loginUser(user) {
            try {
                // Starting login process for: user.name

                AppState.isLoggedIn = true;
                AppState.user = user;
                AppState.currentView = 'dashboard';

                // Record login in audit log
                try {
                    AppState.auditLog = AppState.auditLog || [];
                    AppState.auditLog.unshift({
                        id: AppState.auditLog.length + 1,
                        timestamp: new Date().toISOString(),
                        user: user.name || user.email || 'Unknown User',
                        action: 'login',
                        resource: 'System',
                        details: 'User logged in successfully',
                        ipAddress: '127.0.0.1'
                    });
                } catch (_) {}


                // Hide login screen and show app
                const loginScreen = document.getElementById('loginScreen');
                const mainApp = document.getElementById('mainApp');

                if (loginScreen) {
                    loginScreen.style.display = 'none';
                    // Login screen hidden
                } else {
                    console.error('❌ Login screen element not found');
                }

                if (mainApp) {
                    mainApp.style.display = 'flex';
                    // Main app shown
                    // Ensure the view snaps to the app header after login
                    setTimeout(() => window.scrollTo({ top: 0, behavior: 'smooth' }), 0);
                } else {
                    console.error('❌ Main app element not found');
                }

                document.body.classList.add('logged-in');

                // Set up user info
                const userAvatar = document.getElementById('userAvatar');
                if (userAvatar) {
                    userAvatar.textContent = user.avatar;
                    // User avatar set
                } else {
                    console.error('❌ User avatar element not found');
                }

                // Initialize the application
                try {
                    showView('dashboard');
                    // Dashboard view loaded
                } catch (error) {
                    console.error('❌ Error loading dashboard view:', error);
                }

                try {
                    setupRoleBasedUI();
                    // Role-based UI set up
                } catch (error) {
                    console.error('❌ Error setting up role-based UI:', error);
                }

                try {
                    if (isBackendMode()) {
                        loadProjectsFromBackend().then(async () => {
                            if (!Array.isArray(AppState.projects) || AppState.projects.length === 0) {
                                await initializeSampleData();
                                await loadProjectsFromBackend();
                            }
                        }).catch(err => console.error('❌ Error loading projects from backend:', err));
                        // Projects load triggered
                    } else {
                        AppState.projects = generateLocalSampleProjects().map(normalizeProject);
                        try { renderProjectsGrid(); } catch (_) {}
                        // Offline sample projects loaded
                        showNotification('Offline mode: using sample projects', 'warning');
                    }
                } catch (error) {
                    console.error('❌ Error scheduling backend project load:', error);
                }

                // Budget data is now loaded from database via loadFinancialSettings()
                try {
                    // Calculate initial budget spending for both types
                    calculateBudgetSpending();
                } catch (error) {
                    console.error('❌ Error loading budget data:', error);
                }

                showNotification(`Welcome back, ${user.name}!`, 'success');
                // Successfully logged in as user

            } catch (error) {
                console.error('🚨 Critical error during login process:', error);
                showNotification('Login failed due to system error. Please try again.', 'error');

                // Reset login state
                AppState.isLoggedIn = false;
                AppState.user = null;
                AppState.currentView = 'login';

        async function updateBackendInfo() {
            try {
                console.log('updateBackendInfo called');
                const el = document.getElementById('backendDbInfo');
                if (!el) {
                    console.log('backendDbInfo element not found');
                    return;
                }
                
                // Skip backend check if not enabled
                if (!AppState.config.USE_BACKEND) {
                    el.textContent = 'Offline Mode (No Backend)';
                    console.log('Backend disabled, showing offline mode');
                    return;
                }
                
                console.log('Starting backend health check...');
                el.textContent = 'Checking backend...';
                const url = AppState.config.apiUrl + '/health';
                console.log('Fetching:', url);
                const res = await fetch(url, { 
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                console.log('Response status:', res.status);
                const data = await res.json().catch(()=>({}));
                console.log('Response data:', data);
                if (res.ok && data?.db?.dialect) {
                    const host = data.db.host || 'localhost';
                    const port = data.db.port ? (':' + data.db.port) : '';
                    const message = `Backend: ${String(data.db.dialect).toUpperCase()} @ ${host}${port}`;
                    el.textContent = message;
                    console.log('Backend status updated to:', message);
                } else if (res.ok) {
                    el.textContent = 'Backend reachable';
                    console.log('Backend reachable but no DB info');
                } else {
                    const message = 'Backend not reachable (HTTP ' + res.status + ')';
                    el.textContent = message;
                    console.log('Backend not reachable:', message);
                }
            } catch (error) {
                console.log('updateBackendInfo error:', error);
                const el = document.getElementById('backendDbInfo');
                if (el) {
                    if (error.name === 'AbortError') {
                        el.textContent = 'Backend timeout';
                        console.log('Backend timeout');
                    } else {
                        el.textContent = 'Backend not reachable';
                        console.log('Backend not reachable due to error:', error.message);
                    }
                }
            }
        }

            }
        }

        function logout() {
            AppState.isLoggedIn = false;
            AppState.user = null;
            AppState.currentView = 'login';

            // Show login screen and hide app
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.body.classList.remove('logged-in');

            showNotification('Logged out successfully', 'success');
        }


        // Offline sample projects when backend is unavailable
        function generateLocalSampleProjects() {
            const now = new Date();
            const fmt = d => d.toISOString().slice(0,10);
            return [
                {
                    id: 'p_demo_1',
                    name: 'Executive Conference Room AV Upgrade',
                    requestorInfo: 'Sarah Johnson, Facilities Manager, (555) 123-4567',
                    siteLocation: '1200 Corporate Blvd, Suite 500, Dallas, TX',
                    businessLine: 'corporate',
                    description: 'Complete AV upgrade for executive conference room including 4K display and VC',
                    type: 'upgrade',
                    priority: 'high',
                    status: 'active',
                    startDate: fmt(new Date(now.getFullYear(), now.getMonth(), now.getDate()-20)),
                    endDate: fmt(new Date(now.getFullYear(), now.getMonth(), now.getDate()+10)),
                    estimatedBudget: 35000,
                    actualBudget: 22750,
                    tasks: [
                        { id: 't1', name: 'Site Survey & Design', status: 'completed', ragStatus: 'green', phase: 'phase_1' },
                        { id: 't2', name: 'Equipment Procurement', status: 'in-progress', ragStatus: 'yellow', phase: 'phase_2' },
                        { id: 't3', name: 'Installation', status: 'not-started', ragStatus: 'green', phase: 'phase_3' }
                    ]
                },
                {
                    id: 'p_demo_2',
                    name: 'Custom Board Room Integration',
                    requestorInfo: 'Amanda Foster, IT Director, Sterling Financial',
                    siteLocation: 'Sterling Financial Tower, 42nd Floor, New York, NY',
                    businessLine: 'corporate',
                    description: 'Custom integration with lighting and climate control',
                    type: 'custom',
                    priority: 'medium',
                    status: 'active',
                    startDate: fmt(new Date(now.getFullYear(), now.getMonth(), now.getDate()-5)),
                    endDate: fmt(new Date(now.getFullYear(), now.getMonth(), now.getDate()+25)),
                    estimatedBudget: 75000,
                    actualBudget: 30000,
                    tasks: [
                        { id: 't1', name: 'Requirements Analysis', status: 'completed', ragStatus: 'green', phase: 'phase_1' },
                        { id: 't2', name: 'Hardware Installation', status: 'in-progress', ragStatus: 'yellow', phase: 'phase_3' }
                    ]
                }
            ];
        }

        // ==================== INITIALIZATION ====================
        // Check if libraries are loaded
        function checkLibraries() {
            const libs = {
                'Chart.js': typeof Chart !== 'undefined',
                'jsPDF': typeof window.jspdf !== 'undefined',
                'XLSX': typeof XLSX !== 'undefined',
                'Sortable': typeof Sortable !== 'undefined'
            };
            
            const missing = Object.entries(libs)
                .filter(([name, loaded]) => !loaded)
                .map(([name]) => name);
            
            if (missing.length > 0) {
                console.warn('Missing libraries:', missing.join(', '));
                console.warn('Some features may not work properly. Application will run in offline mode.');
            }
            
            return libs;
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Check library availability
            const libraries = checkLibraries();

            // Strip sensitive query parameters from URL, but keep values to prefill form
            try {
                const usp = new URLSearchParams(window.location.search);
                const qe = usp.get('email');
                const qp = usp.get('password');
                if (qe || qp) {
                    history.replaceState({}, document.title, window.location.pathname);
                    if (qe) { const el = document.getElementById('loginEmail'); if (el) el.value = qe; }
                    if (qp) { const el = document.getElementById('loginPassword'); if (el) el.value = qp; }
                }
            } catch(_) {}

            // Initialize administration data
            initializeAdminData();



            // After init AppState.users

            // Check if already logged in
            if (AppState.isLoggedIn && AppState.user) {



                loginUser(AppState.user);
            } else {
                // Show login screen
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
                // Update backend info note only if backend is enabled
                if (AppState.config.USE_BACKEND && typeof updateBackendInfo === 'function') {
                    setTimeout(() => updateBackendInfo().catch(()=>{}), 100);
                }
            }

            // AV Project Management 8.0 initialized
        });

        // Bind global functions for inline onclick handlers
        try { window.submitTaskNote = submitTaskNote; } catch(_) {}
        try { window.viewTask = viewTask; } catch(_) {}
        try { window.editTaskNote = editTaskNote; } catch(_) {}
        try { window.showAllTaskNotes = showAllTaskNotes; } catch(_) {}




        async function initializeSampleData() {
            // Seed sample data into the BACKEND only if there are no projects yet
            try {
                if (!isBackendMode()) { console.warn('initializeSampleData: backend not connected'); return; }
                const existing = await apiFetch('/projects?limit=1');
                const projects = existing.projects || [];
                if (projects.length > 0) { return; } // Sample seed skipped if backend already has projects

                const sampleProjects = [
                    {
                        id: `proj-${Date.now()}-sample1`,
                        name: 'Executive Conference Room AV Upgrade',
                        requestorInfo: 'Sarah Johnson, Facilities Manager, (555) 123-4567',
                        siteLocation: '1200 Corporate Blvd, Suite 500, Dallas, TX',
                        businessLine: 'Barrington Bank & Trust Company, N.A.',
                        description: 'Complete AV upgrade for executive conference room including 4K display, wireless presentation, and integrated video conferencing',
                        type: 'upgrade',
                        priority: 'high',
                        status: 'active',
                        requestDate: '2024-01-10',
                        startDate: '2024-01-15',
                        dueDate: '2024-02-15',
                        endDate: '2024-02-15',
                        estimatedBudget: 35000,
                        actualBudget: 22750,
                        tasks: [
                            { id: `task-${Date.now()}-s1t1`, name: 'Site Survey & Design', status: 'completed' },
                            { id: `task-${Date.now()}-s1t2`, name: 'Equipment Procurement', status: 'completed' },
                            { id: `task-${Date.now()}-s1t3`, name: 'Display & Control Installation', status: 'in-progress' },
                            { id: `task-${Date.now()}-s1t4`, name: 'System Programming & Testing', status: 'not-started' }
                        ]
                    },
                    {
                        id: `proj-${Date.now()}-sample2`,
                        name: 'New Hospital Patient Room Technology',
                        requestorInfo: 'Dr. Michael Chen, CTO, Regional Medical Center',
                        siteLocation: 'Regional Medical Center, 500 Health Plaza, Austin, TX',
                        businessLine: 'Beverly Bank & Trust Company, N.A.',
                        description: 'Install patient room technology including nurse call integration, bedside entertainment, and digital signage for new wing',
                        type: 'new-build',
                        priority: 'critical',
                        status: 'active',
                        requestDate: '2024-01-15',
                        startDate: '2024-01-20',
                        dueDate: '2024-03-30',
                        endDate: '2024-03-30',
                        estimatedBudget: 125000,
                        actualBudget: 31250,
                        tasks: [
                            { id: `task-${Date.now()}-s2t1`, name: 'Infrastructure Planning', status: 'completed' },
                            { id: `task-${Date.now()}-s2t2`, name: 'Equipment Specification', status: 'in-progress' },
                            { id: `task-${Date.now()}-s2t3`, name: 'Installation Coordination', status: 'not-started' },
                            { id: `task-${Date.now()}-s2t4`, name: 'Staff Training Program', status: 'not-started' }
                        ]
                    },
                    {
                        id: `proj-${Date.now()}-sample3`,
                        name: 'University Lecture Hall Audio System',
                        requestorInfo: 'Prof. Lisa Williams, Dean of Engineering, State University',
                        siteLocation: 'Engineering Building, Room 201, State University Campus',
                        businessLine: 'Crystal Lake Bank & Trust Company, N.A.',
                        description: 'Install modern audio system for 300-seat lecture hall with wireless microphones and hearing loop system',
                        type: 'upgrade',
                        priority: 'medium',
                        status: 'completed',
                        requestDate: '2023-11-25',
                        startDate: '2023-12-01',
                        dueDate: '2023-12-20',
                        endDate: '2023-12-20',
                        estimatedBudget: 45000,
                        actualBudget: 43200,
                        tasks: [
                            { id: `task-${Date.now()}-s3t1`, name: 'Acoustic Analysis', status: 'completed' },
                            { id: `task-${Date.now()}-s3t2`, name: 'System Design', status: 'completed' },
                            { id: `task-${Date.now()}-s3t3`, name: 'Equipment Installation', status: 'completed' },
                            { id: `task-${Date.now()}-s3t4`, name: 'System Commissioning', status: 'completed' }
                        ]
                    },
                    {
                        name: 'Hotel Security Camera Repair',
                        requestorInfo: 'James Rodriguez, Security Director, Grand Plaza Hotel',
                        siteLocation: 'Grand Plaza Hotel, 789 Downtown Ave, Houston, TX',
                        businessLine: 'Hinsdale Bank & Trust Company, N.A.',
                        description: 'Emergency repair of security camera system damaged during severe weather - 12 cameras offline',
                        type: 'breakfix',
                        priority: 'critical',
                        status: 'active',
                        startDate: '2024-02-01',
                        endDate: '2024-02-05',
                        estimatedBudget: 8500,
                        actualBudget: 6800,
                        tasks: [
                            { name: 'Damage Assessment', status: 'completed' },
                            { name: 'Equipment Replacement', status: 'in-progress' },
                            { name: 'System Reconfiguration', status: 'not-started' }
                        ]
                    },
                    {
                        name: 'Custom Board Room Integration',
                        requestorInfo: 'Amanda Foster, IT Director, Sterling Financial',
                        siteLocation: 'Sterling Financial Tower, 42nd Floor, New York, NY',
                        businessLine: 'Lake Forest Bank & Trust Company, N.A.',
                        description: 'Custom integration solution for board room with automated lighting, climate control, and presentation systems',
                        type: 'custom',
                        priority: 'high',
                        status: 'active',
                        startDate: '2024-01-25',
                        endDate: '2024-03-15',
                        estimatedBudget: 75000,
                        actualBudget: 30000,
                        tasks: [
                            { name: 'Requirements Analysis', status: 'completed' },
                            { name: 'Custom Programming', status: 'in-progress' },
                            { name: 'Hardware Installation', status: 'not-started' },
                            { name: 'User Training', status: 'not-started' }
                        ]
                    }
                ];

                for (const p of sampleProjects) {
                    const payload = toBackendProjectPayload({ ...p, tasks: (p.tasks || []).map(t => ({ name: t.name, status: t.status || 'not-started' })) });
                    try {
                        await apiFetch('/projects', { method: 'POST', body: JSON.stringify(payload) });
                    } catch (e) {
                        console.warn('Project create with embedded tasks failed, retrying with separate task creation:', e);
                        // Create without tasks then add tasks individually
                        const base = toBackendProjectPayload({ ...p, tasks: [] });
                        const created = await apiFetch('/projects', { method: 'POST', body: JSON.stringify(base) });
                        const projectId = created?.project?.id || created?.id;
                        if (projectId && Array.isArray(p.tasks)) {
                            for (const t of p.tasks) {
                                try {
                                    await apiFetch(`/projects/${projectId}/tasks`, { method: 'POST', body: JSON.stringify({ name: t.name, status: t.status || 'not-started' }) });
                                } catch (te) { console.error('Failed to create sample task', t.name, te); }
                            }
                        }
                    }
                }

                // Sample project data seeded to backend
            } catch (e) {
                console.error('❌ Error seeding sample data to backend:', e);
            }
        }

        function setupRoleBasedUI() {
            const userRole = ((AppState.user?.Role?.name || AppState.user?.role || '') + '').toLowerCase().replace('-', '_') || 'auditor';

            // Hide Executive tab for non-admin/project_manager roles
            const executiveTab = document.getElementById('executiveTab');
            if (executiveTab && !['admin', 'owner', 'project_manager', 'superadmin', 'root'].includes(userRole)) {
                executiveTab.style.display = 'none';
            }

            // Hide Administration for non-admin
            const navAdminBtn = document.getElementById('navAdmin');
            const adminView = document.getElementById('adminView');
            const privileged = ['admin','owner','superadmin','root'].includes(userRole);
            if (navAdminBtn) navAdminBtn.style.display = privileged ? 'inline-flex' : 'none';
            if (adminView && !privileged) adminView.classList.remove('active');


        }

        function isAdmin() {
            const roleName = (AppState.user?.Role?.name || AppState.user?.role || '').toLowerCase();
            return ['admin','owner','superadmin','root'].includes(roleName);
        }


        async function loadProjectsFromBackend() {
            try {
                const token = AppState.backendAuth?.token;
                if (!token) throw new Error('Not authenticated');
                const res = await fetch(AppState.config.apiUrl + '/projects?limit=1000', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Failed to load projects');
                
                const projects = Array.isArray(data) ? data : (data.projects || []);
                
                // Load tasks for each project
                const projectsWithTasks = await Promise.all(projects.map(async (project) => {
                    try {
                        const tasksRes = await fetch(AppState.config.apiUrl + `/projects/${project.id}/tasks`, {
                            headers: { 'Authorization': 'Bearer ' + token }
                        });
                        if (tasksRes.ok) {
                            const tasks = await tasksRes.json();
                            return { ...project, tasks: tasks || [] };
                        } else {
                            return { ...project, tasks: [] };
                        }
                    } catch (e) {
                        // If task loading fails, just return project without tasks
                        return { ...project, tasks: [] };
                    }
                }));
                
                AppState.projects = projectsWithTasks.map(normalizeProject);

                if (typeof renderProjectsView === 'function') {
                    try { renderProjectsView(); } catch (_) {}
                }
                showNotification(`Loaded ${projectsWithTasks.length} projects from backend`, 'success');
            } catch (e) {
                console.error('Backend load error:', e);
                showNotification('Failed to load projects from backend', 'error');
            }
        }

        // ===== Backend helpers =====
        function isBackendMode() {
            // Check if backend is enabled AND we have auth token
            return AppState.config.USE_BACKEND && !!AppState.backendAuth?.token;
        }

        function mapProjectType(t) {
            const tt = (t || '').toLowerCase();
            if (tt === 'new-build' || tt === 'new build') return 'new-build';
            if (tt === 'renovation' || tt === 'upgrade') return 'renovation';
            if (tt === 'maintenance' || tt === 'breakfix' || tt === 'break-fix' || tt === 'repair') return 'maintenance';
            return 'other';
        }


        async function showBackendForceChangeModal() {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal">
                      <div class="modal-header">
                        <h2>Set a New Password</h2>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">\u00d7</button>
                      </div>
                      <div class="modal-body">
                        <p>For security, you must set a new password before continuing.</p>
                        <form id="forcePwForm">
                          <div class="form-group">
                            <label>Current Password</label>
                            <input type="password" name="currentPassword" class="form-control" required autocomplete="current-password">
                          </div>
                          <div class="form-group">
                            <label>New Password</label>
                            <input type="password" name="newPassword" class="form-control" required minlength="6" autocomplete="new-password">
                          </div>
                          <div class="form-actions" style="margin-top:1rem;">
                            <button type="submit" class="btn btn-primary">Update Password</button>
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                          </div>
                        </form>
                      </div>
                    </div>`;

                document.body.appendChild(modal);

                const form = modal.querySelector('#forcePwForm');
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const fd = new FormData(form);
                    const currentPassword = fd.get('currentPassword');
                    const newPassword = fd.get('newPassword');
                    try {
                        await apiFetch('/auth/password', {
                            method: 'PUT',
                            body: JSON.stringify({ currentPassword, newPassword })
                        });
                        showNotification('Password updated. Thank you!', 'success');
                        modal.remove();
                        resolve();
                    } catch (err) {
                        console.error('Force password change failed:', err);
                        showNotification(err.message || 'Failed to update password', 'error');
                    }
                });
            });
        }

        function mapProjectStatus(s) {
            const ss = (s || '').toLowerCase();
            if (['draft','active','on-hold','completed','cancelled'].includes(ss)) return ss;
            if (ss === 'planning' || ss === 'not-started') return 'draft';
            return 'active';
        }

        function toBackendProjectPayload(p) {
            return {
                id: p.id || `proj-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                name: p.name,
                requestorInfo: p.requestorInfo,
                siteLocation: p.siteLocation,
                businessLine: p.businessLine,
                description: p.description,
                type: p.type,
                priority: p.priority,
                status: p.status,
                requestDate: p.requestDate || new Date().toISOString().slice(0,10),
                startDate: p.startDate || new Date().toISOString().slice(0,10),
                dueDate: p.dueDate || p.endDate || new Date().toISOString().slice(0,10),
                endDate: p.endDate || p.dueDate || new Date().toISOString().slice(0,10),
                estimatedBudget: p.estimatedBudget ?? 0,
                actualBudget: p.actualBudget ?? 0,
                progress: p.progress ?? 0,
                tasks: p.tasks || []
            };
        }

        // Network helper with timeout to avoid hanging UI on unreachable backends
        async function fetchWithTimeout(url, options = {}, timeoutMs = 15000) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeoutMs);
            try {
                const res = await fetch(url, { ...options, signal: controller.signal });
                return res;
            } finally {
                clearTimeout(id);
            }
        }

        async function apiFetch(path, options = {}) {
            const url = AppState.config.apiUrl + path;
            const headers = Object.assign({ 'Content-Type': 'application/json' }, options.headers || {});
            if (AppState.backendAuth?.token) headers['Authorization'] = 'Bearer ' + AppState.backendAuth.token;
            let res = await fetchWithTimeout(url, { ...options, headers }, options.timeoutMs || 15000);
            if (res.status === 401 && AppState.backendAuth?.refreshToken) {
                // try refresh once
                const rr = await fetchWithTimeout(AppState.config.apiUrl + '/auth/refresh', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refreshToken: AppState.backendAuth.refreshToken })
                }, options.timeoutMs || 15000);
                const rdata = await rr.json().catch(() => ({}));
                if (rr.ok && rdata.token) {
                    AppState.backendAuth.token = rdata.token;
                    if (rdata.refreshToken) AppState.backendAuth.refreshToken = rdata.refreshToken;
                    headers['Authorization'] = 'Bearer ' + AppState.backendAuth.token;
                    res = await fetchWithTimeout(url, { ...options, headers }, options.timeoutMs || 15000);
                }
            }
            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data?.error || res.statusText || 'Request failed');
            return data;


        }

        // ==================== GLOBAL UTILITY FUNCTIONS ====================
        
        // Global escapeHtml function for security
        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== PRODUCTIVITY MONITORING SYSTEM ====================

        class ProductivityMonitor {
            constructor() {
                this.isActive = false;
                this.currentSession = null;
                this.activityStream = [];
                this.metrics = {
                    dailyWorkTime: 0,
                    focusRatio: 0,
                    taskVelocity: 0,
                    interactionCount: 0,
                    idleTime: 0,
                    sessionStart: null,
                    sessionEnd: null,
                    activeTaskId: null,
                    activeProjectId: null
                };
                this.lastActivity = Date.now();
                this.isIdle = false;
                this.focusStartTime = null;
                this.totalFocusTime = 0;
                this.init();
            }

            init() {
                this.loadSavedMetrics();
                this.setupActivityTracking();
                this.setupPeriodicSync();
                console.log('📊 ProductivityMonitor initialized');
            }

            loadSavedMetrics() {
                const saved = JSON.parse(localStorage.getItem('productivityMetrics') || '{}');
                const today = new Date().toDateString();
                if (saved.date === today) {
                    this.metrics = { ...this.metrics, ...saved };
                }
            }

            saveMetrics() {
                const data = {
                    ...this.metrics,
                    date: new Date().toDateString(),
                    lastUpdated: Date.now()
                };
                localStorage.setItem('productivityMetrics', JSON.stringify(data));
            }

            setupActivityTracking() {
                // Mouse movement and clicks
                ['mousedown', 'mousemove', 'keydown', 'scroll'].forEach(event => {
                    document.addEventListener(event, () => this.recordActivity(event), { passive: true });
                });

                // Window focus/blur for idle detection
                window.addEventListener('focus', () => this.handleFocusChange(true));
                window.addEventListener('blur', () => this.handleFocusChange(false));
                
                // Page visibility for accurate focus tracking
                document.addEventListener('visibilitychange', () => {
                    this.handleFocusChange(!document.hidden);
                });
            }

            recordActivity(eventType) {
                const now = Date.now();
                this.lastActivity = now;
                
                if (this.isIdle) {
                    this.isIdle = false;
                    this.metrics.idleTime += now - this.idleStartTime;
                }
                
                this.metrics.interactionCount++;
                
                // Stream activity data
                if (this.activityStream.length > 100) {
                    this.activityStream = this.activityStream.slice(-50);
                }
                
                this.activityStream.push({
                    timestamp: now,
                    type: eventType,
                    taskId: this.metrics.activeTaskId,
                    projectId: this.metrics.activeProjectId
                });
            }

            handleFocusChange(hasFocus) {
                const now = Date.now();
                
                if (hasFocus) {
                    if (this.isIdle) {
                        this.metrics.idleTime += now - this.idleStartTime;
                        this.isIdle = false;
                    }
                    this.focusStartTime = now;
                } else {
                    if (this.focusStartTime) {
                        this.totalFocusTime += now - this.focusStartTime;
                        this.focusStartTime = null;
                    }
                    if (!this.isIdle) {
                        this.isIdle = true;
                        this.idleStartTime = now;
                    }
                }
                
                this.calculateFocusRatio();
            }

            calculateFocusRatio() {
                const sessionDuration = Date.now() - (this.metrics.sessionStart || Date.now());
                if (sessionDuration > 0) {
                    this.metrics.focusRatio = Math.round((this.totalFocusTime / sessionDuration) * 100);
                }
            }

            startWorkSession(taskId = null, projectId = null) {
                if (!this.isActive) {
                    this.isActive = true;
                    this.metrics.sessionStart = Date.now();
                    this.metrics.activeTaskId = taskId;
                    this.metrics.activeProjectId = projectId;
                    this.focusStartTime = Date.now();
                    
                    // Show floating timer
                    this.showFloatingTimer();
                    
                    this.recordActivity('session_start');
                    this.saveMetrics();
                    
                    console.log('🎯 Work session started', { taskId, projectId });
                    return true;
                }
                return false;
            }

            stopWorkSession() {
                if (this.isActive) {
                    this.isActive = false;
                    this.metrics.sessionEnd = Date.now();
                    const sessionDuration = this.metrics.sessionEnd - this.metrics.sessionStart;
                    this.metrics.dailyWorkTime += sessionDuration;
                    
                    if (this.focusStartTime) {
                        this.totalFocusTime += Date.now() - this.focusStartTime;
                        this.focusStartTime = null;
                    }
                    
                    this.calculateFocusRatio();
                    this.hideFloatingTimer();
                    
                    this.recordActivity('session_end');
                    this.saveMetrics();
                    this.syncToBackend();
                    
                    const duration = Math.round(sessionDuration / 1000 / 60);
                    showNotification(`Work session completed: ${duration} minutes`, 'success');
                    
                    console.log('⏹️ Work session ended', { duration: `${duration}min` });
                    return sessionDuration;
                }
                return 0;
            }

            showFloatingTimer() {
                if (document.getElementById('floating-timer')) return;
                
                const timer = document.createElement('div');
                timer.id = 'floating-timer';
                timer.style.cssText = `
                    position: fixed;
                    top: 90px;
                    right: 20px;
                    background: var(--primary-500);
                    color: white;
                    padding: 8px 16px;
                    border-radius: 20px;
                    font-size: 12px;
                    font-weight: 500;
                    z-index: 1001;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    cursor: pointer;
                    user-select: none;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                `;
                
                timer.innerHTML = `<span style="color: #4ade80;">●</span> <span id="timer-text">00:00</span>`;
                timer.addEventListener('click', () => this.stopWorkSession());
                timer.title = 'Click to stop work session';
                
                document.body.appendChild(timer);
                
                // Update timer every minute
                this.timerInterval = setInterval(() => {
                    if (this.isActive && this.metrics.sessionStart) {
                        const elapsed = Date.now() - this.metrics.sessionStart;
                        const minutes = Math.floor(elapsed / 1000 / 60);
                        const seconds = Math.floor((elapsed / 1000) % 60);
                        document.getElementById('timer-text').textContent = 
                            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    }
                }, 1000);
            }

            hideFloatingTimer() {
                const timer = document.getElementById('floating-timer');
                if (timer) timer.remove();
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
            }

            setupPeriodicSync() {
                // Sync every 5 minutes
                setInterval(() => {
                    if (this.isActive) {
                        this.saveMetrics();
                        this.syncToBackend();
                    }
                }, 5 * 60 * 1000);
            }

            async syncToBackend() {
                if (!AppState.useBackend) return;
                
                try {
                    const data = {
                        ...this.metrics,
                        activityStream: this.activityStream.slice(-20), // Send last 20 activities
                        timestamp: Date.now()
                    };
                    
                    await apiCall('/productivity/activity', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                } catch (error) {
                    console.warn('Failed to sync productivity data:', error.message);
                }
            }

            getProductivityScore() {
                const focusScore = Math.min(this.metrics.focusRatio, 100);
                const activityScore = Math.min((this.metrics.interactionCount / 100) * 100, 100);
                const consistencyScore = this.metrics.dailyWorkTime > 0 ? 100 : 0;
                
                return Math.round((focusScore + activityScore + consistencyScore) / 3);
            }

            getDailyMetrics() {
                return {
                    workTime: Math.round(this.metrics.dailyWorkTime / 1000 / 60), // minutes
                    focusRatio: this.metrics.focusRatio,
                    productivity: this.getProductivityScore(),
                    interactions: this.metrics.interactionCount,
                    activeTime: Math.round((this.metrics.dailyWorkTime - this.metrics.idleTime) / 1000 / 60)
                };
            }
        }

        // ==================== EARLY WARNING SYSTEM ====================

        class EarlyWarningSystem {
            constructor() {
                this.alerts = [];
                this.riskThresholds = {
                    timelineRisk: 0.8, // 80% of deadline passed
                    budgetRisk: 0.9, // 90% budget used
                    productivityRisk: 30, // Below 30% productivity
                    burnoutRisk: 60 // Over 60 hours per week
                };
                this.assessmentInterval = 30 * 60 * 1000; // 30 minutes
                this.init();
            }

            init() {
                this.startContinuousMonitoring();
                console.log('⚠️ EarlyWarningSystem initialized');
            }

            startContinuousMonitoring() {
                // Initial assessment
                this.performRiskAssessment();
                
                // Continuous monitoring
                setInterval(() => {
                    this.performRiskAssessment();
                }, this.assessmentInterval);
            }

            async performRiskAssessment() {
                try {
                    const projects = AppState.projects || [];
                    const risks = [];
                    
                    for (const project of projects) {
                        const projectRisks = this.assessProjectRisks(project);
                        if (projectRisks.length > 0) {
                            risks.push({ project, risks: projectRisks });
                        }
                    }
                    
                    // Team productivity assessment
                    const productivityRisks = await this.assessProductivityRisks();
                    if (productivityRisks.length > 0) {
                        risks.push({ team: true, risks: productivityRisks });
                    }
                    
                    this.processRiskAlerts(risks);
                    
                } catch (error) {
                    console.warn('Risk assessment failed:', error.message);
                }
            }

            assessProjectRisks(project) {
                const risks = [];
                const now = new Date();
                
                // Timeline risk
                if (project.endDate) {
                    const endDate = new Date(project.endDate);
                    const startDate = project.startDate ? new Date(project.startDate) : new Date(project.createdAt);
                    const totalDuration = endDate.getTime() - startDate.getTime();
                    const elapsed = now.getTime() - startDate.getTime();
                    const progress = project.progress || 0;
                    
                    if (elapsed / totalDuration > this.riskThresholds.timelineRisk && progress < 70) {
                        risks.push({
                            type: 'timeline',
                            severity: 'high',
                            message: `Project "${project.name}" is ${Math.round((elapsed/totalDuration)*100)}% through timeline but only ${progress}% complete`,
                            recommendation: 'Consider reallocating resources or adjusting scope'
                        });
                    }
                }
                
                // Budget risk (if budget tracking exists)
                if (project.budget && project.spent) {
                    const budgetRatio = project.spent / project.budget;
                    if (budgetRatio > this.riskThresholds.budgetRisk && (project.progress || 0) < budgetRatio * 100) {
                        risks.push({
                            type: 'budget',
                            severity: 'high',
                            message: `Project "${project.name}" has used ${Math.round(budgetRatio*100)}% of budget with ${project.progress || 0}% completion`,
                            recommendation: 'Review spending and consider budget adjustment'
                        });
                    }
                }
                
                // Task completion velocity
                if (project.tasks && project.tasks.length > 0) {
                    const completedTasks = project.tasks.filter(t => t.status === 'completed').length;
                    const totalTasks = project.tasks.length;
                    const taskCompletion = (completedTasks / totalTasks) * 100;
                    
                    if (taskCompletion < 20 && project.progress > 50) {
                        risks.push({
                            type: 'task_velocity',
                            severity: 'medium',
                            message: `Project "${project.name}" shows ${project.progress}% progress but only ${Math.round(taskCompletion)}% of tasks completed`,
                            recommendation: 'Review task breakdown and update project status'
                        });
                    }
                }
                
                return risks;
            }

            async assessProductivityRisks() {
                const risks = [];
                
                if (window.productivityMonitor) {
                    const score = productivityMonitor.getProductivityScore();
                    
                    if (score < this.riskThresholds.productivityRisk) {
                        risks.push({
                            type: 'productivity',
                            severity: 'medium',
                            message: `Team productivity score is ${score}%, below threshold of ${this.riskThresholds.productivityRisk}%`,
                            recommendation: 'Review workload distribution and identify productivity blockers'
                        });
                    }
                    
                    const metrics = productivityMonitor.getDailyMetrics();
                    const weeklyHours = metrics.workTime * 7; // Rough estimate
                    
                    if (weeklyHours > this.riskThresholds.burnoutRisk * 60) {
                        risks.push({
                            type: 'burnout',
                            severity: 'high',
                            message: `Team showing signs of overwork with ${Math.round(weeklyHours/60)} hours per week average`,
                            recommendation: 'Consider workload redistribution and mandatory rest periods'
                        });
                    }
                }
                
                return risks;
            }

            processRiskAlerts(riskData) {
                for (const item of riskData) {
                    for (const risk of item.risks) {
                        const alertId = this.generateAlertId(risk, item.project?.id || 'team');
                        
                        if (!this.alerts.find(a => a.id === alertId)) {
                            const alert = {
                                id: alertId,
                                timestamp: Date.now(),
                                projectId: item.project?.id,
                                projectName: item.project?.name,
                                type: risk.type,
                                severity: risk.severity,
                                message: risk.message,
                                recommendation: risk.recommendation,
                                dismissed: false
                            };
                            
                            this.alerts.push(alert);
                            this.showRiskAlert(alert);
                            this.saveAlerts();
                        }
                    }
                }
            }

            generateAlertId(risk, projectId) {
                return `${risk.type}_${projectId}_${new Date().toDateString()}`;
            }

            showRiskAlert(alert) {
                const severityColors = {
                    low: '#f59e0b',
                    medium: '#f97316', 
                    high: '#ef4444'
                };
                
                const severityIcons = {
                    low: '⚠️',
                    medium: '🚨',
                    high: '🔥'
                };
                
                showNotification(
                    `${severityIcons[alert.severity]} ${alert.message}`,
                    alert.severity === 'high' ? 'error' : 'warning',
                    8000 // Show for 8 seconds
                );
                
                // Log for executives
                console.warn(`Risk Alert [${alert.severity.toUpperCase()}]:`, alert);
            }

            saveAlerts() {
                // Keep only last 50 alerts
                this.alerts = this.alerts.slice(-50);
                localStorage.setItem('earlyWarningAlerts', JSON.stringify(this.alerts));
            }

            getActiveAlerts() {
                return this.alerts.filter(a => !a.dismissed);
            }

            dismissAlert(alertId) {
                const alert = this.alerts.find(a => a.id === alertId);
                if (alert) {
                    alert.dismissed = true;
                    this.saveAlerts();
                }
            }
        }

        // ==================== PERSONAL INSIGHTS DASHBOARD ====================

        class PersonalInsights {
            constructor() {
                this.insights = [];
                this.weeklyGoals = {};
                this.personalMetrics = {};
                this.careerProgress = this.loadCareerProgress();
                this.init();
            }

            init() {
                this.loadPersonalData();
                this.generateWeeklyInsights();
                console.log('🧠 PersonalInsights initialized');
            }

            loadPersonalData() {
                const saved = JSON.parse(localStorage.getItem('personalInsights') || '{}');
                this.insights = saved.insights || [];
                this.weeklyGoals = saved.weeklyGoals || {};
                this.personalMetrics = saved.personalMetrics || {};
            }

            loadCareerProgress() {
                return JSON.parse(localStorage.getItem('careerProgress') || JSON.stringify({
                    skills: {
                        'Project Management': 75,
                        'Technical Leadership': 60,
                        'Team Collaboration': 80,
                        'Strategic Planning': 55
                    },
                    achievements: [],
                    weeklyReflection: ''
                }));
            }

            generateWeeklyInsights() {
                if (!window.productivityMonitor) return;
                
                const metrics = productivityMonitor.getDailyMetrics();
                const weekKey = this.getWeekKey();
                
                // Update weekly metrics
                if (!this.personalMetrics[weekKey]) {
                    this.personalMetrics[weekKey] = {
                        totalWorkTime: 0,
                        averageFocus: 0,
                        productivityScore: 0,
                        bestDay: null,
                        achievements: []
                    };
                }
                
                const weekData = this.personalMetrics[weekKey];
                weekData.totalWorkTime += metrics.workTime;
                weekData.averageFocus = Math.round((weekData.averageFocus + metrics.focusRatio) / 2);
                weekData.productivityScore = Math.round((weekData.productivityScore + metrics.productivity) / 2);
                
                // Identify strengths and areas for improvement
                this.analyzePersonalStrengths(metrics);
                this.generatePersonalRecommendations();
                
                this.savePersonalData();
            }

            analyzePersonalStrengths(metrics) {
                const strengths = [];
                
                if (metrics.focusRatio > 80) {
                    strengths.push('Deep Work - Excellent focus during work sessions');
                }
                
                if (metrics.productivity > 85) {
                    strengths.push('Task Velocity - High task completion rate');
                }
                
                if (metrics.workTime > 240) { // 4+ hours
                    strengths.push('Consistency - Strong daily work commitment');
                }
                
                const insight = {
                    id: Date.now(),
                    type: 'strengths',
                    title: 'Personal Strengths Identified',
                    content: strengths,
                    timestamp: Date.now(),
                    week: this.getWeekKey()
                };
                
                this.insights.push(insight);
            }

            generatePersonalRecommendations() {
                const recommendations = [];
                
                if (!window.productivityMonitor) return;
                
                const metrics = productivityMonitor.getDailyMetrics();
                
                if (metrics.focusRatio < 60) {
                    recommendations.push({
                        area: 'Focus Enhancement',
                        suggestion: 'Try the Pomodoro technique: 25-minute focused work sessions with 5-minute breaks',
                        impact: 'Could improve focus ratio by 20-30%'
                    });
                }
                
                if (metrics.productivity < 70) {
                    recommendations.push({
                        area: 'Productivity Optimization',
                        suggestion: 'Identify your peak energy hours and schedule important tasks during these times',
                        impact: 'Potential 15-25% productivity increase'
                    });
                }
                
                if (metrics.workTime < 180) { // Less than 3 hours
                    recommendations.push({
                        area: 'Work-Life Balance',
                        suggestion: 'Consider setting minimum daily work time goals to maintain consistency',
                        impact: 'Better project completion rates'
                    });
                }
                
                if (recommendations.length > 0) {
                    const insight = {
                        id: Date.now() + 1,
                        type: 'recommendations',
                        title: 'AI-Powered Personal Recommendations',
                        content: recommendations,
                        timestamp: Date.now(),
                        week: this.getWeekKey()
                    };
                    
                    this.insights.push(insight);
                }
            }

            setWeeklyGoal(goalType, target) {
                const weekKey = this.getWeekKey();
                if (!this.weeklyGoals[weekKey]) {
                    this.weeklyGoals[weekKey] = {};
                }
                this.weeklyGoals[weekKey][goalType] = {
                    target,
                    progress: 0,
                    achieved: false,
                    setDate: Date.now()
                };
                this.savePersonalData();
            }

            updateSkillProgress(skill, newLevel) {
                this.careerProgress.skills[skill] = newLevel;
                localStorage.setItem('careerProgress', JSON.stringify(this.careerProgress));
                
                // Log achievement
                this.careerProgress.achievements.push({
                    type: 'skill_improvement',
                    skill,
                    level: newLevel,
                    date: Date.now(),
                    description: `Improved ${skill} to ${newLevel}%`
                });
            }

            getWeekKey() {
                const now = new Date();
                const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
                return startOfWeek.toISOString().split('T')[0];
            }

            savePersonalData() {
                const data = {
                    insights: this.insights.slice(-20), // Keep last 20 insights
                    weeklyGoals: this.weeklyGoals,
                    personalMetrics: this.personalMetrics
                };
                localStorage.setItem('personalInsights', JSON.stringify(data));
            }

            getPersonalDashboard() {
                const currentWeek = this.getWeekKey();
                const weeklyData = this.personalMetrics[currentWeek] || {};
                const currentGoals = this.weeklyGoals[currentWeek] || {};
                
                return {
                    weeklyMetrics: weeklyData,
                    goals: currentGoals,
                    recentInsights: this.insights.slice(-5),
                    careerProgress: this.careerProgress,
                    recommendations: this.insights.filter(i => i.type === 'recommendations').slice(-3)
                };
            }
        }

        // ==================== PRODUCTIVITY UI COMPONENTS ====================

        function renderPersonalInsightsView() {
            console.log('🧠 Rendering Personal Insights View');
            console.log('personalInsights exists:', !!window.personalInsights);
            
            if (!window.personalInsights) {
                console.warn('PersonalInsights not initialized yet');
                return `
                    <div style="padding: 3rem; text-align: center; max-width: 600px; margin: 0 auto;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">🧠</div>
                        <h2 style="color: var(--gray-700); margin: 0 0 1rem 0;">Personal Insights Loading...</h2>
                        <p style="color: var(--gray-600); margin-bottom: 2rem;">Productivity monitoring system is initializing. Please wait a moment and refresh the page if needed.</p>
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button class="btn-primary" onclick="initProductivitySystems(); setTimeout(() => loadPersonalInsights(), 1000);" style="padding: 0.5rem 1.5rem;">
                                ⚡ Initialize Now
                            </button>
                            <button class="btn-secondary" onclick="location.reload()" style="padding: 0.5rem 1.5rem;">
                                🔄 Refresh Page
                            </button>
                        </div>
                        <div style="margin-top: 2rem; padding: 1rem; background: var(--gray-50); border-radius: 8px; text-align: left;">
                            <h4 style="margin: 0 0 0.5rem 0; color: var(--gray-800);">💡 What you'll see here:</h4>
                            <ul style="margin: 0; color: var(--gray-600);">
                                <li>Weekly productivity metrics and scoring</li>
                                <li>AI-powered personal recommendations</li>
                                <li>Career development progress tracking</li>
                                <li>Work-life balance insights</li>
                            </ul>
                        </div>
                    </div>
                `;
            }
            
            const dashboard = personalInsights.getPersonalDashboard();
            console.log('Dashboard data:', dashboard);
            
            return `
                <div class="personal-insights-container" style="padding: 2rem; max-width: 1200px; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="color: var(--gray-900); margin: 0;">Personal Productivity Insights</h2>
                        <button class="btn-primary" onclick="setProductivityGoals()" style="padding: 0.5rem 1rem;">
                            🎯 Set Goals
                        </button>
                    </div>
                    
                    <!-- Weekly Metrics -->
                    <div class="metrics-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div class="metric-card" style="background: white; padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--primary-500);">
                            <div style="font-size: 2rem; font-weight: bold; color: var(--primary-500);">
                                ${dashboard.weeklyMetrics.totalWorkTime || 0}<span style="font-size: 1rem; color: var(--gray-500);">h</span>
                            </div>
                            <div style="color: var(--gray-600); font-size: 0.9rem;">Total Work Time</div>
                        </div>
                        <div class="metric-card" style="background: white; padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--success-500);">
                            <div style="font-size: 2rem; font-weight: bold; color: var(--success-500);">
                                ${dashboard.weeklyMetrics.averageFocus || 0}<span style="font-size: 1rem; color: var(--gray-500);">%</span>
                            </div>
                            <div style="color: var(--gray-600); font-size: 0.9rem;">Average Focus</div>
                        </div>
                        <div class="metric-card" style="background: white; padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--warning-500);">
                            <div style="font-size: 2rem; font-weight: bold; color: var(--warning-500);">
                                ${dashboard.weeklyMetrics.productivityScore || 0}<span style="font-size: 1rem; color: var(--gray-500);">pts</span>
                            </div>
                            <div style="color: var(--gray-600); font-size: 0.9rem;">Productivity Score</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
                        <!-- Career Progress -->
                        <div class="career-progress" style="background: white; padding: 1.5rem; border-radius: 8px;">
                            <h3 style="margin: 0 0 1rem 0; color: var(--gray-800);">🚀 Career Development</h3>
                            ${Object.entries(dashboard.careerProgress.skills).map(([skill, level]) => `
                                <div style="margin-bottom: 1rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span style="font-weight: 500;">${skill}</span>
                                        <span style="color: var(--gray-600);">${level}%</span>
                                    </div>
                                    <div style="width: 100%; height: 6px; background: var(--gray-200); border-radius: 3px; overflow: hidden;">
                                        <div style="height: 100%; background: linear-gradient(90deg, var(--primary-500), var(--primary-600)); width: ${level}%; transition: width 0.3s;"></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- Recent Insights -->
                        <div class="recent-insights" style="background: white; padding: 1.5rem; border-radius: 8px;">
                            <h3 style="margin: 0 0 1rem 0; color: var(--gray-800);">🧠 Recent Insights</h3>
                            ${dashboard.recentInsights.map(insight => `
                                <div style="margin-bottom: 1rem; padding: 1rem; background: var(--gray-50); border-radius: 6px;">
                                    <div style="font-weight: 500; margin-bottom: 0.5rem;">${insight.title}</div>
                                    <div style="font-size: 0.9rem; color: var(--gray-600);">
                                        ${Array.isArray(insight.content) ? insight.content.join(', ') : insight.content}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== PRODUCTIVITY UI FUNCTIONS ====================

        function startWorkSession(taskId = null, projectId = null) {
            if (!taskId || !projectId) {
                showNotification('Error: Task and project information required', 'error');
                return;
            }

            // Find the task and project for context
            const project = AppState.projects?.find(p => p.id === projectId);
            const task = project?.tasks?.find(t => t.id === taskId);
            
            if (!task) {
                showNotification('Error: Task not found', 'error');
                return;
            }

            if (window.productivityMonitor) {
                // Check if another task timer is active
                if (productivityMonitor.isActive && productivityMonitor.metrics.activeTaskId !== taskId) {
                    const currentProject = AppState.projects?.find(p => p.id === productivityMonitor.metrics.activeProjectId);
                    const currentTask = currentProject?.tasks?.find(t => t.id === productivityMonitor.metrics.activeTaskId);
                    const confirmSwitch = confirm(`You have an active timer on "${currentTask?.name || 'another task'}". Switch to "${task.name}"?`);
                    
                    if (!confirmSwitch) return;
                    
                    // Stop current session and save its time
                    stopWorkSession();
                }

                const success = productivityMonitor.startWorkSession(taskId, projectId);
                if (success) {
                    // Update UI to show timer is active
                    updateTaskTimerUI(taskId, projectId, true);
                    showNotification(`Work timer started: ${task.name} 🎯`, 'success');
                    
                    // Initialize task time tracking if not exists
                    initializeTaskTimeTracking(taskId, projectId);
                } else {
                    showNotification('Error starting work session', 'error');
                }
            } else {
                showNotification('Productivity system not available', 'error');
            }
        }

        function stopWorkSession(taskId = null, projectId = null) {
            if (window.productivityMonitor && productivityMonitor.isActive) {
                const activeTaskId = productivityMonitor.metrics.activeTaskId;
                const activeProjectId = productivityMonitor.metrics.activeProjectId;
                
                const sessionDuration = productivityMonitor.stopWorkSession();
                
                if (sessionDuration > 0) {
                    // Record time spent on the task
                    recordTaskTime(activeTaskId, activeProjectId, sessionDuration);
                    
                    // Update UI
                    updateTaskTimerUI(activeTaskId, activeProjectId, false);
                    
                    const minutes = Math.round(sessionDuration / 1000 / 60);
                    showNotification(`Work session completed: ${minutes} minutes logged 📊`, 'success');
                    
                    // Refresh the view to show updated time
                    if (AppState.currentView === 'projects') {
                        loadProjects();
                    }
                }
            }
        }

        function initializeTaskTimeTracking(taskId, projectId) {
            // Initialize time tracking data structure if not exists
            const project = AppState.projects?.find(p => p.id === projectId);
            const task = project?.tasks?.find(t => t.id === taskId);
            
            if (task && !task.timeTracking) {
                task.timeTracking = {
                    totalTime: 0, // milliseconds
                    sessions: [],
                    averageSessionLength: 0,
                    productivityRating: 0,
                    lastWorked: null,
                    estimatedTime: null,
                    actualVsEstimated: 0
                };
            }
        }

        function recordTaskTime(taskId, projectId, sessionDuration) {
            const project = AppState.projects?.find(p => p.id === projectId);
            const task = project?.tasks?.find(t => t.id === taskId);
            
            if (!task || !task.timeTracking) return;
            
            const sessionData = {
                id: Date.now(),
                startTime: Date.now() - sessionDuration,
                endTime: Date.now(),
                duration: sessionDuration,
                productivity: window.productivityMonitor?.getProductivityScore() || 0,
                focusRatio: window.productivityMonitor?.metrics.focusRatio || 0,
                interactionCount: window.productivityMonitor?.metrics.interactionCount || 0,
                notes: ''
            };
            
            // Add session to task
            task.timeTracking.sessions.push(sessionData);
            task.timeTracking.totalTime += sessionDuration;
            task.timeTracking.lastWorked = Date.now();
            
            // Calculate averages
            const sessions = task.timeTracking.sessions;
            task.timeTracking.averageSessionLength = sessions.reduce((sum, s) => sum + s.duration, 0) / sessions.length;
            task.timeTracking.productivityRating = sessions.reduce((sum, s) => sum + s.productivity, 0) / sessions.length;
            
            // Update project totals
            updateProjectTimeTracking(projectId);
            
            // Save to storage/backend
            saveTaskTimeData(taskId, projectId, sessionData);
        }

        function updateProjectTimeTracking(projectId) {
            const project = AppState.projects?.find(p => p.id === projectId);
            if (!project) return;
            
            if (!project.timeTracking) {
                project.timeTracking = {
                    totalTime: 0,
                    totalSessions: 0,
                    averageProductivity: 0,
                    activeTasks: 0,
                    completedTasks: 0
                };
            }
            
            // Recalculate project totals from all tasks
            const tasks = project.tasks || [];
            project.timeTracking.totalTime = tasks.reduce((sum, task) => 
                sum + (task.timeTracking?.totalTime || 0), 0);
            
            project.timeTracking.totalSessions = tasks.reduce((sum, task) => 
                sum + (task.timeTracking?.sessions?.length || 0), 0);
            
            const taskProductivities = tasks
                .filter(t => t.timeTracking?.productivityRating)
                .map(t => t.timeTracking.productivityRating);
            
            project.timeTracking.averageProductivity = taskProductivities.length > 0 ?
                taskProductivities.reduce((sum, rating) => sum + rating, 0) / taskProductivities.length : 0;
            
            project.timeTracking.activeTasks = tasks.filter(t => t.status !== 'completed').length;
            project.timeTracking.completedTasks = tasks.filter(t => t.status === 'completed').length;
        }

        function updateTaskTimerUI(taskId, projectId, isActive) {
            // Update the Start Work button to show active state
            const button = document.querySelector(`[onclick*="startWorkSession('${taskId}', '${projectId}')"]`);
            if (button) {
                if (isActive) {
                    button.innerHTML = '⏹️ Stop Work';
                    button.onclick = (e) => {
                        e.stopPropagation();
                        stopWorkSession(taskId, projectId);
                    };
                    button.style.backgroundColor = 'var(--danger-500)';
                    button.title = 'Stop work session';
                } else {
                    button.innerHTML = '🎯 Start Work';
                    button.onclick = (e) => {
                        e.stopPropagation();
                        startWorkSession(taskId, projectId);
                    };
                    button.style.backgroundColor = 'var(--primary-500)';
                    button.title = 'Start work session';
                }
            }
            
            // Refresh the project view if it's currently open to update time tracking displays
            const modal = document.querySelector('.project-modal-overlay');
            if (modal && AppState.currentProjectView === projectId) {
                // Re-render the project view to show updated time tracking data
                setTimeout(() => {
                    showProjectView(projectId);
                }, 100);
            }
        }

        async function saveTaskTimeData(taskId, projectId, sessionData) {
            // Save locally
            if (typeof saveToLocal === 'function') {
                saveToLocal(AppState.projects);
            }
            
            // Sync to backend if available
            if (AppState.useBackend) {
                try {
                    await apiCall(`/projects/${projectId}/tasks/${taskId}/time`, {
                        method: 'POST',
                        body: JSON.stringify({
                            sessionData,
                            totalTime: AppState.projects?.find(p => p.id === projectId)?.tasks?.find(t => t.id === taskId)?.timeTracking?.totalTime
                        })
                    });
                } catch (error) {
                    console.warn('Failed to sync time data to backend:', error.message);
                }
            }
        }

        function showActiveTimers() {
            if (!window.productivityMonitor) {
                showNotification('No active timers', 'info');
                return;
            }
            
            if (productivityMonitor.isActive) {
                const project = AppState.projects?.find(p => p.id === productivityMonitor.metrics.activeProjectId);
                const task = project?.tasks?.find(t => t.id === productivityMonitor.metrics.activeTaskId);
                const elapsed = Date.now() - productivityMonitor.metrics.sessionStart;
                const minutes = Math.floor(elapsed / 1000 / 60);
                const seconds = Math.floor((elapsed / 1000) % 60);
                
                showNotification(`Active: ${task?.name || 'Unknown Task'} (${minutes}:${seconds.toString().padStart(2, '0')})`, 'info');
            } else {
                showNotification('No active timers', 'info');
            }
        }

        function setProductivityGoals() {
            // Simple goal setting modal - could be enhanced
            const weeklyHours = prompt('Set weekly work hours goal (e.g., 40):');
            const focusTarget = prompt('Set focus ratio goal (e.g., 75):');
            
            if (weeklyHours && window.personalInsights) {
                personalInsights.setWeeklyGoal('workTime', parseInt(weeklyHours));
                showNotification(`Weekly goal set: ${weeklyHours} hours`, 'success');
            }
            
            if (focusTarget && window.personalInsights) {
                personalInsights.setWeeklyGoal('focus', parseInt(focusTarget));
                showNotification(`Focus goal set: ${focusTarget}%`, 'success');
            }
        }

        // ==================== INITIALIZATION ====================

        // Initialize productivity systems
        let productivityMonitor, earlyWarningSystem, personalInsights;

        function initProductivitySystems() {
            try {
                productivityMonitor = new ProductivityMonitor();
                earlyWarningSystem = new EarlyWarningSystem();
                personalInsights = new PersonalInsights();
                
                // Make globally available
                window.productivityMonitor = productivityMonitor;
                window.earlyWarningSystem = earlyWarningSystem;
                window.personalInsights = personalInsights;
                
                console.log('🎯 All productivity systems initialized successfully');
            } catch (error) {
                console.error('Failed to initialize productivity systems:', error);
            }
        }

        // Auto-initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize productivity systems after a short delay
            setTimeout(() => {
                initProductivitySystems();
            }, 1000);
        });

    </script>
</body>
</html>